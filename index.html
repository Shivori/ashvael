<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ashvael">
    <meta name="theme-color" content="#c9a227">
    <meta name="description" content="D&D 5e Character Sheet for Ashvael, Circle of Stars Druid">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a0a12' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' fill='%23c9a227' font-size='50'>⭐</text></svg>">
    <title>Ashvael - Circle of Stars Druid</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-dark: #0a0a12;
            --bg-card: #12121f;
            --bg-card-hover: #1a1a2e;
            --border-color: #2a2a4a;
            --accent-gold: #c9a227;
            --accent-purple: #7b68ee;
            --accent-blue: #4a90d9;
            --accent-green: #50c878;
            --accent-red: #dc3545;
            --accent-orange: #ff8c00;
            --text-primary: #e8e8f0;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --safe-left: env(safe-area-inset-left);
            --safe-right: env(safe-area-inset-right);
        }

        /* PWA Install Banner (hidden by default) */
        .pwa-install-banner {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 10px;
            right: 10px;
            background: linear-gradient(135deg, var(--accent-gold) 0%, #8b7355 100%);
            color: var(--bg-dark);
            padding: 12px 15px;
            border-radius: 12px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .pwa-install-banner.show { display: flex; align-items: center; justify-content: space-between; }
        .pwa-install-banner button {
            background: var(--bg-dark);
            color: var(--accent-gold);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Touch-friendly improvements */
        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
        }

        /* Larger touch targets for mobile */
        @media (max-width: 600px) {
            .action-item, .form-option, .spell-card, .feature-item {
                min-height: 48px;
                padding: 12px !important;
            }
            .nav-item {
                min-width: 60px;
            }
            button, .rest-btn, .hp-apply-btn {
                min-height: 44px;
                min-width: 44px;
            }
        }

        /* Smooth scrolling */
        html { scroll-behavior: smooth; }
        .section { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }

        body {
            font-family: 'Crimson Text', Georgia, serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding-top: var(--safe-top);
            padding-bottom: calc(70px + var(--safe-bottom));
            background-image: radial-gradient(white 1px, transparent 1px);
            background-size: 80px 80px;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at center, transparent 0%, var(--bg-dark) 70%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 10px;
        }

        /* Top Bar */
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, var(--bg-card) 0%, #1a1a30 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .character-name-small {
            font-family: 'Cinzel', serif;
            font-size: 1.2em;
            color: var(--accent-gold);
        }

        .rest-buttons {
            display: flex;
            gap: 8px;
        }

        .rest-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-card-hover);
            color: var(--text-primary);
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rest-btn:hover, .rest-btn:active {
            border-color: var(--accent-purple);
            background: rgba(123, 104, 238, 0.2);
        }

        .rest-btn.long { border-color: var(--accent-blue); }
        .rest-btn.short { border-color: var(--accent-green); }

        .undo-btn {
            padding: 8px 12px;
            border: 1px solid var(--accent-orange);
            border-radius: 6px;
            background: transparent;
            color: var(--accent-orange);
            cursor: pointer;
        }

        /* Battle Mode Banner */
        .battle-banner {
            display: none;
            background: linear-gradient(90deg, var(--accent-red), #8b0000);
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-weight: bold;
            justify-content: space-between;
            align-items: center;
        }

        .battle-banner.active { display: flex; }

        .battle-btn {
            padding: 6px 15px;
            border: 2px solid white;
            border-radius: 6px;
            background: transparent;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 5px;
            padding-bottom: calc(8px + var(--safe-bottom));
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 10px;
            color: var(--text-muted);
            font-size: 0.7em;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
        }

        .nav-item:hover, .nav-item.active {
            color: var(--accent-gold);
            background: rgba(201, 162, 39, 0.1);
        }

        .nav-icon {
            font-size: 1.5em;
            margin-bottom: 2px;
        }

        /* Sections */
        .section { display: none; }
        .section.active { display: block; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .card-title {
            font-family: 'Cinzel', serif;
            font-size: 1.2em;
            color: var(--accent-gold);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title-badge {
            font-size: 0.7em;
            padding: 3px 8px;
            background: var(--accent-purple);
            border-radius: 10px;
            color: white;
        }

        /* Collapsible Cards */
        .card-title.collapsible {
            cursor: pointer;
            user-select: none;
        }
        .card-title.collapsible:hover {
            color: var(--accent-gold-light, #f0d890);
        }
        .card-title .collapse-toggle {
            font-size: 0.8em;
            transition: transform 0.2s ease;
            margin-left: auto;
            padding-left: 10px;
        }
        .card-content {
            transition: max-height 0.3s ease, opacity 0.2s ease;
            overflow: hidden;
        }
        .card-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin: 0;
            padding: 0;
        }
        .card.collapsed .card-title {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* Combat Stats Row */
        .combat-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            text-align: center;
        }

        .combat-stat {
            padding: 10px 5px;
            background: var(--bg-card-hover);
            border-radius: 8px;
        }

        .combat-stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-gold);
        }

        .combat-stat-label {
            font-size: 0.7em;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* HP Section */
        .hp-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .hp-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .hp-current {
            font-size: 3em;
            font-weight: bold;
            color: var(--accent-green);
            min-width: 80px;
            text-align: center;
        }

        .hp-current.injured { color: var(--accent-orange); }
        .hp-current.critical { color: var(--accent-red); }

        .hp-max {
            font-size: 1.5em;
            color: var(--text-secondary);
        }

        .hp-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .hp-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .hp-input-group label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .hp-input {
            width: 60px;
            padding: 8px;
            font-size: 1.1em;
            text-align: center;
            background: var(--bg-card-hover);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
        }

        .hp-input:focus {
            outline: none;
            border-color: var(--accent-purple);
        }

        .hp-apply-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .hp-apply-btn.damage {
            background: var(--accent-red);
            color: white;
        }

        .hp-apply-btn.heal {
            background: var(--accent-green);
            color: white;
        }

        .temp-hp-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: rgba(123, 104, 238, 0.1);
            border-radius: 8px;
        }

        /* HP History */
        .hp-history-toggle {
            text-align: center;
            color: var(--accent-purple);
            cursor: pointer;
            font-size: 0.9em;
            padding: 5px;
        }

        .hp-history {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .hp-history.expanded {
            max-height: 300px;
            overflow-y: auto;
        }

        .hp-history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9em;
        }

        .hp-history-item.damage { color: var(--accent-red); }
        .hp-history-item.heal { color: var(--accent-green); }

        /* Ability Scores */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        @media (min-width: 500px) {
            .stat-grid { grid-template-columns: repeat(6, 1fr); }
        }

        .stat-box {
            text-align: center;
            padding: 10px 5px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .stat-name {
            font-size: 0.65em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-score {
            font-size: 1.4em;
            font-weight: bold;
        }

        .stat-mod {
            font-size: 1em;
            color: var(--accent-purple);
        }

        .stat-save {
            font-size: 0.75em;
            color: var(--text-secondary);
        }

        .stat-save.proficient { color: var(--accent-green); }

        .stat-box.wild-shape {
            border-color: var(--accent-green);
            background: rgba(80, 200, 120, 0.15);
        }

        .stat-box.wild-shape .stat-score {
            color: var(--accent-green);
        }

        .skill-item.wild-shape {
            border-color: var(--accent-green);
            background: rgba(80, 200, 120, 0.15);
        }

        .skill-item.wild-shape .skill-mod {
            color: var(--accent-green);
        }

        /* Spellcasting Combined Section */
        .spellcasting-header {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
            margin-bottom: 15px;
        }

        .spell-stat {
            padding: 8px;
            background: var(--bg-card-hover);
            border-radius: 8px;
        }

        .spell-stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--accent-blue);
        }

        .spell-stat-label {
            font-size: 0.7em;
            color: var(--text-secondary);
        }

        /* Spell Slots */
        .spell-slots-row {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .slot-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slot-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            min-width: 35px;
        }

        .slot-boxes {
            display: flex;
            gap: 5px;
        }

        .slot-box {
            width: 28px;
            height: 28px;
            border: 2px solid var(--accent-blue);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            transition: all 0.2s;
        }

        .slot-box:hover { background: rgba(74, 144, 217, 0.3); }
        .slot-box.used { background: var(--accent-blue); color: white; }

        /* Prepared Spells */
        .prepared-spells-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }

        .prepared-spell-chip {
            padding: 8px 10px;
            background: rgba(123, 104, 238, 0.15);
            border: 1px solid var(--accent-purple);
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .prepared-spell-chip:hover {
            background: rgba(123, 104, 238, 0.3);
        }

        .prepared-spell-chip.always {
            border-color: var(--accent-gold);
            background: rgba(201, 162, 39, 0.15);
        }

        .spell-level-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-purple);
            color: white;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .prepared-spell-chip.always .spell-level-dot {
            background: var(--accent-gold);
        }

        /* Actions Section */
        .actions-grid {
            display: grid;
            gap: 10px;
        }

        .action-category {
            padding: 10px;
            background: var(--bg-card-hover);
            border-radius: 8px;
            border-left: 3px solid var(--accent-purple);
        }

        .action-category.bonus { border-left-color: var(--accent-orange); }
        .action-category.reaction { border-left-color: var(--accent-blue); }
        .action-category.free { border-left-color: var(--accent-green); }

        .action-category-title {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .action-item {
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-item:hover { border-color: var(--accent-purple); }

        .action-item.used {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .action-item.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Form Mode Indicator */
        .form-indicator {
            display: none;
            padding: 12px;
            background: linear-gradient(135deg, rgba(123, 104, 238, 0.2), rgba(201, 162, 39, 0.2));
            border: 1px solid var(--accent-purple);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .form-indicator.active { display: block; }

        .form-indicator-title {
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 5px;
        }

        .form-indicator-details {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .form-end-btn {
            margin-top: 10px;
            padding: 6px 12px;
            background: var(--accent-red);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-card);
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            color: var(--accent-gold);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5em;
            cursor: pointer;
        }

        .modal-body {
            padding: 15px;
        }

        /* Battle Log */
        .battle-log {
            display: none;
            max-height: 150px;
            overflow-y: auto;
            background: var(--bg-card-hover);
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }

        .battle-log.active { display: block; }

        .battle-log-item {
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85em;
        }

        .battle-log-time {
            color: var(--text-muted);
            font-size: 0.8em;
        }

        /* Wild Shape Selection */
        .form-options {
            display: grid;
            gap: 10px;
        }

        .form-option {
            padding: 15px;
            background: var(--bg-card-hover);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .form-option:hover {
            border-color: var(--accent-purple);
        }

        .form-option-title {
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 5px;
        }

        .form-option-desc {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        /* Skills compact */
        .skills-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            font-size: 0.85em;
        }

        @media (min-width: 500px) {
            .skills-grid { grid-template-columns: repeat(3, 1fr); }
        }

        .skill-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 8px;
            background: var(--bg-card-hover);
            border-radius: 4px;
        }

        .skill-item.proficient {
            border-left: 2px solid var(--accent-green);
        }

        .skill-mod {
            font-weight: bold;
            color: var(--accent-purple);
        }

        .skill-mod.proficient { color: var(--accent-green); }

        /* Utilities */
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .text-small { font-size: 0.85em; }
        .mt-10 { margin-top: 10px; }
        .mb-10 { margin-bottom: 10px; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .gap-10 { gap: 10px; }

        /* Link to features */
        .feature-link {
            color: var(--accent-purple);
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .feature-link:hover {
            color: var(--accent-gold);
        }

        /* Spell List Styles */
        .prepared-counter-display {
            text-align: center;
            font-size: 1.2em;
            padding: 10px;
            background: var(--bg-card-hover);
            border-radius: 8px;
        }

        .prepared-count-value {
            font-weight: bold;
            color: var(--accent-green);
            font-size: 1.3em;
        }

        .prepared-count-value.over { color: var(--accent-red); }

        .cantrip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
        }

        .cantrip-card {
            padding: 12px;
            background: var(--bg-card-hover);
            border: 1px solid var(--accent-gold);
            border-radius: 8px;
        }

        .cantrip-card-name {
            font-weight: bold;
            color: var(--accent-gold);
        }

        .cantrip-card-source {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .cantrip-card-desc {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .spell-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .spell-card {
            padding: 12px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .spell-card:hover { border-color: var(--accent-purple); }

        .spell-card.prepared {
            border-color: var(--accent-green);
            background: rgba(80, 200, 120, 0.1);
        }

        .spell-card.always {
            border-color: var(--accent-gold);
            background: rgba(201, 162, 39, 0.1);
        }

        .spell-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }

        .spell-card-name {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spell-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .spell-card-tags {
            display: flex;
            gap: 5px;
        }

        .spell-tag {
            padding: 2px 6px;
            font-size: 0.7em;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .spell-tag.conc { background: rgba(220, 53, 69, 0.3); color: #ff6b6b; }
        .spell-tag.ritual { background: rgba(123, 104, 238, 0.3); color: var(--accent-purple); }

        .spell-card-meta {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .spell-card-desc {
            font-size: 0.85em;
            color: var(--text-secondary);
            display: none;
        }

        .spell-card.expanded .spell-card-desc { display: block; }

        /* Beast Form Card */
        .beast-card {
            padding: 12px;
            background: var(--bg-card-hover);
            border: 1px solid var(--accent-green);
            border-radius: 8px;
            cursor: pointer;
        }

        .beast-card-name {
            font-weight: bold;
            color: var(--accent-green);
        }

        .beast-card-stats {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        /* Inventory Styles */
        .inventory-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--bg-card-hover);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .inventory-item.equipped {
            border-color: var(--accent-green);
            background: rgba(80, 200, 120, 0.1);
        }

        .inventory-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .equip-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .inventory-item-name {
            font-weight: 500;
            cursor: pointer;
        }

        .inventory-item-actions {
            display: flex;
            gap: 8px;
        }

        .delete-btn {
            background: none;
            border: none;
            color: var(--accent-red);
            cursor: pointer;
            font-size: 1.1em;
        }

        .add-item-row {
            display: flex;
            gap: 8px;
        }

        .add-item-input {
            flex: 1;
            padding: 10px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
        }

        .add-item-btn {
            padding: 10px 15px;
            background: var(--accent-purple);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }

        .currency-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .currency-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .currency-item label {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .currency-item input {
            width: 70px;
            padding: 8px;
            text-align: center;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
        }

        /* Equipment Slots Styles */
        .equipment-slots-section {
            margin-bottom: 15px;
        }

        .slot-header {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .equipment-slots-row {
            display: flex;
            gap: 10px;
        }

        .equipment-slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .equipment-slot {
            flex: 1;
            padding: 12px;
            background: var(--bg-card-hover);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 60px;
        }

        .equipment-slot:hover {
            border-color: var(--accent-purple);
            background: rgba(123, 104, 238, 0.1);
        }

        .equipment-slot.wide {
            flex: 1;
        }

        .equipment-slot.small {
            padding: 8px;
            min-height: 50px;
        }

        .equipment-slot.filled {
            border-style: solid;
            border-color: var(--accent-green);
            background: rgba(80, 200, 120, 0.1);
        }

        .equipment-slot.magic {
            border-color: var(--accent-purple);
            background: rgba(123, 104, 238, 0.15);
        }

        .slot-label {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .slot-content {
            font-size: 0.9em;
            color: var(--text-primary);
            font-weight: 500;
        }

        .slot-content.empty {
            color: var(--text-muted);
            font-style: italic;
        }

        .attunement-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .attuned-list {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .add-btn {
            background: var(--accent-purple);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            margin-left: 10px;
        }

        .add-btn:hover {
            background: var(--accent-blue);
        }

        /* Add Equipment Modal */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1em;
        }

        .form-group select {
            cursor: pointer;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .magic-options {
            padding: 12px;
            background: rgba(123, 104, 238, 0.1);
            border: 1px solid var(--accent-purple);
            border-radius: 8px;
            margin-top: 10px;
        }

        /* Effects Builder */
        .effects-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .effect-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            font-size: 0.85em;
        }

        .effect-item .effect-icon {
            font-size: 1.1em;
        }

        .effect-item .effect-text {
            flex: 1;
        }

        .effect-item .effect-remove {
            color: var(--accent-red);
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .effect-item .effect-remove:hover {
            background: rgba(255,100,100,0.2);
        }

        .add-effect-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            background: rgba(123, 104, 238, 0.2);
            border: 1px dashed var(--accent-purple);
            border-radius: 6px;
            color: var(--accent-purple);
            cursor: pointer;
            font-size: 0.9em;
        }

        .add-effect-btn:hover {
            background: rgba(123, 104, 238, 0.3);
        }

        .effect-form {
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            margin-top: 8px;
        }

        .effect-form select, .effect-form input {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
        }

        .effect-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        .effect-form-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .effect-form-buttons button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Item Charges Display */
        .item-charges-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .item-charges-row:hover {
            background: rgba(0,0,0,0.3);
        }
        .item-charges-name {
            flex: 1;
            font-weight: 500;
            color: var(--accent-purple);
        }
        .item-charges-bar {
            width: 80px;
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        .item-charges-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-gold));
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .item-charges-count {
            font-size: 0.85em;
            color: var(--text-secondary);
            min-width: 40px;
            text-align: right;
        }
        .item-spell-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(123, 104, 238, 0.1);
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            border-left: 3px solid var(--accent-purple);
        }
        .item-spell-row:hover {
            background: rgba(123, 104, 238, 0.2);
        }
        .item-spell-row.used {
            opacity: 0.5;
            border-left-color: var(--text-muted);
        }
        .item-spell-name {
            flex: 1;
            font-weight: 500;
        }
        .item-spell-usage {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        .no-charges {
            color: var(--text-muted);
            text-align: center;
            padding: 10px;
            font-style: italic;
        }
        /* Item Charges Modal */
        .item-charges-modal .charges-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .item-charges-modal .recharge-info {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        .charges-bar-large {
            height: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .charges-fill-large {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-gold));
            border-radius: 6px;
            transition: width 0.3s ease;
        }
        .charge-spells-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .charge-spell-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(123, 104, 238, 0.15);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .charge-spell-option:hover {
            background: rgba(123, 104, 238, 0.3);
            transform: translateX(4px);
        }
        .charge-spell-name {
            font-weight: 500;
        }
        .charge-spell-cost {
            font-size: 0.9em;
            color: var(--accent-gold);
        }

        /* Resistances Display */
        .resistances-section {
            margin-top: 15px;
            padding: 12px;
            background: var(--bg-card-hover);
            border-radius: 8px;
        }

        .resistances-title {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .resistance-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .resistance-tag {
            padding: 4px 10px;
            background: rgba(80, 200, 120, 0.15);
            border: 1px solid var(--accent-green);
            border-radius: 12px;
            font-size: 0.8em;
            color: var(--accent-green);
        }

        .immunity-tag {
            background: rgba(201, 162, 39, 0.15);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Features Styles */
        .feature-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .feature-item {
            padding: 12px;
            background: var(--bg-card-hover);
            border-left: 3px solid var(--accent-purple);
            border-radius: 0 8px 8px 0;
        }

        .feature-item-name {
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 3px;
        }

        .feature-item-source {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .feature-item-desc {
            font-size: 0.9em;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Backstory Styles */
        .appearance-table {
            width: 100%;
            border-collapse: collapse;
        }

        .appearance-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .appearance-table td:first-child {
            font-weight: bold;
            color: var(--accent-purple);
            width: 80px;
        }

        .backstory-text {
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .backstory-text p { margin-bottom: 10px; }

        .personality-traits {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .trait-item {
            padding: 10px;
            background: var(--bg-card-hover);
            border-radius: 6px;
            font-style: italic;
        }

        .trait-item strong {
            color: var(--accent-gold);
            font-style: normal;
        }

        /* Notes Styles */
        .notes-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .notes-tab {
            padding: 8px 15px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .notes-tab.active {
            border-color: var(--accent-purple);
            color: var(--accent-gold);
        }

        .notes-folder-view {
            min-height: 100px;
            margin-bottom: 15px;
        }

        .note-folder {
            margin-bottom: 10px;
        }

        .note-folder-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--bg-card-hover);
            border-radius: 6px;
            cursor: pointer;
        }

        .note-folder-header:hover {
            background: rgba(123, 104, 238, 0.2);
        }

        .note-folder-items {
            padding-left: 20px;
            margin-top: 5px;
        }

        .note-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--bg-card-hover);
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .note-item:hover { background: rgba(123, 104, 238, 0.2); }

        .add-note-row {
            display: flex;
            gap: 8px;
        }

        .note-textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
            margin-bottom: 10px;
        }

        .save-note-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-green);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <span class="character-name-small">Ashvael</span>
            <span style="font-size: 0.8em; color: var(--text-secondary);">Level 5 Druid (Circle of Stars)</span>
        </div>
        <div class="rest-buttons">
            <button class="undo-btn" onclick="undoLastAction()" title="Undo">↶</button>
            <button class="rest-btn short" onclick="shortRest()">Short Rest</button>
            <button class="rest-btn long" onclick="longRest()">Long Rest</button>
            <button class="rest-btn" onclick="toggleBattle()" id="battleToggle">⚔ Battle</button>
        </div>
    </div>

    <!-- Battle Banner -->
    <div class="battle-banner" id="battleBanner">
        <span>⚔ COMBAT ACTIVE - Round <span id="roundCount">1</span></span>
        <div>
            <button class="battle-btn" onclick="nextRound()">Next Round</button>
            <button class="battle-btn" onclick="endBattle()">End Battle</button>
        </div>
    </div>

    <div class="container">
        <!-- MAIN CHARACTER SHEET -->
        <div id="sheet" class="section active">
            <!-- Form Indicator -->
            <div class="form-indicator" id="formIndicator">
                <div class="form-indicator-title" id="formTitle">Starry Form: Archer</div>
                <div class="form-indicator-details" id="formDetails">Duration: 10 min | Bonus Action: 1d8+4 radiant attack</div>
                <button class="form-end-btn" onclick="endForm()">End Form</button>
            </div>

            <!-- Combat Stats -->
            <div class="card">
                <div class="combat-row">
                    <div class="combat-stat">
                        <div class="combat-stat-value" id="displayAC">15</div>
                        <div class="combat-stat-label">AC</div>
                    </div>
                    <div class="combat-stat">
                        <div class="combat-stat-value">+2</div>
                        <div class="combat-stat-label">Initiative</div>
                    </div>
                    <div class="combat-stat">
                        <div class="combat-stat-value" id="displaySpeed">30ft</div>
                        <div class="combat-stat-label">Speed</div>
                    </div>
                    <div class="combat-stat">
                        <div class="combat-stat-value">+3</div>
                        <div class="combat-stat-label">Prof</div>
                    </div>
                </div>
            </div>

            <!-- HP Section -->
            <div class="card">
                <h2 class="card-title">Hit Points <span class="card-title-badge" style="background: var(--accent-green);">5d8 HD</span></h2>
                <div class="hp-section">
                    <div class="hp-display">
                        <span class="hp-current" id="hpCurrent">38</span>
                        <span class="hp-max">/ 38</span>
                    </div>
                    <div class="hp-controls">
                        <div class="hp-input-group">
                            <label>Damage:</label>
                            <input type="number" id="damageInput" class="hp-input" min="0" value="">
                            <button class="hp-apply-btn damage" onclick="applyDamage()">Apply</button>
                        </div>
                        <div class="hp-input-group">
                            <label>Heal:</label>
                            <input type="number" id="healInput" class="hp-input" min="0" value="">
                            <button class="hp-apply-btn heal" onclick="applyHeal()">Apply</button>
                        </div>
                    </div>
                    <div class="temp-hp-row">
                        <label>Temp HP:</label>
                        <input type="number" id="tempHP" class="hp-input" style="width:50px" min="0" value="0">
                    </div>
                    <div class="hp-history-toggle" onclick="toggleHPHistory()">
                        ▼ Recent Changes (<span id="historyCount">0</span>)
                    </div>
                    <div class="hp-history" id="hpHistory"></div>
                </div>
            </div>

            <!-- Resistances & Immunities -->
            <div class="card" id="resistancesCard">
                <h2 class="card-title">Resistances & Immunities</h2>
                <div id="resistancesDisplay">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Ability Scores -->
            <div class="card">
                <h2 class="card-title">Ability Scores</h2>
                <div class="stat-grid" id="statGrid">
                    <div class="stat-box" id="strBox">
                        <div class="stat-name">STR</div>
                        <div class="stat-score" id="strScore">8</div>
                        <div class="stat-mod" id="strMod">-1</div>
                        <div class="stat-save" id="strSave">-1</div>
                    </div>
                    <div class="stat-box" id="dexBox">
                        <div class="stat-name">DEX</div>
                        <div class="stat-score" id="dexScore">14</div>
                        <div class="stat-mod" id="dexMod">+2</div>
                        <div class="stat-save" id="dexSave">+2</div>
                    </div>
                    <div class="stat-box" id="conBox">
                        <div class="stat-name">CON</div>
                        <div class="stat-score" id="conScore">15</div>
                        <div class="stat-mod" id="conMod">+2</div>
                        <div class="stat-save" id="conSave">+2</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-name">INT</div>
                        <div class="stat-score">8</div>
                        <div class="stat-mod">-1</div>
                        <div class="stat-save proficient">+2</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-name">WIS</div>
                        <div class="stat-score">18</div>
                        <div class="stat-mod">+4</div>
                        <div class="stat-save proficient">+7</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-name">CHA</div>
                        <div class="stat-score">12</div>
                        <div class="stat-mod">+1</div>
                        <div class="stat-save">+1</div>
                    </div>
                </div>
            </div>

            <!-- Spellcasting Combined -->
            <div class="card">
                <h2 class="card-title">
                    Spellcasting
                    <span class="card-title-badge" id="preparedCounter">0/9</span>
                </h2>
                <div class="spellcasting-header">
                    <div class="spell-stat">
                        <div class="spell-stat-value">15</div>
                        <div class="spell-stat-label">Save DC</div>
                    </div>
                    <div class="spell-stat">
                        <div class="spell-stat-value">+7</div>
                        <div class="spell-stat-label">Attack</div>
                    </div>
                    <div class="spell-stat">
                        <div class="spell-stat-value">WIS</div>
                        <div class="spell-stat-label">Ability</div>
                    </div>
                </div>

                <!-- Spell Slots -->
                <div class="spell-slots-row">
                    <div class="slot-group">
                        <span class="slot-label">1st</span>
                        <div class="slot-boxes" data-level="1">
                            <div class="slot-box" onclick="toggleSlot(this)">●</div>
                            <div class="slot-box" onclick="toggleSlot(this)">●</div>
                            <div class="slot-box" onclick="toggleSlot(this)">●</div>
                            <div class="slot-box" onclick="toggleSlot(this)">●</div>
                        </div>
                    </div>
                    <div class="slot-group">
                        <span class="slot-label">2nd</span>
                        <div class="slot-boxes" data-level="2">
                            <div class="slot-box" onclick="toggleSlot(this)">●</div>
                            <div class="slot-box" onclick="toggleSlot(this)">●</div>
                            <div class="slot-box" onclick="toggleSlot(this)">●</div>
                        </div>
                    </div>
                    <div class="slot-group">
                        <span class="slot-label">3rd</span>
                        <div class="slot-boxes" data-level="3">
                            <div class="slot-box" onclick="toggleSlot(this)">●</div>
                            <div class="slot-box" onclick="toggleSlot(this)">●</div>
                        </div>
                    </div>
                </div>

                <!-- Cantrips Display -->
                <div class="text-small text-muted mb-10">Cantrips (click for details):</div>
                <div class="prepared-spells-grid" id="cantripsDisplay"></div>

                <!-- Prepared Spells Display -->
                <div class="text-small text-muted mb-10" style="margin-top: 15px;">Prepared Spells (click for details):</div>
                <div class="prepared-spells-grid" id="preparedDisplay">
                    <div class="prepared-spell-chip always" onclick="showSpellInfo('guiding-bolt')">
                        <span class="spell-level-dot">1</span>
                        <span>Guiding Bolt</span>
                    </div>
                </div>
            </div>

            <!-- Resource Slots (includes Item Charges) -->
            <div class="card" id="resourceSlotsCard">
                <h2 class="card-title collapsible" onclick="toggleCard('resourceSlotsCard')">
                    <span>Resource Slots</span>
                    <span class="collapse-toggle">▼</span>
                </h2>
                <div class="card-content">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div class="slot-group">
                            <span class="slot-label">Wild Shape</span>
                            <div class="slot-boxes" id="wildShapeSlots">
                                <div class="slot-box" onclick="toggleWildShapeSlot(this)" style="border-color: var(--accent-green)">●</div>
                                <div class="slot-box" onclick="toggleWildShapeSlot(this)" style="border-color: var(--accent-green)">●</div>
                            </div>
                        </div>
                        <div class="slot-group">
                            <span class="slot-label">Guiding Bolt</span>
                            <div class="slot-boxes" id="guidingBoltSlots">
                                <div class="slot-box" onclick="toggleGBSlot(this)" style="border-color: var(--accent-gold)">●</div>
                                <div class="slot-box" onclick="toggleGBSlot(this)" style="border-color: var(--accent-gold)">●</div>
                                <div class="slot-box" onclick="toggleGBSlot(this)" style="border-color: var(--accent-gold)">●</div>
                                <div class="slot-box" onclick="toggleGBSlot(this)" style="border-color: var(--accent-gold)">●</div>
                            </div>
                        </div>
                        <div class="slot-group">
                            <span class="slot-label">Healing Word (Free)</span>
                            <div class="slot-boxes" id="healingWordFreeSlot">
                                <div class="slot-box" onclick="toggleHWFreeSlot(this)" style="border-color: var(--accent-green)">●</div>
                            </div>
                        </div>
                        <div class="slot-group">
                            <span class="slot-label">Healing Hands</span>
                            <div class="slot-boxes" id="healingHandsSlot">
                                <div class="slot-box" onclick="toggleHHSlot(this)" style="border-color: var(--accent-purple)">●</div>
                            </div>
                        </div>
                        <div class="slot-group">
                            <span class="slot-label">Celestial Rev.</span>
                            <div class="slot-boxes" id="celestialRevSlot">
                                <div class="slot-box" onclick="toggleCRSlot(this)" style="border-color: var(--accent-orange)">●</div>
                            </div>
                        </div>
                    </div>
                    <!-- Item Charges (integrated into Resource Slots) -->
                    <div id="itemChargesDisplay" style="margin-top: 12px; border-top: 1px solid var(--border-color); padding-top: 12px; display: none;">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card" id="actionsCard">
                <h2 class="card-title collapsible" onclick="toggleCard('actionsCard')">
                    <span>Actions</span>
                    <span class="collapse-toggle">▼</span>
                </h2>
                <div class="card-content">
                    <div class="actions-grid">
                        <div class="action-category">
                            <div class="action-category-title">⚔️ Action</div>
                            <div class="action-list" id="actionList">
                                <div class="action-item" onclick="openAttackSelection()">Attack</div>
                                <div class="action-item" id="reclaimBtn" style="display:none" onclick="openReclaimSelection()">🔄 Reclaim Weapons</div>
                                <div class="action-item" onclick="openCastSpellSelection('action')">Cast Spell (Action)</div>
                                <div class="action-item" onclick="openWildCompanion()">Wild Companion</div>
                                <div class="action-item" onclick="openHealingHands()">Healing Hands</div>
                                <div class="action-item" onclick="useAction('action', this)">Dash</div>
                                <div class="action-item" onclick="useAction('action', this)">Dodge</div>
                                <div class="action-item" onclick="useAction('action', this)">Help</div>
                                <div class="action-item" onclick="useAction('action', this)">Hide</div>
                            </div>
                        </div>
                        <div class="action-category bonus">
                            <div class="action-category-title">⚡ Bonus Action</div>
                            <div class="action-list" id="bonusActionList">
                                <div class="action-item" onclick="openFormSelection()">Wild Shape / Starry Form</div>
                                <div class="action-item" onclick="openCelestialRevelation()">Celestial Revelation</div>
                                <div class="action-item" onclick="openCastSpellSelection('bonus')">Cast Spell (Bonus)</div>
                                <div class="action-item archer-action" style="display:none" onclick="useArcherAttack()">Archer Attack (1d8+4)</div>
                            </div>
                        </div>
                        <div class="action-category reaction">
                            <div class="action-category-title">🛡️ Reaction</div>
                            <div class="action-list" id="reactionList">
                                <div class="action-item" onclick="useAction('reaction', this)">Opportunity Attack</div>
                                <div class="action-item" onclick="openWarCasterSpell()">War Caster Spell</div>
                                <div class="action-item" onclick="useAbsorbElements()">Absorb Elements</div>
                            </div>
                        </div>
                    </div>

                    <!-- Battle Log -->
                    <div class="battle-log" id="battleLog">
                        <div class="text-small text-muted mb-10">Battle Log:</div>
                        <div id="battleLogContent"></div>
                    </div>
                </div>
            </div>

            <!-- Skills -->
            <div class="card" id="skillsCard">
                <h2 class="card-title collapsible" onclick="toggleCard('skillsCard')">
                    <span>Skills</span>
                    <span class="collapse-toggle">▼</span>
                </h2>
                <div class="card-content">
                    <div class="skills-grid">
                        <div class="skill-item" id="skill-acrobatics"><span>Acrobatics</span><span class="skill-mod" id="skillMod-acrobatics">+2</span></div>
                        <div class="skill-item" id="skill-animal"><span>Animal H.</span><span class="skill-mod" id="skillMod-animal">+4</span></div>
                        <div class="skill-item" id="skill-arcana"><span>Arcana*</span><span class="skill-mod" id="skillMod-arcana">+3</span></div>
                        <div class="skill-item" id="skill-athletics"><span>Athletics</span><span class="skill-mod" id="skillMod-athletics">-1</span></div>
                        <div class="skill-item" id="skill-deception"><span>Deception</span><span class="skill-mod" id="skillMod-deception">+1</span></div>
                        <div class="skill-item" id="skill-history"><span>History</span><span class="skill-mod" id="skillMod-history">-1</span></div>
                        <div class="skill-item" id="skill-insight"><span>Insight</span><span class="skill-mod" id="skillMod-insight">+4</span></div>
                        <div class="skill-item" id="skill-intimidation"><span>Intimidation</span><span class="skill-mod" id="skillMod-intimidation">+1</span></div>
                        <div class="skill-item" id="skill-investigation"><span>Investigation</span><span class="skill-mod" id="skillMod-investigation">-1</span></div>
                        <div class="skill-item" id="skill-medicine"><span>Medicine</span><span class="skill-mod" id="skillMod-medicine">+4</span></div>
                        <div class="skill-item proficient" id="skill-nature"><span>Nature*</span><span class="skill-mod proficient" id="skillMod-nature">+6</span></div>
                        <div class="skill-item proficient" id="skill-perception"><span>Perception</span><span class="skill-mod proficient" id="skillMod-perception">+7</span></div>
                        <div class="skill-item" id="skill-performance"><span>Performance</span><span class="skill-mod" id="skillMod-performance">+1</span></div>
                        <div class="skill-item" id="skill-persuasion"><span>Persuasion</span><span class="skill-mod" id="skillMod-persuasion">+1</span></div>
                        <div class="skill-item" id="skill-religion"><span>Religion</span><span class="skill-mod" id="skillMod-religion">-1</span></div>
                        <div class="skill-item" id="skill-sleight"><span>Sleight of H.</span><span class="skill-mod" id="skillMod-sleight">+2</span></div>
                        <div class="skill-item proficient" id="skill-stealth"><span>Stealth</span><span class="skill-mod proficient" id="skillMod-stealth">+5</span></div>
                        <div class="skill-item proficient" id="skill-survival"><span>Survival</span><span class="skill-mod proficient" id="skillMod-survival">+7</span></div>
                    </div>
                    <div class="text-small text-muted mt-10">* Magician adds +4 (Wis) to Arcana/Nature</div>
                </div>
            </div>

            <!-- Character Info -->
            <div class="card" id="charInfoCard">
                <h2 class="card-title collapsible" onclick="toggleCard('charInfoCard')">
                    <span>Character Info</span>
                    <span class="collapse-toggle">▼</span>
                </h2>
                <div class="card-content">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9em;">
                        <div><strong style="color: var(--accent-purple);">Size:</strong> Medium</div>
                        <div><strong style="color: var(--accent-gold);">Background:</strong> Guide</div>
                        <div><strong style="color: var(--accent-purple);">Senses:</strong> <span id="sensesDisplay">Darkvision 60 ft</span></div>
                        <div><strong style="color: var(--accent-blue);">Passive Perception:</strong> <span id="passivePerceptionDisplay">17</span></div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em;">
                        <div><strong style="color: var(--accent-gold);">Languages:</strong> Common, Druidic, Celestial, Infernal</div>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); font-size: 0.85em;">
                        <div style="margin-bottom: 6px;"><strong style="color: var(--text-muted);">Armor:</strong> Light Armor, Shields (no metal)</div>
                        <div style="margin-bottom: 6px;"><strong style="color: var(--text-muted);">Weapons:</strong> Simple Weapons</div>
                        <div><strong style="color: var(--text-muted);">Tools:</strong> <span onclick="showToolInfo('herbalism-kit')" style="cursor: pointer; color: var(--accent-blue); text-decoration: underline;">Herbalism Kit</span>, <span onclick="showToolInfo('cartographers-tools')" style="cursor: pointer; color: var(--accent-blue); text-decoration: underline;">Cartographer's Tools</span></div>
                    </div>
                    <!-- Wild Shape abilities display -->
                    <div id="wildShapeAbilities" style="display: none; margin-top: 15px; padding: 12px; background: rgba(80, 200, 120, 0.1); border: 1px solid var(--accent-green); border-radius: 8px;">
                        <div style="font-weight: bold; color: var(--accent-green); margin-bottom: 8px;">🐾 Beast Abilities</div>
                        <div id="beastAbilitiesContent" style="font-size: 0.9em; line-height: 1.6;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SPELLS SECTION -->
        <div id="spells" class="section">
            <div class="card">
                <div class="prepared-counter-display">
                    <span>Prepared: </span>
                    <span id="spellPreparedCount" class="prepared-count-value">0</span>
                    <span> / 9</span>
                </div>
            </div>

            <!-- Cantrips -->
            <div class="card">
                <h2 class="card-title">Cantrips (At Will)</h2>
                <div class="cantrip-grid" id="cantripGrid"></div>
            </div>

            <!-- 1st Level -->
            <div class="card">
                <h2 class="card-title" onclick="toggleSpellSection('spells1')" style="cursor: pointer;">
                    <span>1st Level Spells</span>
                    <span id="spells1Toggle" style="font-size: 0.8em;">▼</span>
                </h2>
                <div class="spell-list" id="spells1"></div>
            </div>

            <!-- 2nd Level -->
            <div class="card">
                <h2 class="card-title" onclick="toggleSpellSection('spells2')" style="cursor: pointer;">
                    <span>2nd Level Spells</span>
                    <span id="spells2Toggle" style="font-size: 0.8em;">▼</span>
                </h2>
                <div class="spell-list" id="spells2"></div>
            </div>

            <!-- 3rd Level -->
            <div class="card">
                <h2 class="card-title" onclick="toggleSpellSection('spells3')" style="cursor: pointer;">
                    <span>3rd Level Spells</span>
                    <span id="spells3Toggle" style="font-size: 0.8em;">▼</span>
                </h2>
                <div class="spell-list" id="spells3"></div>
            </div>

            <!-- Beast Forms -->
            <div class="card">
                <h2 class="card-title" onclick="toggleSpellSection('beastForms')" style="cursor: pointer;">
                    <span>Wild Shape - Beast Forms</span>
                    <span class="card-title-badge" style="background: var(--accent-green);">Select 6</span>
                    <span id="beastFormsToggle" style="font-size: 0.8em; margin-left: auto;">▼</span>
                </h2>
                <p class="text-small text-muted mb-10">Check up to 6 beast forms you know. At level 5: CR ≤ 1/2, no flying. Click a form for details.</p>
                <div id="beastForms"></div>
            </div>
        </div>

        <!-- INVENTORY SECTION -->
        <div id="inventory" class="section">
            <!-- Equipment Slots -->
            <div class="card">
                <h2 class="card-title">Equipped <span class="card-title-badge" id="acDisplay">AC: 15</span></h2>

                <!-- Weapon Slots -->
                <div class="equipment-slots-section">
                    <div class="slot-header">Weapons</div>
                    <div class="equipment-slots-row">
                        <div class="equipment-slot" id="slot-mainHand" onclick="showSlotOptions('mainHand')">
                            <div class="slot-label">Main Hand</div>
                            <div class="slot-content" id="mainHandContent">Empty</div>
                        </div>
                        <div class="equipment-slot" id="slot-offHand" onclick="showSlotOptions('offHand')">
                            <div class="slot-label">Off Hand</div>
                            <div class="slot-content" id="offHandContent">Empty</div>
                        </div>
                    </div>
                </div>

                <!-- Armor Slot -->
                <div class="equipment-slots-section">
                    <div class="slot-header">Armor</div>
                    <div class="equipment-slots-row">
                        <div class="equipment-slot wide" id="slot-armor" onclick="showSlotOptions('armor')">
                            <div class="slot-label">Body Armor</div>
                            <div class="slot-content" id="armorContent">Empty</div>
                        </div>
                    </div>
                </div>

                <!-- Accessory Slots -->
                <div class="equipment-slots-section">
                    <div class="slot-header">Accessories</div>
                    <div class="equipment-slots-grid">
                        <div class="equipment-slot small" id="slot-head" onclick="showSlotOptions('head')">
                            <div class="slot-label">Head</div>
                            <div class="slot-content" id="headContent">-</div>
                        </div>
                        <div class="equipment-slot small" id="slot-neck" onclick="showSlotOptions('neck')">
                            <div class="slot-label">Neck</div>
                            <div class="slot-content" id="neckContent">-</div>
                        </div>
                        <div class="equipment-slot small" id="slot-hands" onclick="showSlotOptions('hands')">
                            <div class="slot-label">Hands</div>
                            <div class="slot-content" id="handsContent">-</div>
                        </div>
                        <div class="equipment-slot small" id="slot-feet" onclick="showSlotOptions('feet')">
                            <div class="slot-label">Feet</div>
                            <div class="slot-content" id="feetContent">-</div>
                        </div>
                        <div class="equipment-slot small" id="slot-ring1" onclick="showSlotOptions('ring1')">
                            <div class="slot-label">Ring 1</div>
                            <div class="slot-content" id="ring1Content">-</div>
                        </div>
                        <div class="equipment-slot small" id="slot-ring2" onclick="showSlotOptions('ring2')">
                            <div class="slot-label">Ring 2</div>
                            <div class="slot-content" id="ring2Content">-</div>
                        </div>
                    </div>
                </div>

                <!-- Attunement -->
                <div class="attunement-section">
                    <div class="slot-header">Attunement <span id="attunementCount">(0/3)</span></div>
                    <div id="attunedItems" class="attuned-list">No attuned items</div>
                </div>
            </div>

            <!-- Inventory List (unequipped items) -->
            <div class="card">
                <h2 class="card-title">Inventory
                    <div style="display: flex; gap: 8px;">
                        <button class="add-btn" onclick="openAddEquipmentModal()">+ Add</button>
                        <button class="add-btn" onclick="openAddAmmoModal()" style="background: var(--accent-green);">+ Ammo</button>
                    </div>
                </h2>
                <div id="inventoryList" class="inventory-list"></div>
            </div>

            <!-- Adventuring Gear -->
            <div class="card">
                <h2 class="card-title">Adventuring Gear
                    <button class="add-btn" onclick="openAddGearModal()">+ Add</button>
                </h2>
                <div id="gearList" class="inventory-list"></div>
            </div>

            <!-- Currency -->
            <div class="card">
                <h2 class="card-title">Currency</h2>
                <div class="currency-row">
                    <div class="currency-item"><label>CP</label><input type="number" id="currencyCP" value="0" min="0"></div>
                    <div class="currency-item"><label>SP</label><input type="number" id="currencySP" value="0" min="0"></div>
                    <div class="currency-item"><label>GP</label><input type="number" id="currencyGP" value="3" min="0"></div>
                    <div class="currency-item"><label>PP</label><input type="number" id="currencyPP" value="0" min="0"></div>
                </div>
            </div>
        </div>

        <!-- FEATURES SECTION -->
        <div id="features" class="section">
            <div class="card">
                <h2 class="card-title">Background</h2>
                <div class="feature-list" id="backgroundFeatures"></div>
            </div>
            <div class="card">
                <h2 class="card-title">Species: Half-Aasimar/Half-Tiefling</h2>
                <div class="feature-list" id="ancestryFeatures"></div>
            </div>
            <div class="card">
                <h2 class="card-title">Class: Druid (Level 5)</h2>
                <div class="feature-list" id="druidFeatures"></div>
            </div>
            <div class="card">
                <h2 class="card-title">Subclass: Circle of Stars</h2>
                <div class="feature-list" id="starsFeatures"></div>
            </div>
            <div class="card">
                <h2 class="card-title">Feats</h2>
                <div class="feature-list" id="featFeatures"></div>
            </div>
            <div class="card">
                <h2 class="card-title">Proficiencies & Skills</h2>
                <div class="feature-list" id="skillsFeatures"></div>
            </div>
        </div>

        <!-- BACKSTORY SECTION -->
        <div id="backstory" class="section">
            <div class="card">
                <h2 class="card-title">Appearance</h2>
                <table class="appearance-table">
                    <tr><td>Skin</td><td>Vitiligo - patches of luminous pale gold contrasting with deep reddish-bronze</td></tr>
                    <tr><td>Horns</td><td>Single curved horn on the right side of his head</td></tr>
                    <tr><td>Hair</td><td>Two colors - silver-white and deep crimson, naturally split</td></tr>
                    <tr><td>Eyes</td><td>Heterochromia - one golden with soft glow, one deep amber with vertical pupil</td></tr>
                    <tr><td>Build</td><td>Medium height, lean</td></tr>
                    <tr><td>Other</td><td>Faint constellation-like freckles across shoulders</td></tr>
                </table>
            </div>
            <div class="card">
                <h2 class="card-title">Origins</h2>
                <div class="backstory-text">
                    <p>Ashvael was born on a lush forest world where druids served as spiritual guides and astronomers. His parents - an Aasimar and a Tiefling - were both Circle of Stars practitioners.</p>
                    <p>His Aasimar parent taught him the <strong>celestial constellations</strong>: stories of hope and divine guidance. His Tiefling parent taught him the <strong>infernal stars</strong>: tales of ambition and finding light in darkness.</p>
                </div>
            </div>
            <div class="card">
                <h2 class="card-title">The Cataclysm</h2>
                <div class="backstory-text">
                    <p>One night, the stars fell wrong. Crystalline vines erupted from the ground across his world. The vines destroyed cities, uprooted forests, and consumed everything. Ashvael survived, but his world did not.</p>
                </div>
            </div>
            <div class="card">
                <h2 class="card-title">Current Situation</h2>
                <div class="backstory-text">
                    <p>His search for answers made him careless. A Mind Flayer Nautiloid captured his vessel. Now Ashvael waits in the ship's holds, his connection to the stars muffled but not severed, hoping for rescue.</p>
                    <p style="color: var(--accent-purple); font-style: italic;">[The party will rescue him from the Mind Flayers]</p>
                </div>
            </div>
            <div class="card">
                <h2 class="card-title">Personality</h2>
                <div class="personality-traits">
                    <div class="trait-item"><strong>Ideal:</strong> "The same stars shine on everyone. It's not about what you are - it's about what stories you choose to see."</div>
                    <div class="trait-item"><strong>Bond:</strong> "My world is gone, but others can still be saved. I will find what caused the crystalline vines."</div>
                    <div class="trait-item"><strong>Flaw:</strong> "I sometimes trust the stars' guidance more than common sense."</div>
                </div>
            </div>
        </div>

        <!-- NOTES SECTION -->
        <div id="notes" class="section">
            <div class="card">
                <h2 class="card-title">Notes</h2>
                <div class="notes-tabs">
                    <button class="notes-tab active" onclick="showNotesCategory('sessions')">Sessions</button>
                    <button class="notes-tab" onclick="showNotesCategory('cities')">Cities</button>
                    <button class="notes-tab" onclick="showNotesCategory('npcs')">NPCs</button>
                    <button class="notes-tab" onclick="showNotesCategory('other')">Other</button>
                </div>
                <div class="notes-content" id="notesContent">
                    <div class="notes-folder-view" id="notesFolderView"></div>
                    <div class="add-note-row">
                        <input type="text" id="newNoteName" class="add-item-input" placeholder="Note title...">
                        <button class="add-item-btn" onclick="addNote()">+ Note</button>
                        <button class="add-item-btn" onclick="addFolder()">+ Folder</button>
                    </div>
                </div>
            </div>
            <div class="card" id="noteEditorCard" style="display:none;">
                <h2 class="card-title">
                    <span id="noteEditorTitle">Editing Note</span>
                    <button class="card-title-badge" onclick="closeNoteEditor()" style="cursor:pointer;">✕ Close</button>
                </h2>
                <textarea id="noteEditor" class="note-textarea" placeholder="Write your notes here..."></textarea>
                <button class="save-note-btn" onclick="saveCurrentNote()">Save Note</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showSection('sheet')">
            <span class="nav-icon">📋</span>
            <span>Sheet</span>
        </div>
        <div class="nav-item" onclick="showSection('spells')">
            <span class="nav-icon">✨</span>
            <span>Spells</span>
        </div>
        <div class="nav-item" onclick="showSection('inventory')">
            <span class="nav-icon">🎒</span>
            <span>Inventory</span>
        </div>
        <div class="nav-item" onclick="showSection('features')">
            <span class="nav-icon">⭐</span>
            <span>Features</span>
        </div>
        <div class="nav-item" onclick="showSection('backstory')">
            <span class="nav-icon">📖</span>
            <span>Story</span>
        </div>
        <div class="nav-item" onclick="showSection('notes')">
            <span class="nav-icon">📝</span>
            <span>Notes</span>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Title</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // ===== CHARACTER BASE STATS =====
        const PROFICIENCY_BONUS = 3; // Level 5

        const BASE_ABILITY_SCORES = {
            str: 8,   // -1
            dex: 14,  // +2
            con: 14,  // +2
            int: 8,   // -1
            wis: 18,  // +4
            cha: 13   // +1
        };

        // Skills with their governing ability and proficiency status
        // expertise = double proficiency bonus
        const SKILLS = {
            acrobatics:     { ability: 'dex', proficient: false, expertise: false, id: 'skill-acrobatics', modId: 'skillMod-acrobatics' },
            animalHandling: { ability: 'wis', proficient: false, expertise: false, id: 'skill-animal', modId: 'skillMod-animal' },
            arcana:         { ability: 'int', proficient: false, expertise: false, id: 'skill-arcana', modId: 'skillMod-arcana', bonus: 4 }, // +4 from Magician (adds WIS mod)
            athletics:      { ability: 'str', proficient: false, expertise: false, id: 'skill-athletics', modId: 'skillMod-athletics' },
            deception:      { ability: 'cha', proficient: false, expertise: false, id: 'skill-deception', modId: 'skillMod-deception' },
            history:        { ability: 'int', proficient: false, expertise: false, id: 'skill-history', modId: 'skillMod-history' },
            insight:        { ability: 'wis', proficient: false, expertise: false, id: 'skill-insight', modId: 'skillMod-insight' },
            intimidation:   { ability: 'cha', proficient: false, expertise: false, id: 'skill-intimidation', modId: 'skillMod-intimidation' },
            investigation:  { ability: 'int', proficient: false, expertise: false, id: 'skill-investigation', modId: 'skillMod-investigation' },
            medicine:       { ability: 'wis', proficient: false, expertise: false, id: 'skill-medicine', modId: 'skillMod-medicine' },
            nature:         { ability: 'int', proficient: true,  expertise: false, id: 'skill-nature', modId: 'skillMod-nature', bonus: 4 }, // Proficient + Magician bonus (+4 WIS)
            perception:     { ability: 'wis', proficient: true,  expertise: false, id: 'skill-perception', modId: 'skillMod-perception' },
            performance:    { ability: 'cha', proficient: false, expertise: false, id: 'skill-performance', modId: 'skillMod-performance' },
            persuasion:     { ability: 'cha', proficient: false, expertise: false, id: 'skill-persuasion', modId: 'skillMod-persuasion' },
            religion:       { ability: 'int', proficient: false, expertise: false, id: 'skill-religion', modId: 'skillMod-religion' },
            sleightOfHand:  { ability: 'dex', proficient: false, expertise: false, id: 'skill-sleight', modId: 'skillMod-sleight' },
            stealth:        { ability: 'dex', proficient: true,  expertise: false, id: 'skill-stealth', modId: 'skillMod-stealth' },
            survival:       { ability: 'wis', proficient: true,  expertise: false, id: 'skill-survival', modId: 'skillMod-survival' }
        };

        // Calculate ability modifier from score
        function getAbilityMod(score) {
            return Math.floor((score - 10) / 2);
        }

        // Calculate skill modifier given ability scores
        function calculateSkillMod(skillName, abilityScores) {
            const skill = SKILLS[skillName];
            if (!skill) return 0;

            const abilityMod = getAbilityMod(abilityScores[skill.ability]);
            let profBonus = 0;

            if (skill.expertise) {
                profBonus = PROFICIENCY_BONUS * 2;
            } else if (skill.proficient) {
                profBonus = PROFICIENCY_BONUS;
            }

            // Add any static bonus (like from items or features)
            const staticBonus = skill.bonus || 0;

            return abilityMod + profBonus + staticBonus;
        }

        // Format modifier as string (+X or -X)
        function formatMod(mod) {
            return mod >= 0 ? '+' + mod : '' + mod;
        }

        // Get current ability scores (considers Wild Shape)
        function getCurrentAbilityScores() {
            if (state.activeForm && state.activeForm.type === 'wild-shape') {
                const beast = BEAST_FORMS ? BEAST_FORMS.find(b => b.id === state.activeForm.beastId) : null;
                if (beast) {
                    return {
                        str: beast.str,
                        dex: beast.dex,
                        con: beast.con || 12, // Default if not specified
                        int: BASE_ABILITY_SCORES.int,  // Keep mental stats
                        wis: BASE_ABILITY_SCORES.wis,
                        cha: BASE_ABILITY_SCORES.cha
                    };
                }
            }
            return { ...BASE_ABILITY_SCORES };
        }

        // ===== STATE MANAGEMENT =====
        const STATE_VERSION = 2; // Increment to force state reset

        const DEFAULT_STATE = {
            version: STATE_VERSION,
            hp: { current: 38, max: 38, temp: 0 },
            hpHistory: [],
            slots: { 1: [false,false,false,false], 2: [false,false,false], 3: [false,false] },
            resources: { guidingBolt: 4, wildShape: 2, healingHands: 1, healingWordFree: 1, celestialRevelation: 1 },
            preparedSpells: [],
            knownBeastForms: ['cat', 'wolf', 'panther', 'giant-wolf-spider', 'black-bear', 'ape'],
            activeForm: null,
            inBattle: false,
            battleRound: 1,
            battleLog: [],
            battleHistory: [],
            actionsUsed: { action: false, bonus: false, reaction: false },
            equipment: [],
            inventory: [],
            notes: { sessions: [], cities: [], npcs: [], other: [] },
            concentration: null,
            companions: [],  // Array to support multiple companions (familiar + summon beast)
            itemCharges: {},  // Track charges for magic items: { itemId: { current: N, usedToday: [] } }
            itemSpellsUsed: {},  // Track 1/day spell usage: { itemId_spellName: true }
            thrownWeapons: []  // Track weapons that have been thrown and can be reclaimed
        };

        let state = JSON.parse(JSON.stringify(DEFAULT_STATE));

        let undoStack = [];
        const MAX_UNDO = 20;

        function saveForUndo() {
            undoStack.push(JSON.stringify(state));
            if (undoStack.length > MAX_UNDO) undoStack.shift();
        }

        function undoLastAction() {
            if (undoStack.length === 0) return alert('Nothing to undo');
            state = JSON.parse(undoStack.pop());
            updateAllDisplays();
            saveState();
        }

        function saveState() {
            localStorage.setItem('ashvael-v2', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('ashvael-v2');
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    // Check version - reset if outdated
                    if (!loaded.version || loaded.version < STATE_VERSION) {
                        console.log('State version outdated, resetting to defaults');
                        localStorage.removeItem('ashvael-v2');
                        state = JSON.parse(JSON.stringify(DEFAULT_STATE));
                    } else {
                        state = { ...DEFAULT_STATE, ...loaded };
                    }
                } catch (e) {
                    console.error('Error loading state:', e);
                    localStorage.removeItem('ashvael-v2');
                    state = JSON.parse(JSON.stringify(DEFAULT_STATE));
                }
            }
        }

        function updateAllDisplays() {
            try {
                updateHPDisplay();
                updateSlotsDisplay();
                updateResourcesDisplay();
                updateResourceSlots();
                updatePreparedDisplay();
                if (typeof CANTRIPS !== 'undefined') renderCantripsDisplay();
                updateFormIndicator();
                updateWildShapeDisplay();
                updateBattleUI();
                updateConcentrationDisplay();
                updateCompanionDisplay();
                updateItemChargesDisplay();
            } catch (e) {
                console.error('Error in updateAllDisplays:', e);
            }
        }

        // ===== HP SYSTEM =====
        function updateHPDisplay() {
            const el = document.getElementById('hpCurrent');
            el.textContent = state.hp.current;
            el.className = 'hp-current';
            if (state.hp.current <= state.hp.max * 0.25) el.classList.add('critical');
            else if (state.hp.current <= state.hp.max * 0.5) el.classList.add('injured');

            document.getElementById('tempHP').value = state.hp.temp;
            document.getElementById('historyCount').textContent = state.hpHistory.length;

            const historyEl = document.getElementById('hpHistory');
            historyEl.innerHTML = state.hpHistory.slice(-10).reverse().map(h =>
                `<div class="hp-history-item ${h.type}">${h.type === 'damage' ? '−' : '+'}${h.amount} (${h.newHP}/${state.hp.max}) <span class="battle-log-time">${h.time}</span></div>`
            ).join('');
        }

        function applyDamage() {
            const input = document.getElementById('damageInput');
            const amount = parseInt(input.value) || 0;
            if (amount <= 0) return;

            saveForUndo();

            let remaining = amount;
            if (state.hp.temp > 0) {
                if (state.hp.temp >= remaining) {
                    state.hp.temp -= remaining;
                    remaining = 0;
                } else {
                    remaining -= state.hp.temp;
                    state.hp.temp = 0;
                }
            }

            state.hp.current = Math.max(0, state.hp.current - remaining);
            state.hpHistory.push({
                type: 'damage',
                amount: amount,
                newHP: state.hp.current,
                time: new Date().toLocaleTimeString()
            });

            if (state.inBattle) addBattleLog(`Took ${amount} damage`);

            input.value = '';
            updateHPDisplay();
            saveState();
        }

        function applyHeal() {
            const input = document.getElementById('healInput');
            const amount = parseInt(input.value) || 0;
            if (amount <= 0) return;

            saveForUndo();
            state.hp.current = Math.min(state.hp.max, state.hp.current + amount);
            state.hpHistory.push({
                type: 'heal',
                amount: amount,
                newHP: state.hp.current,
                time: new Date().toLocaleTimeString()
            });

            if (state.inBattle) addBattleLog(`Healed ${amount} HP`);

            input.value = '';
            updateHPDisplay();
            saveState();
        }

        function toggleHPHistory() {
            document.getElementById('hpHistory').classList.toggle('expanded');
        }

        // ===== SPELL SLOTS =====
        function toggleSlot(el) {
            saveForUndo();
            el.classList.toggle('used');
            const level = el.parentElement.dataset.level;
            const index = Array.from(el.parentElement.children).indexOf(el);
            state.slots[level][index] = el.classList.contains('used');
            saveState();
        }

        function updateSlotsDisplay() {
            Object.entries(state.slots).forEach(([level, slots]) => {
                const container = document.querySelector(`[data-level="${level}"]`);
                if (container) {
                    Array.from(container.children).forEach((el, i) => {
                        el.classList.toggle('used', slots[i]);
                    });
                }
            });
        }

        // ===== RESOURCES =====
        function updateResourcesDisplay() {
            // Resources are now displayed via Resource Slots section
            updateResourceSlots();
        }

        function useResource(resource) {
            if (resource === 'guiding-bolt' && state.resources.guidingBolt > 0) {
                saveForUndo();
                state.resources.guidingBolt--;
                if (state.inBattle) addBattleLog('Cast Guiding Bolt (free)');
                updateResourceSlots();
                saveState();
            }
        }

        // ===== PREPARED SPELLS =====
        function updatePreparedDisplay() {
            const container = document.getElementById('preparedDisplay');
            const counter = document.getElementById('preparedCounter');

            // Always prepared spells (from features/feats)
            let html = `<div class="prepared-spell-chip always" onclick="showSpellInfo('guiding-bolt')">
                <span class="spell-level-dot">1</span><span>Guiding Bolt</span>
                <span style="font-size:0.7em; color:var(--text-muted);">(Star Map)</span>
            </div>`;
            html += `<div class="prepared-spell-chip always" onclick="showSpellInfo('healing-word')">
                <span class="spell-level-dot">1</span><span>Healing Word</span>
                <span style="font-size:0.7em; color:var(--text-muted);">(Magic Init.)</span>
            </div>`;

            state.preparedSpells.forEach(spell => {
                html += `<div class="prepared-spell-chip" onclick="showSpellInfo('${spell.id}')">
                    <span class="spell-level-dot">${spell.level}</span><span>${spell.name}</span>
                </div>`;
            });

            container.innerHTML = html;
            counter.textContent = `${state.preparedSpells.length}/9`;
        }

        // ===== CANTRIPS DISPLAY (Main Sheet) =====
        function renderCantripsDisplay() {
            const container = document.getElementById('cantripsDisplay');
            if (!container) return;

            container.innerHTML = CANTRIPS.map(c => `
                <div class="prepared-spell-chip always" onclick="showSpellInfo('${c.id}')" style="border-color: var(--accent-gold);">
                    <span class="spell-level-dot" style="background: var(--accent-gold);">C</span>
                    <span>${c.name}</span>
                </div>
            `).join('');
        }

        // ===== FORMS (Wild Shape / Starry Form) =====
        function openFormSelection() {
            if (state.resources.wildShape <= 0) {
                alert('No Wild Shape uses remaining!');
                return;
            }

            const body = `
                <div class="form-options">
                    <div class="form-option" onclick="selectForm('starry-archer')">
                        <div class="form-option-title">⭐ Starry Form: Archer</div>
                        <div class="form-option-desc">Bonus action: Ranged spell attack, 60ft, 1d8+4 radiant</div>
                    </div>
                    <div class="form-option" onclick="selectForm('starry-chalice')">
                        <div class="form-option-title">🏆 Starry Form: Chalice</div>
                        <div class="form-option-desc">Healing spells also heal 1d8+4 to you or ally within 30ft</div>
                    </div>
                    <div class="form-option" onclick="selectForm('starry-dragon')">
                        <div class="form-option-title">🐉 Starry Form: Dragon</div>
                        <div class="form-option-desc">Concentration checks: treat 9 or lower as 10</div>
                    </div>
                    <hr style="border-color: var(--border-color); margin: 15px 0;">
                    <div class="form-option" onclick="openBeastSelection()">
                        <div class="form-option-title">🐺 Wild Shape (Beast Form)</div>
                        <div class="form-option-desc">Transform into a beast (CR 1/2 max, 2 hours, +5 temp HP)</div>
                    </div>
                </div>
            `;
            showModal('Select Form', body);
        }

        function openBeastSelection() {
            const knownForms = getKnownBeastForms();
            let body = '<div class="form-options">';
            body += '<p class="text-muted" style="margin-bottom:15px;">Choose a beast form. You gain 5 temp HP. Your STR/DEX/CON are replaced. You keep Int/Wis/Cha and skill/save proficiencies. Cannot cast spells.</p>';

            knownForms.forEach(b => {
                body += `
                    <div class="form-option" onclick="selectBeastForm('${b.id}')">
                        <div class="form-option-title">${b.name} (CR ${b.cr})</div>
                        <div class="form-option-desc">AC ${b.ac} | HP ${b.hp} | ${b.speed}</div>
                        <div class="form-option-desc" style="margin-top:5px; font-size:0.8em;">${b.attacks}</div>
                    </div>
                `;
            });

            body += '</div>';
            showModal('Choose Beast Form (' + knownForms.length + '/6 known)', body);
        }

        function selectBeastForm(beastId) {
            saveForUndo();
            state.resources.wildShape--;

            const beast = BEAST_FORMS.find(b => b.id === beastId);
            if (!beast) return;

            // Store original stats if not already in a form
            if (!state.originalStats) {
                state.originalStats = {
                    ac: 15,
                    speed: 30,
                    hp: state.hp.current,
                    maxHp: state.hp.max
                };
            }

            // Add 5 temp HP (druid level)
            state.hp.temp += 5;

            state.activeForm = {
                type: 'wild-shape',
                beastId: beastId,
                name: `Wild Shape: ${beast.name}`,
                details: `AC ${beast.ac} | HP ${beast.hp} | ${beast.speed}`,
                beastHp: beast.hp,
                beastMaxHp: beast.hp,
                showArcherAction: false
            };

            if (state.inBattle) {
                state.actionsUsed.bonus = true;
                addBattleLog(`Transformed into ${beast.name} (+5 temp HP)`);
            }

            closeModal();
            updateFormIndicator();
            updateWildShapeDisplay();
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        function selectForm(formType) {
            saveForUndo();
            state.resources.wildShape--;

            const forms = {
                'starry-archer': { name: 'Starry Form: Archer', details: 'Bonus Action: 1d8+4 radiant attack (60ft)', showArcherAction: true },
                'starry-chalice': { name: 'Starry Form: Chalice', details: 'Healing spells also heal 1d8+4 to ally', showArcherAction: false },
                'starry-dragon': { name: 'Starry Form: Dragon', details: 'Concentration: treat rolls 9 or below as 10', showArcherAction: false }
            };

            state.activeForm = { type: formType, ...forms[formType] };

            if (state.inBattle) {
                state.actionsUsed.bonus = true;
                addBattleLog(`Activated ${state.activeForm.name}`);
            }

            closeModal();
            updateFormIndicator();
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        function updateWildShapeDisplay() {
            const inWildShape = state.activeForm && state.activeForm.type === 'wild-shape';
            const abilitiesDiv = document.getElementById('wildShapeAbilities');
            const abilitiesContent = document.getElementById('beastAbilitiesContent');

            // Safety check - if elements don't exist, skip
            if (!abilitiesDiv || !abilitiesContent) return;

            if (inWildShape) {
                const beast = BEAST_FORMS.find(b => b.id === state.activeForm.beastId);
                if (beast) {
                    // Update combat stats (with safety checks)
                    const acEl = document.getElementById('displayAC');
                    const speedEl = document.getElementById('displaySpeed');
                    if (acEl) acEl.textContent = beast.ac;
                    if (speedEl) speedEl.textContent = beast.speed.split(',')[0];

                    // Update physical ability scores (STR, DEX, CON)
                    updateAbilityScore('str', beast.str);
                    updateAbilityScore('dex', beast.dex);
                    updateAbilityScore('con', beast.con);

                    // Add visual indicator
                    const strBox = document.getElementById('strBox');
                    const dexBox = document.getElementById('dexBox');
                    const conBox = document.getElementById('conBox');
                    if (strBox) strBox.classList.add('wild-shape');
                    if (dexBox) dexBox.classList.add('wild-shape');
                    if (conBox) conBox.classList.add('wild-shape');

                    // Update senses
                    const sensesEl = document.getElementById('sensesDisplay');
                    if (sensesEl) sensesEl.textContent = beast.senses;

                    // Show beast abilities with attacks
                    abilitiesDiv.style.display = 'block';
                    abilitiesContent.innerHTML = formatBeastAbilities(beast);

                    // Update skills display
                    updateSkillsForWildShape(beast);

                    // Disable spell casting while in Wild Shape
                    updateSpellButtonsForWildShape(true);
                }
            } else {
                // Restore original stats
                updateACFromEquipment();
                const speedEl = document.getElementById('displaySpeed');
                if (speedEl) speedEl.textContent = '30ft';

                // Restore original ability scores
                updateAbilityScore('str', 8);
                updateAbilityScore('dex', 14);
                updateAbilityScore('con', 15);

                // Remove visual indicator
                const strBox = document.getElementById('strBox');
                const dexBox = document.getElementById('dexBox');
                const conBox = document.getElementById('conBox');
                if (strBox) strBox.classList.remove('wild-shape');
                if (dexBox) dexBox.classList.remove('wild-shape');
                if (conBox) conBox.classList.remove('wild-shape');

                // Restore senses
                const sensesEl = document.getElementById('sensesDisplay');
                const passiveEl = document.getElementById('passivePerceptionDisplay');
                if (sensesEl) sensesEl.textContent = 'Darkvision 60 ft';
                if (passiveEl) passiveEl.textContent = '17';

                // Hide beast abilities
                abilitiesDiv.style.display = 'none';

                // Restore normal skills
                restoreNormalSkills();

                // Re-enable spell casting
                updateSpellButtonsForWildShape(false);
            }
        }

        function updateSpellButtonsForWildShape(disabled) {
            // This will be called to enable/disable spell buttons during Wild Shape
            const castSpellButtons = document.querySelectorAll('.action-item');
            castSpellButtons.forEach(btn => {
                const text = btn.textContent || '';
                if (text.includes('Cast Spell')) {
                    if (disabled) {
                        btn.classList.add('disabled');
                        btn.style.opacity = '0.4';
                        btn.style.pointerEvents = 'none';
                    } else {
                        btn.classList.remove('disabled');
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                    }
                }
            });
        }

        // Ability descriptions for beasts, familiars, and companions
        const ABILITY_DESCRIPTIONS = {
            // Beast form abilities
            'Pack Tactics': 'You have advantage on attack rolls against a creature if at least one of your allies is within 5 feet of the creature and isn\'t incapacitated.',
            'Keen Smell': 'You have advantage on Wisdom (Perception) checks that rely on smell.',
            'Keen Hearing/Smell': 'You have advantage on Wisdom (Perception) checks that rely on hearing or smell.',
            'Keen Hearing/Sight': 'You have advantage on Wisdom (Perception) checks that rely on hearing or sight.',
            'Keen Sight': 'You have advantage on Wisdom (Perception) checks that rely on sight.',
            'Keen Hearing': 'You have advantage on Wisdom (Perception) checks that rely on hearing.',
            'Spider Climb': 'You can climb difficult surfaces, including upside down on ceilings, without needing to make an ability check.',
            'Web Sense': 'While in contact with a web, you know the exact location of any other creature in contact with the same web.',
            'Web Walker': 'You ignore movement restrictions caused by webbing.',
            'Pounce': 'If you move at least 20 feet straight toward a creature and hit it with a claw attack, the target must succeed on a DC 12 Strength save or be knocked prone. If prone, you can make one bite attack as a bonus action.',
            'Charge': 'If you move at least 20 feet straight toward a target and hit with a ram/tusk attack, the target takes extra damage and may be knocked prone.',
            'Relentless': 'If you take damage that would reduce you to 0 HP, you can use your reaction to drop to 1 HP instead. Usable once per short rest.',
            'Amphibious': 'You can breathe air and water.',
            'Standing Leap': 'Your long jump is up to 20 feet and high jump is up to 10 feet, with or without a running start.',
            'Blindsight': 'You can perceive your surroundings without relying on sight within a certain range.',
            'Hold Breath': 'You can hold your breath for 15 minutes.',
            'Sure-Footed': 'You have advantage on Strength and Dexterity saving throws made against effects that would knock you prone.',
            'Trampling Charge': 'If you move at least 20 feet straight toward a creature and hit it, the target must succeed on a DC 14 Strength save or be knocked prone. If prone, you can make a hooves attack as a bonus action.',
            // Familiar abilities
            'Flyby': 'Doesn\'t provoke opportunity attacks when flying out of enemy\'s reach.',
            'Mimicry': 'Can mimic simple sounds it has heard. A creature that hears the sounds can tell they are imitations with a DC 10 Wisdom (Insight) check.',
            'Echolocation': 'Can\'t use blindsight while deafened.',
            // Summon Beast abilities
            'Water Breathing': 'Can breathe underwater.',
            // Senses (for reference)
            'Darkvision 120 ft': 'Can see in dim light within 120 feet as if bright light, and darkness as dim light. Can\'t discern color in darkness.',
            'Darkvision 60 ft': 'Can see in dim light within 60 feet as if bright light, and darkness as dim light.',
            'Darkvision 30 ft': 'Can see in dim light within 30 feet as if bright light, and darkness as dim light.',
            'Blindsight 60 ft': 'Can perceive surroundings without relying on sight within 60 feet.'
        };

        // Keep old name for compatibility
        const BEAST_ABILITY_DESCRIPTIONS = ABILITY_DESCRIPTIONS;

        function formatBeastAbilities(beast) {
            let html = '';

            // Attacks
            html += `<div style="margin-bottom: 8px;"><strong>Attacks:</strong> ${beast.attacks}</div>`;

            // Speed details
            html += `<div style="margin-bottom: 8px;"><strong>Movement:</strong> ${beast.speed}</div>`;

            // Special abilities with descriptions
            html += '<div style="margin-bottom: 8px;"><strong>Special Abilities:</strong></div>';
            const abilities = beast.special.split(', ');
            abilities.forEach(ability => {
                const abilityName = ability.split(':')[0].split('(')[0].trim();
                const description = BEAST_ABILITY_DESCRIPTIONS[abilityName];
                if (description) {
                    html += `<div style="margin-left: 10px; margin-bottom: 5px;">
                        <strong style="color: var(--accent-gold);">${abilityName}:</strong> ${description}
                    </div>`;
                } else {
                    html += `<div style="margin-left: 10px; margin-bottom: 5px;">
                        <strong style="color: var(--accent-gold);">${ability}</strong>
                    </div>`;
                }
            });

            return html;
        }

        function updateSkillsForWildShape(beast) {
            // Create ability scores with beast's physical stats
            const wildShapeScores = {
                str: beast.str,
                dex: beast.dex,
                con: beast.con || 12,
                int: BASE_ABILITY_SCORES.int,  // Keep mental stats
                wis: BASE_ABILITY_SCORES.wis,
                cha: BASE_ABILITY_SCORES.cha
            };

            // Update all physical-based skills (STR and DEX)
            const physicalSkills = ['athletics', 'acrobatics', 'sleightOfHand', 'stealth'];

            physicalSkills.forEach(skillName => {
                const skill = SKILLS[skillName];
                if (!skill) return;

                const newMod = calculateSkillMod(skillName, wildShapeScores);
                const modEl = document.getElementById(skill.modId);
                const skillEl = document.getElementById(skill.id);

                if (modEl) modEl.textContent = formatMod(newMod);
                if (skillEl) skillEl.classList.add('wild-shape');
            });

            // Update passive perception to note beast's senses
            const passiveEl = document.getElementById('passivePerceptionDisplay');
            if (passiveEl) {
                const perceptionMod = calculateSkillMod('perception', wildShapeScores);
                passiveEl.textContent = (10 + perceptionMod) + ' (+ beast senses)';
            }
        }

        function restoreNormalSkills() {
            // Restore all physical-based skills using base ability scores
            const physicalSkills = ['athletics', 'acrobatics', 'sleightOfHand', 'stealth'];

            physicalSkills.forEach(skillName => {
                const skill = SKILLS[skillName];
                if (!skill) return;

                const normalMod = calculateSkillMod(skillName, BASE_ABILITY_SCORES);
                const modEl = document.getElementById(skill.modId);
                const skillEl = document.getElementById(skill.id);

                if (modEl) modEl.textContent = formatMod(normalMod);
                if (skillEl) skillEl.classList.remove('wild-shape');
            });

            // Restore passive perception
            const passiveEl = document.getElementById('passivePerceptionDisplay');
            if (passiveEl) {
                const perceptionMod = calculateSkillMod('perception', BASE_ABILITY_SCORES);
                passiveEl.textContent = '' + (10 + perceptionMod);
            }
        }

        // Update all skill displays based on current ability scores
        function updateAllSkillDisplays() {
            const currentScores = getCurrentAbilityScores();
            const isWildShape = state.activeForm && state.activeForm.type === 'wild-shape';

            Object.keys(SKILLS).forEach(skillName => {
                const skill = SKILLS[skillName];
                const mod = calculateSkillMod(skillName, currentScores);

                const modEl = document.getElementById(skill.modId);
                const skillEl = document.getElementById(skill.id);

                if (modEl) modEl.textContent = formatMod(mod);

                // Mark physical skills as wild-shape affected
                if (skillEl) {
                    if (isWildShape && (skill.ability === 'str' || skill.ability === 'dex')) {
                        skillEl.classList.add('wild-shape');
                    } else {
                        skillEl.classList.remove('wild-shape');
                    }
                }
            });

            // Update passive perception
            const passiveEl = document.getElementById('passivePerceptionDisplay');
            if (passiveEl) {
                const perceptionMod = calculateSkillMod('perception', currentScores);
                const passiveValue = 10 + perceptionMod;
                passiveEl.textContent = isWildShape ? passiveValue + ' (+ beast senses)' : '' + passiveValue;
            }
        }

        function updateAbilityScore(ability, score) {
            const mod = Math.floor((score - 10) / 2);
            const modStr = mod >= 0 ? '+' + mod : '' + mod;

            const scoreEl = document.getElementById(ability + 'Score');
            const modEl = document.getElementById(ability + 'Mod');
            const saveEl = document.getElementById(ability + 'Save');

            if (scoreEl) scoreEl.textContent = score;
            if (modEl) modEl.textContent = modStr;
            if (saveEl) saveEl.textContent = modStr;
        }

        function updateFormIndicator() {
            const indicator = document.getElementById('formIndicator');
            const archerAction = document.querySelector('.archer-action');

            if (state.activeForm) {
                indicator.classList.add('active');
                document.getElementById('formTitle').textContent = state.activeForm.name;

                let detailsText = state.activeForm.details;
                if (state.activeForm.type === 'wild-shape') {
                    const beast = BEAST_FORMS.find(b => b.id === state.activeForm.beastId);
                    if (beast) {
                        detailsText += ` | ${beast.special}`;
                        detailsText += ` | Cannot cast spells`;
                    }
                }
                document.getElementById('formDetails').textContent = detailsText;

                if (archerAction) {
                    archerAction.style.display = state.activeForm.showArcherAction ? 'block' : 'none';
                }
            } else {
                indicator.classList.remove('active');
                if (archerAction) archerAction.style.display = 'none';
            }
        }

        function endForm() {
            saveForUndo();
            if (state.inBattle && state.activeForm) addBattleLog(`Ended ${state.activeForm.name}`);

            // Clear form first
            state.activeForm = null;
            state.originalStats = null;

            // Restore all displays (AC, Speed, Ability Scores)
            updateFormIndicator();
            updateWildShapeDisplay();

            saveState();
        }

        // ===== BATTLE MODE =====
        function toggleBattle() {
            if (state.inBattle) {
                endBattle();
            } else {
                startBattle();
            }
        }

        function startBattle() {
            saveForUndo();
            state.inBattle = true;
            state.battleRound = 1;
            state.battleLog = [];
            state.actionsUsed = { action: false, bonus: false, reaction: false };
            addBattleLog('Combat started!');
            updateBattleUI();
            saveState();
        }

        function endBattle() {
            saveForUndo();
            if (state.battleLog.length > 0) {
                state.battleHistory.push({
                    date: new Date().toLocaleDateString(),
                    rounds: state.battleRound,
                    log: [...state.battleLog]
                });
                if (state.battleHistory.length > 3) state.battleHistory.shift();
            }
            state.inBattle = false;
            state.battleLog = [];
            updateBattleUI();
            saveState();
        }

        function nextRound() {
            saveForUndo();
            state.battleRound++;
            state.actionsUsed = { action: false, bonus: false, reaction: false };
            addBattleLog(`--- Round ${state.battleRound} ---`);
            updateBattleUI();
            saveState();
        }

        function addBattleLog(text) {
            state.battleLog.push({ time: new Date().toLocaleTimeString(), text });
            updateBattleLogDisplay();
        }

        function updateBattleLogDisplay() {
            const content = document.getElementById('battleLogContent');
            content.innerHTML = state.battleLog.slice(-10).map(l =>
                `<div class="battle-log-item"><span class="battle-log-time">${l.time}</span> ${l.text}</div>`
            ).join('');
        }

        function updateBattleUI() {
            const banner = document.getElementById('battleBanner');
            const log = document.getElementById('battleLog');
            const toggle = document.getElementById('battleToggle');

            banner.classList.toggle('active', state.inBattle);
            log.classList.toggle('active', state.inBattle);
            toggle.textContent = state.inBattle ? '🏳 End' : '⚔ Battle';
            document.getElementById('roundCount').textContent = state.battleRound;

            // Update action availability
            document.querySelectorAll('#actionList .action-item').forEach(el => {
                el.classList.toggle('disabled', state.inBattle && state.actionsUsed.action);
            });
            document.querySelectorAll('#bonusActionList .action-item').forEach(el => {
                el.classList.toggle('disabled', state.inBattle && state.actionsUsed.bonus);
            });
            document.querySelectorAll('#reactionList .action-item').forEach(el => {
                el.classList.toggle('disabled', state.inBattle && state.actionsUsed.reaction);
            });

            updateBattleLogDisplay();
        }

        function useAction(type, el) {
            if (state.inBattle) {
                if (state.actionsUsed[type]) return;
                saveForUndo();
                state.actionsUsed[type] = true;
                addBattleLog(`Used ${type}: ${el.textContent}`);
                updateBattleUI();
                saveState();
            }
        }

        // ===== RESTS =====
        function shortRest() {
            if (state.inBattle) return alert('Cannot rest during battle!');
            saveForUndo();
            state.resources.wildShape = 2;
            state.activeForm = null;
            state.originalStats = null;

            // Recharge magic items that recharge on short rest
            const recharged = rechargeItems('shortRest');

            updateFormIndicator();
            updateResourceSlots();
            updateWildShapeDisplay();
            updateItemChargesDisplay();
            saveState();

            // Build message
            let msg = 'Short rest complete! Wild Shape restored.';
            if (recharged.length > 0) {
                msg += '\n\nMagic items recharged:';
                recharged.forEach(r => {
                    msg += `\n• ${r.item}: +${r.gained} charges (${r.current}/${r.max})`;
                });
            }
            alert(msg);
        }

        function longRest() {
            if (state.inBattle) return alert('Cannot rest during battle!');
            saveForUndo();
            state.hp.current = state.hp.max;
            state.hp.temp = 0;
            Object.keys(state.slots).forEach(k => state.slots[k].fill(false));
            state.resources = { guidingBolt: 4, wildShape: 2, healingHands: 1, healingWordFree: 1, celestialRevelation: 1 };
            state.activeForm = null;
            state.originalStats = null;
            state.celestialForm = null;

            // Recharge magic items (both longRest and dawn items)
            const rechargedLR = rechargeItems('longRest');
            const rechargedDawn = rechargeItems('dawn');

            updateAllDisplays();
            saveState();

            // Build recharge message
            let msg = 'Long rest complete! All resources restored.';
            const allRecharged = [...rechargedLR, ...rechargedDawn];
            if (allRecharged.length > 0) {
                msg += '\n\nMagic items recharged:';
                allRecharged.forEach(r => {
                    msg += `\n• ${r.item}: +${r.gained} charges (${r.current}/${r.max})`;
                });
            }
            alert(msg);
        }

        // ===== NAVIGATION =====
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelector(`.nav-item[onclick="showSection('${id}')"]`).classList.add('active');
        }

        // ===== MODALS =====
        function showModal(title, body) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal(e) {
            if (!e || e.target === document.getElementById('modalOverlay')) {
                document.getElementById('modalOverlay').classList.remove('active');
            }
        }

        function showSpellInfo(spellId) {
            // Search cantrips first
            let spell = CANTRIPS.find(c => c.id === spellId);
            if (spell) {
                showModal(spell.name, `
                    <div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                        <p><strong style="color: var(--accent-purple);">${spell.school || 'Cantrip'}</strong> | ${spell.source}</p>
                        <p style="margin-top: 8px;"><strong>Casting Time:</strong> ${spell.time || 'Action'}</p>
                        <p><strong>Range:</strong> ${spell.range || 'Touch'}</p>
                        <p><strong>Components:</strong> ${spell.comp || 'V, S'}</p>
                        <p><strong>Duration:</strong> ${spell.dur || 'Instant'}</p>
                    </div>
                    <p style="line-height: 1.6;">${spell.desc}</p>
                `);
                return;
            }

            // Search leveled spells
            for (let level = 1; level <= 3; level++) {
                spell = SPELLS[level].find(s => s.id === spellId);
                if (spell) {
                    let content = `
                        <div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                            <p><strong style="color: var(--accent-purple);">${spell.school || ''}</strong> | Level ${level} ${spell.ritual ? '<span style="color: var(--accent-blue);">(Ritual)</span>' : ''}</p>
                            <p style="margin-top: 8px;"><strong>Casting Time:</strong> ${spell.time}</p>
                            <p><strong>Range:</strong> ${spell.range}</p>
                            <p><strong>Components:</strong> ${spell.comp || 'V, S'}</p>
                            <p><strong>Duration:</strong> ${spell.dur} ${spell.conc ? '<span style="color: var(--accent-orange);">(Concentration)</span>' : ''}</p>
                        </div>
                        <p style="line-height: 1.6;">${spell.desc}</p>
                    `;
                    if (spell.higher) {
                        content += `<p style="margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border-color); color: var(--accent-gold);"><strong>At Higher Levels:</strong> ${spell.higher}</p>`;
                    }
                    if (spell.note) {
                        content += `<p style="margin-top: 10px; color: var(--accent-green);"><strong>${spell.note}</strong></p>`;
                    }
                    showModal(spell.name, content);
                    return;
                }
            }

            showModal('Spell Not Found', '<p>Spell information not available.</p>');
        }

        // ===== NEW ACTION FUNCTIONS =====

        function openAttackSelection() {
            const inWildShape = state.activeForm && state.activeForm.type === 'wild-shape';
            let body = '<div class="form-options">';

            if (inWildShape) {
                const beast = BEAST_FORMS.find(b => b.id === state.activeForm.beastId);
                body += `
                    <div class="form-option" onclick="useAction('action', {textContent:'${beast.name} Attack'}); closeModal();">
                        <div class="form-option-title">${beast.name} Attack</div>
                        <div class="form-option-desc">${beast.attacks}</div>
                    </div>
                `;
            } else {
                // Get equipped weapons from inventory
                const equippedWeapons = state.inventory ? state.inventory.filter(item =>
                    item.type === 'weapon' && (item.equipped === 'mainHand' || item.equipped === 'twoHanded')
                ) : [];

                // Also get unequipped ranged weapons that can be drawn
                const rangedWeapons = state.inventory ? state.inventory.filter(item =>
                    item.type === 'weapon' && item.weaponType === 'ranged' && !item.equipped
                ) : [];

                body += '<div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 8px;">🗡️ Melee Weapons</div>';

                // Show equipped melee and melee/thrown weapons
                equippedWeapons.filter(w => w.weaponType === 'melee' || w.weaponType === 'melee/thrown').forEach(weapon => {
                    const attackInfo = getWeaponAttackInfo(weapon);
                    body += `
                        <div class="form-option" onclick="performWeaponAttack('${weapon.id}', 'melee'); closeModal();">
                            <div class="form-option-title">${weapon.name} ${weapon.isMagic ? '✦' : ''}</div>
                            <div class="form-option-desc">${attackInfo}</div>
                        </div>
                    `;
                });

                // If no melee weapon equipped, show unarmed
                if (equippedWeapons.filter(w => w.weaponType === 'melee' || w.weaponType === 'melee/thrown').length === 0) {
                    body += `
                        <div class="form-option" onclick="useAction('action', {textContent:'Unarmed Strike (+1, 1)'}); closeModal();">
                            <div class="form-option-title">Unarmed Strike</div>
                            <div class="form-option-desc">+1 to hit, 1 bludgeoning</div>
                        </div>
                    `;
                }

                body += '<hr style="border-color: var(--border-color); margin: 12px 0;">';
                body += '<div style="color: var(--accent-blue); font-weight: bold; margin-bottom: 8px;">🏹 Ranged & Thrown</div>';

                // Show equipped ranged weapons
                equippedWeapons.filter(w => w.weaponType === 'ranged').forEach(weapon => {
                    const attackInfo = getWeaponAttackInfo(weapon);
                    const ammoType = getAmmoTypeForWeapon(weapon);
                    const ammoCount = ammoType ? getAmmoCount(ammoType) : null;
                    const ammoText = ammoCount !== null ? ` <span style="color: ${ammoCount > 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">(${ammoCount} ${ammoType})</span>` : '';
                    const isDisabled = ammoCount === 0;
                    body += `
                        <div class="form-option ${isDisabled ? 'disabled' : ''}" onclick="${isDisabled ? '' : `performWeaponAttack('${weapon.id}', 'ranged'); closeModal();`}" style="${isDisabled ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            <div class="form-option-title">${weapon.name} ${weapon.isMagic ? '✦' : ''}${ammoText}</div>
                            <div class="form-option-desc">${attackInfo}</div>
                        </div>
                    `;
                });

                // Show equipped thrown and melee/thrown weapons as throw option
                equippedWeapons.filter(w => w.weaponType === 'thrown' || w.weaponType === 'melee/thrown').forEach(weapon => {
                    const attackInfo = getWeaponAttackInfo(weapon, true); // true = thrown attack
                    body += `
                        <div class="form-option" onclick="throwWeapon('${weapon.id}'); closeModal();" style="border-left: 3px solid var(--accent-orange);">
                            <div class="form-option-title">🎯 Throw ${weapon.name} ${weapon.isMagic ? '✦' : ''}</div>
                            <div class="form-option-desc">${attackInfo} (unequips weapon)</div>
                        </div>
                    `;
                });

                // Show unequipped ranged weapons (need to equip first)
                rangedWeapons.forEach(weapon => {
                    const ammoType = getAmmoTypeForWeapon(weapon);
                    const ammoCount = ammoType ? getAmmoCount(ammoType) : null;
                    body += `
                        <div class="form-option" onclick="equipAndAttack('${weapon.id}'); closeModal();" style="border-left: 2px solid var(--text-muted);">
                            <div class="form-option-title" style="color: var(--text-muted);">${weapon.name} (not equipped)</div>
                            <div class="form-option-desc">Click to equip and attack${ammoCount !== null ? ` (${ammoCount} ${ammoType})` : ''}</div>
                        </div>
                    `;
                });

                body += '<hr style="border-color: var(--border-color); margin: 12px 0;">';
                body += '<div style="color: var(--accent-purple); font-weight: bold; margin-bottom: 8px;">✨ Cantrips</div>';

                // Cantrip attacks
                body += `
                    <div class="form-option" onclick="useAction('action', {textContent:'Thorn Whip (+7, 2d6)'}); closeModal();">
                        <div class="form-option-title">Thorn Whip</div>
                        <div class="form-option-desc">+7 to hit, 30ft, 2d6 piercing, pull 10ft</div>
                    </div>
                    <div class="form-option" onclick="useAction('action', {textContent:'Produce Flame (+7, 2d8)'}); closeModal();">
                        <div class="form-option-title">Produce Flame</div>
                        <div class="form-option-desc">+7 to hit, 30ft, 2d8 fire</div>
                    </div>
                    <div class="form-option" onclick="useAction('action', {textContent:'Starry Wisp (+7, 2d8)'}); closeModal();">
                        <div class="form-option-title">Starry Wisp</div>
                        <div class="form-option-desc">+7 to hit, 60ft, 2d8 radiant</div>
                    </div>
                `;
            }
            body += '</div>';
            showModal('Choose Attack', body);
        }

        function getWeaponAttackInfo(weapon, asThrown = false) {
            // Calculate attack bonus and damage
            let attackBonus = 0;
            let damageMod = 0;
            const profBonus = PROFICIENCY_BONUS;

            // Determine which ability modifier to use
            // Thrown weapons can use STR or DEX (finesse-like)
            if (weapon.modifier === 'finesse' || asThrown) {
                // Use higher of STR or DEX
                const strMod = getAbilityMod(BASE_ABILITY_SCORES.str);
                const dexMod = getAbilityMod(BASE_ABILITY_SCORES.dex);
                damageMod = Math.max(strMod, dexMod);
            } else if (weapon.modifier === 'dex') {
                damageMod = getAbilityMod(BASE_ABILITY_SCORES.dex);
            } else {
                damageMod = getAbilityMod(BASE_ABILITY_SCORES.str);
            }

            attackBonus = profBonus + damageMod;

            // Add magic bonuses
            if (weapon.isMagic) {
                attackBonus += weapon.attackBonus || 0;
                damageMod += weapon.damageBonus || 0;
            }

            const attackStr = attackBonus >= 0 ? '+' + attackBonus : '' + attackBonus;
            const damageStr = damageMod >= 0 ? '+' + damageMod : '' + damageMod;
            // Show range for thrown attacks or ranged weapons
            const rangeStr = (asThrown || weapon.weaponType === 'ranged' || weapon.weaponType === 'thrown') && weapon.range
                ? `, ${weapon.range} ft` : '';

            return `${attackStr} to hit, ${weapon.damageDie}${damageStr} ${weapon.damageType}${rangeStr}`;
        }

        function performWeaponAttack(weaponId, attackType) {
            const weapon = state.inventory.find(w => w.id === weaponId);
            if (!weapon) return;

            // If ranged weapon with ammo requirement, use ammo
            if (weapon.weaponType === 'ranged' && weapon.properties && weapon.properties.includes('ammunition')) {
                const ammoType = getAmmoTypeForWeapon(weapon);
                if (ammoType && !useAmmo(ammoType, 1)) {
                    return; // Failed to use ammo
                }
            }

            const attackInfo = getWeaponAttackInfo(weapon);
            useAction('action', { textContent: `${weapon.name} Attack (${attackInfo})` });
        }

        function equipAndAttack(weaponId) {
            const weapon = state.inventory.find(w => w.id === weaponId);
            if (!weapon) return;

            // Equip the weapon
            saveForUndo();
            if (weapon.hands === 'two') {
                // Unequip anything in both hands
                state.inventory.forEach(item => {
                    if (item.equipped === 'mainHand' || item.equipped === 'offHand' || item.equipped === 'twoHanded') {
                        item.equipped = null;
                    }
                });
                weapon.equipped = 'twoHanded';
            } else {
                weapon.equipped = 'mainHand';
            }
            saveState();
            renderInventory();
            updateACFromEquipment();

            // Then attack
            performWeaponAttack(weaponId, weapon.weaponType);
        }

        function throwWeapon(weaponId) {
            const weapon = state.inventory.find(w => w.id === weaponId);
            if (!weapon) return;

            saveForUndo();

            // Perform the attack
            const attackInfo = getWeaponAttackInfo(weapon, true);
            useAction('action', { textContent: `Throw ${weapon.name} (${attackInfo})` });

            // Unequip the weapon
            weapon.equipped = null;

            // Add to thrown weapons list for reclaiming
            if (!state.thrownWeapons) state.thrownWeapons = [];
            if (!state.thrownWeapons.includes(weaponId)) {
                state.thrownWeapons.push(weaponId);
            }

            saveState();
            renderInventory();
            updateReclaimButton();
        }

        function reclaimWeapon(weaponId) {
            const weapon = state.inventory.find(w => w.id === weaponId);
            if (!weapon) return;

            saveForUndo();

            // Remove from thrown list
            if (state.thrownWeapons) {
                state.thrownWeapons = state.thrownWeapons.filter(id => id !== weaponId);
            }

            // Re-equip the weapon if hand is free
            const mainHand = state.inventory.find(i => i.equipped === 'mainHand');
            const twoHanded = state.inventory.find(i => i.equipped === 'twoHanded');

            if (!mainHand && !twoHanded) {
                weapon.equipped = 'mainHand';
            }
            // Otherwise it just goes back to inventory

            saveState();
            renderInventory();
            updateReclaimButton();
        }

        function reclaimAllWeapons() {
            if (!state.thrownWeapons || state.thrownWeapons.length === 0) return;

            saveForUndo();

            // Reclaim all thrown weapons
            const thrownIds = [...state.thrownWeapons];
            let equipped = false;

            thrownIds.forEach(weaponId => {
                const weapon = state.inventory.find(w => w.id === weaponId);
                if (weapon) {
                    // Only equip the first one if hands are free
                    if (!equipped) {
                        const mainHand = state.inventory.find(i => i.equipped === 'mainHand');
                        const twoHanded = state.inventory.find(i => i.equipped === 'twoHanded');
                        if (!mainHand && !twoHanded) {
                            weapon.equipped = 'mainHand';
                            equipped = true;
                        }
                    }
                }
            });

            state.thrownWeapons = [];
            saveState();
            renderInventory();
            updateReclaimButton();
        }

        function openReclaimSelection() {
            const thrownWeapons = state.thrownWeapons || [];
            if (thrownWeapons.length === 0) {
                showModal('No Thrown Weapons', '<div style="padding: 15px; text-align: center; color: var(--text-muted);">No thrown weapons to reclaim.</div>');
                return;
            }

            let body = '<div class="form-options">';

            // Reclaim section
            body += '<div style="color: var(--accent-green); font-weight: bold; margin-bottom: 8px;">↩️ Reclaim Weapons</div>';

            thrownWeapons.forEach(weaponId => {
                const weapon = state.inventory.find(w => w.id === weaponId);
                if (weapon) {
                    body += `
                        <div class="form-option" onclick="reclaimWeapon('${weapon.id}'); closeModal(); openReclaimSelection();" style="background: rgba(80,200,120,0.1);">
                            <div class="form-option-title">↩️ Reclaim ${weapon.name}</div>
                            <div class="form-option-desc">Pick up and re-equip (free object interaction)</div>
                        </div>
                    `;
                }
            });

            if (thrownWeapons.length > 1) {
                body += `
                    <div class="form-option" onclick="reclaimAllWeapons(); closeModal();" style="background: rgba(80,200,120,0.15);">
                        <div class="form-option-title">↩️ Reclaim All (${thrownWeapons.length})</div>
                        <div class="form-option-desc">Pick up all thrown weapons</div>
                    </div>
                `;
            }

            // Lost section
            body += '<hr style="border-color: var(--border-color); margin: 15px 0;">';
            body += '<div style="color: var(--accent-red); font-weight: bold; margin-bottom: 8px;">❌ Lost Weapons</div>';
            body += '<div style="color: var(--text-muted); font-size: 0.85em; margin-bottom: 10px;">Remove from inventory permanently</div>';

            thrownWeapons.forEach(weaponId => {
                const weapon = state.inventory.find(w => w.id === weaponId);
                if (weapon) {
                    body += `
                        <div class="form-option" onclick="lostWeapon('${weapon.id}'); closeModal(); openReclaimSelection();" style="background: rgba(220,53,69,0.1);">
                            <div class="form-option-title">❌ Lost ${weapon.name}</div>
                            <div class="form-option-desc">Remove from inventory</div>
                        </div>
                    `;
                }
            });

            if (thrownWeapons.length > 1) {
                body += `
                    <div class="form-option" onclick="lostAllWeapons(); closeModal();" style="background: rgba(220,53,69,0.15);">
                        <div class="form-option-title">❌ Lost All (${thrownWeapons.length})</div>
                        <div class="form-option-desc">Remove all thrown weapons from inventory</div>
                    </div>
                `;
            }

            body += '</div>';
            showModal('Reclaim Thrown Weapons', body);
        }

        function lostWeapon(weaponId) {
            const weaponIndex = state.inventory.findIndex(w => w.id === weaponId);
            if (weaponIndex === -1) return;

            saveForUndo();

            // Remove from thrown list
            if (state.thrownWeapons) {
                state.thrownWeapons = state.thrownWeapons.filter(id => id !== weaponId);
            }

            // Remove from inventory
            state.inventory.splice(weaponIndex, 1);

            saveState();
            renderInventory();
            updateReclaimButton();
        }

        function lostAllWeapons() {
            if (!state.thrownWeapons || state.thrownWeapons.length === 0) return;

            saveForUndo();

            // Remove all thrown weapons from inventory
            state.thrownWeapons.forEach(weaponId => {
                const weaponIndex = state.inventory.findIndex(w => w.id === weaponId);
                if (weaponIndex !== -1) {
                    state.inventory.splice(weaponIndex, 1);
                }
            });

            state.thrownWeapons = [];
            saveState();
            renderInventory();
            updateReclaimButton();
        }

        function updateReclaimButton() {
            const reclaimBtn = document.getElementById('reclaimBtn');
            if (reclaimBtn) {
                const thrownCount = (state.thrownWeapons || []).length;
                reclaimBtn.style.display = thrownCount > 0 ? 'block' : 'none';
                if (thrownCount > 0) {
                    reclaimBtn.textContent = `🔄 Reclaim Weapons (${thrownCount})`;
                }
            }
        }

        function openCastSpellSelection(actionType) {
            if (state.activeForm && state.activeForm.type === 'wild-shape') {
                alert('Cannot cast spells while in Wild Shape beast form!');
                return;
            }

            const timeFilter = actionType === 'action' ? 'Action' :
                              actionType === 'bonus' ? 'Bonus Action' : 'Reaction';
            let body = '<div class="form-options">';

            // Add cantrips matching the casting time
            const availableCantrips = CANTRIPS.filter(c => {
                if (actionType === 'action') return c.time === 'Action';
                if (actionType === 'bonus') return c.time === 'Bonus Action';
                return false;
            });

            if (availableCantrips.length > 0) {
                body += '<div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 8px;">Cantrips (No Slot)</div>';
                availableCantrips.forEach(cantrip => {
                    const damage = getScaledCantripDamage(cantrip);
                    body += `
                        <div class="form-option" onclick="castCantrip('${cantrip.id}', '${actionType}')">
                            <div class="form-option-title">${cantrip.name}</div>
                            <div class="form-option-desc">${cantrip.range}${damage ? ' | ' + damage : ''}</div>
                        </div>
                    `;
                });
                body += '<hr style="border-color: var(--border-color); margin: 12px 0;">';
            }

            // Filter prepared spells by casting time
            const availableSpells = [];

            // Always prepared spells with free uses
            if (actionType === 'action') {
                // Guiding Bolt - always prepared from Star Map
                const gb = SPELLS[1].find(s => s.id === 'guiding-bolt');
                if (gb) availableSpells.push({ ...gb, level: 1, hasFree: true, freeResource: 'guidingBolt', freeMax: 4 });
            }

            if (actionType === 'bonus') {
                // Healing Word - always prepared from Magic Initiate
                const hw = SPELLS[1].find(s => s.id === 'healing-word');
                if (hw) availableSpells.push({ ...hw, level: 1, hasFree: true, freeResource: 'healingWordFree', freeMax: 1 });
            }

            // Check other prepared spells
            state.preparedSpells.forEach(prep => {
                // Skip if already added as always-prepared
                if (prep.id === 'guiding-bolt' || prep.id === 'healing-word') return;

                for (let level = 1; level <= 3; level++) {
                    const spell = SPELLS[level].find(s => s.id === prep.id);
                    if (spell && spell.time === timeFilter) {
                        availableSpells.push({ ...spell, level });
                    }
                }
            });

            if (availableSpells.length > 0) {
                body += '<div style="color: var(--accent-purple); font-weight: bold; margin-bottom: 8px;">Leveled Spells</div>';
                availableSpells.forEach(spell => {
                    const dmgPreview = getSpellDamagePreview(spell, spell.level);
                    const freeIndicator = spell.hasFree ? ` <span style="color: var(--accent-green);">(${state.resources[spell.freeResource]}/${spell.freeMax} free)</span>` : '';
                    body += `
                        <div class="form-option" onclick="openSpellCastOptions('${spell.id}', ${spell.level}, '${actionType}', ${spell.hasFree || false}, '${spell.freeResource || ''}')">
                            <div class="form-option-title">${spell.name}${freeIndicator}</div>
                            <div class="form-option-desc">${spell.range} | ${spell.dur}${spell.conc ? ' <span style="color:var(--accent-orange)">(C)</span>' : ''}${dmgPreview ? ' | ' + dmgPreview : ''}</div>
                        </div>
                    `;
                });
            } else if (availableCantrips.length === 0) {
                body += '<p class="text-muted">No prepared spells with this casting time.</p>';
            }

            // Add Item Spells section
            const itemSpells = getItemSpellsForCasting(actionType);
            if (itemSpells.length > 0) {
                body += '<hr style="border-color: var(--border-color); margin: 12px 0;">';
                body += '<div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 8px;">✦ Item Spells</div>';
                itemSpells.forEach(is => {
                    let statusText = '';
                    let isDisabled = false;
                    if (is.type === 'charges') {
                        const charges = state.itemCharges[is.itemId];
                        const canCast = charges && charges.current >= is.cost;
                        statusText = `${is.cost} charge${is.cost > 1 ? 's' : ''} (${charges ? charges.current : 0} left)`;
                        isDisabled = !canCast;
                    } else if (is.type === 'spell') {
                        const usageKey = `${is.itemId}_${is.spellName}`;
                        const used = state.itemSpellsUsed[usageKey];
                        statusText = is.usage === 'atWill' ? 'At Will' : (used ? 'Used today' : is.usage);
                        isDisabled = used && is.usage !== 'atWill';
                    }
                    body += `
                        <div class="form-option ${isDisabled ? 'disabled' : ''}" onclick="${isDisabled ? '' : `castItemSpellFromMenu('${is.itemId}', '${is.spellName}', '${is.type}', ${is.cost || 0}, '${is.usage || ''}')`}" style="${isDisabled ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            <div class="form-option-title">${is.spellName} <span style="color: var(--text-muted); font-size: 0.85em;">(${is.itemName})</span></div>
                            <div class="form-option-desc" style="color: ${isDisabled ? 'var(--accent-red)' : 'var(--accent-gold)'};">${statusText}</div>
                        </div>
                    `;
                });
            }

            body += '</div>';
            showModal(`Cast Spell (${timeFilter})`, body);
        }

        function getScaledCantripDamage(cantrip) {
            // At level 5, cantrips scale to 2 dice
            const damageCantrips = {
                'starry-wisp': '2d8 radiant',
                'thorn-whip': '2d6 piercing',
                'produce-flame': '2d8 fire'
            };
            return damageCantrips[cantrip.id] || '';
        }

        function getItemSpellsForCasting(actionType) {
            // Collect all spells from magic items
            const itemSpells = [];

            state.inventory.forEach(item => {
                if (!item.effects) return;

                // Spells from charge-based items
                const chargesEffect = item.effects.find(e => e.type === 'charges');
                if (chargesEffect && chargesEffect.spells) {
                    chargesEffect.spells.forEach(spell => {
                        itemSpells.push({
                            type: 'charges',
                            itemId: item.id,
                            itemName: item.name,
                            spellName: spell.name,
                            spellLevel: spell.level,
                            cost: spell.cost
                        });
                    });
                }

                // Spells granted by items (spell effect type)
                item.effects.filter(e => e.type === 'spell').forEach(effect => {
                    itemSpells.push({
                        type: 'spell',
                        itemId: item.id,
                        itemName: item.name,
                        spellName: effect.spell,
                        spellLevel: effect.spellLevel,
                        usage: effect.usage
                    });
                });
            });

            return itemSpells;
        }

        function castItemSpellFromMenu(itemId, spellName, spellType, cost, usage) {
            if (spellType === 'charges') {
                if (castItemSpell(itemId, spellName, cost)) {
                    closeModal();
                    if (state.inBattle) {
                        useAction('action');
                    }
                }
            } else if (spellType === 'spell') {
                if (castItemGrantedSpell(itemId, spellName, usage)) {
                    closeModal();
                    if (state.inBattle) {
                        useAction('action');
                    }
                }
            }
        }

        function getSpellDamagePreview(spell, slotLevel) {
            const previews = {
                'guiding-bolt': { base: 4, perLevel: 1, type: 'd6 radiant' },
                'cure-wounds': { base: 2, perLevel: 2, type: 'd8+4 healing', isHealing: true },
                'healing-word': { base: 2, perLevel: 2, type: 'd4+4 healing', isHealing: true },
                'thunderwave': { base: 2, perLevel: 1, type: 'd8 thunder' },
                'absorb-elements': { base: 1, perLevel: 1, type: 'd6 (extra)' },
                'moonbeam': { base: 2, perLevel: 1, type: 'd10 radiant', baseLevel: 2 },
                'heat-metal': { base: 2, perLevel: 1, type: 'd8 fire', baseLevel: 2 },
                'call-lightning': { base: 3, perLevel: 1, type: 'd10 lightning', baseLevel: 3 },
                'conjure-animals': { base: 0, perLevel: 10, type: ' HP', isHP: true, baseLevel: 3 }
            };
            const p = previews[spell.id];
            if (!p) return '';
            const baseLevel = p.baseLevel || 1;
            const dice = p.base + (slotLevel - baseLevel) * p.perLevel;
            if (p.isHP) return `+${(slotLevel - baseLevel) * p.perLevel}${p.type}`;
            return `${dice}${p.type}`;
        }

        function castCantrip(cantripId, actionType) {
            const cantrip = CANTRIPS.find(c => c.id === cantripId);
            if (state.inBattle) {
                state.actionsUsed[actionType] = true;
                addBattleLog(`Cast ${cantrip.name} (cantrip)`);
            }
            closeModal();
            updateBattleUI();
            saveState();
        }

        function openSpellCastOptions(spellId, baseLevel, actionType, hasFree, freeResource) {
            // Find the spell
            let spell = null;
            for (let level = 1; level <= 3; level++) {
                spell = SPELLS[level].find(s => s.id === spellId);
                if (spell) break;
            }
            if (!spell) return;

            let body = '<div class="form-options">';
            body += `<p class="text-muted" style="margin-bottom:12px;"><strong>${spell.name}</strong> - Choose how to cast:</p>`;

            // Concentration warning
            if (spell.conc && state.concentration) {
                body += `<div style="background: rgba(255,140,0,0.15); border: 1px solid var(--accent-orange); padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                    <strong style="color: var(--accent-orange);">Concentration Warning</strong><br>
                    <span style="font-size: 0.9em;">Currently concentrating on <strong>${state.concentration.spellName}</strong>. Casting this will end it.</span>
                </div>`;
            }

            // Free option (if available)
            if (hasFree && state.resources[freeResource] > 0) {
                const freeMax = freeResource === 'guidingBolt' ? 4 : 1;
                const dmg = getSpellDamagePreview(spell, 1);
                body += `
                    <div class="form-option" style="border-color: var(--accent-green);" onclick="castSpellFree('${spellId}', '${freeResource}', '${actionType}')">
                        <div class="form-option-title" style="color: var(--accent-green);">Free Cast (${state.resources[freeResource]}/${freeMax} remaining)</div>
                        <div class="form-option-desc">1st level effect${dmg ? ' | ' + dmg : ''}</div>
                    </div>
                `;
            } else if (hasFree) {
                body += `<div class="form-option" style="opacity: 0.5; pointer-events: none;">
                    <div class="form-option-title">Free Cast (0 remaining)</div>
                    <div class="form-option-desc">No free uses left today</div>
                </div>`;
            }

            // Slot options
            for (let l = baseLevel; l <= 3; l++) {
                const available = state.slots[l].filter(used => !used).length;
                const dmg = getSpellDamagePreview(spell, l);
                const isUpcast = l > baseLevel;

                if (available > 0) {
                    body += `
                        <div class="form-option" onclick="castSpellWithSlot('${spellId}', ${l}, '${actionType}')">
                            <div class="form-option-title">${l}${getOrdinal(l)} Level Slot${isUpcast ? ' (Upcast)' : ''}</div>
                            <div class="form-option-desc">${available} slot${available > 1 ? 's' : ''} remaining${dmg ? ' | ' + dmg : ''}</div>
                        </div>
                    `;
                } else {
                    body += `<div class="form-option" style="opacity: 0.5; pointer-events: none;">
                        <div class="form-option-title">${l}${getOrdinal(l)} Level Slot${isUpcast ? ' (Upcast)' : ''}</div>
                        <div class="form-option-desc">No slots remaining</div>
                    </div>`;
                }
            }

            body += '</div>';
            showModal(`Cast ${spell.name}`, body);
        }

        function castSpellFree(spellId, freeResource, actionType) {
            if (state.resources[freeResource] <= 0) {
                alert('No free uses remaining!');
                return;
            }

            // Find the spell for logging and concentration
            let spell = null;
            for (let level = 1; level <= 3; level++) {
                spell = SPELLS[level].find(s => s.id === spellId);
                if (spell) break;
            }

            saveForUndo();
            state.resources[freeResource]--;

            // Handle concentration
            if (spell && spell.conc) {
                if (state.concentration) {
                    addBattleLog(`Ended concentration on ${state.concentration.spellName}`);
                }
                state.concentration = { spellId, spellName: spell.name, slotLevel: 1 };
                updateConcentrationDisplay();
            }

            // Handle summon spells
            if (spellId === 'summon-beast') {
                closeModal();
                openSummonBeastSelection(1);
                return;
            }

            if (state.inBattle) {
                state.actionsUsed[actionType] = true;
                addBattleLog(`Cast ${spell ? spell.name : spellId} (free)`);
            }

            closeModal();
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        function castSpellWithSlot(spellId, slotLevel, actionType) {
            // Find the spell
            let spell = null;
            for (let level = 1; level <= 3; level++) {
                spell = SPELLS[level].find(s => s.id === spellId);
                if (spell) break;
            }

            // Use the slot
            const slotIndex = state.slots[slotLevel].findIndex(used => !used);
            if (slotIndex === -1) {
                alert('No spell slots available at this level!');
                return;
            }

            saveForUndo();
            state.slots[slotLevel][slotIndex] = true;

            // Handle concentration
            if (spell && spell.conc) {
                if (state.concentration) {
                    addBattleLog(`Ended concentration on ${state.concentration.spellName}`);
                }
                state.concentration = { spellId, spellName: spell.name, slotLevel };
                updateConcentrationDisplay();
            }

            // Handle summon spells
            if (spellId === 'summon-beast') {
                closeModal();
                openSummonBeastSelection(slotLevel);
                updateSlotsDisplay();
                saveState();
                return;
            }

            if (state.inBattle) {
                state.actionsUsed[actionType] = true;
                addBattleLog(`Cast ${spell ? spell.name : spellId} using ${slotLevel}${getOrdinal(slotLevel)} level slot`);
            }

            closeModal();
            updateSlotsDisplay();
            updateBattleUI();
            saveState();
        }

        function openUpcastSelection(spellId, baseLevel, actionType) {
            // Redirect to new unified function
            openSpellCastOptions(spellId, baseLevel, actionType, false, '');
        }

        function castSpell(spellId, slotLevel, actionType, spellOverride) {
            // Find the spell
            let spell = spellOverride;
            if (!spell) {
                for (let level = 1; level <= 3; level++) {
                    spell = SPELLS[level].find(s => s.id === spellId);
                    if (spell) break;
                }
            }

            saveForUndo();

            // Use the specified slot level
            const slotIndex = state.slots[slotLevel].findIndex(used => !used);
            if (slotIndex === -1) {
                alert('No spell slots available at this level!');
                return;
            }

            state.slots[slotLevel][slotIndex] = true;

            // Handle concentration
            if (spell && spell.conc) {
                if (state.concentration) {
                    addBattleLog(`Ended concentration on ${state.concentration.spellName}`);
                }
                state.concentration = { spellId, spellName: spell.name, slotLevel };
                updateConcentrationDisplay();
            }

            // Handle summoning spells (Find Familiar via Wild Companion or Summon Beast)
            if (spellId === 'find-familiar') {
                summonFamiliar();
            } else if (spellId === 'summon-beast') {
                openSummonBeastSelection(slotLevel);
            }

            if (state.inBattle) {
                state.actionsUsed[actionType] = true;
                addBattleLog(`Cast ${spell ? spell.name : spellId} using ${slotLevel}${getOrdinal(slotLevel)} level slot`);
            }

            closeModal();
            updateSlotsDisplay();
            updateBattleUI();
            saveState();
        }

        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        function useGuidingBoltFree() {
            if (state.resources.guidingBolt <= 0) {
                alert('No free Guiding Bolt uses remaining! Use a spell slot instead.');
                return;
            }
            saveForUndo();
            state.resources.guidingBolt--;
            if (state.inBattle) {
                state.actionsUsed.action = true;
                addBattleLog('Cast Guiding Bolt (free from Star Map)');
            }
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        function useHealingWordFree() {
            if (state.resources.healingWordFree <= 0) {
                alert('Free Healing Word already used today! Use a spell slot instead.');
                return;
            }
            saveForUndo();
            state.resources.healingWordFree--;
            if (state.inBattle) {
                state.actionsUsed.bonus = true;
                addBattleLog('Cast Healing Word (free from Magic Initiate)');
            }
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        function openHealingHands() {
            if (state.resources.healingHands <= 0) {
                alert('Healing Hands already used today!');
                return;
            }
            showModal('Healing Hands', `
                <p><strong>Action</strong> | Touch | 1/Long Rest</p>
                <p style="margin-top: 10px;">Touch a creature and roll <strong>3d4</strong>. The creature regains HP equal to the total.</p>
                <button class="add-item-btn" style="width:100%; margin-top:15px;" onclick="useHealingHands()">Use Healing Hands</button>
            `);
        }

        function useHealingHands() {
            saveForUndo();
            state.resources.healingHands--;
            if (state.inBattle) {
                state.actionsUsed.action = true;
                addBattleLog('Used Healing Hands (3d4 healing)');
            }
            closeModal();
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        function openCelestialRevelation() {
            if (state.resources.celestialRevelation <= 0) {
                alert('Celestial Revelation already used today!');
                return;
            }
            showModal('Celestial Revelation', `
                <p><strong>Bonus Action</strong> | 1 minute | 1/Long Rest</p>
                <div class="form-options" style="margin-top:15px;">
                    <div class="form-option" onclick="useCelestialRevelation('radiant-soul')">
                        <div class="form-option-title">Radiant Soul</div>
                        <div class="form-option-desc">Spectral wings (fly 30ft), +3 radiant damage once/turn</div>
                    </div>
                    <div class="form-option" onclick="useCelestialRevelation('necrotic-shroud')">
                        <div class="form-option-title">Necrotic Shroud</div>
                        <div class="form-option-desc">Frighten enemies within 10ft (Cha save), +3 necrotic damage once/turn</div>
                    </div>
                    <div class="form-option" onclick="useCelestialRevelation('inner-radiance')">
                        <div class="form-option-title">Inner Radiance</div>
                        <div class="form-option-desc">Bright light 10ft, creatures ending turn within 10ft take 3 radiant</div>
                    </div>
                </div>
            `);
        }

        function useCelestialRevelation(form) {
            saveForUndo();
            state.resources.celestialRevelation--;
            state.celestialForm = form;
            if (state.inBattle) {
                state.actionsUsed.bonus = true;
                addBattleLog(`Activated Celestial Revelation: ${form}`);
            }
            closeModal();
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        // ===== WILD COMPANION =====
        function openWildCompanion() {
            if (state.activeForm && state.activeForm.type === 'wild-shape') {
                alert('Cannot use Wild Companion while in Wild Shape beast form!');
                return;
            }

            let body = '<div class="form-options">';
            body += '<p class="text-muted" style="margin-bottom:12px;"><strong>Wild Companion (Level 2)</strong><br>Cast Find Familiar without material components. Choose resource:</p>';

            // Check if Wild Shape uses available
            const hasWildShape = state.resources.wildShape > 0;
            // Check for available spell slots
            const hasSlots = Object.values(state.slots).some(slots => slots.some(used => !used));

            if (hasWildShape) {
                body += `
                    <div class="form-option" onclick="useWildCompanion('wildshape')">
                        <div class="form-option-title">🐾 Use Wild Shape</div>
                        <div class="form-option-desc">${state.resources.wildShape}/2 uses remaining</div>
                    </div>
                `;
            }

            if (hasSlots) {
                for (let l = 1; l <= 3; l++) {
                    const available = state.slots[l].filter(used => !used).length;
                    if (available > 0) {
                        body += `
                            <div class="form-option" onclick="useWildCompanion('slot', ${l})">
                                <div class="form-option-title">✨ Use ${l}${getOrdinal(l)} Level Slot</div>
                                <div class="form-option-desc">${available} slot${available > 1 ? 's' : ''} remaining</div>
                            </div>
                        `;
                    }
                }
            }

            if (!hasWildShape && !hasSlots) {
                body += '<p class="text-muted">No Wild Shape uses or spell slots available!</p>';
            }

            body += '</div>';
            showModal('Wild Companion', body);
        }

        function useWildCompanion(resourceType, slotLevel) {
            saveForUndo();

            if (resourceType === 'wildshape') {
                state.resources.wildShape--;
                updateResourceSlots();
            } else {
                const slotIndex = state.slots[slotLevel].findIndex(used => !used);
                state.slots[slotLevel][slotIndex] = true;
                updateSlotsDisplay();
            }

            if (state.inBattle) {
                state.actionsUsed.action = true;
                addBattleLog(`Used Wild Companion (Find Familiar) via ${resourceType === 'wildshape' ? 'Wild Shape' : slotLevel + getOrdinal(slotLevel) + ' slot'}`);
            }

            closeModal();
            summonFamiliar();
            updateBattleUI();
            saveState();
        }

        // ===== COMPANION TRACKING =====
        const FAMILIAR_FORMS = [
            { id: 'owl', name: 'Owl', ac: 11, hp: 1, speed: '5 ft, fly 60 ft', abilities: 'Flyby, Keen Hearing/Sight, Darkvision 120 ft' },
            { id: 'cat', name: 'Cat', ac: 12, hp: 2, speed: '40 ft, climb 30 ft', abilities: 'Keen Smell, Darkvision 60 ft' },
            { id: 'hawk', name: 'Hawk', ac: 13, hp: 1, speed: '10 ft, fly 60 ft', abilities: 'Keen Sight' },
            { id: 'raven', name: 'Raven', ac: 12, hp: 1, speed: '10 ft, fly 50 ft', abilities: 'Mimicry' },
            { id: 'spider', name: 'Spider', ac: 12, hp: 1, speed: '20 ft, climb 20 ft', abilities: 'Spider Climb, Web Sense, Darkvision 30 ft' },
            { id: 'frog', name: 'Frog', ac: 11, hp: 1, speed: '20 ft, swim 20 ft', abilities: 'Amphibious, Standing Leap, Darkvision 30 ft' },
            { id: 'bat', name: 'Bat', ac: 12, hp: 1, speed: '5 ft, fly 30 ft', abilities: 'Echolocation, Keen Hearing, Blindsight 60 ft' },
            { id: 'rat', name: 'Rat', ac: 10, hp: 1, speed: '20 ft', abilities: 'Keen Smell, Darkvision 30 ft' }
        ];

        const BESTIAL_SPIRIT = {
            air: { name: 'Air Spirit', speed: '30 ft, fly 60 ft', ability: 'Flyby: Doesn\'t provoke opportunity attacks when flying out of reach.' },
            land: { name: 'Land Spirit', speed: '30 ft, climb 30 ft', ability: 'Pack Tactics: Advantage if ally within 5 ft of target.' },
            water: { name: 'Water Spirit', speed: '30 ft, swim 30 ft', ability: 'Water Breathing, Pack Tactics.' }
        };

        function summonFamiliar() {
            let body = '<div class="form-options">';
            body += '<p class="text-muted" style="margin-bottom:12px;">Choose your familiar form (Fey, not Beast):</p>';

            FAMILIAR_FORMS.forEach(f => {
                body += `
                    <div class="form-option" onclick="createFamiliar('${f.id}')">
                        <div class="form-option-title">${f.name}</div>
                        <div class="form-option-desc">AC ${f.ac} | HP ${f.hp} | ${f.speed}</div>
                        <div class="form-option-desc" style="font-size:0.8em; margin-top:4px;">${f.abilities}</div>
                    </div>
                `;
            });

            body += '</div>';
            showModal('Choose Familiar Form', body);
        }

        function createFamiliar(formId) {
            const form = FAMILIAR_FORMS.find(f => f.id === formId);
            if (!form) return;

            // Remove existing familiar if any (can only have one familiar)
            state.companions = state.companions.filter(c => c.type !== 'familiar');

            // Add new familiar
            state.companions.push({
                id: 'familiar-' + Date.now(),
                type: 'familiar',
                name: form.name + ' (Familiar)',
                formId: formId,
                hp: { current: form.hp, max: form.hp },
                ac: form.ac,
                speed: form.speed,
                abilities: form.abilities
            });

            closeModal();
            updateCompanionDisplay();
            saveState();

            showModal('Familiar Summoned!', `
                <p>Your <strong>${form.name}</strong> familiar appears!</p>
                <p style="margin-top:10px; font-size:0.9em;">It is a <strong>Fey</strong> (not Beast) and will disappear after your next Long Rest.</p>
                <p style="margin-top:10px; font-size:0.9em;"><strong>Abilities:</strong> ${form.abilities}</p>
            `);
        }

        function openSummonBeastSelection(slotLevel) {
            let body = '<div class="form-options">';
            body += '<p class="text-muted" style="margin-bottom:12px;">Choose environment for your Bestial Spirit:</p>';

            const hp = 20 + 5 * (slotLevel - 2);
            const ac = 11 + slotLevel;
            const attackMod = 3 + slotLevel;
            const damage = `1d8+${2 + slotLevel}`;

            Object.entries(BESTIAL_SPIRIT).forEach(([env, spirit]) => {
                body += `
                    <div class="form-option" onclick="createBestialSpirit('${env}', ${slotLevel})">
                        <div class="form-option-title">${spirit.name} (${env.charAt(0).toUpperCase() + env.slice(1)})</div>
                        <div class="form-option-desc">AC ${ac} | HP ${hp} | ${spirit.speed}</div>
                        <div class="form-option-desc" style="margin-top:4px;">Attack: +${attackMod} to hit, ${damage} damage</div>
                        <div class="form-option-desc" style="font-size:0.8em; margin-top:4px;">${spirit.ability}</div>
                    </div>
                `;
            });

            body += '</div>';
            showModal('Summon Beast - Choose Environment', body);
        }

        function createBestialSpirit(environment, slotLevel) {
            const spirit = BESTIAL_SPIRIT[environment];
            const hp = 20 + 5 * (slotLevel - 2);
            const ac = 11 + slotLevel;

            // Remove existing beast if any (Summon Beast requires concentration, so only one)
            state.companions = state.companions.filter(c => c.type !== 'beast');

            // Add new beast companion
            state.companions.push({
                id: 'beast-' + Date.now(),
                type: 'beast',
                name: spirit.name,
                environment: environment,
                slotLevel: slotLevel,
                hp: { current: hp, max: hp },
                ac: ac,
                speed: spirit.speed,
                abilities: spirit.ability,
                attackMod: 3 + slotLevel,
                damage: `1d8+${2 + slotLevel}`
            });

            closeModal();
            updateCompanionDisplay();
            saveState();
        }

        function updateCompanionDisplay() {
            let companionSection = document.getElementById('companionSection');

            // Handle legacy state (single companion) to array conversion
            if (state.companion && !state.companions) {
                state.companions = [state.companion];
                delete state.companion;
            }
            if (!state.companions) state.companions = [];

            if (state.companions.length === 0) {
                if (companionSection) companionSection.style.display = 'none';
                return;
            }

            if (!companionSection) {
                // Create companion section dynamically in the HP section
                const hpSection = document.querySelector('.hp-section');
                companionSection = document.createElement('div');
                companionSection.id = 'companionSection';
                companionSection.className = 'companion-section';
                hpSection.appendChild(companionSection);
            }

            // Build HTML for all companions
            let html = '';
            state.companions.forEach((c, index) => {
                const borderColor = c.type === 'familiar' ? 'var(--accent-blue)' : 'var(--accent-purple)';
                const bgColor = c.type === 'familiar' ? 'rgba(74,144,217,0.1)' : 'rgba(123,104,238,0.1)';
                html += `
                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 12px; margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: ${borderColor};">${c.type === 'familiar' ? '🦉' : '🐾'} ${c.name}</strong>
                            <button onclick="dismissCompanion('${c.id}')" style="background: var(--accent-red); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">Dismiss</button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 0.85em; margin-bottom: 8px;">
                            <div><strong>AC:</strong> ${c.ac}</div>
                            <div><strong>Speed:</strong> ${c.speed}</div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <strong>HP:</strong>
                                <input type="number" value="${c.hp.current}" min="0" max="${c.hp.max}" style="width: 40px; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; padding: 2px 4px;" onchange="updateCompanionHP('${c.id}', this.value)">
                                <span>/ ${c.hp.max}</span>
                            </div>
                        </div>
                        ${c.type === 'beast' ? `<div style="font-size: 0.85em; margin-bottom: 5px;"><strong>Attack:</strong> +${c.attackMod} to hit, ${c.damage} damage</div>` : ''}
                        <div style="font-size: 0.8em; margin-top: 8px;">
                            <strong>Abilities:</strong>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px;">
                                ${formatCompanionAbilities(c.abilities)}
                            </div>
                        </div>
                    </div>
                `;
            });

            companionSection.style.display = 'block';
            companionSection.innerHTML = html;
        }

        function formatCompanionAbilities(abilitiesString) {
            // Parse abilities (comma or period separated)
            const abilities = abilitiesString.split(/[,.]/).map(a => a.trim()).filter(a => a.length > 0);
            let html = '';

            abilities.forEach(ability => {
                // Extract ability name (before colon if present)
                const abilityName = ability.split(':')[0].trim();
                const hasDescription = ABILITY_DESCRIPTIONS[abilityName];

                if (hasDescription) {
                    const escapedName = abilityName.replace(/'/g, "\\'");
                    html += `<span onclick="showAbilityDescription('${escapedName}')" style="background: rgba(123,104,238,0.2); border: 1px solid var(--accent-purple); padding: 3px 8px; border-radius: 12px; cursor: pointer; color: var(--accent-purple); font-size: 0.85em;">${abilityName}</span>`;
                } else {
                    // Just display the full text for abilities without descriptions
                    html += `<span style="background: rgba(100,100,100,0.2); border: 1px solid var(--border-color); padding: 3px 8px; border-radius: 12px; color: var(--text-secondary); font-size: 0.85em;">${ability}</span>`;
                }
            });

            return html;
        }

        function showAbilityDescription(abilityName) {
            const description = ABILITY_DESCRIPTIONS[abilityName];
            if (description) {
                showModal(abilityName, `<p style="font-size: 1em; line-height: 1.5;">${description}</p>`);
            }
        }

        function updateCompanionHP(companionId, value) {
            if (!state.companions) return;
            const companion = state.companions.find(c => c.id === companionId);
            if (!companion) return;

            const hp = parseInt(value) || 0;
            companion.hp.current = Math.max(0, Math.min(hp, companion.hp.max));

            if (companion.hp.current <= 0) {
                if (state.inBattle) addBattleLog(`${companion.name} dropped to 0 HP and disappeared!`);
                state.companions = state.companions.filter(c => c.id !== companionId);
                updateCompanionDisplay();
            }
            saveState();
        }

        function dismissCompanion(companionId) {
            if (!state.companions) return;
            const companion = state.companions.find(c => c.id === companionId);
            if (!companion) return;

            if (confirm(`Dismiss your ${companion.name}?`)) {
                if (state.inBattle) addBattleLog(`Dismissed ${companion.name}`);
                state.companions = state.companions.filter(c => c.id !== companionId);
                updateCompanionDisplay();
                saveState();
            }
        }

        // ===== CONCENTRATION TRACKING =====
        function updateConcentrationDisplay() {
            let concSection = document.getElementById('concentrationSection');

            if (!state.concentration) {
                if (concSection) concSection.style.display = 'none';
                return;
            }

            if (!concSection) {
                // Create concentration section dynamically in the HP section
                const hpSection = document.querySelector('.hp-section');
                concSection = document.createElement('div');
                concSection.id = 'concentrationSection';
                // Insert before companion section if it exists
                const companionSection = document.getElementById('companionSection');
                if (companionSection) {
                    hpSection.insertBefore(concSection, companionSection);
                } else {
                    hpSection.appendChild(concSection);
                }
            }

            concSection.style.display = 'block';
            concSection.innerHTML = `
                <div style="background: rgba(255,140,0,0.15); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 12px; margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--accent-orange);">🎯 Concentrating:</strong> ${state.concentration.spellName}
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="promptConcentrationSave()" style="background: var(--accent-blue); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">Save</button>
                            <button onclick="endConcentration()" style="background: var(--accent-red); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">End</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function promptConcentrationSave() {
            showModal('Concentration Save', `
                <p style="margin-bottom: 15px;">When you take damage, make a Constitution saving throw to maintain concentration.</p>
                <p style="margin-bottom: 10px;"><strong>DC:</strong> 10 or half damage taken (whichever is higher)</p>
                <div style="background: rgba(80,200,120,0.15); border: 1px solid var(--accent-green); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: var(--accent-green);">⚔️ War Caster:</strong> You have <strong>Advantage</strong> on this save!
                </div>
                <div style="background: rgba(123,104,238,0.15); border: 1px solid var(--accent-purple); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: var(--accent-purple);">🐉 Dragon Form:</strong> If you're in Starry Form (Dragon), treat rolls of 9 or lower as 10.
                </div>
                <p><strong>Your Con Save:</strong> +2 (with Advantage from War Caster)</p>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="closeModal()" style="flex:1; padding: 10px; background: var(--accent-green); color: white; border: none; border-radius: 6px; cursor: pointer;">Saved!</button>
                    <button onclick="endConcentration(); closeModal();" style="flex:1; padding: 10px; background: var(--accent-red); color: white; border: none; border-radius: 6px; cursor: pointer;">Failed</button>
                </div>
            `);
        }

        function endConcentration() {
            if (!state.concentration) return;
            const spellName = state.concentration.spellName;

            // If it was Summon Beast, dismiss only beast companions (not familiars)
            if (state.concentration.spellId === 'summon-beast' && state.companions) {
                state.companions = state.companions.filter(c => c.type !== 'beast');
                updateCompanionDisplay();
            }

            state.concentration = null;
            updateConcentrationDisplay();
            if (state.inBattle) addBattleLog(`Ended concentration on ${spellName}`);
            saveState();
        }

        function useArcherAttack() {
            if (!state.activeForm || !state.activeForm.showArcherAction) {
                alert('Archer form not active!');
                return;
            }
            saveForUndo();
            if (state.inBattle) {
                state.actionsUsed.bonus = true;
                addBattleLog('Archer Attack: +7 to hit, 1d8+4 radiant');
            }
            updateBattleUI();
            saveState();
        }

        function openWarCasterSpell() {
            if (state.activeForm && state.activeForm.type === 'wild-shape') {
                alert('Cannot cast spells while in Wild Shape!');
                return;
            }
            let body = '<div class="form-options">';
            body += '<p class="text-muted" style="margin-bottom:10px;">Cast a spell targeting the creature leaving your reach:</p>';

            // Add attack cantrips first
            const attackCantrips = CANTRIPS.filter(c =>
                ['starry-wisp', 'thorn-whip', 'produce-flame'].includes(c.id)
            );

            if (attackCantrips.length > 0) {
                body += '<div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 8px;">Cantrips (No Slot)</div>';
                attackCantrips.forEach(cantrip => {
                    const damage = getScaledCantripDamage(cantrip);
                    body += `
                        <div class="form-option" onclick="castWarCasterCantrip('${cantrip.id}')">
                            <div class="form-option-title">${cantrip.name}</div>
                            <div class="form-option-desc">${cantrip.range}${damage ? ' | ' + damage : ''}</div>
                        </div>
                    `;
                });
                body += '<hr style="border-color: var(--border-color); margin: 12px 0;">';
            }

            // Show action spells that can target one creature
            const singleTargetSpells = [];
            state.preparedSpells.forEach(prep => {
                for (let level = 1; level <= 3; level++) {
                    const spell = SPELLS[level].find(s => s.id === prep.id);
                    if (spell && spell.time === 'Action') {
                        singleTargetSpells.push({ ...spell, level });
                    }
                }
            });

            // Always add Guiding Bolt
            singleTargetSpells.unshift({ ...SPELLS[1].find(s => s.id === 'guiding-bolt'), level: 1 });

            body += '<div style="color: var(--accent-purple); font-weight: bold; margin-bottom: 8px;">Leveled Spells</div>';
            singleTargetSpells.forEach(spell => {
                const dmgPreview = getSpellDamagePreview(spell, spell.level);
                body += `
                    <div class="form-option" onclick="castWarCasterSpell('${spell.id}', ${spell.level})">
                        <div class="form-option-title">${spell.name} (${spell.level}${getOrdinal(spell.level)})</div>
                        <div class="form-option-desc">${spell.range}${dmgPreview ? ' | ' + dmgPreview : ''}</div>
                    </div>
                `;
            });

            body += '</div>';
            showModal('War Caster - Choose Spell', body);
        }

        function castWarCasterCantrip(cantripId) {
            const cantrip = CANTRIPS.find(c => c.id === cantripId);
            if (state.inBattle) {
                state.actionsUsed.reaction = true;
                addBattleLog(`War Caster: Cast ${cantrip.name} as reaction`);
            }
            closeModal();
            updateBattleUI();
            saveState();
        }

        function castWarCasterSpell(spellId, level) {
            saveForUndo();

            // Use spell slot
            let slotUsed = false;
            for (let l = level; l <= 3; l++) {
                const slotIndex = state.slots[l].findIndex(used => !used);
                if (slotIndex !== -1) {
                    state.slots[l][slotIndex] = true;
                    slotUsed = true;
                    break;
                }
            }

            if (!slotUsed) {
                alert('No spell slots available!');
                return;
            }

            if (state.inBattle) {
                state.actionsUsed.reaction = true;
                addBattleLog(`War Caster: Cast ${spellId} as reaction`);
            }

            closeModal();
            updateSlotsDisplay();
            updateBattleUI();
            saveState();
        }

        function useAbsorbElements() {
            // Check for 1st level slot
            const slotIndex = state.slots[1].findIndex(used => !used);
            if (slotIndex === -1) {
                // Check higher slots
                for (let l = 2; l <= 3; l++) {
                    const idx = state.slots[l].findIndex(used => !used);
                    if (idx !== -1) {
                        saveForUndo();
                        state.slots[l][idx] = true;
                        if (state.inBattle) {
                            state.actionsUsed.reaction = true;
                            addBattleLog('Cast Absorb Elements');
                        }
                        updateSlotsDisplay();
                        updateBattleUI();
                        saveState();
                        return;
                    }
                }
                alert('No spell slots available!');
                return;
            }

            saveForUndo();
            state.slots[1][slotIndex] = true;
            if (state.inBattle) {
                state.actionsUsed.reaction = true;
                addBattleLog('Cast Absorb Elements');
            }
            updateSlotsDisplay();
            updateBattleUI();
            saveState();
        }

        // ===== RESOURCE SLOT TOGGLES =====
        function toggleWildShapeSlot(el) {
            el.classList.toggle('used');
            const used = document.querySelectorAll('#wildShapeSlots .slot-box.used').length;
            state.resources.wildShape = 2 - used;
            saveState();
        }

        function toggleGBSlot(el) {
            el.classList.toggle('used');
            const used = document.querySelectorAll('#guidingBoltSlots .slot-box.used').length;
            state.resources.guidingBolt = 4 - used;
            saveState();
        }

        function toggleHWFreeSlot(el) {
            el.classList.toggle('used');
            state.resources.healingWordFree = el.classList.contains('used') ? 0 : 1;
            saveState();
        }

        function toggleHHSlot(el) {
            el.classList.toggle('used');
            state.resources.healingHands = el.classList.contains('used') ? 0 : 1;
            saveState();
        }

        function toggleCRSlot(el) {
            el.classList.toggle('used');
            state.resources.celestialRevelation = el.classList.contains('used') ? 0 : 1;
            saveState();
        }

        function updateResourceSlots() {
            // Guiding Bolt
            const gbSlots = document.querySelectorAll('#guidingBoltSlots .slot-box');
            gbSlots.forEach((slot, i) => {
                slot.classList.toggle('used', i >= state.resources.guidingBolt);
            });

            // Wild Shape
            const wsSlots = document.querySelectorAll('#wildShapeSlots .slot-box');
            wsSlots.forEach((slot, i) => {
                slot.classList.toggle('used', i >= state.resources.wildShape);
            });

            // Healing Word Free
            const hwSlot = document.querySelector('#healingWordFreeSlot .slot-box');
            if (hwSlot) hwSlot.classList.toggle('used', state.resources.healingWordFree <= 0);

            // Healing Hands
            const hhSlot = document.querySelector('#healingHandsSlot .slot-box');
            if (hhSlot) hhSlot.classList.toggle('used', state.resources.healingHands <= 0);

            // Celestial Revelation
            const crSlot = document.querySelector('#celestialRevSlot .slot-box');
            if (crSlot) crSlot.classList.toggle('used', state.resources.celestialRevelation <= 0);
        }

        function showFeatureModal(featureId) {
            const features = {
                'healing-hands': {
                    title: 'Healing Hands',
                    body: '<p><strong>Action</strong></p><p>Touch a creature and roll 3d4. The creature regains HP equal to the total.</p><p><strong>Uses:</strong> 1/Long Rest</p>'
                },
                'celestial-revelation': {
                    title: 'Celestial Revelation',
                    body: '<p><strong>Bonus Action</strong></p><p>Transform for 1 minute. Choose: Radiant Soul (fly 30ft, +3 radiant), Necrotic Shroud (frighten, +3 necrotic), or Inner Radiance (damage aura).</p><p><strong>Uses:</strong> 1/Long Rest</p>'
                }
            };

            const f = features[featureId];
            if (f) showModal(f.title, f.body);
        }

        // ===== INIT =====
        // Handle Enter key for HP inputs
        document.getElementById('damageInput').addEventListener('keypress', e => { if (e.key === 'Enter') applyDamage(); });
        document.getElementById('healInput').addEventListener('keypress', e => { if (e.key === 'Enter') applyHeal(); });

        // ===== SPELL DATA (2024 Druid) =====
        const CANTRIPS = [
            { id: 'guidance', name: 'Guidance', source: 'Druid (Level 1)', school: 'Divination', time: 'Action', range: 'Touch', dur: '1 min (C)', comp: 'V, S',
              desc: 'You touch a willing creature and choose one of the following: Ability Check or Saving Throw. Once before the spell ends, the target can roll 1d4 and add the number rolled to one ability check or saving throw (your choice) of its choice. It can roll before or after making the roll. The spell then ends.' },
            { id: 'starry-wisp', name: 'Starry Wisp', source: 'Druid (Level 1)', school: 'Evocation', time: 'Action', range: '60 ft', dur: 'Instant', comp: 'V, S',
              desc: 'You launch a mote of light at one creature or object within range. Make a ranged spell attack against the target. On a hit, the target takes 1d8 Radiant damage, and until the end of your next turn, it emits Dim Light in a 10-foot radius and can\'t benefit from the Invisible condition. Damage increases: 2d8 at 5th level, 3d8 at 11th level, 4d8 at 17th level.' },
            { id: 'thorn-whip', name: 'Thorn Whip', source: 'Druid (Level 4)', school: 'Transmutation', time: 'Action', range: '30 ft', dur: 'Instant', comp: 'V, S, M (stem of a thorny plant)',
              desc: 'You create a vine-like whip covered in thorns that lashes out at your command toward a creature within range. Make a melee spell attack against the target. If the attack hits, the creature takes 1d6 Piercing damage, and if the creature is Large or smaller, you can pull the creature up to 10 feet closer to you. Damage increases: 2d6 at 5th level, 3d6 at 11th level, 4d6 at 17th level.' },
            { id: 'message', name: 'Message', source: 'Druid (Magician)', school: 'Transmutation', time: 'Action', range: '120 ft', dur: '1 round', comp: 'V, S, M (a copper wire)',
              desc: 'You point toward a creature within range and whisper a message. The target (and only the target) hears the message and can reply in a whisper that only you can hear. You can cast this spell through solid objects if you are familiar with the target. The spell is blocked by 3 feet of wood, 1 foot of stone, 1 inch of metal, or a thin sheet of lead.' },
            { id: 'produce-flame', name: 'Produce Flame', source: 'Magic Initiate', school: 'Conjuration', time: 'Bonus Action', range: 'Self', dur: '10 min', comp: 'V, S',
              desc: 'A flickering flame appears in your hand and remains for the duration. While there, the flame emits no heat and ignites nothing, and it sheds Bright Light in a 20-foot radius and Dim Light for an additional 20 feet. The spell ends if you cast it again. Until the spell ends, you can take a Magic action to hurl fire at a creature or object within 60 feet. Make a ranged spell attack. On a hit, the target takes 1d8 Fire damage. Damage increases: 2d8 at 5th level, 3d8 at 11th level, 4d8 at 17th level.' },
            { id: 'mending', name: 'Mending', source: 'Magic Initiate', school: 'Transmutation', time: '1 min', range: 'Touch', dur: 'Instant', comp: 'V, S, M (two lodestones)',
              desc: 'This spell repairs a single break or tear in an object you touch, such as a broken chain link, two halves of a broken key, a torn cloak, or a leaking wineskin. As long as the damage is no larger than 1 foot in any dimension, you mend it, leaving no trace of the former damage. This spell can physically repair a magic item, but it can\'t restore magic to such an object.' }
        ];

        const SPELLS = {
            1: [
                { id: 'guiding-bolt', name: 'Guiding Bolt', always: true, school: 'Evocation', conc: false, ritual: false, time: 'Action', range: '120 ft', dur: '1 round', comp: 'V, S',
                  desc: 'A flash of light streaks toward a creature of your choice within range. Make a ranged spell attack against the target. On a hit, the target takes 4d6 Radiant damage, and the next attack roll made against this target before the end of your next turn has Advantage.',
                  higher: 'The damage increases by 1d6 for each spell slot level above 1.',
                  note: '⭐ FREE: 4/long rest from Star Map (Wis mod)' },
                { id: 'cure-wounds', name: 'Cure Wounds', school: 'Abjuration', conc: false, ritual: false, time: 'Action', range: 'Touch', dur: 'Instant', comp: 'V, S',
                  desc: 'A creature you touch regains a number of Hit Points equal to 2d8 + your spellcasting ability modifier. This spell has no effect on Constructs or Undead.',
                  higher: 'The healing increases by 2d8 for each spell slot level above 1.' },
                { id: 'healing-word', name: 'Healing Word', always: true, school: 'Abjuration', conc: false, ritual: false, time: 'Bonus Action', range: '60 ft', dur: 'Instant', comp: 'V',
                  desc: 'A creature of your choice that you can see within range regains Hit Points equal to 2d4 + your spellcasting ability modifier. This spell has no effect on Constructs or Undead.',
                  higher: 'The healing increases by 2d4 for each spell slot level above 1.',
                  note: '⭐ FREE 1/day from Magic Initiate (always prepared)' },
                { id: 'entangle', name: 'Entangle', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '90 ft', dur: '1 min', comp: 'V, S',
                  desc: 'Grasping weeds and vines sprout from the ground in a 20-foot square starting from a point within range. For the duration, these plants turn the ground in the area into Difficult Terrain. A creature in the area when you cast the spell must succeed on a Strength saving throw or be Restrained by the entangling plants until the spell ends. A creature Restrained by the plants can take an action to make a Strength check against your spell save DC. On a success, it frees itself. When the spell ends, the conjured plants wilt away.' },
                { id: 'faerie-fire', name: 'Faerie Fire', school: 'Evocation', conc: true, ritual: false, time: 'Action', range: '60 ft', dur: '1 min', comp: 'V',
                  desc: 'Objects in a 20-foot Cube within range are outlined in blue, green, or violet light (your choice). Each creature in the Cube is also outlined if it fails a Dexterity saving throw. For the duration, objects and affected creatures shed Dim Light in a 10-foot radius and can\'t benefit from the Invisible condition. Attack rolls against affected creatures and objects have Advantage.' },
                { id: 'absorb-elements', name: 'Absorb Elements', school: 'Abjuration', conc: false, ritual: false, time: 'Reaction', range: 'Self', dur: '1 round', comp: 'S',
                  desc: 'Trigger: You take Acid, Cold, Fire, Lightning, or Thunder damage. You have Resistance to the triggering damage type until the start of your next turn. Also, the first time you hit with a melee attack on your next turn, the target takes an extra 1d6 damage of the triggering type.',
                  higher: 'The extra damage increases by 1d6 for each spell slot level above 1.' },
                { id: 'goodberry', name: 'Goodberry', school: 'Conjuration', conc: false, ritual: false, time: 'Action', range: 'Self', dur: 'Instant', comp: 'V, S, M (a sprig of mistletoe)',
                  desc: 'Ten berries appear in your hand and are infused with magic for the duration. A creature can use its Bonus Action to eat one berry. Eating a berry restores 1 Hit Point, and the berry provides enough nourishment to sustain a creature for one day. Uneaten berries disappear when the spell ends.' },
                { id: 'fog-cloud', name: 'Fog Cloud', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '120 ft', dur: '1 hour', comp: 'V, S',
                  desc: 'You create a 20-foot-radius Sphere of fog centered on a point within range. The Sphere is Heavily Obscured. It lasts for the duration or until a strong wind (such as one created by Gust of Wind) disperses it.',
                  higher: 'The fog\'s radius increases by 20 feet for each spell slot level above 1.' },
                { id: 'speak-animals', name: 'Speak with Animals', school: 'Divination', conc: false, ritual: true, time: 'Action', range: 'Self', dur: '10 min', comp: 'V, S',
                  desc: 'You gain the ability to comprehend and verbally communicate with Beasts for the duration. The knowledge and awareness of many Beasts is limited by their intelligence, but at minimum, Beasts can give you information about nearby locations and monsters, including whatever they have perceived within the past day.' },
                { id: 'thunderwave', name: 'Thunderwave', school: 'Evocation', conc: false, ritual: false, time: 'Action', range: 'Self (15-ft cube)', dur: 'Instant', comp: 'V, S',
                  desc: 'A wave of thunderous force sweeps out from you. Each creature in a 15-foot Cube originating from you makes a Constitution saving throw. On a failed save, a creature takes 2d8 Thunder damage and is pushed 10 feet away from you. On a successful save, it takes half damage only. In addition, unsecured objects that are completely within the Cube are pushed 10 feet away, and the spell emits a thunderous boom audible out to 300 feet.',
                  higher: 'The damage increases by 1d8 for each spell slot level above 1.' },
                { id: 'animal-friendship', name: 'Animal Friendship', school: 'Enchantment', conc: false, ritual: false, time: 'Action', range: '30 ft', dur: '24 hours', comp: 'V, S, M (a morsel of food)',
                  desc: 'Target a Beast that you can see within range. The target must succeed on a Wisdom saving throw or have the Charmed condition for the duration. If you or one of your allies deals damage to the target, the spell ends.',
                  higher: 'You can target one additional Beast for each spell slot level above 1.' },
                { id: 'detect-magic', name: 'Detect Magic', school: 'Divination', conc: true, ritual: true, time: 'Action', range: 'Self (30-ft radius)', dur: '10 min', comp: 'V, S',
                  desc: 'For the duration, you sense the presence of magical effects within 30 feet of yourself. If you sense such effects, you can take the Magic action to see a faint aura around any visible creature or object in the area that bears the magic, and if the magic was created by a spell, you learn the spell\'s school of magic. The spell is blocked by 1 foot of stone, dirt, or wood; 1 inch of metal; or a thin sheet of lead.' },
                { id: 'purify-food', name: 'Purify Food and Drink', school: 'Transmutation', conc: false, ritual: true, time: 'Action', range: '10 ft', dur: 'Instant', comp: 'V, S',
                  desc: 'You remove poison and disease from all nonmagical food and drink in a 5-foot-radius Sphere centered on a point within range.' },
                { id: 'charm-person', name: 'Charm Person', school: 'Enchantment', conc: false, ritual: false, time: 'Action', range: '30 ft', dur: '1 hour', comp: 'V, S',
                  desc: 'One Humanoid you can see within range makes a Wisdom saving throw. It does so with Advantage if you or your allies are fighting it. On a failed save, the target has the Charmed condition until the spell ends or until you or your allies damage it. The Charmed creature is Friendly to you. When the spell ends, the target knows it was Charmed by you.',
                  higher: 'You can target one additional creature for each spell slot level above 1.' },
                { id: 'create-water', name: 'Create or Destroy Water', school: 'Transmutation', conc: false, ritual: false, time: 'Action', range: '30 ft', dur: 'Instant', comp: 'V, S, M (a drop of water or a few grains of sand)',
                  desc: 'You do one of the following: Create Water: You create up to 10 gallons of clean water within range in an open container, or you create rain in a 30-foot Cube within range, extinguishing exposed flames. Destroy Water: You destroy up to 10 gallons of water in an open container, or you destroy fog in a 30-foot Cube within range.',
                  higher: 'You create or destroy 10 additional gallons for each spell slot level above 1, or the Cube increases by 5 feet.' },
                { id: 'jump', name: 'Jump', school: 'Transmutation', conc: false, ritual: false, time: 'Bonus Action', range: 'Touch', dur: '1 min', comp: 'V, S, M (a grasshopper\'s hind leg)',
                  desc: 'You touch a willing creature. Once on each of its turns until the spell ends, that creature can jump up to 30 feet by spending only 10 feet of movement.' },
                { id: 'longstrider', name: 'Longstrider', school: 'Transmutation', conc: false, ritual: false, time: 'Action', range: 'Touch', dur: '1 hour', comp: 'V, S, M (a pinch of dirt)',
                  desc: 'You touch a creature. The target\'s Speed increases by 10 feet until the spell ends.',
                  higher: 'You can target one additional creature for each spell slot level above 1.' }
            ],
            2: [
                { id: 'moonbeam', name: 'Moonbeam', school: 'Evocation', conc: true, ritual: false, time: 'Action', range: '120 ft', dur: '1 min', comp: 'V, S, M (several seeds of any moonseed plant and a piece of opalescent feldspar)',
                  desc: 'A silvery beam of pale light shines down in a 5-foot-radius, 40-foot-high Cylinder centered on a point within range. Until the spell ends, Dim Light fills the Cylinder. When a creature enters the Cylinder for the first time on a turn or starts its turn there, it makes a Constitution saving throw, taking 2d10 Radiant damage on a failed save, or half as much damage on a successful one. A Shapechanger makes its saving throw with Disadvantage. On your later turns, you can take a Magic action to move the Cylinder up to 60 feet.',
                  higher: 'The damage increases by 1d10 for each spell slot level above 2.' },
                { id: 'pass-without-trace', name: 'Pass Without Trace', school: 'Abjuration', conc: true, ritual: false, time: 'Action', range: 'Self (30-ft emanation)', dur: '1 hour', comp: 'V, S, M (ashes from burned mistletoe)',
                  desc: 'You and each creature you choose within 30 feet of yourself have a +10 bonus to Dexterity (Stealth) checks and leave no tracks or other traces of your passage.' },
                { id: 'hold-person', name: 'Hold Person', school: 'Enchantment', conc: true, ritual: false, time: 'Action', range: '60 ft', dur: '1 min', comp: 'V, S, M (a straight piece of iron)',
                  desc: 'Choose a Humanoid that you can see within range. The target must succeed on a Wisdom saving throw or have the Paralyzed condition for the duration. At the end of each of its turns, the target repeats the save, ending the spell on itself on a success.',
                  higher: 'You can target one additional Humanoid for each spell slot level above 2.' },
                { id: 'spike-growth', name: 'Spike Growth', school: 'Transmutation', conc: true, ritual: false, time: 'Action', range: '150 ft', dur: '10 min', comp: 'V, S, M (seven sharp thorns)',
                  desc: 'The ground in a 20-foot-radius Sphere centered on a point within range twists and sprouts hard spikes and thorns. The area becomes Difficult Terrain for the duration. When a creature moves into or within the area, it takes 2d4 Piercing damage for every 5 feet it travels. The transformation of the ground is camouflaged to look natural. Any creature that can\'t see the area when the spell is cast must take a Search action and succeed on a Wisdom (Perception) check against your spell save DC to recognize the terrain as hazardous.' },
                { id: 'lesser-restoration', name: 'Lesser Restoration', school: 'Abjuration', conc: false, ritual: false, time: 'Bonus Action', range: 'Touch', dur: 'Instant', comp: 'V, S',
                  desc: 'You touch a creature and end one condition on it: Blinded, Deafened, Paralyzed, or Poisoned. Alternatively, you can end one disease on the creature.' },
                { id: 'heat-metal', name: 'Heat Metal', school: 'Transmutation', conc: true, ritual: false, time: 'Action', range: '60 ft', dur: '1 min', comp: 'V, S, M (a piece of iron and a flame)',
                  desc: 'Choose a manufactured metal object, such as a metal weapon or a suit of Heavy or Medium metal armor. You cause the object to glow red-hot. Any creature in physical contact with the object takes 2d8 Fire damage when you cast the spell. Until the spell ends, you can take a Bonus Action on your later turns to deal this damage again. If a creature is holding or wearing the object and takes damage from it, the creature must succeed on a Constitution saving throw or drop the object if it can. If it doesn\'t drop the object, it has Disadvantage on attack rolls and ability checks until the start of your next turn.',
                  higher: 'The damage increases by 1d8 for each spell slot level above 2.' },
                { id: 'barkskin', name: 'Barkskin', school: 'Transmutation', conc: false, ritual: false, time: 'Bonus Action', range: 'Touch', dur: '1 hour', comp: 'V, S, M (a handful of bark)',
                  desc: 'You touch a willing creature. Until the spell ends, the target\'s skin takes on a rough, bark-like appearance, and the target\'s AC can\'t be less than 17, regardless of what kind of armor it is wearing.' },
                { id: 'beast-sense', name: 'Beast Sense', school: 'Divination', conc: true, ritual: true, time: 'Action', range: 'Touch', dur: '1 hour', comp: 'S',
                  desc: 'You touch a willing Beast. For the duration, you can take a Magic action to see through the Beast\'s eyes and hear what it hears, gaining the benefits of any special senses it has. During this time, your senses don\'t function, and you have the Blinded and Deafened conditions.' },
                { id: 'darkvision', name: 'Darkvision', school: 'Transmutation', conc: false, ritual: false, time: 'Action', range: 'Touch', dur: '8 hours', comp: 'V, S, M (a dried carrot)',
                  desc: 'You touch a willing creature to grant it Darkvision. For the duration, that creature has Darkvision with a range of 150 feet.' },
                { id: 'enhance-ability', name: 'Enhance Ability', school: 'Transmutation', conc: true, ritual: false, time: 'Action', range: 'Touch', dur: '1 hour', comp: 'V, S, M (fur or a feather)',
                  desc: 'You touch a creature and choose one of the following effects; the target gains that effect until the spell ends. Bear\'s Endurance: Advantage on Constitution checks. The target also gains 2d6 Temporary Hit Points. Bull\'s Strength: Advantage on Strength checks, and carrying capacity doubles. Cat\'s Grace: Advantage on Dexterity checks. Also doesn\'t take damage from falling 20 feet or less if not Incapacitated. Eagle\'s Splendor: Advantage on Charisma checks. Fox\'s Cunning: Advantage on Intelligence checks. Owl\'s Wisdom: Advantage on Wisdom checks.',
                  higher: 'You can target one additional creature for each spell slot level above 2.' },
                { id: 'flame-blade', name: 'Flame Blade', school: 'Evocation', conc: true, ritual: false, time: 'Bonus Action', range: 'Self', dur: '10 min', comp: 'V, S, M (a sumac leaf)',
                  desc: 'You evoke a fiery blade in your free hand. The blade sheds Bright Light in a 10-foot radius and Dim Light for an additional 10 feet. You can take a Magic action to make a melee spell attack with the blade. On a hit, the target takes Fire damage equal to 3d6 plus your spellcasting ability modifier. The flaming blade disappears if you let go of it, but you can evoke it again as a Bonus Action.',
                  higher: 'The Fire damage increases by 1d6 for every slot level above 2.' },
                { id: 'gust-of-wind', name: 'Gust of Wind', school: 'Evocation', conc: true, ritual: false, time: 'Action', range: 'Self', dur: '1 min', comp: 'V, S, M (a legume seed)',
                  desc: 'A Line of strong wind 60 feet long and 10 feet wide blasts from you in a direction you choose. Each creature in the Line must succeed on a Strength saving throw or be pushed 15 feet away from you in a direction following the Line. Any creature in the Line must spend 2 feet of movement for every 1 foot it moves when moving closer to you. The gust disperses gas or vapor, and it extinguishes candles and similar unprotected flames. It causes protected flames, such as lanterns, to dance wildly and has a 50 percent chance to extinguish them. As a Bonus Action on your later turns, you can change the direction of the Line.' },
                { id: 'protection-poison', name: 'Protection from Poison', school: 'Abjuration', conc: false, ritual: false, time: 'Action', range: 'Touch', dur: '1 hour', comp: 'V, S',
                  desc: 'You touch a creature. If it is Poisoned, you neutralize the poison. If more than one poison afflicts the target, you neutralize one poison you know is present, or you neutralize one at random. For the duration, the target has Advantage on saving throws against being Poisoned and has Resistance to Poison damage.' },
                { id: 'summon-beast', name: 'Summon Beast', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '90 ft', dur: '1 hour', comp: 'V, S, M (a feather, tuft of fur, and fish tail inside a gilded acorn worth 200+ GP)',
                  desc: 'You call forth a bestial spirit. It manifests in an unoccupied space that you can see within range and uses the Bestial Spirit stat block. When you cast the spell, choose an environment: Air, Land, or Water. The creature resembles an animal of your choice and gains certain traits based on the environment. The creature disappears when it drops to 0 Hit Points or when the spell ends. It is an ally to you and your companions. In combat, it shares your Initiative count and takes its turn immediately after yours. It obeys your verbal commands (no action required). If you don\'t issue any, it takes the Dodge action and moves to avoid danger.',
                  higher: 'Use the spell slot\'s level for the spell\'s level in the stat block.' }
            ],
            3: [
                { id: 'conjure-animals', name: 'Conjure Animals', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '60 ft', dur: '10 min', comp: 'V, S',
                  desc: 'You conjure nature spirits that take the form of a Large swarm of spectral animals in an unoccupied space you can see within range. The swarm lasts for the duration, is allied with you and your companions, and obeys your commands. The swarm uses the Conjured Animals stat block. When you cast the spell, you choose the swarm\'s kind. Each kind has a specific creature appearance. See the spell for the full stat block. If you don\'t issue any commands, the swarm defends itself from hostile creatures but otherwise takes no actions.',
                  higher: 'The swarm\'s HP increases by 10 for each spell slot level above 3.' },
                { id: 'call-lightning', name: 'Call Lightning', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '120 ft', dur: '10 min', comp: 'V, S',
                  desc: 'A storm cloud appears at a point within range. It is a 10-foot-tall, 60-foot-radius cylinder. When you cast the spell, choose a point you can see under the cloud. A lightning bolt strikes that point. Each creature within 5 feet of that point makes a Dexterity saving throw, taking 3d10 Lightning damage on a failed save, or half as much damage on a successful one. Until the spell ends, you can take a Magic action to call down lightning in this way again, targeting the same point or a different one. If you\'re outdoors in a storm when you cast this spell, the damage increases by 1d10.',
                  higher: 'The damage increases by 1d10 for each spell slot level above 3.' },
                { id: 'dispel-magic', name: 'Dispel Magic', school: 'Abjuration', conc: false, ritual: false, time: 'Action', range: '120 ft', dur: 'Instant', comp: 'V, S',
                  desc: 'Choose one creature, object, or magical effect within range. Any ongoing spell of level 3 or lower on the target ends. For each ongoing spell of level 4 or higher on the target, make an ability check using your spellcasting ability (DC = 10 + the spell\'s level). On a successful check, the spell ends.',
                  higher: 'You automatically end a spell on the target if the spell\'s level is equal to or less than the level of the spell slot you used.' },
                { id: 'plant-growth', name: 'Plant Growth', school: 'Transmutation', conc: false, ritual: false, time: 'Action or 8 hours', range: '150 ft', dur: 'Instant', comp: 'V, S',
                  desc: 'This spell channels vitality into plants. There are two possible uses: If you cast this spell using 1 action, choose a point within range. All normal plants in a 100-foot-radius Sphere centered on that point become thick and overgrown. A creature moving through that area must spend 4 feet of movement for every 1 foot it moves. You can exclude areas of any size from being affected. If you cast this spell over 8 hours, you enrich the land. All plants in a half-mile radius centered on a point within range become enriched for 1 year. The plants yield twice the normal amount of food when harvested.' },
                { id: 'revivify', name: 'Revivify', school: 'Necromancy', conc: false, ritual: false, time: 'Action', range: 'Touch', dur: 'Instant', comp: 'V, S, M (diamonds worth 300+ GP, which the spell consumes)',
                  desc: 'You touch a creature that has died within the last minute. That creature revives with 1 Hit Point. This spell can\'t revive a creature that has died of old age, nor can it restore any missing body parts.' },
                { id: 'daylight', name: 'Daylight', school: 'Evocation', conc: false, ritual: false, time: 'Action', range: '60 ft', dur: '1 hour', comp: 'V, S',
                  desc: 'A 60-foot-radius Sphere of Bright Light spreads from a point you choose within range. The Sphere is Bright Light and sheds Dim Light for an additional 60 feet. If any of this spell\'s area overlaps with an area of Darkness created by a spell of level 3 or lower, that other spell is dispelled.' },
                { id: 'meld-into-stone', name: 'Meld into Stone', school: 'Transmutation', conc: false, ritual: true, time: 'Action', range: 'Touch', dur: '8 hours', comp: 'V, S',
                  desc: 'You step into a stone object or surface large enough to fully contain your body, melding yourself and everything you\'re carrying with the stone for the duration. Using your movement, you can step into the stone at a point you can touch. You remain aware of the passage of time and can cast spells on yourself while merged. You can exit the stone where you entered or at any other location that shares a surface with the stone you entered. If the stone is damaged, you are expelled and take 6d6 Bludgeoning damage. If the stone is destroyed, you die unless you exit first.' },
                { id: 'protection-energy', name: 'Protection from Energy', school: 'Abjuration', conc: true, ritual: false, time: 'Action', range: 'Touch', dur: '1 hour', comp: 'V, S',
                  desc: 'For the duration, the willing creature you touch has Resistance to one damage type of your choice: Acid, Cold, Fire, Lightning, or Thunder.' },
                { id: 'sleet-storm', name: 'Sleet Storm', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '150 ft', dur: '1 min', comp: 'V, S, M (a miniature umbrella)',
                  desc: 'Until the spell ends, sleet falls in a 40-foot-tall, 20-foot-radius Cylinder centered on a point you choose within range. The area is Heavily Obscured, and exposed flames in the area are doused. Ground in the area is covered with slick ice, making it Difficult Terrain. When a creature enters the area for the first time on a turn or starts its turn there, it must make a Dexterity saving throw. On a failed save, it has the Prone condition. If a creature starts its turn in the spell\'s area and is concentrating, it must succeed on a Constitution saving throw against your spell save DC or lose Concentration.' },
                { id: 'speak-plants', name: 'Speak with Plants', school: 'Transmutation', conc: false, ritual: false, time: 'Action', range: 'Self', dur: '10 min', comp: 'V, S',
                  desc: 'You imbue plants in an immobile 30-foot Emanation with limited sentience and animation, giving them the ability to communicate with you and follow your simple commands. You can question plants about events in the spell\'s area within the past day. You can also turn Difficult Terrain caused by plant growth (such as thickets and undergrowth) into ordinary terrain for the duration, or turn ordinary terrain where plants are present into Difficult Terrain for the duration. The spell doesn\'t enable plants to uproot themselves and move about. Plants might perform other tasks for you, at the DM\'s discretion.' },
                { id: 'water-breathing', name: 'Water Breathing', school: 'Transmutation', conc: false, ritual: true, time: 'Action', range: '30 ft', dur: '24 hours', comp: 'V, S, M (a short reed)',
                  desc: 'This spell grants up to ten willing creatures you can see within range the ability to breathe underwater until the spell ends. Affected creatures also retain their normal mode of respiration.' },
                { id: 'wind-wall', name: 'Wind Wall', school: 'Evocation', conc: true, ritual: false, time: 'Action', range: '120 ft', dur: '1 min', comp: 'V, S, M (a fan and feather)',
                  desc: 'A wall of strong wind rises from the ground at a point you choose within range. You can make the wall up to 50 feet long, 15 feet high, and 1 foot thick. You can shape the wall in any way you choose so long as it makes one continuous path along the ground. The wall lasts for the duration. When the wall appears, each creature in its area makes a Strength saving throw, taking 4d8 Bludgeoning damage on a failed save, or half as much damage on a successful one. The strong wind keeps fog, smoke, and other gases at bay. Small or smaller flying creatures or objects can\'t pass through the wall. Loose, lightweight materials are picked up. Arrows, bolts, and other ordinary projectiles launched at targets behind the wall are deflected upward and automatically miss.',
                  higher: 'The damage increases by 1d8 for each spell slot level above 3.' }
            ]
        };

        // ALL available beast forms (no flying, up to CR 1/2 at level 5)
        const ALL_BEAST_FORMS = [
            // CR 0 - Utility/Scouting
            { id: 'cat', name: 'Cat', cr: '0', ac: 12, hp: 2, speed: '40 ft, climb 30 ft', str: 3, dex: 15, con: 10, attacks: 'Claws: +0 to hit, 1 slashing', senses: 'Darkvision 60 ft', special: 'Keen Smell: Advantage on Perception (smell)' },
            { id: 'rat', name: 'Rat', cr: '0', ac: 10, hp: 1, speed: '20 ft', str: 2, dex: 11, con: 9, attacks: 'Bite: +0 to hit, 1 piercing', senses: 'Darkvision 30 ft', special: 'Keen Smell, Tiny size for infiltration' },
            { id: 'spider', name: 'Spider', cr: '0', ac: 12, hp: 1, speed: '20 ft, climb 20 ft', str: 2, dex: 14, con: 8, attacks: 'Bite: +4 to hit, 1 piercing + DC 9 Con or 1d4 poison', senses: 'Darkvision 30 ft', special: 'Spider Climb, Web Sense, Web Walker' },
            { id: 'frog', name: 'Frog', cr: '0', ac: 11, hp: 1, speed: '20 ft, swim 20 ft', str: 1, dex: 13, con: 8, attacks: 'None (Tiny)', senses: 'Darkvision 30 ft', special: 'Amphibious, Standing Leap (10ft/20ft)' },
            { id: 'lizard', name: 'Lizard', cr: '0', ac: 10, hp: 2, speed: '20 ft, climb 20 ft', str: 2, dex: 11, con: 10, attacks: 'Bite: +0 to hit, 1 piercing', senses: 'Darkvision 30 ft', special: 'Climbing, small size for scouting' },
            { id: 'badger', name: 'Badger', cr: '0', ac: 10, hp: 3, speed: '20 ft, burrow 5 ft', str: 4, dex: 11, con: 12, attacks: 'Bite: +2 to hit, 1 piercing', senses: 'Darkvision 30 ft', special: 'Keen Smell, Burrow' },
            { id: 'crab', name: 'Crab', cr: '0', ac: 11, hp: 2, speed: '20 ft, swim 20 ft', str: 2, dex: 11, con: 10, attacks: 'Claw: +0 to hit, 1 bludgeoning', senses: 'Blindsight 30 ft', special: 'Amphibious, Blindsight' },
            // CR 1/4 - Combat capable
            { id: 'wolf', name: 'Wolf', cr: '1/4', ac: 13, hp: 11, speed: '40 ft', str: 12, dex: 15, con: 12, attacks: 'Bite: +4 to hit, 2d4+2 piercing, DC 11 Str or prone', senses: 'Passive Perception 13', special: 'Keen Hearing/Smell, Pack Tactics' },
            { id: 'panther', name: 'Panther', cr: '1/4', ac: 12, hp: 13, speed: '50 ft, climb 40 ft', str: 14, dex: 15, con: 10, attacks: 'Bite +4 (1d6+2) or Claw +4 (1d4+2)', senses: 'Passive Perception 14', special: 'Keen Smell, Pounce (20ft charge = bonus claw + prone DC 12)' },
            { id: 'boar', name: 'Boar', cr: '1/4', ac: 11, hp: 11, speed: '40 ft', str: 13, dex: 11, con: 12, attacks: 'Tusk: +3 to hit, 1d6+1 slashing', senses: 'Passive Perception 9', special: 'Charge (+1d6 dmg), Relentless (1/day drop to 1 HP instead of 0)' },
            { id: 'giant-badger', name: 'Giant Badger', cr: '1/4', ac: 10, hp: 13, speed: '30 ft, burrow 10 ft', str: 13, dex: 10, con: 15, attacks: 'Multiattack: Bite +3 (1d6+1) + Claws +3 (2d4+1)', senses: 'Darkvision 30 ft', special: 'Keen Smell, Burrow, Multiattack' },
            { id: 'giant-frog', name: 'Giant Frog', cr: '1/4', ac: 11, hp: 18, speed: '30 ft, swim 30 ft', str: 12, dex: 13, con: 11, attacks: 'Bite: +3 to hit, 1d6+1 + grapple (DC 11)', senses: 'Darkvision 30 ft', special: 'Amphibious, Standing Leap (20ft/40ft), Swallow Small creatures' },
            { id: 'giant-wolf-spider', name: 'Giant Wolf Spider', cr: '1/4', ac: 13, hp: 11, speed: '40 ft, climb 40 ft', str: 12, dex: 16, con: 13, attacks: 'Bite: +3 to hit, 1d6+1 + DC 11 Con or 2d6 poison', senses: 'Blindsight 10 ft, Darkvision 60 ft', special: 'Spider Climb, Web Sense, Web Walker' },
            { id: 'giant-centipede', name: 'Giant Centipede', cr: '1/4', ac: 13, hp: 4, speed: '30 ft, climb 30 ft', str: 5, dex: 14, con: 12, attacks: 'Bite: +4 to hit, 1d4+2 + DC 11 Con or 3d6 poison', senses: 'Blindsight 30 ft', special: 'High poison damage on failed save' },
            { id: 'giant-crab', name: 'Giant Crab', cr: '1/8', ac: 15, hp: 13, speed: '30 ft, swim 30 ft', str: 13, dex: 15, con: 11, attacks: 'Claw: +3 to hit, 1d6+1 + grapple (DC 11)', senses: 'Blindsight 30 ft', special: 'Amphibious, Blindsight, High AC, Grapple' },
            // CR 1/2 - Strong combat forms
            { id: 'black-bear', name: 'Black Bear', cr: '1/2', ac: 11, hp: 19, speed: '40 ft, climb 30 ft', str: 15, dex: 10, con: 14, attacks: 'Multiattack: Bite +4 (1d6+2) + Claws +4 (2d4+2)', senses: 'Passive Perception 13', special: 'Keen Smell, Multiattack, Good HP' },
            { id: 'ape', name: 'Ape', cr: '1/2', ac: 12, hp: 19, speed: '30 ft, climb 30 ft', str: 16, dex: 14, con: 14, attacks: 'Multiattack: 2x Fist +5 (1d6+3) or Rock +5 (1d6+3, 25/50 ft)', senses: 'Passive Perception 12', special: 'Multiattack, Ranged rock attack, +3 STR' },
            { id: 'crocodile', name: 'Crocodile', cr: '1/2', ac: 12, hp: 19, speed: '20 ft, swim 30 ft', str: 15, dex: 10, con: 13, attacks: 'Bite: +4 to hit, 1d10+2 + grapple (DC 12) + restrain', senses: 'Passive Perception 10', special: 'Hold Breath 15 min, Grapple + Restrain' },
            { id: 'giant-goat', name: 'Giant Goat', cr: '1/2', ac: 11, hp: 19, speed: '40 ft', str: 17, dex: 11, con: 12, attacks: 'Ram: +5 to hit, 2d4+3', senses: 'Passive Perception 11', special: 'Charge (+2d4 + prone DC 13), Sure-Footed (adv vs prone)' },
            { id: 'warhorse', name: 'Warhorse', cr: '1/2', ac: 11, hp: 19, speed: '60 ft', str: 18, dex: 12, con: 13, attacks: 'Hooves: +6 to hit, 2d6+4', senses: 'Passive Perception 11', special: 'Trampling Charge (20ft = prone DC 14 + bonus hooves), 60ft speed!' }
        ];

        // Default known forms (max 6 at level 5)
        const DEFAULT_KNOWN_FORMS = ['cat', 'wolf', 'panther', 'giant-wolf-spider', 'black-bear', 'ape'];

        // Helper to get known beast forms
        function getKnownBeastForms() {
            const knownIds = state.knownBeastForms || DEFAULT_KNOWN_FORMS;
            return ALL_BEAST_FORMS.filter(b => knownIds.includes(b.id));
        }

        // For compatibility with existing code
        const BEAST_FORMS = ALL_BEAST_FORMS;

        // ===== RENDER FUNCTIONS =====
        function renderCantrips() {
            const grid = document.getElementById('cantripGrid');
            if (!grid || !CANTRIPS) return;
            grid.innerHTML = CANTRIPS.map(c => `
                <div class="cantrip-card" onclick="this.classList.toggle('expanded')" style="cursor: pointer;">
                    <div class="cantrip-card-name">${c.name}</div>
                    <div class="cantrip-card-source">${c.source}</div>
                    <div style="font-size: 0.8em; color: var(--accent-purple); margin-bottom: 5px;">
                        ${c.school || ''} | ${c.time || 'Action'} | ${c.range || 'Touch'} | ${c.dur || 'Instant'}
                    </div>
                    <div style="font-size: 0.75em; color: var(--text-muted); margin-bottom: 8px;">
                        Components: ${c.comp || 'V, S'}
                    </div>
                    <div class="cantrip-card-desc">${c.desc}</div>
                </div>
            `).join('');
        }

        function renderSpells() {
            if (!SPELLS) return;
            [1, 2, 3].forEach(level => {
                const container = document.getElementById('spells' + level);
                if (!container || !SPELLS[level]) return;
                container.innerHTML = SPELLS[level].map(s => `
                    <div class="spell-card ${s.always ? 'always' : ''} ${state.preparedSpells.some(p => p.id === s.id) ? 'prepared' : ''}"
                         data-spell-id="${s.id}" onclick="toggleSpellExpand(this)">
                        <div class="spell-card-header">
                            <div class="spell-card-name">
                                ${!s.always ? `<input type="checkbox" class="spell-checkbox" ${state.preparedSpells.some(p => p.id === s.id) ? 'checked' : ''} onclick="toggleSpellPrepared(event, '${s.id}', '${s.name}', ${level})">` : ''}
                                ${s.name}
                            </div>
                            <div class="spell-card-tags">
                                ${s.conc ? '<span class="spell-tag conc">C</span>' : ''}
                                ${s.ritual ? '<span class="spell-tag ritual">R</span>' : ''}
                            </div>
                        </div>
                        <div class="spell-card-meta">
                            <span style="color: var(--accent-purple);">${s.school || ''}</span> |
                            ${s.time} | ${s.range} | ${s.dur}
                        </div>
                        <div class="spell-card-meta" style="font-size: 0.85em; color: var(--text-muted);">
                            Components: ${s.comp || 'V, S'}
                        </div>
                        <div class="spell-card-desc">
                            <p>${s.desc}</p>
                            ${s.higher ? `<p style="margin-top: 10px; padding-top: 8px; border-top: 1px solid var(--border-color); color: var(--accent-gold);"><strong>At Higher Levels:</strong> ${s.higher}</p>` : ''}
                            ${s.note ? `<p style="margin-top: 8px; color: var(--accent-green);"><strong>${s.note}</strong></p>` : ''}
                        </div>
                    </div>
                `).join('');
            });
            updateSpellCount();
        }

        function renderBeasts() {
            const container = document.getElementById('beastForms');
            const knownIds = state.knownBeastForms || DEFAULT_KNOWN_FORMS;
            const knownCount = knownIds.length;

            // Group by CR
            const crGroups = { '0': [], '1/8': [], '1/4': [], '1/2': [] };
            ALL_BEAST_FORMS.forEach(b => {
                if (crGroups[b.cr]) crGroups[b.cr].push(b);
                else crGroups['1/4'].push(b); // fallback
            });

            let html = `<div class="prepared-counter-display mb-10">
                Known Forms: <span class="prepared-count-value ${knownCount > 6 ? 'over' : ''}">${knownCount}</span> / 6
            </div>`;

            Object.entries(crGroups).forEach(([cr, beasts]) => {
                if (beasts.length === 0) return;
                html += `<h3 style="color: var(--accent-gold); margin: 15px 0 10px; font-size: 1em;">CR ${cr}</h3>`;
                html += '<div class="spell-list">';
                beasts.forEach(b => {
                    const isKnown = knownIds.includes(b.id);
                    html += `
                        <div class="spell-card ${isKnown ? 'prepared' : ''}" data-beast-id="${b.id}" onclick="toggleBeastExpand(this)">
                            <div class="spell-card-header">
                                <div class="spell-card-name">
                                    <input type="checkbox" class="spell-checkbox" ${isKnown ? 'checked' : ''}
                                        onclick="toggleBeastKnown(event, '${b.id}')">
                                    ${b.name}
                                </div>
                                <div class="spell-card-tags">
                                    <span class="spell-tag" style="background: rgba(80, 200, 120, 0.3); color: var(--accent-green);">CR ${b.cr}</span>
                                </div>
                            </div>
                            <div class="spell-card-meta">AC ${b.ac} | HP ${b.hp} | ${b.speed}</div>
                            <div class="spell-card-desc">
                                <p><strong>Attacks:</strong> ${b.attacks}</p>
                                <p><strong>Senses:</strong> ${b.senses}</p>
                                <p><strong>Special:</strong> ${b.special}</p>
                                <p><strong>Stats:</strong> STR ${b.str} (${formatMod(b.str)}) | DEX ${b.dex} (${formatMod(b.dex)}) | CON ${b.con} (${formatMod(b.con)})</p>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            });

            container.innerHTML = html;
        }

        function formatMod(score) {
            const mod = Math.floor((score - 10) / 2);
            return mod >= 0 ? '+' + mod : '' + mod;
        }

        function toggleBeastExpand(el) {
            if (event.target.classList.contains('spell-checkbox')) return;
            el.classList.toggle('expanded');
        }

        function toggleBeastKnown(event, beastId) {
            event.stopPropagation();
            saveForUndo();

            if (!state.knownBeastForms) {
                state.knownBeastForms = [...DEFAULT_KNOWN_FORMS];
            }

            const index = state.knownBeastForms.indexOf(beastId);
            if (index > -1) {
                // Remove from known
                state.knownBeastForms.splice(index, 1);
            } else {
                // Add to known (max 6)
                if (state.knownBeastForms.length >= 6) {
                    alert('Maximum 6 beast forms known at level 5! Uncheck one first.');
                    event.target.checked = false;
                    return;
                }
                state.knownBeastForms.push(beastId);
            }

            renderBeasts();
            saveState();
        }

        function toggleSpellSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + 'Toggle');
            if (section.style.display === 'none') {
                section.style.display = 'flex';
                if (toggle) toggle.textContent = '▼';
            } else {
                section.style.display = 'none';
                if (toggle) toggle.textContent = '▶';
            }
        }

        // Collapsible card system
        function toggleCard(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const content = card.querySelector('.card-content');
            const toggle = card.querySelector('.collapse-toggle');

            if (!content) return;

            const isCollapsed = content.classList.contains('collapsed');

            if (isCollapsed) {
                content.classList.remove('collapsed');
                card.classList.remove('collapsed');
                if (toggle) toggle.textContent = '▼';
            } else {
                content.classList.add('collapsed');
                card.classList.add('collapsed');
                if (toggle) toggle.textContent = '▶';
            }

            // Save collapse state
            saveCardCollapseState(cardId, !isCollapsed);
        }

        function saveCardCollapseState(cardId, collapsed) {
            let collapseStates = JSON.parse(localStorage.getItem('ashvael-collapse') || '{}');
            collapseStates[cardId] = collapsed;
            localStorage.setItem('ashvael-collapse', JSON.stringify(collapseStates));
        }

        function loadCardCollapseStates() {
            const collapseStates = JSON.parse(localStorage.getItem('ashvael-collapse') || '{}');
            Object.keys(collapseStates).forEach(cardId => {
                if (collapseStates[cardId]) {
                    const card = document.getElementById(cardId);
                    if (card) {
                        const content = card.querySelector('.card-content');
                        const toggle = card.querySelector('.collapse-toggle');
                        if (content) {
                            content.classList.add('collapsed');
                            card.classList.add('collapsed');
                            if (toggle) toggle.textContent = '▶';
                        }
                    }
                }
            });
        }

        function toggleSpellExpand(el) {
            if (event.target.classList.contains('spell-checkbox')) return;
            el.classList.toggle('expanded');
        }

        function toggleSpellPrepared(event, spellId, spellName, level) {
            event.stopPropagation();
            saveForUndo();

            const index = state.preparedSpells.findIndex(s => s.id === spellId);
            if (index > -1) {
                state.preparedSpells.splice(index, 1);
            } else {
                if (state.preparedSpells.length >= 9) {
                    alert('Maximum 9 spells prepared!');
                    event.target.checked = false;
                    return;
                }
                state.preparedSpells.push({ id: spellId, name: spellName, level });
            }

            renderSpells();
            updatePreparedDisplay();
            saveState();
        }

        function updateSpellCount() {
            const count = state.preparedSpells.length;
            document.getElementById('spellPreparedCount').textContent = count;
            document.getElementById('spellPreparedCount').className = 'prepared-count-value' + (count > 9 ? ' over' : '');
        }

        function showBeastInfo(beastId) {
            const b = BEAST_FORMS.find(x => x.id === beastId);
            if (!b) return;
            showModal(b.name, `
                <p><strong>CR:</strong> ${b.cr}</p>
                <p><strong>AC:</strong> ${b.ac}</p>
                <p><strong>HP:</strong> ${b.hp}</p>
                <p><strong>Speed:</strong> ${b.speed}</p>
                <p><strong>Attacks:</strong> ${b.attacks}</p>
                <p><strong>Senses:</strong> ${b.senses}</p>
            `);
        }

        // ===== FEATURES =====
        const FEATURES = {
            background: [
                {
                    name: 'Guide Background',
                    source: 'Background',
                    desc: '<strong>You know the wilderness like the back of your hand.</strong> Years of guiding travelers through treacherous terrain have honed your senses and survival skills.<br><br><strong style="color: var(--accent-gold);">Ability Scores:</strong> +2 Wisdom, +1 Constitution (applied to your stats)<br><br><strong style="color: var(--accent-blue);">Skill Proficiencies:</strong> <strong>Stealth</strong>, <strong>Survival</strong><br><br><strong style="color: var(--accent-purple);">Tool Proficiency:</strong> Cartographer\'s Tools<br><br><strong style="color: var(--accent-green);">Feat:</strong> Magic Initiate (Druid) - See Feats section<br><br><strong>Starting Equipment:</strong> Bedroll, Tent, Tinderbox, Traveler\'s Clothes, Waterskin, 50 ft Hempen Rope, Quiver with 20 Arrows, Cartographer\'s Tools, 3 GP'
                }
            ],
            ancestry: [
                {
                    name: 'Half-Aasimar/Half-Tiefling Heritage',
                    source: 'Species',
                    desc: '<strong>Creature Type:</strong> Humanoid<br><strong>Size:</strong> Medium (4-7 feet tall)<br><strong>Speed:</strong> 30 feet<br><br>You are the rare offspring of both celestial and fiendish bloodlines, bearing traits from both Aasimar and Tiefling heritage. Your unique lineage grants you abilities from both sides.'
                },
                {
                    name: 'Celestial Resistance',
                    source: 'Species Trait',
                    desc: 'You have <strong>resistance to Necrotic damage</strong> (from Aasimar) and <strong>resistance to Radiant damage</strong> (from Tiefling adaptation). When you take these damage types, you only take half damage (rounded down).',
                    detail: 'This resistance stacks with temporary sources like Absorb Elements.'
                },
                {
                    name: 'Darkvision',
                    source: 'Species Trait',
                    desc: 'You can see in dim light within <strong>60 feet</strong> of yourself as if it were bright light, and in darkness as if it were dim light. You discern colors in that darkness only as shades of gray.',
                    detail: 'Does not see through magical darkness.'
                },
                {
                    name: 'Healing Hands',
                    source: 'Species Trait (3/Long Rest)',
                    desc: '<strong>Action</strong> | Touch | 3 uses per Long Rest<br><br>You touch a creature and roll <strong>3d4</strong> (proficiency bonus in d4s). The creature regains Hit Points equal to the total rolled.<br><br>Average healing: 7.5 HP per use.',
                    detail: 'Uses = Proficiency Bonus. At level 5: 3 uses.'
                },
                {
                    name: 'Celestial Revelation',
                    source: 'Species Trait (Level 3+, 1/Long Rest)',
                    desc: '<strong>Bonus Action</strong> | 1 Minute | Once per Long Rest<br><br>Unveil your supernatural nature. Choose one option each time:<br><br><strong style="color: var(--accent-gold);">☀️ Radiant Soul:</strong> Spectral wings grant Fly Speed 30 ft. Once per turn, add +3 to Radiant or Necrotic damage.<br><br><strong style="color: var(--accent-purple);">🌑 Necrotic Shroud:</strong> Creatures within 10 ft make CHA save (DC 13) or are Frightened. Once per turn, add +3 to Radiant or Necrotic damage.<br><br><strong style="color: var(--accent-orange);">✨ Inner Radiance:</strong> Shed Bright Light 10 ft, Dim 10 more. End of your turn: creatures within 10 ft take 3 Radiant damage.',
                    hasChoices: true,
                    choices: ['Radiant Soul (Fly)', 'Necrotic Shroud (Fear)', 'Inner Radiance (Aura)']
                }
            ],
            druid: [
                {
                    name: 'Druid Class Features',
                    source: 'Class Overview',
                    desc: '<strong>Hit Dice:</strong> 1d8 per level (5d8 total)<br><strong>Hit Points:</strong> 38 (8 + 4×CON mod + 4×average roll)<br><br><strong style="color: var(--accent-gold);">Saving Throw Proficiencies:</strong><br>• <strong>Intelligence</strong> (+2)<br>• <strong>Wisdom</strong> (+7)<br><br><strong style="color: var(--accent-blue);">Skill Proficiencies (chose 2):</strong><br>• <strong>Perception</strong> (chosen)<br>• <strong>Nature</strong> (chosen)<br>• Other options: Arcana, Animal Handling, Insight, Medicine, Religion, Survival<br><br><strong style="color: var(--accent-purple);">Armor Proficiencies:</strong> Light Armor, Medium Armor, Shields (druids won\'t wear metal armor or shields)<br><br><strong style="color: var(--accent-green);">Weapon Proficiencies:</strong> Simple Weapons<br><br><strong style="color: var(--text-muted);">Tool Proficiencies:</strong> Herbalism Kit'
                },
                {
                    name: 'Spellcasting',
                    source: 'Level 1',
                    desc: '<strong>Spell Slots (Level 5):</strong> 4 × 1st, 3 × 2nd, 2 × 3rd<br><strong>Spellcasting Ability:</strong> Wisdom<br><strong>Spell Save DC:</strong> 15 (8 + 3 + 4)<br><strong>Spell Attack Bonus:</strong> +7 (3 + 4)<br><br><strong style="color: var(--accent-gold);">Cantrips Known:</strong> 4 (class) + 1 (Magician) + 2 (Magic Initiate) = 7 total<br><br><strong style="color: var(--accent-blue);">Prepared Spells:</strong> 9 (Druid level + WIS mod)<br><br><strong style="color: var(--accent-purple);">Ritual Casting:</strong> You can cast any spell with the Ritual tag as a ritual (adds 10 minutes to casting time, doesn\'t use a spell slot).<br><br><strong style="color: var(--accent-green);">Spellcasting Focus:</strong> Druidic Focus (Star Map)'
                },
                {
                    name: 'Primal Order: Magician',
                    source: 'Level 1 Choice',
                    desc: '<strong style="color: var(--accent-gold);">Chosen at Level 1</strong><br><br>You know one extra cantrip from the Druid spell list: <strong>Message</strong><br><br>Your mystical connection to nature gives you a bonus to <strong>Intelligence (Arcana)</strong> and <strong>Intelligence (Nature)</strong> checks equal to your Wisdom modifier: <strong>+4</strong>',
                    detail: 'Alternative: Warden (martial weapons, medium armor proficiency)',
                    hasChoices: true,
                    choices: ['<strong>Magician (Chosen)</strong>', 'Warden']
                },
                {
                    name: 'Druidic',
                    source: 'Level 1',
                    desc: 'You know <strong>Druidic</strong>, the secret language of druids. You can speak the language and use it to leave hidden messages that only druids can automatically spot.<br><br>Others can spot the message with a DC 15 Intelligence (Investigation) check but cannot decipher it without magic.'
                },
                {
                    name: 'Wild Shape',
                    source: 'Level 2 (2/Short Rest)',
                    desc: '<strong>Bonus Action</strong> | 2 Hours Duration | 2 Uses per Short Rest<br><br>Transform into any Beast you have seen.<br><br><strong style="color: var(--accent-green);">Level 5 Limits:</strong><br>• Max CR: 1/2<br>• No Flying Speed yet<br>• Must have seen the beast<br><br><strong>While Transformed:</strong><br>• Gain <strong>5 Temporary HP</strong> (= Druid level)<br>• Use beast\'s STR, DEX, CON<br>• Keep your INT, WIS, CHA, proficiencies, features<br>• <strong>Cannot cast spells</strong> (can maintain concentration)<br>• Revert when temp HP drops to 0'
                },
                {
                    name: 'Wild Companion',
                    source: 'Level 2',
                    desc: '<strong>Action</strong> | Costs: Spell Slot OR Wild Shape use<br><br>Cast <strong>Find Familiar</strong> without material components. The familiar is a <strong>Fey</strong> creature and disappears after your next Long Rest.<br><br><strong>Familiar Benefits:</strong><br>• Telepathic link within 100 ft<br>• See through its eyes (Action)<br>• Deliver your touch spells<br>• Take Help action in combat<br>• Cannot attack'
                },
                {
                    name: 'Wild Resurgence',
                    source: 'Level 5',
                    desc: '<strong>No Action Required</strong> | Once per Turn<br><br>If you have no Wild Shape uses remaining, you can expend a <strong>spell slot</strong> to regain one use.<br><br>This ensures you can always access Wild Shape or Starry Form as long as you have spell slots!'
                }
            ],
            stars: [
                {
                    name: 'Circle of Stars Overview',
                    source: 'Subclass (Level 2)',
                    desc: 'You have looked to the stars and their endless patterns for guidance. By harnessing the magic of starlight, you gain abilities that blend divination with celestial power.<br><br><strong>Subclass Features:</strong><br>• Level 2: Star Map, Starry Form<br>• Level 6: Cosmic Omen (coming soon)<br>• Level 10: Twinkling Constellations<br>• Level 14: Full of Stars'
                },
                {
                    name: 'Star Map',
                    source: 'Circle of Stars Level 2',
                    desc: '<strong>Spellcasting Focus</strong><br><br>Your star chart is your connection to the cosmos. While holding it:<br><br><strong style="color: var(--accent-gold);">Guiding Bolt:</strong> Always prepared, doesn\'t count against your limit.<br><br><strong style="color: var(--accent-blue);">Free Casts:</strong> Cast Guiding Bolt <strong>4 times</strong> without a spell slot (WIS mod uses per Long Rest).<br><br><strong>Guiding Bolt:</strong> 4d6 radiant damage, next attack vs target has Advantage!'
                },
                {
                    name: 'Starry Form',
                    source: 'Circle of Stars Level 2',
                    desc: '<strong>Bonus Action</strong> | Uses Wild Shape | 10 Minutes<br><br>Take on a starry form instead of becoming a beast. You shed dim light 10 ft. Choose one constellation:<br><br><strong style="color: var(--accent-gold);">⭐ Archer:</strong><br>Bonus Action: Ranged spell attack, 60 ft, <strong>1d8+4 radiant</strong> damage. Can attack when you activate and each subsequent turn.<br><br><strong style="color: var(--accent-blue);">🏆 Chalice:</strong><br>When you cast a healing spell using a slot, you OR another creature within 30 ft regains <strong>1d8+4 additional HP</strong>.<br><br><strong style="color: var(--accent-purple);">🐉 Dragon:</strong><br>Treat rolls of 9 or lower as 10 on Intelligence checks, Wisdom checks, and <strong>Concentration saves</strong>. Minimum roll is 10!',
                    hasChoices: true,
                    choices: ['Archer (Bonus Action attack)', 'Chalice (Healing boost)', 'Dragon (Minimum 10 on checks)']
                }
            ],
            feats: [
                {
                    name: 'Magic Initiate: Druid',
                    source: 'Guide Background (Level 1)',
                    desc: '<strong>Origin Feat from Guide Background</strong><br><br><strong style="color: var(--accent-gold);">Two Cantrips:</strong><br>• <strong>Produce Flame</strong> - Bonus Action light, or hurl for 2d8 fire (60 ft)<br>• <strong>Mending</strong> - Repair small breaks/tears in objects<br><br><strong style="color: var(--accent-purple);">1st-Level Spell (Always Prepared):</strong><br>• <strong>Healing Word</strong> - 60 ft, Bonus Action, 2d4+4 healing<br>• Can cast <strong>1/day free</strong>, or use spell slots'
                },
                {
                    name: 'War Caster',
                    source: 'Level 4 ASI/Feat',
                    desc: '<strong>Taken at Level 4 instead of +2 Ability Score</strong><br><br><strong style="color: var(--accent-green);">Concentration Advantage:</strong><br>Advantage on CON saves to maintain concentration when damaged.<br><br><strong style="color: var(--accent-blue);">Somatic Components:</strong><br>Cast spells with S components while holding weapons/shield.<br><br><strong style="color: var(--accent-purple);">Reactive Spell:</strong><br>Cast a 1-action spell instead of Opportunity Attack when a creature leaves your reach.',
                    detail: 'Synergy: Dragon Starry Form + War Caster = minimum 10 + Advantage on concentration!'
                }
            ],
            skills: [
                {
                    name: 'Skill Proficiencies',
                    source: 'Summary',
                    desc: '<strong style="color: var(--accent-gold);">Proficient Skills (+3 proficiency bonus):</strong><br><br><strong>From Guide Background:</strong><br>• <strong>Stealth</strong> (DEX): +2 +3 = <strong>+5</strong><br>• <strong>Survival</strong> (WIS): +4 +3 = <strong>+7</strong><br><br><strong>From Druid Class (chose 2):</strong><br>• <strong>Nature</strong> (INT): -1 +3 +4 = <strong>+6</strong> (includes Magician +4)<br>• <strong>Perception</strong> (WIS): +4 +3 = <strong>+7</strong><br><br><strong style="color: var(--text-muted);">Arcana Note:</strong> With Magician, you add +4 to Arcana checks = <strong>+3</strong> total (-1 INT + 4 WIS)<br><br><strong style="color: var(--accent-blue);">Passive Perception:</strong> 10 + 7 = <strong>17</strong>'
                }
            ]
        };

        function renderFeatures() {
            if (!FEATURES) return;
            const categoryMap = {
                background: 'backgroundFeatures',
                ancestry: 'ancestryFeatures',
                druid: 'druidFeatures',
                stars: 'starsFeatures',
                feats: 'featFeatures',
                skills: 'skillsFeatures'
            };

            Object.keys(categoryMap).forEach(cat => {
                const container = document.getElementById(categoryMap[cat]);
                if (!container || !FEATURES[cat]) return;

                container.innerHTML = FEATURES[cat].map((f, idx) => `
                    <div class="feature-item" onclick="showFeatureDetail('${cat}', ${idx})" style="cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div class="feature-item-name">${f.name}</div>
                            <span style="color: var(--accent-blue); font-size: 0.8em;">Tap for details</span>
                        </div>
                        ${f.source ? `<div class="feature-item-source">${f.source}</div>` : ''}
                        <div class="feature-item-desc" style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">${f.desc.replace(/<[^>]*>/g, ' ').substring(0, 120)}...</div>
                        ${f.hasChoices ? `<div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 5px;">${f.choices.map(c => `<span style="background: rgba(123,104,238,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.75em;">${c}</span>`).join('')}</div>` : ''}
                    </div>
                `).join('');
            });
        }

        function showFeatureDetail(category, index) {
            const f = FEATURES[category][index];
            let content = `
                <div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                    <p><strong style="color: var(--accent-gold);">${f.source || 'Feature'}</strong></p>
                </div>
                <div style="line-height: 1.7;">${f.desc}</div>
            `;

            if (f.detail) {
                content += `<div style="margin-top: 15px; padding: 10px; background: rgba(123,104,238,0.1); border-radius: 8px; border-left: 3px solid var(--accent-purple);">
                    <strong style="color: var(--accent-purple);">DM Note:</strong> ${f.detail}
                </div>`;
            }

            if (f.hasChoices && f.choices) {
                content += `<div style="margin-top: 15px;">
                    <strong style="color: var(--accent-blue);">Options/Choices:</strong>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                        ${f.choices.map(c => `<span style="background: rgba(74,144,217,0.2); padding: 5px 12px; border-radius: 15px; border: 1px solid var(--accent-blue);">${c}</span>`).join('')}
                    </div>
                </div>`;
            }

            showModal(f.name, content);
        }

        // ===== INVENTORY =====
        // ===== EQUIPMENT SYSTEM =====

        // Default starting inventory
        const DEFAULT_INVENTORY = [
            // Weapons
            { id: 'scimitar', type: 'weapon', name: 'Scimitar', category: 'martial', weaponType: 'melee', hands: 'one',
              damageDie: '1d6', damageType: 'slashing', modifier: 'finesse', properties: ['light', 'finesse'],
              isMagic: false, equipped: 'mainHand' },
            { id: 'dagger', type: 'weapon', name: 'Dagger', category: 'simple', weaponType: 'melee/thrown', hands: 'one',
              damageDie: '1d4', damageType: 'piercing', modifier: 'finesse', range: '20/60',
              properties: ['light', 'finesse', 'thrown'], isMagic: false, equipped: null },
            { id: 'shield', type: 'shield', name: 'Wooden Shield', acBonus: 2, isMagic: false, equipped: 'offHand' },
            { id: 'shortbow', type: 'weapon', name: 'Shortbow', category: 'simple', weaponType: 'ranged', hands: 'two',
              damageDie: '1d6', damageType: 'piercing', modifier: 'dex', range: '80/320',
              properties: ['ammunition', 'two-handed'], isMagic: false, equipped: null },
            // Armor
            { id: 'hide-armor', type: 'armor', name: 'Hide Armor', armorType: 'medium',
              baseAC: 12, maxDex: 2, stealthDisadvantage: false, isMagic: false, equipped: 'armor' },
            // Focus
            { id: 'star-map', type: 'focus', name: 'Star Map', isMagic: true, equipped: null,
              description: 'Spellcasting focus. Grants free Guiding Bolt casts (4/long rest).' },
            // Ammunition
            { id: 'arrows', type: 'ammo', name: 'Arrows', quantity: 20 }
        ];

        const DEFAULT_GEAR = [
            { id: 'backpack', name: 'Backpack', qty: 1, consumable: false,
              desc: 'A backpack can hold one cubic foot or 30 pounds of gear. You can also strap items to the outside.' },
            { id: 'bedroll', name: 'Bedroll', qty: 1, consumable: false,
              desc: 'A sleeping bag to keep you warm and comfortable while camping outdoors.' },
            { id: 'quiver', name: 'Quiver', qty: 1, consumable: false,
              desc: 'A quiver can hold up to 20 arrows.' },
            { id: 'tent', name: 'Tent (2-person)', qty: 1, consumable: false,
              desc: 'A simple, portable canvas shelter that sleeps two.' },
            { id: 'travelers-clothes', name: "Traveler's Clothes", qty: 1, consumable: false,
              desc: 'Sturdy boots, leather breeches, a belt, a shirt, and a hooded cloak.' },
            { id: 'herbalism-kit', name: "Herbalism Kit", qty: 1, consumable: false, isTool: true,
              desc: 'This kit contains pouches to store herbs, clippers, mortar and pestle, and several glass jars.',
              proficient: true,
              uses: [
                'Identify plants (DC 10-15 INT check)',
                'Create antitoxin (DC 15, 25 gp materials, 8 hours)',
                'Create healing potion (DC 15, 25 gp materials, 1 day)',
                'Create herbal remedies for common ailments',
                'Forage for medicinal herbs in the wild'
              ],
              checks: 'INT (Nature) or WIS (Medicine) for herbal identification and remedies' },
            { id: 'cartographers-tools', name: "Cartographer's Tools", qty: 1, consumable: false, isTool: true,
              desc: 'These tools include a quill, ink, parchment, a pair of compasses, calipers, and a ruler.',
              proficient: true,
              uses: [
                'Create accurate maps of areas you explore',
                'Determine your position on a map (DC 10-15 WIS check)',
                'Identify terrain features and estimate distances',
                'Copy or forge maps (DC 15+ DEX check)'
              ],
              checks: 'INT (Investigation) or WIS (Survival) when navigating or mapping' },
            { id: 'tinderbox', name: 'Tinderbox', qty: 1, consumable: false,
              desc: 'This small container holds flint, fire steel, and tinder. Using it to light a torch takes an action. Lighting any other fire takes 1 minute.' },
            { id: 'rations', name: 'Rations', qty: 10, consumable: true, unit: 'days',
              desc: 'Dry foods suitable for extended travel: jerky, dried fruit, hardtack, and nuts.' },
            { id: 'waterskin', name: 'Waterskin', qty: 1, consumable: false,
              desc: 'Holds 4 pints of liquid. A creature needs 1 gallon (8 pints) of water per day, or twice that in hot weather.' },
            { id: 'rope', name: 'Hempen Rope', qty: 50, consumable: true, unit: 'ft',
              desc: 'Rope has 2 HP and can be burst with DC 17 Strength. Use for climbing, tying, or improvised tools.' },
            { id: 'torches', name: 'Torch', qty: 5, consumable: true,
              desc: 'Burns for 1 hour, providing bright light (20 ft) and dim light (+20 ft). Can deal 1 fire damage as improvised weapon.' }
        ];

        function initInventory() {
            if (!state.inventory || state.inventory.length === 0) {
                state.inventory = JSON.parse(JSON.stringify(DEFAULT_INVENTORY));
            }
            if (!state.gear || state.gear.length === 0) {
                state.gear = JSON.parse(JSON.stringify(DEFAULT_GEAR));
            }
        }

        // ===== AMMUNITION SYSTEM =====
        // Map weapon names to their required ammo type
        const AMMO_REQUIREMENTS = {
            'shortbow': 'arrows',
            'longbow': 'arrows',
            'light crossbow': 'bolts',
            'heavy crossbow': 'bolts',
            'hand crossbow': 'bolts',
            'crossbow': 'bolts'
        };

        function getAmmoTypeForWeapon(weapon) {
            if (!weapon.properties || !weapon.properties.includes('ammunition')) return null;
            const weaponName = weapon.name.toLowerCase();
            for (const [key, ammoType] of Object.entries(AMMO_REQUIREMENTS)) {
                if (weaponName.includes(key)) return ammoType;
            }
            // Default fallback based on weapon type keywords
            if (weaponName.includes('bow')) return 'arrows';
            if (weaponName.includes('crossbow')) return 'bolts';
            return 'arrows'; // Default
        }

        function getAmmoCount(ammoType) {
            const ammoItem = state.inventory.find(item =>
                item.type === 'ammo' && item.name.toLowerCase().includes(ammoType.toLowerCase())
            );
            return ammoItem ? ammoItem.quantity : 0;
        }

        function useAmmo(ammoType, amount = 1) {
            const ammoItem = state.inventory.find(item =>
                item.type === 'ammo' && item.name.toLowerCase().includes(ammoType.toLowerCase())
            );
            if (!ammoItem) {
                alert(`No ${ammoType} in inventory!`);
                return false;
            }
            if (ammoItem.quantity < amount) {
                alert(`Not enough ${ammoType}! (have ${ammoItem.quantity})`);
                return false;
            }
            saveForUndo();
            ammoItem.quantity -= amount;
            saveState();
            renderInventory();
            return true;
        }

        function addAmmo(ammoType, amount) {
            const ammoItem = state.inventory.find(item =>
                item.type === 'ammo' && item.name.toLowerCase().includes(ammoType.toLowerCase())
            );
            if (ammoItem) {
                saveForUndo();
                ammoItem.quantity += amount;
                saveState();
                renderInventory();
            } else {
                // Create new ammo item
                saveForUndo();
                const capitalizedName = ammoType.charAt(0).toUpperCase() + ammoType.slice(1);
                state.inventory.push({
                    id: ammoType + '-' + Date.now(),
                    type: 'ammo',
                    name: capitalizedName,
                    quantity: amount
                });
                saveState();
                renderInventory();
            }
        }

        function openAddAmmoModal() {
            const body = `
                <div class="form-group">
                    <label>Ammo Type</label>
                    <select id="ammoTypeSelect">
                        <option value="arrows">Arrows</option>
                        <option value="bolts">Bolts</option>
                        <option value="bullets">Sling Bullets</option>
                        <option value="darts">Darts</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity to Add</label>
                    <input type="number" id="ammoQuantity" value="20" min="1">
                </div>
                <button onclick="confirmAddAmmo()" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Ammunition</button>
            `;
            showModal('Add Ammunition', body);
        }

        function confirmAddAmmo() {
            const ammoType = document.getElementById('ammoTypeSelect').value;
            const quantity = parseInt(document.getElementById('ammoQuantity').value) || 1;
            addAmmo(ammoType, quantity);
            closeModal();
        }

        function getEquippedInSlot(slot) {
            if (!state.inventory) return null;
            // For hand slots, also check for two-handed weapons
            if (slot === 'mainHand' || slot === 'offHand') {
                const twoHanded = state.inventory.find(item => item.equipped === 'twoHanded');
                if (twoHanded) return twoHanded;
            }
            return state.inventory.find(item => item.equipped === slot);
        }

        function renderInventory() {
            initInventory();
            renderEquipmentSlots();
            renderInventoryList();
            renderGearList();
            renderAttunement();
            updateACFromEquipment();
        }

        function renderEquipmentSlots() {
            const slots = ['mainHand', 'offHand', 'armor', 'head', 'neck', 'hands', 'feet', 'ring1', 'ring2'];

            // Check for two-handed weapon
            const twoHandedWeapon = state.inventory.find(item => item.equipped === 'twoHanded');

            slots.forEach(slot => {
                const contentEl = document.getElementById(slot + 'Content');
                const slotEl = document.getElementById('slot-' + slot);

                if (!contentEl || !slotEl) return;

                // Handle two-handed weapon display in both hand slots
                if ((slot === 'mainHand' || slot === 'offHand') && twoHandedWeapon) {
                    let displayText = twoHandedWeapon.name;
                    if (twoHandedWeapon.type === 'weapon') {
                        displayText += ` (${twoHandedWeapon.damageDie})`;
                    }
                    if (slot === 'offHand') {
                        displayText = '↑ Two-handed';
                    }
                    contentEl.textContent = displayText;
                    contentEl.classList.remove('empty');
                    slotEl.classList.add('filled');
                    if (twoHandedWeapon.isMagic) slotEl.classList.add('magic');
                    else slotEl.classList.remove('magic');
                    return;
                }

                const item = state.inventory.find(i => i.equipped === slot);

                if (item) {
                    let displayText = item.name;
                    if (item.type === 'weapon') {
                        displayText += ` (${item.damageDie})`;
                    } else if (item.type === 'armor') {
                        displayText += ` (AC ${item.baseAC})`;
                    } else if (item.type === 'shield') {
                        displayText += ` (+${item.acBonus} AC)`;
                    }
                    contentEl.textContent = displayText;
                    contentEl.classList.remove('empty');
                    slotEl.classList.add('filled');
                    if (item.isMagic) slotEl.classList.add('magic');
                    else slotEl.classList.remove('magic');
                } else {
                    contentEl.textContent = slot === 'mainHand' || slot === 'offHand' || slot === 'armor' ? 'Empty' : '-';
                    contentEl.classList.add('empty');
                    slotEl.classList.remove('filled', 'magic');
                }
            });
        }

        function renderInventoryList() {
            const listEl = document.getElementById('inventoryList');
            if (!listEl) return;

            const unequipped = state.inventory.filter(item => !item.equipped);

            if (unequipped.length === 0) {
                listEl.innerHTML = '<div class="text-muted" style="padding: 10px;">No unequipped items</div>';
                return;
            }

            listEl.innerHTML = unequipped.map(item => {
                let subtitle = '';
                if (item.type === 'weapon') {
                    const cat = item.category ? item.category.charAt(0).toUpperCase() + item.category.slice(1) : '';
                    subtitle = `${cat ? cat + ' | ' : ''}${item.damageDie} ${item.damageType}`;
                } else if (item.type === 'armor') {
                    subtitle = `AC ${item.baseAC} + DEX (max ${item.maxDex})`;
                } else if (item.type === 'shield') {
                    subtitle = `+${item.acBonus} AC`;
                } else if (item.type === 'ammo') {
                    subtitle = `Qty: ${item.quantity}`;
                }

                return `
                    <div class="inventory-item ${item.isMagic ? 'magic' : ''}" onclick="showItemOptions('${item.id}')">
                        <div class="inventory-item-left">
                            <span class="inventory-item-name">${item.name}</span>
                            <span style="font-size: 0.8em; color: var(--text-muted);">${subtitle}</span>
                        </div>
                        <div class="inventory-item-actions">
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteInventoryItem('${item.id}')">✕</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderGearList() {
            const gearList = document.getElementById('gearList');
            if (!gearList) return;

            gearList.innerHTML = state.gear.map((item, i) => {
                const qtyDisplay = item.unit ? `${item.qty} ${item.unit}` : `×${item.qty || 1}`;
                const isConsumable = item.consumable;
                const isTool = item.isTool;
                const icon = isTool ? '🛠️' : (isConsumable ? '📦' : '🎒');

                return `
                    <div class="inventory-item ${isTool ? 'tool-item' : ''}" onclick="showGearDetails(${i})" style="cursor: pointer;">
                        <div class="inventory-item-left">
                            <span class="inventory-item-name">${icon} ${item.name}</span>
                        </div>
                        <div class="inventory-item-actions" onclick="event.stopPropagation();">
                            ${isConsumable ? `
                                <button class="qty-btn" onclick="adjustGearQty(${i}, -1)" style="padding: 4px 8px; background: var(--accent-red); border: none; border-radius: 4px; color: white; cursor: pointer;">−</button>
                                <span style="color: var(--text-muted); min-width: 50px; text-align: center;">${qtyDisplay}</span>
                                <button class="qty-btn" onclick="adjustGearQty(${i}, 1)" style="padding: 4px 8px; background: var(--accent-green); border: none; border-radius: 4px; color: white; cursor: pointer;">+</button>
                            ` : `
                                <span style="color: var(--text-muted);">${qtyDisplay}</span>
                            `}
                            <button class="delete-btn" onclick="deleteItem('gear', ${i})">✕</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showGearDetails(index) {
            const item = state.gear[index];
            if (!item) return;

            let body = `<div style="padding: 10px;">`;

            // Basic info
            body += `<div style="font-size: 1.1em; margin-bottom: 10px;">${item.desc || 'No description available.'}</div>`;

            // Stats row
            if (item.qty !== undefined) {
                body += `<div style="margin-bottom: 15px; color: var(--text-muted);">`;
                body += `<span>📦 Qty: ${item.qty}${item.unit ? ' ' + item.unit : ''}</span>`;
                body += `</div>`;
            }

            // Tool-specific info
            if (item.isTool) {
                body += `<div style="background: rgba(100,149,237,0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px;">`;
                body += `<div style="color: var(--accent-blue); font-weight: bold; margin-bottom: 8px;">🛠️ Tool Proficiency${item.proficient ? ' (Proficient)' : ''}</div>`;

                if (item.checks) {
                    body += `<div style="margin-bottom: 8px;"><strong>Related Checks:</strong> ${item.checks}</div>`;
                }

                if (item.uses && item.uses.length > 0) {
                    body += `<div style="margin-bottom: 5px;"><strong>Common Uses:</strong></div>`;
                    body += `<ul style="margin: 0; padding-left: 20px;">`;
                    item.uses.forEach(use => {
                        body += `<li style="margin-bottom: 4px;">${use}</li>`;
                    });
                    body += `</ul>`;
                }
                body += `</div>`;
            }

            // Consumable actions
            if (item.consumable && item.qty > 0) {
                body += `<div style="display: flex; gap: 10px; margin-top: 15px;">`;
                body += `<button onclick="useGearItem(${index}); closeModal();" style="flex: 1; padding: 12px; background: var(--accent-orange); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Use 1 ${item.name}</button>`;
                body += `</div>`;
            }

            body += `</div>`;

            showModal(item.name, body);
        }

        function adjustGearQty(index, amount) {
            const item = state.gear[index];
            if (!item) return;

            saveForUndo();
            item.qty = Math.max(0, (item.qty || 1) + amount);
            saveState();
            renderGearList();
        }

        function showToolInfo(toolId) {
            // Find the tool in gear by ID
            const index = state.gear.findIndex(item => item.id === toolId);
            if (index !== -1) {
                showGearDetails(index);
            } else {
                // Fallback: show basic info if tool not in gear
                showModal('Tool Not Found', `<div style="padding: 10px;">Tool "${toolId}" not found in gear inventory.</div>`);
            }
        }

        function useGearItem(index) {
            const item = state.gear[index];
            if (!item || !item.consumable || item.qty <= 0) return;

            saveForUndo();
            item.qty -= 1;
            saveState();
            renderGearList();

            // Log the usage if in battle
            if (state.inBattle) {
                addBattleLog(`Used ${item.name}`);
            }
        }

        function openAddGearModal() {
            const body = `
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" id="gearName" placeholder="e.g., Rope, Torch, Rations">
                </div>
                <div class="form-row" style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Quantity</label>
                        <input type="number" id="gearQty" value="1" min="1">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Unit (optional)</label>
                        <select id="gearUnit">
                            <option value="">-</option>
                            <option value="ft">ft</option>
                            <option value="days">days</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="display: flex; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="gearConsumable" style="width: 20px; height: 20px;">
                        <span>Consumable (can be used up)</span>
                    </label>
                </div>
                <div class="form-group">
                    <label>Description (optional)</label>
                    <textarea id="gearDesc" rows="2" placeholder="What does this item do?"></textarea>
                </div>
                <button onclick="saveNewGear()" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Gear</button>
            `;
            showModal('Add Adventuring Gear', body);
        }

        function saveNewGear() {
            const name = document.getElementById('gearName').value.trim();
            if (!name) { alert('Please enter an item name'); return; }

            const newItem = {
                id: 'gear-' + Date.now(),
                name: name,
                qty: parseInt(document.getElementById('gearQty').value) || 1,
                consumable: document.getElementById('gearConsumable').checked,
                desc: document.getElementById('gearDesc').value.trim() || null
            };

            const unit = document.getElementById('gearUnit').value;
            if (unit) newItem.unit = unit;

            saveForUndo();
            state.gear.push(newItem);
            saveState();
            renderGearList();
            closeModal();
        }

        function renderAttunement() {
            const attuned = state.inventory.filter(item => item.attuned);
            const countEl = document.getElementById('attunementCount');
            const listEl = document.getElementById('attunedItems');

            if (countEl) countEl.textContent = `(${attuned.length}/3)`;
            if (listEl) {
                if (attuned.length === 0) {
                    listEl.innerHTML = '<span class="text-muted">No attuned items</span>';
                } else {
                    listEl.innerHTML = attuned.map(item => `<div style="color: var(--accent-purple);">✦ ${item.name}</div>`).join('');
                }
            }
        }

        function updateACFromEquipment() {
            const dexMod = 2; // Character's DEX modifier
            let ac = 10 + dexMod; // Base AC (unarmored)

            const armor = getEquippedInSlot('armor');
            const shield = getEquippedInSlot('offHand');

            if (armor && armor.type === 'armor') {
                const maxDex = armor.maxDex !== undefined ? armor.maxDex : 99;
                const dexBonus = Math.min(dexMod, maxDex);
                ac = armor.baseAC + dexBonus;
                if (armor.magicBonus) ac += armor.magicBonus;
            }

            if (shield && shield.type === 'shield') {
                ac += shield.acBonus;
                if (shield.magicBonus) ac += shield.magicBonus;
            }

            const displayACEl = document.getElementById('displayAC');
            const acDisplayEl = document.getElementById('acDisplay');
            if (displayACEl) displayACEl.textContent = ac;
            if (acDisplayEl) acDisplayEl.textContent = 'AC: ' + ac;
        }

        function showSlotOptions(slot) {
            const currentItem = getEquippedInSlot(slot);
            let validItems = [];

            // Filter items that can go in this slot
            if (slot === 'mainHand') {
                validItems = state.inventory.filter(item => item.type === 'weapon' && !item.equipped);
            } else if (slot === 'offHand') {
                validItems = state.inventory.filter(item =>
                    ((item.type === 'weapon' && item.hands === 'one') || item.type === 'shield') && !item.equipped
                );
            } else if (slot === 'armor') {
                validItems = state.inventory.filter(item => item.type === 'armor' && !item.equipped);
            } else {
                validItems = state.inventory.filter(item =>
                    item.type === 'accessory' && item.slotType === slot && !item.equipped
                );
            }

            let body = '<div class="form-options">';

            if (currentItem) {
                body += `<div class="form-option" onclick="unequipFromSlot('${slot}')">
                    <div class="form-option-title" style="color: var(--accent-red);">✕ Unequip ${currentItem.name}</div>
                </div><hr style="border-color: var(--border-color); margin: 10px 0;">`;
            }

            if (validItems.length === 0) {
                body += '<p class="text-muted">No items available for this slot</p>';
            } else {
                validItems.forEach(item => {
                    let subtitle = '';
                    if (item.type === 'weapon') subtitle = `${item.damageDie} ${item.damageType}`;
                    else if (item.type === 'armor') subtitle = `AC ${item.baseAC}`;
                    else if (item.type === 'shield') subtitle = `+${item.acBonus} AC`;

                    body += `<div class="form-option" onclick="equipToSlot('${item.id}', '${slot}')">
                        <div class="form-option-title">${item.name}</div>
                        <div class="form-option-desc">${subtitle}</div>
                    </div>`;
                });
            }

            body += '</div>';
            showModal(getSlotLabel(slot), body);
        }

        function getSlotLabel(slot) {
            const labels = {
                mainHand: 'Main Hand', offHand: 'Off Hand', armor: 'Body Armor',
                head: 'Head', neck: 'Neck', hands: 'Hands', feet: 'Feet',
                ring1: 'Ring 1', ring2: 'Ring 2'
            };
            return labels[slot] || slot;
        }

        // Druid proficiencies (D&D 5e 2024)
        const CLASS_PROFICIENCIES = {
            weapons: ['simple'],  // Druids are only proficient with simple weapons
            armor: ['light'],      // Light armor only
            shields: true          // Shields (no metal)
        };

        function checkWeaponProficiency(weapon) {
            if (!weapon.category) return { proficient: true }; // No category = assume proficient
            if (CLASS_PROFICIENCIES.weapons.includes(weapon.category)) {
                return { proficient: true };
            }
            return {
                proficient: false,
                warning: '⚠️ Not proficient - no proficiency bonus to attack'
            };
        }

        function checkArmorProficiency(armor) {
            if (!armor.armorType) return { proficient: true };
            if (CLASS_PROFICIENCIES.armor.includes(armor.armorType)) {
                return { proficient: true };
            }
            return {
                proficient: false,
                warning: '⚠️ Not proficient - disadvantage on STR/DEX checks and saves, cannot cast spells'
            };
        }

        function equipToSlot(itemId, slot) {
            saveForUndo();
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            // Check if a two-handed weapon is currently equipped and we're replacing either hand
            if (slot === 'mainHand' || slot === 'offHand') {
                const twoHandedEquipped = state.inventory.find(i =>
                    i.equipped === 'twoHanded' || (i.equipped === 'mainHand' && i.hands === 'two')
                );
                if (twoHandedEquipped) {
                    twoHandedEquipped.equipped = null; // Fully unequip two-handed weapon
                }
            }

            // Handle two-handed weapons
            if (item.hands === 'two') {
                // Unequip both hand slots (automatic - no confirmation per user preference)
                state.inventory.forEach(i => {
                    if (i.equipped === 'mainHand' || i.equipped === 'offHand' || i.equipped === 'twoHanded') {
                        i.equipped = null;
                    }
                });
                item.equipped = 'twoHanded'; // Special marker for two-handed
            } else {
                // Unequip current item in slot
                state.inventory.forEach(i => {
                    if (i.equipped === slot) i.equipped = null;
                });
                item.equipped = slot;
            }

            closeModal();
            renderInventory();
            updateAttackOptions();
            updateResistancesDisplay();
            saveState();
        }

        function unequipFromSlot(slot) {
            saveForUndo();
            // If clicking on either hand slot with a two-handed weapon, unequip it
            if (slot === 'mainHand' || slot === 'offHand') {
                const twoHandedEquipped = state.inventory.find(i => i.equipped === 'twoHanded');
                if (twoHandedEquipped) {
                    twoHandedEquipped.equipped = null;
                    closeModal();
                    renderInventory();
                    updateAttackOptions();
                    updateResistancesDisplay();
                    saveState();
                    return;
                }
            }
            state.inventory.forEach(item => {
                if (item.equipped === slot) item.equipped = null;
            });
            closeModal();
            renderInventory();
            updateAttackOptions();
            updateResistancesDisplay();
            saveState();
        }

        function showItemOptions(itemId) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            let body = '<div class="form-options">';

            // Check proficiency and add warnings
            let profWarning = null;
            if (item.type === 'weapon') {
                const profCheck = checkWeaponProficiency(item);
                if (!profCheck.proficient) profWarning = profCheck.warning;
            } else if (item.type === 'armor') {
                const profCheck = checkArmorProficiency(item);
                if (!profCheck.proficient) profWarning = profCheck.warning;
            }

            // Show proficiency warning if applicable
            if (profWarning) {
                body += `<div style="background: rgba(220,53,69,0.15); padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9em; color: var(--accent-red);">${profWarning}</div>`;
            }

            // Equip options based on item type
            if (item.type === 'weapon') {
                body += `<div class="form-option" onclick="equipToSlot('${itemId}', 'mainHand')">
                    <div class="form-option-title">⚔️ Equip to Main Hand</div>
                </div>`;
                if (item.hands === 'one') {
                    body += `<div class="form-option" onclick="equipToSlot('${itemId}', 'offHand')">
                        <div class="form-option-title">🛡️ Equip to Off Hand</div>
                    </div>`;
                }
            } else if (item.type === 'shield') {
                body += `<div class="form-option" onclick="equipToSlot('${itemId}', 'offHand')">
                    <div class="form-option-title">🛡️ Equip Shield</div>
                </div>`;
            } else if (item.type === 'armor') {
                body += `<div class="form-option" onclick="equipToSlot('${itemId}', 'armor')">
                    <div class="form-option-title">🛡️ Equip Armor</div>
                </div>`;
            }

            // Info
            body += `<hr style="border-color: var(--border-color); margin: 10px 0;">`;
            body += `<div style="padding: 10px; font-size: 0.9em;">`;
            body += `<strong>${item.name}</strong><br>`;
            if (item.type === 'weapon') {
                const cat = item.category ? item.category.charAt(0).toUpperCase() + item.category.slice(1) : 'Unknown';
                const profCheck = checkWeaponProficiency(item);
                body += `Category: ${cat} ${profCheck.proficient ? '<span style="color:var(--accent-green);">✓</span>' : '<span style="color:var(--accent-red);">✗</span>'}<br>`;
                body += `Damage: ${item.damageDie} ${item.damageType}<br>`;
                body += `Type: ${item.weaponType}, ${item.hands}-handed<br>`;
                if (item.range) body += `Range: ${item.range} ft<br>`;
                if (item.properties) body += `Properties: ${item.properties.join(', ')}`;
            } else if (item.type === 'armor') {
                body += `AC: ${item.baseAC} + DEX (max ${item.maxDex})<br>`;
                body += `Type: ${item.armorType}`;
            } else if (item.type === 'shield') {
                body += `AC Bonus: +${item.acBonus}`;
                if (item.magicBonus) body += ` (+${item.magicBonus} magic)`;
            }
            if (item.isMagic) {
                body += `<br><span style="color: var(--accent-purple);">✦ Magic Item</span>`;
                if (item.requiresAttunement) body += ` <span style="color: var(--text-muted);">(Attunement)</span>`;

                // Show attack/damage bonuses for weapons
                if (item.type === 'weapon' && (item.attackBonus || item.damageBonus)) {
                    body += `<br>+${item.attackBonus || 0} attack, +${item.damageBonus || 0} damage`;
                }

                // Show magic bonus for armor
                if (item.type === 'armor' && item.magicBonus) {
                    body += `<br>+${item.magicBonus} AC bonus`;
                }

                // Display effects
                if (item.effects && item.effects.length > 0) {
                    body += `<br><div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color);">`;
                    body += `<strong style="color: var(--accent-purple);">Effects:</strong>`;
                    item.effects.forEach(effect => {
                        const desc = getEffectDescription(effect);
                        const info = EFFECT_TYPES[effect.type] || { icon: '✦' };
                        body += `<br><span style="color: var(--text-secondary);">${info.icon} ${desc}</span>`;
                    });
                    body += `</div>`;
                }

                // Legacy: show old effect text if present
                if (item.effect) {
                    body += `<br><span style="color: var(--text-secondary);">${item.effect}</span>`;
                }
            }
            body += `</div>`;

            body += '</div>';
            showModal(item.name, body);
        }

        function deleteInventoryItem(itemId) {
            if (!confirm('Delete this item?')) return;
            saveForUndo();
            state.inventory = state.inventory.filter(item => item.id !== itemId);
            closeModal();
            renderInventory();
            updateAttackOptions();
            saveState();
        }

        function updateAttackOptions() {
            // This will update the attack menu to reflect equipped weapons
            // Called when weapons are equipped/unequipped
        }

        function updateResistancesDisplay() {
            const display = document.getElementById('resistancesDisplay');
            if (!display) return;

            // Base character resistances (Half-Aasimar/Half-Tiefling heritage)
            const baseResistances = ['necrotic', 'radiant'];

            // Collect all effects from equipped magic items
            const itemResistances = [];
            const immunities = [];
            const conditionImmunities = [];

            if (state.inventory) {
                state.inventory.forEach(item => {
                    if (!item.equipped || !item.isMagic || !item.effects) return;

                    item.effects.forEach(effect => {
                        switch(effect.type) {
                            case 'resistance':
                                if (!itemResistances.includes(effect.damageType) && !baseResistances.includes(effect.damageType)) {
                                    itemResistances.push(effect.damageType);
                                }
                                break;
                            case 'immunity':
                                if (!immunities.includes(effect.damageType)) {
                                    immunities.push(effect.damageType);
                                }
                                break;
                            case 'conditionImmunity':
                                if (!conditionImmunities.includes(effect.condition)) {
                                    conditionImmunities.push(effect.condition);
                                }
                                break;
                        }
                    });
                });
            }

            let html = '<div class="resistance-tags">';

            // Base character resistances (always shown)
            baseResistances.forEach(r => {
                html += `<span class="resistance-tag">Resist ${r}</span>`;
            });

            // Item resistances
            itemResistances.forEach(r => {
                html += `<span class="resistance-tag" style="border-color: var(--accent-purple); background: rgba(123, 104, 238, 0.15);">Resist ${r} ✦</span>`;
            });

            // Damage Immunities
            immunities.forEach(i => {
                html += `<span class="resistance-tag immunity-tag">Immune ${i}</span>`;
            });

            // Condition Immunities
            conditionImmunities.forEach(c => {
                html += `<span class="resistance-tag immunity-tag">Immune ${c}</span>`;
            });

            html += '</div>';
            display.innerHTML = html;
        }

        // Add Equipment Modal
        function openAddEquipmentModal() {
            const body = `
                <div class="form-options">
                    <div class="form-option" onclick="openAddWeaponForm()">
                        <div class="form-option-title">⚔️ Add Weapon</div>
                        <div class="form-option-desc">Melee, ranged, or thrown weapons</div>
                    </div>
                    <div class="form-option" onclick="openAddArmorForm()">
                        <div class="form-option-title">🛡️ Add Armor</div>
                        <div class="form-option-desc">Body armor (light, medium, heavy)</div>
                    </div>
                    <div class="form-option" onclick="openAddShieldForm()">
                        <div class="form-option-title">🛡️ Add Shield</div>
                        <div class="form-option-desc">Shields and bucklers</div>
                    </div>
                    <div class="form-option" onclick="openAddAccessoryForm()">
                        <div class="form-option-title">💍 Add Accessory</div>
                        <div class="form-option-desc">Rings, amulets, boots, etc.</div>
                    </div>
                </div>
            `;
            showModal('Add Equipment', body);
        }

        // ===== MAGIC ITEM EFFECTS SYSTEM =====
        const EFFECT_TYPES = {
            resistance: { icon: '🛡️', label: 'Damage Resistance' },
            immunity: { icon: '⭐', label: 'Damage Immunity' },
            conditionImmunity: { icon: '✨', label: 'Condition Immunity' },
            extraDamage: { icon: '⚔️', label: 'Extra Damage' },
            extraDamageVs: { icon: '🎯', label: 'Extra Damage vs Creature Type' },
            speed: { icon: '💨', label: 'Movement Speed' },
            advantage: { icon: '🎲', label: 'Advantage on Checks' },
            light: { icon: '💡', label: 'Light Source' },
            darkvision: { icon: '👁️', label: 'Darkvision' },
            charges: { icon: '⚡', label: 'Charges (with spells)' },
            spell: { icon: '✨', label: 'Grants Spell (at-will or 1/day)' },
            description: { icon: '📜', label: 'Description/Flavor' }
        };

        const DAMAGE_TYPES = ['Acid', 'Cold', 'Fire', 'Force', 'Lightning', 'Necrotic', 'Poison', 'Psychic', 'Radiant', 'Thunder', 'Bludgeoning', 'Piercing', 'Slashing'];
        const CONDITIONS = ['Blinded', 'Charmed', 'Deafened', 'Frightened', 'Grappled', 'Paralyzed', 'Petrified', 'Poisoned', 'Prone', 'Restrained', 'Stunned', 'Unconscious'];
        const CREATURE_TYPES = ['Aberrations', 'Beasts', 'Celestials', 'Constructs', 'Dragons', 'Elementals', 'Fey', 'Fiends', 'Giants', 'Monstrosities', 'Oozes', 'Plants', 'Undead'];
        const SPEED_TYPES = ['Walking', 'Flying', 'Swimming', 'Climbing', 'Burrowing'];

        // Common spells that magic items can grant
        const ITEM_SPELLS = [
            { name: 'Detect Magic', level: 1 },
            { name: 'Shield', level: 1 },
            { name: 'Feather Fall', level: 1 },
            { name: 'Healing Word', level: 1 },
            { name: 'Cure Wounds', level: 1 },
            { name: 'Invisibility', level: 2 },
            { name: 'Levitate', level: 2 },
            { name: 'Misty Step', level: 2 },
            { name: 'Darkness', level: 2 },
            { name: 'Spider Climb', level: 2 },
            { name: 'Fly', level: 3 },
            { name: 'Fireball', level: 3 },
            { name: 'Lightning Bolt', level: 3 },
            { name: 'Dispel Magic', level: 3 },
            { name: 'Revivify', level: 3 },
            { name: 'Greater Invisibility', level: 4 },
            { name: 'Polymorph', level: 4 },
            { name: 'Wall of Fire', level: 4 },
            { name: 'Raise Dead', level: 5 },
            { name: 'Teleportation Circle', level: 5 },
            { name: 'Other (Custom)', level: 0 }
        ];

        // Temporary storage for effects being added to items
        let tempEffects = { weapon: [], armor: [], shield: [], accessory: [] };

        function showAddEffectForm(itemType) {
            const formEl = document.getElementById(itemType + 'EffectForm');
            if (!formEl) return;

            formEl.style.display = 'block';
            formEl.innerHTML = `
                <div class="effect-form">
                    <label>Effect Type</label>
                    <select id="${itemType}EffectType" onchange="updateEffectOptions('${itemType}')">
                        <option value="">Select effect type...</option>
                        ${Object.entries(EFFECT_TYPES).map(([key, val]) =>
                            `<option value="${key}">${val.icon} ${val.label}</option>`
                        ).join('')}
                    </select>
                    <div id="${itemType}EffectOptions"></div>
                    <div class="effect-form-buttons">
                        <button onclick="cancelAddEffect('${itemType}')" style="background: var(--bg-card);">Cancel</button>
                        <button onclick="confirmAddEffect('${itemType}')" style="background: var(--accent-green);">Add</button>
                    </div>
                </div>
            `;
        }

        function updateEffectOptions(itemType) {
            const effectType = document.getElementById(itemType + 'EffectType').value;
            const optionsEl = document.getElementById(itemType + 'EffectOptions');
            if (!optionsEl) return;

            let html = '';
            switch(effectType) {
                case 'resistance':
                case 'immunity':
                    html = `
                        <label style="margin-top:8px;">Damage Type</label>
                        <select id="${itemType}EffectValue">
                            ${DAMAGE_TYPES.map(t => `<option value="${t.toLowerCase()}">${t}</option>`).join('')}
                        </select>`;
                    break;
                case 'conditionImmunity':
                    html = `
                        <label style="margin-top:8px;">Condition</label>
                        <select id="${itemType}EffectValue">
                            ${CONDITIONS.map(c => `<option value="${c.toLowerCase()}">${c}</option>`).join('')}
                        </select>`;
                    break;
                case 'extraDamage':
                    html = `
                        <div class="effect-form-row">
                            <div>
                                <label>Dice</label>
                                <select id="${itemType}EffectDice">
                                    <option value="1d4">1d4</option>
                                    <option value="1d6">1d6</option>
                                    <option value="2d6" selected>2d6</option>
                                    <option value="1d8">1d8</option>
                                    <option value="2d8">2d8</option>
                                    <option value="1d10">1d10</option>
                                    <option value="2d10">2d10</option>
                                </select>
                            </div>
                            <div>
                                <label>Damage Type</label>
                                <select id="${itemType}EffectValue">
                                    ${DAMAGE_TYPES.map(t => `<option value="${t.toLowerCase()}">${t}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="effect-form-row" style="margin-top:8px;">
                            <div>
                                <label>Save DC (optional)</label>
                                <select id="${itemType}EffectSaveDC" onchange="toggleExtraDamageDC('${itemType}')">
                                    <option value="">No save (automatic)</option>
                                    <option value="character">Character's DC (15)</option>
                                    <option value="STR">STR save</option>
                                    <option value="DEX">DEX save</option>
                                    <option value="CON">CON save</option>
                                    <option value="custom">Custom DC...</option>
                                </select>
                            </div>
                            <div id="${itemType}ExtraDmgDCInput" style="display:none;">
                                <label>DC Value</label>
                                <input type="number" id="${itemType}EffectCustomDC" value="15" min="1" max="30" style="width:60px;">
                            </div>
                        </div>
                        <div id="${itemType}ExtraDmgSaveEffect" style="display:none; margin-top:8px;">
                            <label>On Save</label>
                            <select id="${itemType}EffectOnSave">
                                <option value="half">Half damage</option>
                                <option value="none">No damage</option>
                            </select>
                        </div>
                        <label style="margin-top:8px;">Activation</label>
                        <select id="${itemType}EffectActivation">
                            <option value="always">Always Active</option>
                            <option value="bonusAction">Bonus Action (Command Word)</option>
                        </select>`;
                    break;
                case 'extraDamageVs':
                    html = `
                        <div class="effect-form-row">
                            <div>
                                <label>Dice</label>
                                <select id="${itemType}EffectDice">
                                    <option value="1d6">1d6</option>
                                    <option value="2d6">2d6</option>
                                    <option value="3d6" selected>3d6</option>
                                </select>
                            </div>
                            <div>
                                <label>Creature Type</label>
                                <select id="${itemType}EffectValue">
                                    ${CREATURE_TYPES.map(c => `<option value="${c.toLowerCase()}">${c}</option>`).join('')}
                                </select>
                            </div>
                        </div>`;
                    break;
                case 'speed':
                    html = `
                        <div class="effect-form-row">
                            <div>
                                <label>Speed Type</label>
                                <select id="${itemType}EffectValue">
                                    ${SPEED_TYPES.map(s => `<option value="${s.toLowerCase()}">${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label>Speed (ft)</label>
                                <input type="number" id="${itemType}EffectAmount" value="30" min="5" step="5">
                            </div>
                        </div>`;
                    break;
                case 'advantage':
                    html = `
                        <label style="margin-top:8px;">Advantage On</label>
                        <select id="${itemType}EffectValue">
                            <option value="stealthChecks">Stealth Checks</option>
                            <option value="perceptionChecks">Perception Checks</option>
                            <option value="initiativeRolls">Initiative Rolls</option>
                            <option value="savesVsSpells">Saving Throws vs Spells</option>
                            <option value="savesVsMagic">Saving Throws vs Magic</option>
                            <option value="savesVsFrightened">Saving Throws vs Frightened</option>
                            <option value="savesVsCharmed">Saving Throws vs Charmed</option>
                        </select>`;
                    break;
                case 'light':
                    html = `
                        <div class="effect-form-row">
                            <div>
                                <label>Bright (ft)</label>
                                <input type="number" id="${itemType}EffectBright" value="20" min="0" step="5">
                            </div>
                            <div>
                                <label>Dim (ft)</label>
                                <input type="number" id="${itemType}EffectDim" value="20" min="0" step="5">
                            </div>
                        </div>
                        <label style="margin-top:8px;">Activation</label>
                        <select id="${itemType}EffectActivation">
                            <option value="always">Always On</option>
                            <option value="bonusAction">Bonus Action Toggle</option>
                        </select>`;
                    break;
                case 'darkvision':
                    html = `
                        <label style="margin-top:8px;">Range (ft)</label>
                        <select id="${itemType}EffectValue">
                            <option value="60">60 ft</option>
                            <option value="120">120 ft</option>
                        </select>`;
                    break;
                case 'description':
                    html = `
                        <label style="margin-top:8px;">Description</label>
                        <input type="text" id="${itemType}EffectValue" placeholder="e.g., Glows faintly in darkness">`;
                    break;
                case 'charges':
                    html = `
                        <div class="effect-form-row">
                            <div>
                                <label>Max Charges</label>
                                <input type="number" id="${itemType}EffectMaxCharges" value="7" min="1" max="50">
                            </div>
                            <div>
                                <label>Recharge</label>
                                <select id="${itemType}EffectRecharge" onchange="updateRechargeOptions('${itemType}')">
                                    <option value="dawn">At Dawn</option>
                                    <option value="dusk">At Dusk</option>
                                    <option value="longRest">Long Rest</option>
                                    <option value="shortRest">Short Rest</option>
                                    <option value="never">Never</option>
                                </select>
                            </div>
                        </div>
                        <div id="${itemType}RechargeOptions">
                            <div class="effect-form-row" style="margin-top:8px;">
                                <div>
                                    <label>Recharge Dice</label>
                                    <select id="${itemType}EffectRechargeDice">
                                        <option value="1d4+1">1d4+1</option>
                                        <option value="1d6+1" selected>1d6+1</option>
                                        <option value="1d8+1">1d8+1</option>
                                        <option value="2d4">2d4</option>
                                        <option value="all">Full Recharge</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Break Chance</label>
                                    <select id="${itemType}EffectBreakChance">
                                        <option value="0">Never Breaks</option>
                                        <option value="1">On 1 (crumbles)</option>
                                        <option value="5">On 1-5 (5%)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <label style="margin-top:12px;">Spells (click to add)</label>
                        <div id="${itemType}ChargeSpellsList" style="margin-bottom:8px; font-size:0.9em;"></div>
                        <div class="effect-form-row">
                            <div style="flex:2;">
                                <select id="${itemType}ChargeSpellSelect" onchange="toggleChargeCustomSpell('${itemType}')">
                                    ${ITEM_SPELLS.map(s => `<option value="${s.name}">${s.name} (${s.level === 0 ? 'Cantrip' : 'Lvl ' + s.level})</option>`).join('')}
                                    <option value="custom">✨ Custom Spell...</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <input type="number" id="${itemType}ChargeSpellCost" value="1" min="1" max="10" placeholder="Cost">
                            </div>
                            <div>
                                <button type="button" onclick="addChargeSpell('${itemType}')" style="padding:8px 12px; background:var(--accent-green);">+</button>
                            </div>
                        </div>
                        <div id="${itemType}ChargeCustomSpellForm" style="display:none; margin-top:10px; padding:10px; background:rgba(100,149,237,0.1); border-radius:8px; font-size:0.9em;">
                            <div style="color:var(--accent-blue); font-weight:bold; margin-bottom:8px;">Custom Spell Details</div>
                            <div class="form-group" style="margin-bottom:8px;">
                                <input type="text" id="${itemType}ChargeCustomName" placeholder="Spell name">
                            </div>
                            <div class="effect-form-row">
                                <div>
                                    <label style="font-size:0.85em;">Level</label>
                                    <select id="${itemType}ChargeCustomLevel">
                                        <option value="0">Cantrip</option>
                                        <option value="1" selected>1st</option>
                                        <option value="2">2nd</option>
                                        <option value="3">3rd</option>
                                        <option value="4">4th</option>
                                        <option value="5">5th</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:0.85em;">School</label>
                                    <select id="${itemType}ChargeCustomSchool">
                                        <option value="Abjuration">Abjuration</option>
                                        <option value="Evocation">Evocation</option>
                                        <option value="Conjuration">Conjuration</option>
                                        <option value="Transmutation">Transmutation</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top:8px;">
                                <textarea id="${itemType}ChargeCustomDesc" rows="2" placeholder="Brief spell description (optional)"></textarea>
                            </div>
                        </div>`;
                    // Initialize empty spell list for this item
                    setTimeout(() => { if (!window.tempChargeSpells) window.tempChargeSpells = {}; window.tempChargeSpells[itemType] = []; }, 0);
                    break;
                case 'spell':
                    html = `
                        <label style="margin-top:8px;">Spell</label>
                        <select id="${itemType}EffectSpell" onchange="toggleCustomSpellForm('${itemType}')">
                            ${ITEM_SPELLS.map(s => `<option value="${s.name}" data-level="${s.level}">${s.name} (${s.level === 0 ? 'Cantrip' : 'Lvl ' + s.level})</option>`).join('')}
                        </select>
                        <div id="${itemType}CustomSpellForm" style="display:none; margin-top:12px; padding:12px; background:rgba(100,149,237,0.1); border-radius:8px;">
                            <div style="color:var(--accent-blue); font-weight:bold; margin-bottom:10px;">Custom Spell Details</div>
                            <div class="form-group">
                                <label>Spell Name</label>
                                <input type="text" id="${itemType}CustomSpellName" placeholder="Enter spell name">
                            </div>
                            <div class="effect-form-row">
                                <div>
                                    <label>School</label>
                                    <select id="${itemType}CustomSpellSchool">
                                        <option value="Abjuration">Abjuration</option>
                                        <option value="Conjuration">Conjuration</option>
                                        <option value="Divination">Divination</option>
                                        <option value="Enchantment">Enchantment</option>
                                        <option value="Evocation">Evocation</option>
                                        <option value="Illusion">Illusion</option>
                                        <option value="Necromancy">Necromancy</option>
                                        <option value="Transmutation">Transmutation</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Casting Time</label>
                                    <select id="${itemType}CustomSpellTime">
                                        <option value="Action">Action</option>
                                        <option value="Bonus Action">Bonus Action</option>
                                        <option value="Reaction">Reaction</option>
                                        <option value="1 Minute">1 Minute</option>
                                        <option value="10 Minutes">10 Minutes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="effect-form-row" style="margin-top:8px;">
                                <div>
                                    <label>Range</label>
                                    <select id="${itemType}CustomSpellRange" onchange="toggleCustomRange('${itemType}')">
                                        <option value="Self">Self</option>
                                        <option value="Touch">Touch</option>
                                        <option value="30 feet">30 feet</option>
                                        <option value="60 feet">60 feet</option>
                                        <option value="90 feet">90 feet</option>
                                        <option value="120 feet">120 feet</option>
                                        <option value="Sight">Sight</option>
                                        <option value="custom">Other...</option>
                                    </select>
                                    <input type="number" id="${itemType}CustomSpellRangeFeet" placeholder="feet" style="display:none; margin-top:5px; width:80px;" min="5" step="5">
                                </div>
                                <div>
                                    <label>Duration</label>
                                    <select id="${itemType}CustomSpellDuration">
                                        <option value="Instantaneous">Instantaneous</option>
                                        <option value="1 round">1 round</option>
                                        <option value="1 minute">1 minute</option>
                                        <option value="10 minutes">10 minutes</option>
                                        <option value="1 hour">1 hour</option>
                                        <option value="8 hours">8 hours</option>
                                        <option value="24 hours">24 hours</option>
                                        <option value="Until dispelled">Until dispelled</option>
                                        <option value="Special">Special</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top:8px;">
                                <label>Area of Effect (optional)</label>
                                <div class="effect-form-row">
                                    <select id="${itemType}CustomSpellAreaShape">
                                        <option value="">No area</option>
                                        <option value="Sphere">Sphere</option>
                                        <option value="Cube">Cube</option>
                                        <option value="Cone">Cone</option>
                                        <option value="Line">Line</option>
                                        <option value="Cylinder">Cylinder</option>
                                    </select>
                                    <input type="number" id="${itemType}CustomSpellAreaSize" placeholder="Size (ft)" style="width:80px;" min="5" step="5">
                                </div>
                            </div>
                            <div class="effect-form-row" style="margin-top:8px;">
                                <div style="display:flex; gap:10px; align-items:center;">
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}CustomSpellConc" style="width:18px; height:18px;">
                                        <span>Concentration</span>
                                    </label>
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}CustomSpellRitual" style="width:18px; height:18px;">
                                        <span>Ritual</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top:8px;">
                                <label>Components</label>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}CustomSpellV" checked style="width:18px; height:18px;">
                                        <span>V</span>
                                    </label>
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}CustomSpellS" checked style="width:18px; height:18px;">
                                        <span>S</span>
                                    </label>
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}CustomSpellM" style="width:18px; height:18px;">
                                        <span>M</span>
                                    </label>
                                </div>
                                <input type="text" id="${itemType}CustomSpellMaterial" placeholder="Material component details (if M)" style="margin-top:5px; display:none;">
                            </div>
                            <div class="effect-form-row" style="margin-top:8px;">
                                <div>
                                    <label>Damage/Healing</label>
                                    <input type="text" id="${itemType}CustomSpellDamage" placeholder="e.g., 8d6 fire">
                                </div>
                                <div>
                                    <label>Save DC</label>
                                    <select id="${itemType}CustomSpellSave" onchange="toggleCustomDC('${itemType}')">
                                        <option value="">None</option>
                                        <option value="character">Character's DC (15)</option>
                                        <option value="STR">STR save</option>
                                        <option value="DEX">DEX save</option>
                                        <option value="CON">CON save</option>
                                        <option value="INT">INT save</option>
                                        <option value="WIS">WIS save</option>
                                        <option value="CHA">CHA save</option>
                                        <option value="custom">Custom DC...</option>
                                    </select>
                                    <input type="number" id="${itemType}CustomSpellDCValue" placeholder="DC" style="display:none; margin-top:5px; width:60px;" min="1" max="30">
                                </div>
                            </div>
                            <div class="form-group" style="margin-top:8px;">
                                <label>Description</label>
                                <textarea id="${itemType}CustomSpellDesc" rows="3" placeholder="Full spell description..."></textarea>
                            </div>
                            <div class="form-group" style="margin-top:8px;">
                                <label>Upcast Scaling (optional)</label>
                                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                                    <input type="text" id="${itemType}CustomSpellUpcastDice" placeholder="Extra dice" style="width:80px;">
                                    <span style="color:var(--text-muted);">per</span>
                                    <select id="${itemType}CustomSpellUpcastInterval" style="width:100px;">
                                        <option value="1">1 level</option>
                                        <option value="2">2 levels</option>
                                    </select>
                                    <span style="color:var(--text-muted);">above base</span>
                                </div>
                                <div style="font-size:0.8em; color:var(--text-muted); margin-top:4px;">e.g., "1d6" per 1 level = +1d6 at 2nd, +2d6 at 3rd...</div>
                            </div>
                        </div>
                        <div class="effect-form-row" style="margin-top:8px;">
                            <div>
                                <label>Spell Level</label>
                                <select id="${itemType}EffectSpellLevel">
                                    <option value="0">Cantrip</option>
                                    <option value="1" selected>1st</option>
                                    <option value="2">2nd</option>
                                    <option value="3">3rd</option>
                                    <option value="4">4th</option>
                                    <option value="5">5th</option>
                                </select>
                            </div>
                            <div>
                                <label>Usage</label>
                                <select id="${itemType}EffectSpellUsage">
                                    <option value="atWill">At Will</option>
                                    <option value="1/day" selected>1/Day</option>
                                    <option value="2/day">2/Day</option>
                                    <option value="3/day">3/Day</option>
                                </select>
                            </div>
                        </div>
                        <label style="margin-top:8px;">Spellcasting Ability (for save DC)</label>
                        <select id="${itemType}EffectSpellAbility">
                            <option value="item">Item's DC (use item DC)</option>
                            <option value="wis">Wisdom (your DC)</option>
                            <option value="int">Intelligence (your DC)</option>
                            <option value="cha">Charisma (your DC)</option>
                        </select>`;
                    // Set up material component toggle
                    setTimeout(() => {
                        const mCheckbox = document.getElementById(itemType + 'CustomSpellM');
                        const mInput = document.getElementById(itemType + 'CustomSpellMaterial');
                        if (mCheckbox && mInput) {
                            mCheckbox.addEventListener('change', () => {
                                mInput.style.display = mCheckbox.checked ? 'block' : 'none';
                            });
                        }
                    }, 50);
                    break;
            }
            optionsEl.innerHTML = html;
        }

        function confirmAddEffect(itemType) {
            const effectType = document.getElementById(itemType + 'EffectType').value;
            if (!effectType) { alert('Please select an effect type'); return; }

            const effect = { type: effectType };

            switch(effectType) {
                case 'resistance':
                case 'immunity':
                    effect.damageType = document.getElementById(itemType + 'EffectValue').value;
                    break;
                case 'conditionImmunity':
                    effect.condition = document.getElementById(itemType + 'EffectValue').value;
                    break;
                case 'extraDamage':
                    effect.dice = document.getElementById(itemType + 'EffectDice').value;
                    effect.damageType = document.getElementById(itemType + 'EffectValue').value;
                    effect.activation = document.getElementById(itemType + 'EffectActivation').value;
                    const saveDC = document.getElementById(itemType + 'EffectSaveDC').value;
                    if (saveDC) {
                        effect.saveDC = saveDC;
                        if (saveDC === 'custom') {
                            effect.customDC = parseInt(document.getElementById(itemType + 'EffectCustomDC').value) || 15;
                        }
                        effect.onSave = document.getElementById(itemType + 'EffectOnSave').value;
                    }
                    break;
                case 'extraDamageVs':
                    effect.dice = document.getElementById(itemType + 'EffectDice').value;
                    effect.creatureType = document.getElementById(itemType + 'EffectValue').value;
                    break;
                case 'speed':
                    effect.speedType = document.getElementById(itemType + 'EffectValue').value;
                    effect.value = parseInt(document.getElementById(itemType + 'EffectAmount').value);
                    break;
                case 'advantage':
                    effect.on = document.getElementById(itemType + 'EffectValue').value;
                    break;
                case 'light':
                    effect.bright = parseInt(document.getElementById(itemType + 'EffectBright').value);
                    effect.dim = parseInt(document.getElementById(itemType + 'EffectDim').value);
                    effect.activation = document.getElementById(itemType + 'EffectActivation').value;
                    break;
                case 'darkvision':
                    effect.range = parseInt(document.getElementById(itemType + 'EffectValue').value);
                    break;
                case 'description':
                    effect.text = document.getElementById(itemType + 'EffectValue').value;
                    if (!effect.text) { alert('Please enter a description'); return; }
                    break;
                case 'charges':
                    effect.maxCharges = parseInt(document.getElementById(itemType + 'EffectMaxCharges').value);
                    effect.recharge = document.getElementById(itemType + 'EffectRecharge').value;
                    if (effect.recharge !== 'never') {
                        effect.rechargeDice = document.getElementById(itemType + 'EffectRechargeDice').value;
                        effect.breakChance = parseInt(document.getElementById(itemType + 'EffectBreakChance').value);
                    }
                    effect.spells = window.tempChargeSpells && window.tempChargeSpells[itemType] ? [...window.tempChargeSpells[itemType]] : [];
                    if (effect.spells.length === 0) {
                        alert('Please add at least one spell to use with charges');
                        return;
                    }
                    break;
                case 'spell':
                    const spellSelect = document.getElementById(itemType + 'EffectSpell');
                    const spellName = spellSelect.value;
                    if (spellName === 'Other (Custom)') {
                        effect.spell = document.getElementById(itemType + 'CustomSpellName').value;
                        if (!effect.spell) { alert('Please enter a custom spell name'); return; }
                        effect.isCustom = true;
                        // Get range value (handle custom feet input)
                        const rangeSelect = document.getElementById(itemType + 'CustomSpellRange').value;
                        const rangeFeet = document.getElementById(itemType + 'CustomSpellRangeFeet').value;
                        const rangeValue = rangeSelect === 'custom' && rangeFeet ? `${rangeFeet} feet` : rangeSelect;
                        // Get save DC (handle custom DC input)
                        const saveSelect = document.getElementById(itemType + 'CustomSpellSave').value;
                        const customDC = document.getElementById(itemType + 'CustomSpellDCValue').value;
                        // Get area effect
                        const areaShape = document.getElementById(itemType + 'CustomSpellAreaShape').value;
                        const areaSize = document.getElementById(itemType + 'CustomSpellAreaSize').value;
                        // Get upcast scaling
                        const upcastDice = document.getElementById(itemType + 'CustomSpellUpcastDice').value;
                        const upcastInterval = document.getElementById(itemType + 'CustomSpellUpcastInterval').value;
                        // Capture full custom spell details
                        effect.spellDetails = {
                            school: document.getElementById(itemType + 'CustomSpellSchool').value,
                            castingTime: document.getElementById(itemType + 'CustomSpellTime').value,
                            range: rangeValue,
                            duration: document.getElementById(itemType + 'CustomSpellDuration').value,
                            concentration: document.getElementById(itemType + 'CustomSpellConc').checked,
                            ritual: document.getElementById(itemType + 'CustomSpellRitual').checked,
                            components: {
                                v: document.getElementById(itemType + 'CustomSpellV').checked,
                                s: document.getElementById(itemType + 'CustomSpellS').checked,
                                m: document.getElementById(itemType + 'CustomSpellM').checked,
                                material: document.getElementById(itemType + 'CustomSpellMaterial').value || null
                            },
                            area: areaShape ? { shape: areaShape, size: parseInt(areaSize) || 0 } : null,
                            damage: document.getElementById(itemType + 'CustomSpellDamage').value || null,
                            save: saveSelect || null,
                            customDC: saveSelect === 'custom' && customDC ? parseInt(customDC) : null,
                            description: document.getElementById(itemType + 'CustomSpellDesc').value || null,
                            upcast: upcastDice ? { dice: upcastDice, interval: parseInt(upcastInterval) || 1 } : null
                        };
                    } else {
                        effect.spell = spellName;
                        effect.isCustom = false;
                    }
                    effect.spellLevel = parseInt(document.getElementById(itemType + 'EffectSpellLevel').value);
                    effect.usage = document.getElementById(itemType + 'EffectSpellUsage').value;
                    effect.ability = document.getElementById(itemType + 'EffectSpellAbility').value;
                    break;
            }

            tempEffects[itemType].push(effect);
            renderEffectsList(itemType);
            cancelAddEffect(itemType);
        }

        function cancelAddEffect(itemType) {
            const formEl = document.getElementById(itemType + 'EffectForm');
            if (formEl) formEl.style.display = 'none';
        }

        function removeEffect(itemType, index) {
            tempEffects[itemType].splice(index, 1);
            renderEffectsList(itemType);
        }

        function renderEffectsList(itemType) {
            const listEl = document.getElementById(itemType + 'EffectsList');
            if (!listEl) return;

            if (tempEffects[itemType].length === 0) {
                listEl.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85em; padding: 8px;">No effects added</div>';
                return;
            }

            listEl.innerHTML = tempEffects[itemType].map((effect, i) => {
                const info = EFFECT_TYPES[effect.type] || { icon: '❓', label: effect.type };
                let desc = getEffectDescription(effect);
                return `
                    <div class="effect-item">
                        <span class="effect-icon">${info.icon}</span>
                        <span class="effect-text">${desc}</span>
                        <span class="effect-remove" onclick="removeEffect('${itemType}', ${i})">✕</span>
                    </div>
                `;
            }).join('');
        }

        function getEffectDescription(effect) {
            switch(effect.type) {
                case 'resistance': return `Resistance to ${effect.damageType} damage`;
                case 'immunity': return `Immunity to ${effect.damageType} damage`;
                case 'conditionImmunity': return `Immunity to ${effect.condition}`;
                case 'extraDamage':
                    let dmgDesc = `+${effect.dice} ${effect.damageType}`;
                    if (effect.saveDC) {
                        const dcVal = effect.saveDC === 'character' ? '15' : (effect.saveDC === 'custom' ? effect.customDC : effect.saveDC);
                        const saveType = effect.saveDC === 'character' || effect.saveDC === 'custom' ? '' : ` ${effect.saveDC}`;
                        dmgDesc += ` (DC ${dcVal}${saveType} save, ${effect.onSave === 'half' ? 'half on save' : 'none on save'})`;
                    }
                    return effect.activation === 'always' ? dmgDesc : `${dmgDesc} (command word)`;
                case 'extraDamageVs': return `+${effect.dice} damage vs ${effect.creatureType}`;
                case 'speed': return `${effect.speedType} speed ${effect.value} ft`;
                case 'advantage':
                    const advLabels = {
                        stealthChecks: 'Stealth checks',
                        perceptionChecks: 'Perception checks',
                        initiativeRolls: 'Initiative',
                        savesVsSpells: 'saves vs spells',
                        savesVsMagic: 'saves vs magic',
                        savesVsFrightened: 'saves vs frightened',
                        savesVsCharmed: 'saves vs charmed'
                    };
                    return `Advantage on ${advLabels[effect.on] || effect.on}`;
                case 'light':
                    return effect.activation === 'always'
                        ? `Light: ${effect.bright}/${effect.dim} ft`
                        : `Light: ${effect.bright}/${effect.dim} ft (toggle)`;
                case 'darkvision': return `Darkvision ${effect.range} ft`;
                case 'description': return effect.text;
                case 'charges':
                    const spellNames = effect.spells.map(s => s.name).join(', ');
                    const rechargeText = effect.recharge === 'never' ? 'no recharge' : `recharges at ${effect.recharge}`;
                    return `${effect.maxCharges} charges (${rechargeText}) - ${spellNames}`;
                case 'spell':
                    const usageText = effect.usage === 'atWill' ? 'at will' : effect.usage;
                    return `${effect.spell} (${usageText})`;
                default: return effect.type;
            }
        }

        // Helper functions for charges effect type
        function updateRechargeOptions(itemType) {
            const rechargeType = document.getElementById(itemType + 'EffectRecharge').value;
            const optionsEl = document.getElementById(itemType + 'RechargeOptions');
            if (optionsEl) {
                optionsEl.style.display = rechargeType === 'never' ? 'none' : 'block';
            }
        }

        function toggleChargeCustomSpell(itemType) {
            const spellSelect = document.getElementById(itemType + 'ChargeSpellSelect');
            const customForm = document.getElementById(itemType + 'ChargeCustomSpellForm');
            if (customForm) {
                customForm.style.display = spellSelect.value === 'custom' ? 'block' : 'none';
            }
        }

        function addChargeSpell(itemType) {
            const spellSelect = document.getElementById(itemType + 'ChargeSpellSelect');
            const costInput = document.getElementById(itemType + 'ChargeSpellCost');
            const spellValue = spellSelect.value;
            const cost = parseInt(costInput.value) || 1;

            if (!window.tempChargeSpells) window.tempChargeSpells = {};
            if (!window.tempChargeSpells[itemType]) window.tempChargeSpells[itemType] = [];

            let spellName, level, isCustom = false, customDetails = null;

            if (spellValue === 'custom') {
                // Handle custom spell
                spellName = document.getElementById(itemType + 'ChargeCustomName').value.trim();
                if (!spellName) {
                    alert('Please enter a custom spell name');
                    return;
                }
                level = parseInt(document.getElementById(itemType + 'ChargeCustomLevel').value);
                isCustom = true;
                customDetails = {
                    school: document.getElementById(itemType + 'ChargeCustomSchool').value,
                    description: document.getElementById(itemType + 'ChargeCustomDesc').value || null
                };
            } else {
                spellName = spellValue;
                // Get spell level from ITEM_SPELLS
                const spellData = ITEM_SPELLS.find(s => s.name === spellName);
                level = spellData ? spellData.level : 1;
            }

            // Check if spell already exists
            if (window.tempChargeSpells[itemType].find(s => s.name === spellName)) {
                alert('This spell is already added');
                return;
            }

            const spellEntry = { name: spellName, cost: cost, level: level };
            if (isCustom) {
                spellEntry.isCustom = true;
                spellEntry.customDetails = customDetails;
            }

            window.tempChargeSpells[itemType].push(spellEntry);
            renderChargeSpells(itemType);
            costInput.value = '1'; // Reset cost

            // Reset custom form if used
            if (spellValue === 'custom') {
                document.getElementById(itemType + 'ChargeCustomName').value = '';
                document.getElementById(itemType + 'ChargeCustomDesc').value = '';
                spellSelect.value = ITEM_SPELLS[0].name;
                toggleChargeCustomSpell(itemType);
            }
        }

        function renderChargeSpells(itemType) {
            const listEl = document.getElementById(itemType + 'ChargeSpellsList');
            if (!listEl) return;

            if (!window.tempChargeSpells || !window.tempChargeSpells[itemType] || window.tempChargeSpells[itemType].length === 0) {
                listEl.innerHTML = '<span style="color: var(--text-muted);">No spells added yet</span>';
                return;
            }

            listEl.innerHTML = window.tempChargeSpells[itemType].map((spell, i) => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:4px 8px; background:var(--bg-input); border-radius:4px; margin-bottom:4px;">
                    <span>${spell.isCustom ? '✨ ' : ''}${spell.name} (${spell.cost} charge${spell.cost > 1 ? 's' : ''})</span>
                    <span style="cursor:pointer; color:var(--accent-red);" onclick="removeChargeSpell('${itemType}', ${i})">✕</span>
                </div>
            `).join('');
        }

        function removeChargeSpell(itemType, index) {
            if (window.tempChargeSpells && window.tempChargeSpells[itemType]) {
                window.tempChargeSpells[itemType].splice(index, 1);
                renderChargeSpells(itemType);
            }
        }

        // Helper function for spell effect type - toggles custom spell form
        function toggleCustomSpellForm(itemType) {
            const spellSelect = document.getElementById(itemType + 'EffectSpell');
            const levelSelect = document.getElementById(itemType + 'EffectSpellLevel');
            const customForm = document.getElementById(itemType + 'CustomSpellForm');
            const selectedOption = spellSelect.options[spellSelect.selectedIndex];

            if (spellSelect.value === 'Other (Custom)') {
                if (customForm) customForm.style.display = 'block';
            } else {
                if (customForm) customForm.style.display = 'none';
                const level = selectedOption.dataset.level;
                if (level && levelSelect) {
                    levelSelect.value = level;
                }
            }
        }

        function toggleCustomRange(itemType) {
            const rangeSelect = document.getElementById(itemType + 'CustomSpellRange');
            const feetInput = document.getElementById(itemType + 'CustomSpellRangeFeet');
            if (rangeSelect && feetInput) {
                feetInput.style.display = rangeSelect.value === 'custom' ? 'block' : 'none';
            }
        }

        function toggleCustomDC(itemType) {
            const saveSelect = document.getElementById(itemType + 'CustomSpellSave');
            const dcInput = document.getElementById(itemType + 'CustomSpellDCValue');
            if (saveSelect && dcInput) {
                dcInput.style.display = saveSelect.value === 'custom' ? 'block' : 'none';
            }
        }

        function toggleExtraDamageDC(itemType) {
            const saveSelect = document.getElementById(itemType + 'EffectSaveDC');
            const dcInput = document.getElementById(itemType + 'ExtraDmgDCInput');
            const saveEffect = document.getElementById(itemType + 'ExtraDmgSaveEffect');
            if (saveSelect) {
                const hasSave = saveSelect.value !== '';
                if (dcInput) dcInput.style.display = saveSelect.value === 'custom' ? 'block' : 'none';
                if (saveEffect) saveEffect.style.display = hasSave ? 'block' : 'none';
            }
        }

        // Legacy alias for backwards compatibility
        function updateSpellLevelFromSelection(itemType) {
            toggleCustomSpellForm(itemType);
        }

        function resetTempEffects(itemType) {
            tempEffects[itemType] = [];
            const listEl = document.getElementById(itemType + 'EffectsList');
            if (listEl) listEl.innerHTML = '';
            // Also clear temporary charge spells
            if (window.tempChargeSpells && window.tempChargeSpells[itemType]) {
                window.tempChargeSpells[itemType] = [];
            }
        }

        // ===== ITEM CHARGES MANAGEMENT =====
        function initializeItemCharges(item) {
            // Check if item has a charges effect
            if (!item.effects) return;
            const chargesEffect = item.effects.find(e => e.type === 'charges');
            if (!chargesEffect) return;

            // Initialize charges if not already set
            if (!state.itemCharges[item.id]) {
                state.itemCharges[item.id] = {
                    current: chargesEffect.maxCharges,
                    max: chargesEffect.maxCharges
                };
            }
        }

        function getItemCharges(itemId) {
            return state.itemCharges[itemId] || null;
        }

        function useItemCharges(itemId, amount) {
            if (!state.itemCharges[itemId]) return false;
            if (state.itemCharges[itemId].current < amount) return false;

            saveForUndo();
            state.itemCharges[itemId].current -= amount;
            saveState();
            updateItemChargesDisplay();
            return true;
        }

        function getChargesEffectForItem(item) {
            if (!item.effects) return null;
            return item.effects.find(e => e.type === 'charges');
        }

        function rollDice(diceStr) {
            // Parse dice string like "1d6+1", "2d4", "all"
            if (diceStr === 'all') return Infinity; // Will be capped to max

            const match = diceStr.match(/(\d+)d(\d+)(?:\+(\d+))?/);
            if (!match) return 0;

            const numDice = parseInt(match[1]);
            const dieSize = parseInt(match[2]);
            const bonus = parseInt(match[3]) || 0;

            let total = bonus;
            for (let i = 0; i < numDice; i++) {
                total += Math.floor(Math.random() * dieSize) + 1;
            }
            return total;
        }

        function rechargeItems(rechargeTime) {
            // rechargeTime can be 'dawn', 'dusk', 'longRest', 'shortRest'
            let recharged = [];

            state.inventory.forEach(item => {
                const chargesEffect = getChargesEffectForItem(item);
                if (!chargesEffect) return;
                if (chargesEffect.recharge === 'never') return;
                if (chargesEffect.recharge !== rechargeTime) return;

                const charges = state.itemCharges[item.id];
                if (!charges) return;

                // Roll recharge dice
                let rechargeAmount = rollDice(chargesEffect.rechargeDice);
                if (rechargeAmount === Infinity) {
                    rechargeAmount = charges.max;
                }

                const oldCharges = charges.current;
                charges.current = Math.min(charges.current + rechargeAmount, charges.max);
                const gained = charges.current - oldCharges;

                if (gained > 0) {
                    recharged.push({ item: item.name, gained: gained, current: charges.current, max: charges.max });
                }

                // Check for break on last charge used (roll d20, break on specified value)
                if (oldCharges === 0 && chargesEffect.breakChance > 0) {
                    const breakRoll = Math.floor(Math.random() * 20) + 1;
                    if (breakRoll <= chargesEffect.breakChance) {
                        // Item breaks!
                        alert(`${item.name} crumbles to dust!`);
                        // Remove from inventory
                        const index = state.inventory.indexOf(item);
                        if (index > -1) {
                            state.inventory.splice(index, 1);
                            delete state.itemCharges[item.id];
                        }
                    }
                }
            });

            // Also reset 1/day spell usage
            if (rechargeTime === 'dawn' || rechargeTime === 'longRest') {
                state.itemSpellsUsed = {};
            }

            saveState();
            updateItemChargesDisplay();
            renderInventory();

            return recharged;
        }

        function castItemSpell(itemId, spellName, chargeCost) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) { alert('Item not found'); return false; }

            if (chargeCost > 0) {
                // Spell costs charges
                if (!useItemCharges(itemId, chargeCost)) {
                    alert(`Not enough charges! (need ${chargeCost})`);
                    return false;
                }
                // Check if item should break (expended last charge)
                const charges = state.itemCharges[itemId];
                const chargesEffect = getChargesEffectForItem(item);
                if (charges && charges.current === 0 && chargesEffect && chargesEffect.breakChance > 0) {
                    const breakRoll = Math.floor(Math.random() * 20) + 1;
                    if (breakRoll <= chargesEffect.breakChance) {
                        alert(`${item.name} crumbles to dust!`);
                        const index = state.inventory.indexOf(item);
                        if (index > -1) {
                            state.inventory.splice(index, 1);
                            delete state.itemCharges[item.id];
                        }
                        saveState();
                        renderInventory();
                    }
                }
            }

            // Log the cast
            if (state.inBattle) {
                state.battleLog.push(`Cast ${spellName} from ${item.name}`);
            }

            updateItemChargesDisplay();
            return true;
        }

        function castItemGrantedSpell(itemId, spellName, usage) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) { alert('Item not found'); return false; }

            const usageKey = `${itemId}_${spellName}`;

            if (usage !== 'atWill') {
                // Check if already used today
                if (state.itemSpellsUsed[usageKey]) {
                    alert(`${spellName} has already been used today!`);
                    return false;
                }
                // Mark as used
                saveForUndo();
                state.itemSpellsUsed[usageKey] = true;
                saveState();
            }

            // Log the cast
            if (state.inBattle) {
                state.battleLog.push(`Cast ${spellName} from ${item.name}`);
            }

            updateItemChargesDisplay();
            return true;
        }

        function updateItemChargesDisplay() {
            const chargesContainer = document.getElementById('itemChargesDisplay');
            if (!chargesContainer) return;

            let html = '';
            let hasChargedItems = false;

            state.inventory.forEach(item => {
                // Initialize charges if needed
                initializeItemCharges(item);

                const chargesEffect = getChargesEffectForItem(item);
                if (chargesEffect) {
                    const charges = state.itemCharges[item.id];
                    if (charges) {
                        hasChargedItems = true;
                        const percentage = (charges.current / charges.max) * 100;
                        html += `
                            <div class="item-charges-row" onclick="showItemChargesModal('${item.id}')">
                                <span class="item-charges-name">${item.name}</span>
                                <div class="item-charges-bar">
                                    <div class="item-charges-fill" style="width: ${percentage}%"></div>
                                </div>
                                <span class="item-charges-count">${charges.current}/${charges.max}</span>
                            </div>
                        `;
                    }
                }

                // Also show spell effects with usage (non-at-will)
                if (item.effects) {
                    item.effects.filter(e => e.type === 'spell' && e.usage !== 'atWill').forEach(effect => {
                        hasChargedItems = true;
                        const usageKey = `${item.id}_${effect.spell}`;
                        const used = state.itemSpellsUsed[usageKey];
                        html += `
                            <div class="item-spell-row ${used ? 'used' : ''}" onclick="showItemSpellModal('${item.id}', '${effect.spell}')">
                                <span class="item-spell-name">${effect.spell} (${item.name})</span>
                                <span class="item-spell-usage">${used ? 'Used' : effect.usage}</span>
                            </div>
                        `;
                    });
                }
            });

            // Show/hide the integrated charges section
            chargesContainer.style.display = hasChargedItems ? 'block' : 'none';

            if (hasChargedItems) {
                chargesContainer.innerHTML = '<div style="font-size: 0.85em; color: var(--accent-purple); margin-bottom: 8px;">⚡ Magic Item Charges</div>' + html;
            }
        }

        function showItemChargesModal(itemId) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            const chargesEffect = getChargesEffectForItem(item);
            if (!chargesEffect) return;

            const charges = state.itemCharges[itemId];
            if (!charges) return;

            let spellsHtml = chargesEffect.spells.map(spell => `
                <div class="charge-spell-option" onclick="castItemSpell('${itemId}', '${spell.name}', ${spell.cost})">
                    <span class="charge-spell-name">${spell.name}</span>
                    <span class="charge-spell-cost">${spell.cost} charge${spell.cost > 1 ? 's' : ''}</span>
                </div>
            `).join('');

            const body = `
                <div class="item-charges-modal">
                    <div class="charges-header">
                        <span>Charges: ${charges.current} / ${charges.max}</span>
                        <span class="recharge-info">${chargesEffect.recharge === 'never' ? 'No recharge' : 'Recharges at ' + chargesEffect.recharge}</span>
                    </div>
                    <div class="charges-bar-large">
                        <div class="charges-fill-large" style="width: ${(charges.current / charges.max) * 100}%"></div>
                    </div>
                    <h4 style="margin: 15px 0 10px;">Cast Spell:</h4>
                    <div class="charge-spells-list">
                        ${spellsHtml}
                    </div>
                </div>
            `;

            showModal(item.name, body);
        }

        function showItemSpellModal(itemId, spellName) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            const spellEffect = item.effects.find(e => e.type === 'spell' && e.spell === spellName);
            if (!spellEffect) return;

            const usageKey = `${itemId}_${spellName}`;
            const used = state.itemSpellsUsed[usageKey];

            // Build spell details section
            let detailsHtml = '';
            if (spellEffect.isCustom && spellEffect.spellDetails) {
                const d = spellEffect.spellDetails;
                const components = [];
                if (d.components.v) components.push('V');
                if (d.components.s) components.push('S');
                if (d.components.m) components.push('M' + (d.components.material ? ` (${d.components.material})` : ''));

                // Build area effect string
                let areaStr = '';
                if (d.area && d.area.shape) {
                    areaStr = `${d.area.size}-ft ${d.area.shape.toLowerCase()}`;
                }

                // Build save DC string
                let saveStr = '';
                if (d.save) {
                    if (d.save === 'character') {
                        saveStr = 'DC 15 (your DC)';
                    } else if (d.save === 'custom' && d.customDC) {
                        saveStr = `DC ${d.customDC}`;
                    } else {
                        saveStr = `${d.save} save`;
                    }
                }

                // Build upcast info
                let upcastStr = '';
                if (d.upcast && d.upcast.dice) {
                    upcastStr = `+${d.upcast.dice} per ${d.upcast.interval === 1 ? 'level' : d.upcast.interval + ' levels'} above base`;
                }

                detailsHtml = `
                    <div style="background: rgba(100,149,237,0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                            <div><strong>School:</strong> ${d.school}</div>
                            <div><strong>Casting Time:</strong> ${d.castingTime}</div>
                            <div><strong>Range:</strong> ${d.range}${areaStr ? ` (${areaStr})` : ''}</div>
                            <div><strong>Duration:</strong> ${d.concentration ? 'Conc., ' : ''}${d.duration}</div>
                            <div><strong>Components:</strong> ${components.join(', ')}</div>
                            ${saveStr ? `<div><strong>Save:</strong> ${saveStr}</div>` : ''}
                            ${d.damage ? `<div><strong>Damage:</strong> ${d.damage}</div>` : ''}
                        </div>
                        ${d.description ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">${d.description}</div>` : ''}
                        ${upcastStr ? `<div style="margin-top: 10px; color: var(--accent-gold);"><strong>At Higher Levels:</strong> ${upcastStr}</div>` : ''}
                    </div>
                `;
            }

            const body = `
                <div class="item-spell-modal">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 1.3em; font-weight: bold; color: var(--accent-purple);">${spellName}</div>
                        <div style="color: var(--text-secondary);">Level ${spellEffect.spellLevel} ${spellEffect.isCustom && spellEffect.spellDetails ? spellEffect.spellDetails.school : ''} Spell</div>
                    </div>
                    ${detailsHtml}
                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Usage:</span>
                            <span style="color: ${used ? 'var(--accent-red)' : 'var(--accent-green)'};">${used ? 'Already Used' : spellEffect.usage}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                            <span>Save DC:</span>
                            <span>${spellEffect.ability === 'item' ? 'Item DC' : 'Your DC (15)'}</span>
                        </div>
                    </div>
                    ${used ?
                        `<div style="text-align: center; color: var(--text-muted); padding: 15px;">This spell has already been used today.<br>It resets at dawn.</div>` :
                        `<button onclick="castItemGrantedSpell('${itemId}', '${spellName}', '${spellEffect.usage}'); closeModal();" style="width: 100%; padding: 12px; background: var(--accent-purple); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">Cast ${spellName}</button>`
                    }
                </div>
            `;

            showModal(`${item.name}`, body);
        }

        function openAddWeaponForm() {
            resetTempEffects('weapon');
            const body = `
                <div class="form-group">
                    <label>Weapon Name</label>
                    <input type="text" id="weaponName" placeholder="e.g., Longsword">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="weaponCategory">
                            <option value="simple">Simple</option>
                            <option value="martial">Martial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="weaponType">
                            <option value="melee">Melee</option>
                            <option value="ranged">Ranged</option>
                            <option value="thrown">Thrown Only</option>
                            <option value="melee/thrown">Melee/Thrown</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hands</label>
                        <select id="weaponHands">
                            <option value="one">One-handed</option>
                            <option value="two">Two-handed</option>
                            <option value="versatile">Versatile</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Damage Die</label>
                        <select id="weaponDamageDie">
                            <option value="1d4">1d4</option>
                            <option value="1d6" selected>1d6</option>
                            <option value="1d8">1d8</option>
                            <option value="1d10">1d10</option>
                            <option value="1d12">1d12</option>
                            <option value="2d6">2d6</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Damage Type</label>
                        <select id="weaponDamageType">
                            <option value="slashing">Slashing</option>
                            <option value="piercing">Piercing</option>
                            <option value="bludgeoning">Bludgeoning</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Modifier</label>
                    <select id="weaponModifier">
                        <option value="str">Strength</option>
                        <option value="dex">Dexterity</option>
                        <option value="finesse">Finesse (STR or DEX)</option>
                    </select>
                </div>
                <div class="form-group" id="rangeGroup" style="display:none;">
                    <label>Range (normal/long)</label>
                    <input type="text" id="weaponRange" placeholder="e.g., 80/320">
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="weaponMagic">
                        <label>Magic Item</label>
                    </div>
                </div>
                <div id="magicWeaponOptions" class="magic-options" style="display:none;">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="weaponAttunement">
                            <label>Requires Attunement</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Attack Bonus</label>
                            <select id="weaponAttackBonus">
                                <option value="0">+0</option>
                                <option value="1">+1</option>
                                <option value="2">+2</option>
                                <option value="3">+3</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Damage Bonus</label>
                            <select id="weaponDamageBonus">
                                <option value="0">+0</option>
                                <option value="1">+1</option>
                                <option value="2">+2</option>
                                <option value="3">+3</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Magic Effects</label>
                        <div id="weaponEffectsList" class="effects-list"></div>
                        <div class="add-effect-btn" onclick="showAddEffectForm('weapon')">+ Add Effect</div>
                        <div id="weaponEffectForm" style="display:none;"></div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="saveNewWeapon()" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Weapon</button>
                </div>
            `;
            showModal('Add Weapon', body);

            // Show/hide range based on weapon type
            setTimeout(() => {
                document.getElementById('weaponType').addEventListener('change', function() {
                    document.getElementById('rangeGroup').style.display = ['ranged', 'thrown', 'melee/thrown'].includes(this.value) ? 'block' : 'none';
                });
                document.getElementById('weaponMagic').addEventListener('change', function() {
                    document.getElementById('magicWeaponOptions').style.display = this.checked ? 'block' : 'none';
                });
            }, 100);
        }

        function saveNewWeapon() {
            const name = document.getElementById('weaponName').value.trim();
            if (!name) { alert('Please enter a weapon name'); return; }

            const weapon = {
                id: 'weapon-' + Date.now(),
                type: 'weapon',
                name: name,
                category: document.getElementById('weaponCategory').value,
                weaponType: document.getElementById('weaponType').value,
                hands: document.getElementById('weaponHands').value,
                damageDie: document.getElementById('weaponDamageDie').value,
                damageType: document.getElementById('weaponDamageType').value,
                modifier: document.getElementById('weaponModifier').value,
                isMagic: document.getElementById('weaponMagic').checked,
                equipped: null
            };

            if (['ranged', 'thrown', 'melee/thrown'].includes(weapon.weaponType)) {
                weapon.range = document.getElementById('weaponRange').value || '20/60';
            }

            if (weapon.isMagic) {
                weapon.requiresAttunement = document.getElementById('weaponAttunement').checked;
                weapon.attackBonus = parseInt(document.getElementById('weaponAttackBonus').value) || 0;
                weapon.damageBonus = parseInt(document.getElementById('weaponDamageBonus').value) || 0;
                weapon.effects = [...tempEffects.weapon];
            }

            saveForUndo();
            state.inventory.push(weapon);
            initializeItemCharges(weapon);
            resetTempEffects('weapon');
            closeModal();
            renderInventory();
            updateResistancesDisplay();
            updateItemChargesDisplay();
            saveState();
        }

        function openAddArmorForm() {
            resetTempEffects('armor');
            const body = `
                <div class="form-group">
                    <label>Armor Name</label>
                    <input type="text" id="armorName" placeholder="e.g., Chain Mail">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Armor Type</label>
                        <select id="armorType">
                            <option value="light">Light</option>
                            <option value="medium">Medium</option>
                            <option value="heavy">Heavy</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Base AC</label>
                        <select id="armorBaseAC">
                            <option value="11">11 (Padded/Leather)</option>
                            <option value="12">12 (Studded/Hide)</option>
                            <option value="13">13 (Chain Shirt)</option>
                            <option value="14">14 (Scale/Breastplate)</option>
                            <option value="15">15 (Half Plate)</option>
                            <option value="16">16 (Ring/Chain)</option>
                            <option value="17">17 (Splint)</option>
                            <option value="18">18 (Plate)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Max DEX Bonus</label>
                    <select id="armorMaxDex">
                        <option value="99">No limit (Light)</option>
                        <option value="2">+2 (Medium)</option>
                        <option value="0">+0 (Heavy)</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="armorStealth">
                        <label>Disadvantage on Stealth</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="armorMagic">
                        <label>Magic Armor</label>
                    </div>
                </div>
                <div id="magicArmorOptions" class="magic-options" style="display:none;">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="armorAttunement">
                            <label>Requires Attunement</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>AC Bonus</label>
                        <select id="armorACBonus">
                            <option value="0">+0</option>
                            <option value="1">+1</option>
                            <option value="2">+2</option>
                            <option value="3">+3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Magic Effects</label>
                        <div id="armorEffectsList" class="effects-list"></div>
                        <div class="add-effect-btn" onclick="showAddEffectForm('armor')">+ Add Effect</div>
                        <div id="armorEffectForm" style="display:none;"></div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="saveNewArmor()" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Armor</button>
                </div>
            `;
            showModal('Add Armor', body);

            setTimeout(() => {
                document.getElementById('armorMagic').addEventListener('change', function() {
                    document.getElementById('magicArmorOptions').style.display = this.checked ? 'block' : 'none';
                });
            }, 100);
        }

        function saveNewArmor() {
            const name = document.getElementById('armorName').value.trim();
            if (!name) { alert('Please enter an armor name'); return; }

            const armor = {
                id: 'armor-' + Date.now(),
                type: 'armor',
                name: name,
                armorType: document.getElementById('armorType').value,
                baseAC: parseInt(document.getElementById('armorBaseAC').value),
                maxDex: parseInt(document.getElementById('armorMaxDex').value),
                stealthDisadvantage: document.getElementById('armorStealth').checked,
                isMagic: document.getElementById('armorMagic').checked,
                equipped: null
            };

            if (armor.isMagic) {
                armor.requiresAttunement = document.getElementById('armorAttunement').checked;
                armor.magicBonus = parseInt(document.getElementById('armorACBonus').value) || 0;
                armor.effects = [...tempEffects.armor];
            }

            saveForUndo();
            state.inventory.push(armor);
            initializeItemCharges(armor);
            resetTempEffects('armor');
            closeModal();
            renderInventory();
            updateResistancesDisplay();
            updateItemChargesDisplay();
            saveState();
        }

        function openAddShieldForm() {
            resetTempEffects('shield');
            const body = `
                <div class="form-group">
                    <label>Shield Name</label>
                    <input type="text" id="shieldName" placeholder="e.g., Wooden Shield" value="Shield">
                </div>
                <div class="form-group">
                    <label>AC Bonus</label>
                    <select id="shieldACBonus">
                        <option value="1">+1</option>
                        <option value="2" selected>+2</option>
                        <option value="3">+3</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="shieldMagic">
                        <label>Magic Shield</label>
                    </div>
                </div>
                <div id="magicShieldOptions" class="magic-options" style="display:none;">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="shieldAttunement">
                            <label>Requires Attunement</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Additional AC Bonus</label>
                        <select id="shieldMagicBonus">
                            <option value="0">+0</option>
                            <option value="1">+1</option>
                            <option value="2">+2</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Magic Effects</label>
                        <div id="shieldEffectsList" class="effects-list"></div>
                        <div class="add-effect-btn" onclick="showAddEffectForm('shield')">+ Add Effect</div>
                        <div id="shieldEffectForm" style="display:none;"></div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="saveNewShield()" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Shield</button>
                </div>
            `;
            showModal('Add Shield', body);

            setTimeout(() => {
                document.getElementById('shieldMagic').addEventListener('change', function() {
                    document.getElementById('magicShieldOptions').style.display = this.checked ? 'block' : 'none';
                });
            }, 100);
        }

        function saveNewShield() {
            const name = document.getElementById('shieldName').value.trim() || 'Shield';

            const shield = {
                id: 'shield-' + Date.now(),
                type: 'shield',
                name: name,
                acBonus: parseInt(document.getElementById('shieldACBonus').value),
                isMagic: document.getElementById('shieldMagic').checked,
                equipped: null
            };

            if (shield.isMagic) {
                shield.requiresAttunement = document.getElementById('shieldAttunement').checked;
                shield.magicBonus = parseInt(document.getElementById('shieldMagicBonus').value) || 0;
                shield.effects = [...tempEffects.shield];
            }

            saveForUndo();
            state.inventory.push(shield);
            initializeItemCharges(shield);
            resetTempEffects('shield');
            closeModal();
            renderInventory();
            updateResistancesDisplay();
            updateItemChargesDisplay();
            saveState();
        }

        function openAddAccessoryForm() {
            resetTempEffects('accessory');
            const body = `
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" id="accessoryName" placeholder="e.g., Ring of Protection">
                </div>
                <div class="form-group">
                    <label>Slot</label>
                    <select id="accessorySlot">
                        <option value="head">Head</option>
                        <option value="neck">Neck</option>
                        <option value="hands">Hands</option>
                        <option value="feet">Feet</option>
                        <option value="ring1">Ring</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="accessoryAttunement">
                        <label>Requires Attunement</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Magic Effects</label>
                    <div id="accessoryEffectsList" class="effects-list"></div>
                    <div class="add-effect-btn" onclick="showAddEffectForm('accessory')">+ Add Effect</div>
                    <div id="accessoryEffectForm" style="display:none;"></div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="saveNewAccessory()" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Accessory</button>
                </div>
            `;
            showModal('Add Accessory', body);
        }

        function saveNewAccessory() {
            const name = document.getElementById('accessoryName').value.trim();
            if (!name) { alert('Please enter an item name'); return; }

            const accessory = {
                id: 'accessory-' + Date.now(),
                type: 'accessory',
                name: name,
                slotType: document.getElementById('accessorySlot').value,
                requiresAttunement: document.getElementById('accessoryAttunement').checked,
                effects: [...tempEffects.accessory],
                isMagic: true,
                equipped: null
            };

            saveForUndo();
            state.inventory.push(accessory);
            initializeItemCharges(accessory);
            resetTempEffects('accessory');
            closeModal();
            renderInventory();
            updateResistancesDisplay();
            updateItemChargesDisplay();
            saveState();
        }

        function deleteItem(type, index) {
            if (!confirm('Delete this item?')) return;
            saveForUndo();
            if (type === 'gear') state.gear.splice(index, 1);
            renderInventory();
            saveState();
        }

        // ===== NOTES =====
        let currentNoteCategory = 'sessions';
        let currentNoteId = null;

        function initNotes() {
            if (!state.notes) {
                state.notes = { sessions: [], cities: [], npcs: [], other: [] };
            }
            ['sessions', 'cities', 'npcs', 'other'].forEach(cat => {
                if (!state.notes[cat]) state.notes[cat] = [];
            });
        }

        function showNotesCategory(cat) {
            currentNoteCategory = cat;
            document.querySelectorAll('.notes-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.notes-tab[onclick="showNotesCategory('${cat}')"]`).classList.add('active');
            renderNotes();
        }

        function renderNotes() {
            initNotes();
            const view = document.getElementById('notesFolderView');
            const notes = state.notes[currentNoteCategory] || [];

            if (notes.length === 0) {
                view.innerHTML = '<p class="text-muted text-center">No notes yet. Add one below!</p>';
                return;
            }

            view.innerHTML = renderNoteTree(notes, 0);
        }

        function renderNoteTree(items, depth) {
            return items.map((item, i) => {
                if (item.type === 'folder') {
                    return `
                        <div class="note-folder" style="margin-left: ${depth * 15}px">
                            <div class="note-folder-header" onclick="toggleFolder(this)">
                                <span>📁</span> ${item.name}
                                <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${i})">✕</button>
                            </div>
                            <div class="note-folder-items" style="display:none;">
                                ${item.children ? renderNoteTree(item.children, depth + 1) : ''}
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="note-item" style="margin-left: ${depth * 15}px" onclick="openNote(${i})">
                            <span>📝 ${item.name}</span>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${i})">✕</button>
                        </div>
                    `;
                }
            }).join('');
        }

        function toggleFolder(el) {
            const items = el.nextElementSibling;
            items.style.display = items.style.display === 'none' ? 'block' : 'none';
        }

        function addNote() {
            const name = document.getElementById('newNoteName').value.trim();
            if (!name) return;
            saveForUndo();
            state.notes[currentNoteCategory].push({ type: 'note', name, content: '' });
            document.getElementById('newNoteName').value = '';
            renderNotes();
            saveState();
        }

        function addFolder() {
            const name = document.getElementById('newNoteName').value.trim();
            if (!name) return;
            saveForUndo();
            state.notes[currentNoteCategory].push({ type: 'folder', name, children: [] });
            document.getElementById('newNoteName').value = '';
            renderNotes();
            saveState();
        }

        function openNote(index) {
            currentNoteId = index;
            const note = state.notes[currentNoteCategory][index];
            document.getElementById('noteEditorTitle').textContent = 'Editing: ' + note.name;
            document.getElementById('noteEditor').value = note.content || '';
            document.getElementById('noteEditorCard').style.display = 'block';
        }

        function closeNoteEditor() {
            document.getElementById('noteEditorCard').style.display = 'none';
            currentNoteId = null;
        }

        function saveCurrentNote() {
            if (currentNoteId === null) return;
            saveForUndo();
            state.notes[currentNoteCategory][currentNoteId].content = document.getElementById('noteEditor').value;
            saveState();
            alert('Note saved!');
        }

        function deleteNote(index) {
            if (!confirm('Delete this note/folder?')) return;
            saveForUndo();
            state.notes[currentNoteCategory].splice(index, 1);
            renderNotes();
            saveState();
        }

        // ===== ENHANCED INIT =====
        function initAll() {
            try {
                // Load saved state first
                loadState();

                // Render all sections
                if (typeof CANTRIPS !== 'undefined') {
                    renderCantrips();
                    renderCantripsDisplay();
                }
                if (typeof SPELLS !== 'undefined') {
                    renderSpells();
                }
                if (typeof ALL_BEAST_FORMS !== 'undefined') {
                    renderBeasts();
                }
                if (typeof FEATURES !== 'undefined') {
                    renderFeatures();
                }

                renderInventory();
                renderNotes();

                // Update all displays with current state
                updateHPDisplay();
                updateSlotsDisplay();
                updateResourcesDisplay();
                updateResourceSlots();
                updatePreparedDisplay();
                updateFormIndicator();
                updateWildShapeDisplay();
                updateBattleUI();
                updateConcentrationDisplay();
                updateCompanionDisplay();
                updateResistancesDisplay();
                updateItemChargesDisplay();
                updateReclaimButton();
                loadCardCollapseStates();

                console.log('Ashvael character sheet initialized successfully');
            } catch (error) {
                console.error('Init error:', error);
                alert('Error initializing: ' + error.message + '\n\nTry clearing site data and refreshing.');
            }
        }

        document.addEventListener('DOMContentLoaded', initAll);

        // ===== PWA SERVICE WORKER =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered:', reg.scope))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        // ===== iOS PWA INSTALL PROMPT =====
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        function isInStandaloneMode() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                   window.navigator.standalone === true;
        }

        function showIOSInstallPrompt() {
            if (isIOS() && !isInStandaloneMode() && !localStorage.getItem('pwa-install-dismissed')) {
                const banner = document.createElement('div');
                banner.className = 'pwa-install-banner show';
                banner.innerHTML = `
                    <div>
                        <strong>Install Ashvael</strong><br>
                        <small>Tap Share then "Add to Home Screen"</small>
                    </div>
                    <button onclick="this.parentElement.remove(); localStorage.setItem('pwa-install-dismissed', 'true');">Got it</button>
                `;
                document.body.appendChild(banner);
            }
        }

        // Show install prompt after a short delay
        setTimeout(showIOSInstallPrompt, 3000);
    </script>
</body>
</html>
