<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ashvael">
    <meta name="theme-color" content="#c9a227">
    <meta name="description" content="D&D 5e Character Sheet for Ashvael, Circle of Stars Druid">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a0a12' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' fill='%23c9a227' font-size='50'>‚≠ê</text></svg>">
    <title>Ashvael - Circle of Stars Druid</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-dark: #0a0a12;
            --bg-card: #12121f;
            --bg-card-hover: #1a1a2e;
            --border-color: #2a2a4a;
            --accent-gold: #c9a227;
            --accent-purple: #7b68ee;
            --accent-blue: #4a90d9;
            --accent-green: #50c878;
            --accent-red: #dc3545;
            --accent-orange: #ff8c00;
            --text-primary: #e8e8f0;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --safe-left: env(safe-area-inset-left);
            --safe-right: env(safe-area-inset-right);
        }

        /* PWA Install Banner (hidden by default) */
        .pwa-install-banner {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 10px;
            right: 10px;
            background: linear-gradient(135deg, var(--accent-gold) 0%, #8b7355 100%);
            color: var(--bg-dark);
            padding: 12px 15px;
            border-radius: 12px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .pwa-install-banner.show { display: flex; align-items: center; justify-content: space-between; }
        .pwa-install-banner button {
            background: var(--bg-dark);
            color: var(--accent-gold);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Touch-friendly improvements */
        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
        }

        /* Larger touch targets for mobile */
        @media (max-width: 600px) {
            .action-item, .form-option, .spell-card, .feature-item {
                min-height: 48px;
                padding: 12px !important;
            }
            .nav-item {
                min-width: 60px;
            }
            button, .rest-btn, .hp-apply-btn {
                min-height: 44px;
                min-width: 44px;
            }
        }

        /* Smooth scrolling */
        html { scroll-behavior: smooth; }
        .section { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }

        body {
            font-family: 'Crimson Text', Georgia, serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding-top: var(--safe-top);
            padding-bottom: calc(70px + var(--safe-bottom));
            background-image: radial-gradient(white 1px, transparent 1px);
            background-size: 80px 80px;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at center, transparent 0%, var(--bg-dark) 70%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 10px;
        }

        /* Top Bar */
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, var(--bg-card) 0%, #1a1a30 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .character-name-small {
            font-family: 'Cinzel', serif;
            font-size: 1.2em;
            color: var(--accent-gold);
        }

        .rest-buttons {
            display: flex;
            gap: 8px;
        }

        .rest-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-card-hover);
            color: var(--text-primary);
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rest-btn:hover, .rest-btn:active {
            border-color: var(--accent-purple);
            background: rgba(123, 104, 238, 0.2);
        }

        .rest-btn.long { border-color: var(--accent-blue); }
        .rest-btn.short { border-color: var(--accent-green); }

        .undo-btn {
            padding: 8px 12px;
            border: 1px solid var(--accent-orange);
            border-radius: 6px;
            background: transparent;
            color: var(--accent-orange);
            cursor: pointer;
        }

        /* Battle Mode Banner */
        .battle-banner {
            display: none;
            background: linear-gradient(90deg, var(--accent-red), #8b0000);
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-weight: bold;
            justify-content: space-between;
            align-items: center;
        }

        .battle-banner.active { display: flex; }

        .battle-btn {
            padding: 6px 15px;
            border: 2px solid white;
            border-radius: 6px;
            background: transparent;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 5px;
            padding-bottom: calc(8px + var(--safe-bottom));
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 10px;
            color: var(--text-muted);
            font-size: 0.7em;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
        }

        .nav-item:hover, .nav-item.active {
            color: var(--accent-gold);
            background: rgba(201, 162, 39, 0.1);
        }

        .nav-icon {
            font-size: 1.5em;
            margin-bottom: 2px;
        }

        /* Sections */
        .section { display: none; }
        .section.active { display: block; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .card-title {
            font-family: 'Cinzel', serif;
            font-size: 1.2em;
            color: var(--accent-gold);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title-badge {
            font-size: 0.7em;
            padding: 3px 8px;
            background: var(--accent-purple);
            border-radius: 10px;
            color: white;
        }

        /* Collapsible Cards */
        .card-title.collapsible {
            cursor: pointer;
            user-select: none;
        }
        .card-title.collapsible:hover {
            color: var(--accent-gold-light, #f0d890);
        }
        .card-title .collapse-toggle {
            font-size: 0.8em;
            transition: transform 0.2s ease;
            margin-left: auto;
            padding-left: 10px;
        }
        .card-content {
            transition: max-height 0.3s ease, opacity 0.2s ease;
            overflow: hidden;
        }
        .card-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin: 0;
            padding: 0;
        }
        .card.collapsed .card-title {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* Combat Stats Row */
        .combat-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            text-align: center;
        }

        .combat-stat {
            padding: 10px 5px;
            background: var(--bg-card-hover);
            border-radius: 8px;
        }

        .combat-stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-gold);
        }

        .combat-stat-label {
            font-size: 0.7em;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .movement-counter {
            cursor: pointer;
            border: 2px solid var(--accent-gold);
            transition: background 0.2s;
        }
        .movement-counter:active {
            background: var(--bg-card);
        }

        /* HP Section */
        .hp-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .hp-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .hp-current {
            font-size: 3em;
            font-weight: bold;
            color: var(--accent-green);
            min-width: 80px;
            text-align: center;
        }

        .hp-current.injured { color: var(--accent-orange); }
        .hp-current.critical { color: var(--accent-red); }

        .hp-max {
            font-size: 1.5em;
            color: var(--text-secondary);
        }

        .hp-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .hp-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .hp-input-group label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .hp-input {
            width: 60px;
            padding: 8px;
            font-size: 1.1em;
            text-align: center;
            background: var(--bg-card-hover);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
        }

        .hp-input:focus {
            outline: none;
            border-color: var(--accent-purple);
        }

        .hp-apply-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .hp-apply-btn.damage {
            background: var(--accent-red);
            color: white;
        }

        .hp-apply-btn.heal {
            background: var(--accent-green);
            color: white;
        }

        .temp-hp-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: rgba(123, 104, 238, 0.1);
            border-radius: 8px;
        }

        /* HP History */
        .hp-history-toggle {
            text-align: center;
            color: var(--accent-purple);
            cursor: pointer;
            font-size: 0.9em;
            padding: 5px;
        }

        .hp-history {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .hp-history.expanded {
            max-height: 300px;
            overflow-y: auto;
        }

        .hp-history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9em;
        }

        .hp-history-item.damage { color: var(--accent-red); }
        .hp-history-item.heal { color: var(--accent-green); }

        /* Ability Scores */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        @media (min-width: 500px) {
            .stat-grid { grid-template-columns: repeat(6, 1fr); }
        }

        .stat-box {
            text-align: center;
            padding: 10px 5px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .stat-name {
            font-size: 0.65em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-score {
            font-size: 1.4em;
            font-weight: bold;
        }

        .stat-mod {
            font-size: 1em;
            color: var(--accent-purple);
        }

        .stat-save {
            font-size: 0.75em;
            color: var(--text-secondary);
        }

        .stat-save.proficient { color: var(--accent-green); }

        .stat-box.wild-shape {
            border-color: var(--accent-green);
            background: rgba(80, 200, 120, 0.15);
        }

        .stat-box.wild-shape .stat-score {
            color: var(--accent-green);
        }

        .skill-item.wild-shape {
            border-color: var(--accent-green);
            background: rgba(80, 200, 120, 0.15);
        }

        .skill-item.wild-shape .skill-mod {
            color: var(--accent-green);
        }

        /* Spellcasting Combined Section */
        .spellcasting-header {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
            margin-bottom: 15px;
        }

        .spell-stat {
            padding: 8px;
            background: var(--bg-card-hover);
            border-radius: 8px;
        }

        .spell-stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--accent-blue);
        }

        .spell-stat-label {
            font-size: 0.7em;
            color: var(--text-secondary);
        }

        /* Spell Slots */
        .spell-slots-row {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .slot-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slot-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            min-width: 35px;
        }

        .slot-boxes {
            display: flex;
            gap: 5px;
        }

        .slot-box {
            width: 28px;
            height: 28px;
            border: 2px solid var(--accent-blue);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            transition: all 0.2s;
        }

        .slot-box:hover { background: rgba(74, 144, 217, 0.3); }
        .slot-box.used { background: var(--accent-blue); color: white; }

        /* Prepared Spells */
        .prepared-spells-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }

        .prepared-spell-chip {
            padding: 8px 10px;
            background: rgba(123, 104, 238, 0.15);
            border: 1px solid var(--accent-purple);
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .prepared-spell-chip:hover {
            background: rgba(123, 104, 238, 0.3);
        }

        .prepared-spell-chip.always {
            border-color: var(--accent-gold);
            background: rgba(201, 162, 39, 0.15);
        }

        .spell-level-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-purple);
            color: white;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .prepared-spell-chip.always .spell-level-dot {
            background: var(--accent-gold);
        }

        /* Actions Section */
        .actions-grid {
            display: grid;
            gap: 10px;
        }

        .action-category {
            padding: 10px;
            background: var(--bg-card-hover);
            border-radius: 8px;
            border-left: 3px solid var(--accent-purple);
        }

        .action-category.bonus { border-left-color: var(--accent-orange); }
        .action-category.reaction { border-left-color: var(--accent-blue); }
        .action-category.free { border-left-color: var(--accent-green); }

        .action-category-title {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .action-item {
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-item:hover { border-color: var(--accent-purple); }

        .action-item.used {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .action-item.disabled,
        .action-item.disabled:hover,
        .action-item.disabled:active,
        .action-item.disabled:focus {
            opacity: 0.4;
            pointer-events: none;
            cursor: not-allowed;
            border-color: var(--border-color) !important;
            background: var(--bg-tertiary) !important;
            color: var(--text-secondary) !important;
        }

        .action-item.extra-action {
            background: linear-gradient(135deg, var(--bg-card-hover), var(--bg-card));
            border-style: dashed;
        }

        /* Activation Section (DC Save) */
        .activation-section {
            margin: 15px 0;
            padding: 12px;
            background: rgba(123, 104, 238, 0.1);
            border: 1px solid var(--accent-purple);
            border-radius: 8px;
        }

        /* Extra Menu Styles */
        .extra-menu-section {
            margin-bottom: 15px;
        }
        .extra-menu-section h4 {
            margin: 0 0 8px 0;
            color: var(--accent-gold);
            font-size: 0.9em;
        }
        .extra-menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .extra-menu-item {
            padding: 10px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .extra-menu-item:hover {
            border-color: var(--accent-purple);
            background: rgba(123, 104, 238, 0.2);
        }
        .extra-menu-item .skill-mod {
            display: block;
            color: var(--accent-gold);
            font-weight: bold;
            font-size: 0.9em;
        }

        /* Form Mode Indicator */
        .form-indicator {
            display: none;
            padding: 12px;
            background: linear-gradient(135deg, rgba(123, 104, 238, 0.2), rgba(201, 162, 39, 0.2));
            border: 1px solid var(--accent-purple);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .form-indicator.active { display: block; }

        .form-indicator-title {
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 5px;
        }

        .form-indicator-details {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .form-end-btn {
            margin-top: 10px;
            padding: 6px 12px;
            background: var(--accent-red);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }

        /* Modal */
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-gold);
            color: var(--bg-dark);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10000;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-card);
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            color: var(--accent-gold);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5em;
            cursor: pointer;
        }

        .modal-body {
            padding: 15px;
        }

        /* Battle Log */
        .battle-log {
            display: none;
            max-height: 150px;
            overflow-y: auto;
            background: var(--bg-card-hover);
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }

        .battle-log.active { display: block; }

        .battle-log-item {
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85em;
        }

        .battle-log-time {
            color: var(--text-muted);
            font-size: 0.8em;
        }

        /* Wild Shape Selection */
        .form-options {
            display: grid;
            gap: 10px;
        }

        .form-option {
            padding: 15px;
            background: var(--bg-card-hover);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .form-option:hover {
            border-color: var(--accent-purple);
        }

        .form-option-title {
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 5px;
        }

        .form-option-desc {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        /* Skills compact */
        .skills-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            font-size: 0.85em;
        }

        @media (min-width: 500px) {
            .skills-grid { grid-template-columns: repeat(3, 1fr); }
        }

        .skill-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 8px;
            background: var(--bg-card-hover);
            border-radius: 4px;
        }

        .skill-item.proficient {
            border-left: 2px solid var(--accent-green);
        }

        .skill-mod {
            font-weight: bold;
            color: var(--accent-purple);
        }

        .skill-mod.proficient { color: var(--accent-green); }

        /* Utilities */
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .text-small { font-size: 0.85em; }
        .mt-10 { margin-top: 10px; }
        .mb-10 { margin-bottom: 10px; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .gap-10 { gap: 10px; }

        /* Link to features */
        .feature-link {
            color: var(--accent-purple);
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .feature-link:hover {
            color: var(--accent-gold);
        }

        /* Spell List Styles */
        .prepared-counter-display {
            text-align: center;
            font-size: 1.2em;
            padding: 10px;
            background: var(--bg-card-hover);
            border-radius: 8px;
        }

        .prepared-count-value {
            font-weight: bold;
            color: var(--accent-green);
            font-size: 1.3em;
        }

        .prepared-count-value.over { color: var(--accent-red); }

        .cantrip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
        }

        .cantrip-card {
            padding: 12px;
            background: var(--bg-card-hover);
            border: 1px solid var(--accent-gold);
            border-radius: 8px;
        }

        .cantrip-card-name {
            font-weight: bold;
            color: var(--accent-gold);
        }

        .cantrip-card-source {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .cantrip-card-desc {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .spell-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .spell-card {
            padding: 12px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .spell-card:hover { border-color: var(--accent-purple); }

        .spell-card.prepared {
            border-color: var(--accent-green);
            background: rgba(80, 200, 120, 0.1);
        }

        .spell-card.always {
            border-color: var(--accent-gold);
            background: rgba(201, 162, 39, 0.1);
        }

        .spell-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }

        .spell-card-name {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spell-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .spell-card-tags {
            display: flex;
            gap: 5px;
        }

        .spell-tag {
            padding: 2px 6px;
            font-size: 0.7em;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .spell-tag.conc { background: rgba(220, 53, 69, 0.3); color: #ff6b6b; }
        .spell-tag.ritual { background: rgba(123, 104, 238, 0.3); color: var(--accent-purple); }

        .spell-card-meta {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .spell-card-desc {
            font-size: 0.85em;
            color: var(--text-secondary);
            display: none;
        }

        .spell-card.expanded .spell-card-desc { display: block; }

        /* Beast Form Card */
        .beast-card {
            padding: 12px;
            background: var(--bg-card-hover);
            border: 1px solid var(--accent-green);
            border-radius: 8px;
            cursor: pointer;
        }

        .beast-card-name {
            font-weight: bold;
            color: var(--accent-green);
        }

        .beast-card-stats {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        /* Inventory Styles */
        .inventory-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--bg-card-hover);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .inventory-item.equipped {
            border-color: var(--accent-green);
            background: rgba(80, 200, 120, 0.1);
        }

        .inventory-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .equip-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .inventory-item-name {
            font-weight: 500;
            cursor: pointer;
        }

        .inventory-item-actions {
            display: flex;
            gap: 8px;
        }

        .delete-btn {
            background: none;
            border: none;
            color: var(--accent-red);
            cursor: pointer;
            font-size: 1.1em;
        }

        .add-item-row {
            display: flex;
            gap: 8px;
        }

        .add-item-input {
            flex: 1;
            padding: 10px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
        }

        .add-item-btn {
            padding: 10px 15px;
            background: var(--accent-purple);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }

        .currency-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .currency-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .currency-item label {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .currency-item input {
            width: 70px;
            padding: 8px;
            text-align: center;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
        }

        /* Equipment Slots Styles */
        .equipment-slots-section {
            margin-bottom: 15px;
        }

        .slot-header {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .equipment-slots-row {
            display: flex;
            gap: 10px;
        }

        .equipment-slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .equipment-slot {
            flex: 1;
            padding: 12px;
            background: var(--bg-card-hover);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 60px;
        }

        .equipment-slot:hover {
            border-color: var(--accent-purple);
            background: rgba(123, 104, 238, 0.1);
        }

        .equipment-slot.wide {
            flex: 1;
        }

        .equipment-slot.small {
            padding: 8px;
            min-height: 50px;
        }

        .equipment-slot.filled {
            border-style: solid;
            border-color: var(--accent-green);
            background: rgba(80, 200, 120, 0.1);
        }

        .equipment-slot.magic {
            border-color: var(--accent-purple);
            background: rgba(123, 104, 238, 0.15);
        }

        .slot-label {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .slot-content {
            font-size: 0.9em;
            color: var(--text-primary);
            font-weight: 500;
        }

        .slot-content.empty {
            color: var(--text-muted);
            font-style: italic;
        }

        .attunement-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .attuned-list {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .add-btn {
            background: var(--accent-purple);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            margin-left: 10px;
        }

        .add-btn:hover {
            background: var(--accent-blue);
        }

        /* Add Equipment Modal */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1em;
        }

        .form-group select {
            cursor: pointer;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .magic-options {
            padding: 12px;
            background: rgba(123, 104, 238, 0.1);
            border: 1px solid var(--accent-purple);
            border-radius: 8px;
            margin-top: 10px;
        }

        /* Effects Builder */
        .effects-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .effect-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            font-size: 0.85em;
        }

        .effect-item .effect-icon {
            font-size: 1.1em;
        }

        .effect-item .effect-text {
            flex: 1;
        }

        .effect-item .effect-remove {
            color: var(--accent-red);
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .effect-item .effect-remove:hover {
            background: rgba(255,100,100,0.2);
        }

        .add-effect-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            background: rgba(123, 104, 238, 0.2);
            border: 1px dashed var(--accent-purple);
            border-radius: 6px;
            color: var(--accent-purple);
            cursor: pointer;
            font-size: 0.9em;
        }

        .add-effect-btn:hover {
            background: rgba(123, 104, 238, 0.3);
        }

        .effect-form {
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            margin-top: 8px;
        }

        .effect-form select, .effect-form input {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
        }

        .effect-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        .effect-form-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .effect-form-buttons button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Item Charges Display */
        .item-charges-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .item-charges-row:hover {
            background: rgba(0,0,0,0.3);
        }
        .item-charges-name {
            flex: 1;
            font-weight: 500;
            color: var(--accent-purple);
        }
        .item-charges-bar {
            width: 80px;
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        .item-charges-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-gold));
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .item-charges-count {
            font-size: 0.85em;
            color: var(--text-secondary);
            min-width: 40px;
            text-align: right;
        }
        .item-spell-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(123, 104, 238, 0.1);
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            border-left: 3px solid var(--accent-purple);
        }
        .item-spell-row:hover {
            background: rgba(123, 104, 238, 0.2);
        }
        .item-spell-row.used {
            opacity: 0.5;
            border-left-color: var(--text-muted);
        }
        .item-spell-name {
            flex: 1;
            font-weight: 500;
        }
        .item-spell-usage {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        .no-charges {
            color: var(--text-muted);
            text-align: center;
            padding: 10px;
            font-style: italic;
        }
        /* Item Charges Modal */
        .item-charges-modal .charges-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .item-charges-modal .recharge-info {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        .charges-bar-large {
            height: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .charges-fill-large {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-gold));
            border-radius: 6px;
            transition: width 0.3s ease;
        }
        .charge-spells-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .charge-spell-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(123, 104, 238, 0.15);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .charge-spell-option:hover {
            background: rgba(123, 104, 238, 0.3);
            transform: translateX(4px);
        }
        .charge-spell-name {
            font-weight: 500;
        }
        .charge-spell-cost {
            font-size: 0.9em;
            color: var(--accent-gold);
        }

        /* Resistances Display */
        .resistances-section {
            margin-top: 15px;
            padding: 12px;
            background: var(--bg-card-hover);
            border-radius: 8px;
        }

        .resistances-title {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .resistance-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .resistance-tag {
            padding: 4px 10px;
            background: rgba(80, 200, 120, 0.15);
            border: 1px solid var(--accent-green);
            border-radius: 12px;
            font-size: 0.8em;
            color: var(--accent-green);
        }

        .immunity-tag {
            background: rgba(201, 162, 39, 0.15);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Features Styles */
        .feature-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .feature-item {
            padding: 12px;
            background: var(--bg-card-hover);
            border-left: 3px solid var(--accent-purple);
            border-radius: 0 8px 8px 0;
        }

        .feature-item-name {
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 3px;
        }

        .feature-item-source {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .feature-item-desc {
            font-size: 0.9em;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Backstory Styles */
        .appearance-table {
            width: 100%;
            border-collapse: collapse;
        }

        .appearance-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .appearance-table td:first-child {
            font-weight: bold;
            color: var(--accent-purple);
            width: 80px;
        }

        .backstory-text {
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .backstory-text p { margin-bottom: 10px; }

        .personality-traits {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .trait-item {
            padding: 10px;
            background: var(--bg-card-hover);
            border-radius: 6px;
            font-style: italic;
        }

        .trait-item strong {
            color: var(--accent-gold);
            font-style: normal;
        }

        /* Notes Styles */
        .notes-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .notes-tab {
            padding: 8px 15px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .notes-tab.active {
            border-color: var(--accent-purple);
            color: var(--accent-gold);
        }

        .notes-folder-view {
            min-height: 100px;
            margin-bottom: 15px;
        }

        .note-folder {
            margin-bottom: 10px;
        }

        .note-folder-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--bg-card-hover);
            border-radius: 6px;
            cursor: pointer;
        }

        .note-folder-header:hover {
            background: rgba(123, 104, 238, 0.2);
        }

        .note-folder-items {
            padding-left: 20px;
            margin-top: 5px;
        }

        .note-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--bg-card-hover);
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .note-item:hover { background: rgba(123, 104, 238, 0.2); }

        /* Battle Log Display */
        .battle-record {
            border-left: 3px solid var(--accent-gold);
        }
        .battle-log-details {
            padding: 10px;
            background: var(--bg-card);
            border-radius: 0 0 8px 8px;
        }
        .battle-log-summary {
            padding: 8px;
            background: var(--bg-card-hover);
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .battle-log-entries {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .battle-log-entry {
            padding: 4px 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85em;
        }
        .battle-log-entry .battle-log-time {
            color: var(--text-secondary);
            margin-right: 8px;
            font-size: 0.8em;
        }
        .battle-notes-input {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9em;
            resize: vertical;
        }

        /* Party Member Card */
        .party-member-card {
            background: var(--bg-card-hover);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent-blue);
        }
        .party-member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .party-member-name {
            font-weight: bold;
            color: var(--accent-gold);
        }
        .party-member-class {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        .party-member-details {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        .party-member-details.expanded { display: block; }
        .party-member-stat {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .party-member-stat label {
            color: var(--text-secondary);
            min-width: 60px;
        }

        /* Location Card */
        .location-card {
            background: var(--bg-card-hover);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent-green);
        }
        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .location-title {
            font-weight: bold;
            color: var(--accent-gold);
        }
        .location-details {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        .location-details.expanded { display: block; }
        .location-desc {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        /* NPC Card */
        .npc-card {
            background: var(--bg-card-hover);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent-purple);
        }
        .npc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .npc-name {
            font-weight: bold;
            color: var(--accent-gold);
        }

        /* Add Info Items */
        .add-info-list {
            margin-top: 10px;
        }
        .add-info-item {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .add-info-type {
            font-size: 0.8em;
            color: var(--accent-purple);
            margin-bottom: 4px;
        }
        .add-info-content {
            color: var(--text-primary);
        }
        .add-info-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px dashed var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 8px;
        }
        .add-info-btn:hover {
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }

        /* Mention Links */
        .mention-link {
            color: var(--accent-blue);
            cursor: pointer;
            text-decoration: underline;
        }
        .mention-link:hover {
            color: var(--accent-gold);
        }

        /* Add Note Buttons */
        .add-note-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .add-note-row {
            display: flex;
            gap: 8px;
        }

        .note-textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            background: var(--bg-card-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
            margin-bottom: 10px;
        }

        .save-note-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-green);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        /* Level Up Button */
        .level-up-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent-gold) 0%, #e6a800 100%);
            border: 2px solid #ffd700;
            border-radius: 12px;
            color: #1a1a2e;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
        }
        .level-up-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
        }
        .level-up-button:active {
            transform: translateY(0);
        }

        /* Level Up Modal */
        .level-up-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        .level-up-section {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .level-up-section h4 {
            color: var(--accent-gold);
            margin: 0 0 8px 0;
            font-size: 1em;
        }
        .level-up-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .level-up-item:last-child {
            border-bottom: none;
        }
        .level-up-item .icon {
            font-size: 1.2em;
        }
        .level-up-item .text {
            flex: 1;
        }
        .level-up-item .value {
            color: var(--accent-green);
            font-weight: bold;
        }
        .level-up-confirm {
            margin-top: 16px;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-green) 0%, #228B22 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
        }
        .level-up-confirm:hover {
            opacity: 0.9;
        }
        .level-up-spells-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .new-spell-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(123, 104, 238, 0.1);
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .new-spell-option:hover {
            border-color: var(--accent-purple);
        }
        .new-spell-option.selected {
            background: rgba(123, 104, 238, 0.3);
            border-color: var(--accent-purple);
        }
        .asi-option {
            padding: 12px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid transparent;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .asi-option:hover {
            border-color: var(--accent-gold);
        }
        .asi-option.selected {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--accent-gold);
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <span class="character-name-small">Ashvael</span>
            <span id="topBarLevel" onclick="openLevelSelector()" style="font-size: 0.8em; color: var(--text-secondary); cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(201,162,39,0.2)'" onmouseout="this.style.background='transparent'">Level 6 Druid (Circle of Stars) ‚ñº</span>
        </div>
        <div class="rest-buttons">
            <button class="undo-btn" onclick="undoLastAction()" title="Undo">‚Ü∂</button>
            <button class="rest-btn short" onclick="shortRest()">Short Rest</button>
            <button class="rest-btn long" onclick="longRest()">Long Rest</button>
            <button class="rest-btn" onclick="toggleBattle()" id="battleToggle">‚öî Battle</button>
        </div>
    </div>

    <!-- Battle Banner -->
    <div class="battle-banner" id="battleBanner">
        <span>‚öî COMBAT ACTIVE - Round <span id="roundCount">1</span></span>
        <div>
            <button class="battle-btn" onclick="nextRound()">Next Round</button>
            <button class="battle-btn" onclick="endBattle()">End Battle</button>
        </div>
    </div>

    <div class="container">
        <!-- MAIN CHARACTER SHEET -->
        <div id="sheet" class="section active">
            <!-- Form Indicator -->
            <div class="form-indicator" id="formIndicator">
                <div class="form-indicator-title" id="formTitle">Starry Form: Archer</div>
                <div class="form-indicator-details" id="formDetails">Duration: 10 min | Bonus Action: 1d8+4 radiant attack</div>
                <button class="form-end-btn" onclick="endForm()">End Form</button>
            </div>

            <!-- Combat Stats -->
            <div class="card">
                <div class="combat-row">
                    <div class="combat-stat">
                        <div class="combat-stat-value" id="displayAC">15</div>
                        <div class="combat-stat-label">AC</div>
                    </div>
                    <div class="combat-stat">
                        <div class="combat-stat-value">+2</div>
                        <div class="combat-stat-label">Initiative</div>
                    </div>
                    <div class="combat-stat">
                        <div class="combat-stat-value" id="displaySpeed">30ft</div>
                        <div class="combat-stat-label">Speed</div>
                    </div>
                    <div class="combat-stat">
                        <div class="combat-stat-value">+3</div>
                        <div class="combat-stat-label">Prof</div>
                    </div>
                    <div class="combat-stat movement-counter" id="movementCounter" style="display:none;" onclick="openMovementModal()">
                        <div class="combat-stat-value" id="movementDisplay">0/30</div>
                        <div class="combat-stat-label">Movement</div>
                    </div>
                </div>
            </div>

            <!-- HP Section -->
            <div class="card">
                <h2 class="card-title">Hit Points <span class="card-title-badge" id="hitDiceBadge" style="background: var(--accent-green);">5d8 HD</span></h2>
                <div class="hp-section">
                    <div class="hp-display">
                        <span class="hp-current" id="hpCurrent">38</span>
                        <span class="hp-max" id="hpMax">/ 38</span>
                    </div>
                    <div class="hp-controls">
                        <div class="hp-input-group">
                            <label>Damage:</label>
                            <input type="number" id="damageInput" class="hp-input" min="0" value="">
                            <button class="hp-apply-btn damage" onclick="applyDamage()">Apply</button>
                        </div>
                        <div class="hp-input-group">
                            <label>Heal:</label>
                            <input type="number" id="healInput" class="hp-input" min="0" value="">
                            <button class="hp-apply-btn heal" onclick="applyHeal()">Apply</button>
                        </div>
                    </div>
                    <div class="temp-hp-row">
                        <label>Temp HP:</label>
                        <input type="number" id="tempHP" class="hp-input" style="width:50px" min="0" value="0" onchange="updateTempHP(this.value)">
                        <button class="hp-apply-btn" onclick="openTempHPModal()" style="padding: 4px 8px; font-size: 0.8em;">Set</button>
                    </div>
                    <div class="hp-history-toggle" onclick="toggleHPHistory()">
                        ‚ñº Recent Changes (<span id="historyCount">0</span>)
                    </div>
                    <div class="hp-history" id="hpHistory"></div>
                </div>
            </div>

            <!-- Resistances & Immunities -->
            <div class="card" id="resistancesCard">
                <h2 class="card-title">Resistances & Immunities</h2>
                <div id="resistancesDisplay">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Ability Scores -->
            <div class="card">
                <h2 class="card-title">Ability Scores</h2>
                <div class="stat-grid" id="statGrid">
                    <div class="stat-box" id="strBox">
                        <div class="stat-name">STR</div>
                        <div class="stat-score" id="strScore">8</div>
                        <div class="stat-mod" id="strMod">-1</div>
                        <div class="stat-save" id="strSave">-1</div>
                    </div>
                    <div class="stat-box" id="dexBox">
                        <div class="stat-name">DEX</div>
                        <div class="stat-score" id="dexScore">14</div>
                        <div class="stat-mod" id="dexMod">+2</div>
                        <div class="stat-save" id="dexSave">+2</div>
                    </div>
                    <div class="stat-box" id="conBox">
                        <div class="stat-name">CON</div>
                        <div class="stat-score" id="conScore">15</div>
                        <div class="stat-mod" id="conMod">+2</div>
                        <div class="stat-save" id="conSave">+2</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-name">INT</div>
                        <div class="stat-score">8</div>
                        <div class="stat-mod">-1</div>
                        <div class="stat-save proficient">+2</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-name">WIS</div>
                        <div class="stat-score">18</div>
                        <div class="stat-mod">+4</div>
                        <div class="stat-save proficient">+7</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-name">CHA</div>
                        <div class="stat-score">12</div>
                        <div class="stat-mod">+1</div>
                        <div class="stat-save">+1</div>
                    </div>
                </div>
            </div>

            <!-- Spellcasting Combined -->
            <div class="card">
                <h2 class="card-title">
                    Spellcasting
                    <span class="card-title-badge" id="preparedCounter">0/9</span><!-- Updated dynamically -->
                </h2>
                <div class="spellcasting-header">
                    <div class="spell-stat">
                        <div class="spell-stat-value">15</div>
                        <div class="spell-stat-label">Save DC</div>
                    </div>
                    <div class="spell-stat">
                        <div class="spell-stat-value">+7</div>
                        <div class="spell-stat-label">Attack</div>
                    </div>
                    <div class="spell-stat">
                        <div class="spell-stat-value">WIS</div>
                        <div class="spell-stat-label">Ability</div>
                    </div>
                </div>

                <!-- Spell Slots (dynamically generated) -->
                <div class="spell-slots-row" id="spellSlotsContainer">
                    <!-- Populated by renderSpellSlots() -->
                </div>

                <!-- Cantrips Display -->
                <div class="text-small text-muted mb-10">Cantrips (click for details):</div>
                <div class="prepared-spells-grid" id="cantripsDisplay"></div>

                <!-- Prepared Spells Display -->
                <div class="text-small text-muted mb-10" style="margin-top: 15px;">Prepared Spells (click for details):</div>
                <div class="prepared-spells-grid" id="preparedDisplay">
                    <div class="prepared-spell-chip always" onclick="showSpellInfo('guiding-bolt')">
                        <span class="spell-level-dot">1</span>
                        <span>Guiding Bolt</span>
                    </div>
                </div>
            </div>

            <!-- Resource Slots (includes Item Charges) -->
            <div class="card" id="resourceSlotsCard">
                <h2 class="card-title collapsible" onclick="toggleCard('resourceSlotsCard')">
                    <span>Resource Slots</span>
                    <span class="collapse-toggle">‚ñº</span>
                </h2>
                <div class="card-content">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div class="slot-group">
                            <span class="slot-label">Wild Shape</span>
                            <div class="slot-boxes" id="wildShapeSlots">
                                <div class="slot-box" onclick="toggleWildShapeSlot(this)" style="border-color: var(--accent-green)">‚óè</div>
                                <div class="slot-box" onclick="toggleWildShapeSlot(this)" style="border-color: var(--accent-green)">‚óè</div>
                            </div>
                        </div>
                        <div class="slot-group">
                            <span class="slot-label">Guiding Bolt</span>
                            <div class="slot-boxes" id="guidingBoltSlots">
                                <div class="slot-box" onclick="toggleGBSlot(this)" style="border-color: var(--accent-gold)">‚óè</div>
                                <div class="slot-box" onclick="toggleGBSlot(this)" style="border-color: var(--accent-gold)">‚óè</div>
                                <div class="slot-box" onclick="toggleGBSlot(this)" style="border-color: var(--accent-gold)">‚óè</div>
                                <div class="slot-box" onclick="toggleGBSlot(this)" style="border-color: var(--accent-gold)">‚óè</div>
                            </div>
                        </div>
                        <div class="slot-group">
                            <span class="slot-label">Healing Word (Free)</span>
                            <div class="slot-boxes" id="healingWordFreeSlot">
                                <div class="slot-box" onclick="toggleHWFreeSlot(this)" style="border-color: var(--accent-green)">‚óè</div>
                            </div>
                        </div>
                        <div class="slot-group">
                            <span class="slot-label">Healing Hands</span>
                            <div class="slot-boxes" id="healingHandsSlot">
                                <div class="slot-box" onclick="toggleHHSlot(this)" style="border-color: var(--accent-purple)">‚óè</div>
                            </div>
                        </div>
                        <div class="slot-group">
                            <span class="slot-label">Celestial Rev.</span>
                            <div class="slot-boxes" id="celestialRevSlot">
                                <div class="slot-box" onclick="toggleCRSlot(this)" style="border-color: var(--accent-orange)">‚óè</div>
                            </div>
                        </div>
                        <div class="slot-group" id="cosmicOmenGroup" style="display: none;">
                            <span class="slot-label">Cosmic Omen</span>
                            <div class="slot-boxes" id="cosmicOmenSlots">
                                <div class="slot-box" onclick="toggleCOSlot(this)" style="border-color: var(--accent-blue)">‚óè</div>
                                <div class="slot-box" onclick="toggleCOSlot(this)" style="border-color: var(--accent-blue)">‚óè</div>
                                <div class="slot-box" onclick="toggleCOSlot(this)" style="border-color: var(--accent-blue)">‚óè</div>
                            </div>
                        </div>
                    </div>
                    <!-- Item Charges (integrated into Resource Slots) -->
                    <div id="itemChargesDisplay" style="margin-top: 12px; border-top: 1px solid var(--border-color); padding-top: 12px; display: none;">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card" id="actionsCard">
                <h2 class="card-title collapsible" onclick="toggleCard('actionsCard')">
                    <span>Actions</span>
                    <span class="collapse-toggle">‚ñº</span>
                </h2>
                <div class="card-content">
                    <div class="actions-grid">
                        <div class="action-category">
                            <div class="action-category-title">‚öîÔ∏è Action</div>
                            <div class="action-list" id="actionList">
                                <div class="action-item" onclick="openAttackSelection()">Attack</div>
                                <div class="action-item" id="reclaimBtn" style="display:none" onclick="openReclaimSelection()">üîÑ Reclaim Weapons</div>
                                <div class="action-item" onclick="openCastSpellSelection('action')">Cast Spell</div>
                                <div class="action-item" onclick="openWildCompanion()">Wild Companion</div>
                                <div class="action-item" onclick="openHealingHands()">Healing Hands</div>
                                <div class="action-item extra-action" onclick="openExtraMenu('action')">Extra</div>
                            </div>
                        </div>
                        <div class="action-category bonus">
                            <div class="action-category-title">‚ö° Bonus Action</div>
                            <div class="action-list" id="bonusActionList">
                                <div class="action-item" onclick="openFormSelection()">Wild Shape / Starry Form</div>
                                <div class="action-item" onclick="openCelestialRevelation()">Celestial Revelation</div>
                                <div class="action-item" onclick="openCastSpellSelection('bonus')">Cast Spell</div>
                                <div class="action-item archer-action" style="display:none" onclick="useArcherAttack()">Archer Attack (1d8+4)</div>
                                <div class="action-item offhand-attack" style="display:none" onclick="openOffhandAttack()">Attack</div>
                                <div class="action-item extra-action" onclick="openExtraMenu('bonus')">Extra</div>
                            </div>
                        </div>
                        <div class="action-category reaction">
                            <div class="action-category-title">üõ°Ô∏è Reaction</div>
                            <div class="action-list" id="reactionList">
                                <div class="action-item" onclick="openOpportunityAttack()">Opportunity Attack</div>
                                <div class="action-item" onclick="useAbsorbElements()">Absorb Elements</div>
                                <div class="action-item cosmic-omen-action" id="cosmicOmenReaction" style="display:none" onclick="useCosmicOmen()">Cosmic Omen</div>
                            </div>
                        </div>
                    </div>

                    <!-- Battle Log -->
                    <div class="battle-log" id="battleLog">
                        <div class="text-small text-muted mb-10">Battle Log:</div>
                        <div id="battleLogContent"></div>
                    </div>
                </div>
            </div>

            <!-- Skills -->
            <div class="card" id="skillsCard">
                <h2 class="card-title collapsible" onclick="toggleCard('skillsCard')">
                    <span>Skills</span>
                    <span class="collapse-toggle">‚ñº</span>
                </h2>
                <div class="card-content">
                    <div class="skills-grid">
                        <div class="skill-item" id="skill-acrobatics"><span>Acrobatics</span><span class="skill-mod" id="skillMod-acrobatics">+2</span></div>
                        <div class="skill-item" id="skill-animal"><span>Animal H.</span><span class="skill-mod" id="skillMod-animal">+4</span></div>
                        <div class="skill-item" id="skill-arcana"><span>Arcana*</span><span class="skill-mod" id="skillMod-arcana">+3</span></div>
                        <div class="skill-item" id="skill-athletics"><span>Athletics</span><span class="skill-mod" id="skillMod-athletics">-1</span></div>
                        <div class="skill-item" id="skill-deception"><span>Deception</span><span class="skill-mod" id="skillMod-deception">+1</span></div>
                        <div class="skill-item" id="skill-history"><span>History</span><span class="skill-mod" id="skillMod-history">-1</span></div>
                        <div class="skill-item" id="skill-insight"><span>Insight</span><span class="skill-mod" id="skillMod-insight">+4</span></div>
                        <div class="skill-item" id="skill-intimidation"><span>Intimidation</span><span class="skill-mod" id="skillMod-intimidation">+1</span></div>
                        <div class="skill-item" id="skill-investigation"><span>Investigation</span><span class="skill-mod" id="skillMod-investigation">-1</span></div>
                        <div class="skill-item" id="skill-medicine"><span>Medicine</span><span class="skill-mod" id="skillMod-medicine">+4</span></div>
                        <div class="skill-item proficient" id="skill-nature"><span>Nature*</span><span class="skill-mod proficient" id="skillMod-nature">+6</span></div>
                        <div class="skill-item proficient" id="skill-perception"><span>Perception</span><span class="skill-mod proficient" id="skillMod-perception">+7</span></div>
                        <div class="skill-item" id="skill-performance"><span>Performance</span><span class="skill-mod" id="skillMod-performance">+1</span></div>
                        <div class="skill-item" id="skill-persuasion"><span>Persuasion</span><span class="skill-mod" id="skillMod-persuasion">+1</span></div>
                        <div class="skill-item" id="skill-religion"><span>Religion</span><span class="skill-mod" id="skillMod-religion">-1</span></div>
                        <div class="skill-item" id="skill-sleight"><span>Sleight of H.</span><span class="skill-mod" id="skillMod-sleight">+2</span></div>
                        <div class="skill-item proficient" id="skill-stealth"><span>Stealth</span><span class="skill-mod proficient" id="skillMod-stealth">+5</span></div>
                        <div class="skill-item proficient" id="skill-survival"><span>Survival</span><span class="skill-mod proficient" id="skillMod-survival">+7</span></div>
                    </div>
                    <div class="text-small text-muted mt-10">* Magician adds +4 (Wis) to Arcana/Nature</div>
                </div>
            </div>

            <!-- Character Info -->
            <div class="card" id="charInfoCard">
                <h2 class="card-title collapsible" onclick="toggleCard('charInfoCard')">
                    <span>Character Info</span>
                    <span class="collapse-toggle">‚ñº</span>
                </h2>
                <div class="card-content">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9em;">
                        <div><strong style="color: var(--accent-purple);">Size:</strong> Medium</div>
                        <div><strong style="color: var(--accent-gold);">Background:</strong> Guide</div>
                        <div><strong style="color: var(--accent-purple);">Senses:</strong> <span id="sensesDisplay">Darkvision 60 ft</span></div>
                        <div><strong style="color: var(--accent-blue);">Passive Perception:</strong> <span id="passivePerceptionDisplay">17</span></div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em;">
                        <div><strong style="color: var(--accent-gold);">Languages:</strong> Common, Druidic, Celestial, Infernal</div>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); font-size: 0.85em;">
                        <div style="margin-bottom: 6px;"><strong style="color: var(--text-muted);">Armor:</strong> Light Armor, Shields (no metal)</div>
                        <div style="margin-bottom: 6px;"><strong style="color: var(--text-muted);">Weapons:</strong> Simple Weapons</div>
                        <div><strong style="color: var(--text-muted);">Tools:</strong> <span onclick="showToolInfo('herbalism-kit')" style="cursor: pointer; color: var(--accent-blue); text-decoration: underline;">Herbalism Kit</span>, <span onclick="showToolInfo('cartographers-tools')" style="cursor: pointer; color: var(--accent-blue); text-decoration: underline;">Cartographer's Tools</span></div>
                    </div>
                    <!-- Wild Shape abilities display -->
                    <div id="wildShapeAbilities" style="display: none; margin-top: 15px; padding: 12px; background: rgba(80, 200, 120, 0.1); border: 1px solid var(--accent-green); border-radius: 8px;">
                        <div style="font-weight: bold; color: var(--accent-green); margin-bottom: 8px;">üêæ Beast Abilities</div>
                        <div id="beastAbilitiesContent" style="font-size: 0.9em; line-height: 1.6;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SPELLS SECTION -->
        <div id="spells" class="section">
            <div class="card">
                <div class="prepared-counter-display">
                    <span>Prepared: </span>
                    <span id="spellPreparedCount" class="prepared-count-value">0</span>
                    <span> / </span>
                    <span id="spellPreparedMax">10</span>
                </div>
            </div>

            <!-- Cantrips -->
            <div class="card">
                <h2 class="card-title">Cantrips (At Will)</h2>
                <div class="cantrip-grid" id="cantripGrid"></div>
            </div>

            <!-- 1st Level -->
            <div class="card">
                <h2 class="card-title" onclick="toggleSpellSection('spells1')" style="cursor: pointer;">
                    <span>1st Level Spells</span>
                    <span id="spells1Toggle" style="font-size: 0.8em;">‚ñº</span>
                </h2>
                <div class="spell-list" id="spells1"></div>
            </div>

            <!-- 2nd Level -->
            <div class="card">
                <h2 class="card-title" onclick="toggleSpellSection('spells2')" style="cursor: pointer;">
                    <span>2nd Level Spells</span>
                    <span id="spells2Toggle" style="font-size: 0.8em;">‚ñº</span>
                </h2>
                <div class="spell-list" id="spells2"></div>
            </div>

            <!-- 3rd Level -->
            <div class="card">
                <h2 class="card-title" onclick="toggleSpellSection('spells3')" style="cursor: pointer;">
                    <span>3rd Level Spells</span>
                    <span id="spells3Toggle" style="font-size: 0.8em;">‚ñº</span>
                </h2>
                <div class="spell-list" id="spells3"></div>
            </div>

            <!-- 4th Level (Level 7+) -->
            <div class="card" id="spells4Card" style="display: none;">
                <h2 class="card-title" onclick="toggleSpellSection('spells4')" style="cursor: pointer;">
                    <span>4th Level Spells</span>
                    <span id="spells4Toggle" style="font-size: 0.8em;">‚ñº</span>
                </h2>
                <div class="spell-list" id="spells4"></div>
            </div>

            <!-- Beast Forms -->
            <div class="card">
                <h2 class="card-title" onclick="toggleSpellSection('beastForms')" style="cursor: pointer;">
                    <span>Wild Shape - Beast Forms</span>
                    <span class="card-title-badge" style="background: var(--accent-green);">Select 6</span>
                    <span id="beastFormsToggle" style="font-size: 0.8em; margin-left: auto;">‚ñº</span>
                </h2>
                <p class="text-small text-muted mb-10">Check up to 6 beast forms you know. At level 5: CR ‚â§ 1/2, no flying. Click a form for details.</p>
                <div id="beastForms"></div>
            </div>
        </div>

        <!-- INVENTORY SECTION -->
        <div id="inventory" class="section">
            <!-- Equipment Slots -->
            <div class="card">
                <h2 class="card-title">Equipped <span class="card-title-badge" id="acDisplay">AC: 15</span></h2>

                <!-- Weapon Slots -->
                <div class="equipment-slots-section">
                    <div class="slot-header">Weapons</div>
                    <div class="equipment-slots-row">
                        <div class="equipment-slot" id="slot-mainHand" onclick="showSlotOptions('mainHand')">
                            <div class="slot-label">Main Hand</div>
                            <div class="slot-content" id="mainHandContent">Empty</div>
                        </div>
                        <div class="equipment-slot" id="slot-offHand" onclick="showSlotOptions('offHand')">
                            <div class="slot-label">Off Hand</div>
                            <div class="slot-content" id="offHandContent">Empty</div>
                        </div>
                    </div>
                </div>

                <!-- Armor Slot -->
                <div class="equipment-slots-section">
                    <div class="slot-header">Armor</div>
                    <div class="equipment-slots-row">
                        <div class="equipment-slot wide" id="slot-armor" onclick="showSlotOptions('armor')">
                            <div class="slot-label">Body Armor</div>
                            <div class="slot-content" id="armorContent">Empty</div>
                        </div>
                    </div>
                </div>

                <!-- Accessory Slots -->
                <div class="equipment-slots-section">
                    <div class="slot-header">Accessories</div>
                    <div class="equipment-slots-grid">
                        <div class="equipment-slot small" id="slot-head" onclick="showSlotOptions('head')">
                            <div class="slot-label">Head</div>
                            <div class="slot-content" id="headContent">-</div>
                        </div>
                        <div class="equipment-slot small" id="slot-neck" onclick="showSlotOptions('neck')">
                            <div class="slot-label">Neck</div>
                            <div class="slot-content" id="neckContent">-</div>
                        </div>
                        <div class="equipment-slot small" id="slot-hands" onclick="showSlotOptions('hands')">
                            <div class="slot-label">Hands</div>
                            <div class="slot-content" id="handsContent">-</div>
                        </div>
                        <div class="equipment-slot small" id="slot-feet" onclick="showSlotOptions('feet')">
                            <div class="slot-label">Feet</div>
                            <div class="slot-content" id="feetContent">-</div>
                        </div>
                        <div class="equipment-slot small" id="slot-ring1" onclick="showSlotOptions('ring1')">
                            <div class="slot-label">Ring 1</div>
                            <div class="slot-content" id="ring1Content">-</div>
                        </div>
                        <div class="equipment-slot small" id="slot-ring2" onclick="showSlotOptions('ring2')">
                            <div class="slot-label">Ring 2</div>
                            <div class="slot-content" id="ring2Content">-</div>
                        </div>
                    </div>
                </div>

                <!-- Attunement -->
                <div class="attunement-section">
                    <div class="slot-header">Attunement <span id="attunementCount">(0/3)</span></div>
                    <div id="attunedItems" class="attuned-list">No attuned items</div>
                </div>
            </div>

            <!-- Inventory List (unequipped items) -->
            <div class="card">
                <h2 class="card-title">Inventory
                    <div style="display: flex; gap: 8px;">
                        <button class="add-btn" onclick="openAddEquipmentModal()">+ Add</button>
                        <button class="add-btn" onclick="openAddAmmoModal()" style="background: var(--accent-green);">+ Ammo</button>
                    </div>
                </h2>
                <div id="inventoryList" class="inventory-list"></div>
            </div>

            <!-- Adventuring Gear -->
            <div class="card">
                <h2 class="card-title">Adventuring Gear
                    <button class="add-btn" onclick="openAddGearModal()">+ Add</button>
                </h2>
                <div id="gearList" class="inventory-list"></div>
            </div>

            <!-- Currency -->
            <div class="card">
                <h2 class="card-title">Currency</h2>
                <div class="currency-row">
                    <div class="currency-item"><label>CP</label><input type="number" id="currencyCP" value="0" min="0"></div>
                    <div class="currency-item"><label>SP</label><input type="number" id="currencySP" value="0" min="0"></div>
                    <div class="currency-item"><label>GP</label><input type="number" id="currencyGP" value="12" min="0"></div>
                    <div class="currency-item"><label>PP</label><input type="number" id="currencyPP" value="0" min="0"></div>
                </div>
            </div>
        </div>

        <!-- FEATURES SECTION -->
        <div id="features" class="section">
            <div class="card">
                <h2 class="card-title">Background</h2>
                <div class="feature-list" id="backgroundFeatures"></div>
            </div>
            <div class="card">
                <h2 class="card-title">Species: Half-Aasimar/Half-Tiefling</h2>
                <div class="feature-list" id="ancestryFeatures"></div>
            </div>
            <div class="card">
                <h2 class="card-title" id="classLevelTitle">Class: Druid (Level 5)</h2>
                <div class="feature-list" id="druidFeatures"></div>
            </div>
            <div class="card">
                <h2 class="card-title">Subclass: Circle of Stars</h2>
                <div class="feature-list" id="starsFeatures"></div>
            </div>
            <div class="card">
                <h2 class="card-title">Feats</h2>
                <div class="feature-list" id="featFeatures"></div>
            </div>
            <div class="card">
                <h2 class="card-title">Proficiencies & Skills</h2>
                <div class="feature-list" id="skillsFeatures"></div>
            </div>

        </div>

        <!-- BACKSTORY SECTION -->
        <div id="backstory" class="section">
            <div class="card">
                <h2 class="card-title">Appearance</h2>
                <table class="appearance-table">
                    <tr><td>Skin</td><td>Vitiligo - patches of luminous pale gold contrasting with deep reddish-bronze</td></tr>
                    <tr><td>Horns</td><td>Single curved horn on the right side of his head</td></tr>
                    <tr><td>Hair</td><td>Two colors - silver-white and deep crimson, naturally split</td></tr>
                    <tr><td>Eyes</td><td>Heterochromia - one golden with soft glow, one deep amber with vertical pupil</td></tr>
                    <tr><td>Build</td><td>Medium height, lean</td></tr>
                    <tr><td>Other</td><td>Faint constellation-like freckles across shoulders</td></tr>
                </table>
            </div>
            <div class="card">
                <h2 class="card-title">Origins</h2>
                <div class="backstory-text">
                    <p>Ashvael was born on a lush forest world where druids served as spiritual guides and astronomers. His parents - an Aasimar and a Tiefling - were both Circle of Stars practitioners.</p>
                    <p>His Aasimar parent taught him the <strong>celestial constellations</strong>: stories of hope and divine guidance. His Tiefling parent taught him the <strong>infernal stars</strong>: tales of ambition and finding light in darkness.</p>
                </div>
            </div>
            <div class="card">
                <h2 class="card-title">The Cataclysm</h2>
                <div class="backstory-text">
                    <p>One night, the stars fell wrong. Crystalline vines erupted from the ground across his world. The vines destroyed cities, uprooted forests, and consumed everything. Ashvael survived, but his world did not.</p>
                </div>
            </div>
            <div class="card">
                <h2 class="card-title">Current Situation</h2>
                <div class="backstory-text">
                    <p>His search for answers made him careless. A Mind Flayer Nautiloid captured his vessel. Now Ashvael waits in the ship's holds, his connection to the stars muffled but not severed, hoping for rescue.</p>
                    <p style="color: var(--accent-purple); font-style: italic;">[The party will rescue him from the Mind Flayers]</p>
                </div>
            </div>
            <div class="card">
                <h2 class="card-title">Personality</h2>
                <div class="personality-traits">
                    <div class="trait-item"><strong>Ideal:</strong> "The same stars shine on everyone. It's not about what you are - it's about what stories you choose to see."</div>
                    <div class="trait-item"><strong>Bond:</strong> "My world is gone, but others can still be saved. I will find what caused the crystalline vines."</div>
                    <div class="trait-item"><strong>Flaw:</strong> "I sometimes trust the stars' guidance more than common sense."</div>
                </div>
            </div>
        </div>

        <!-- NOTES SECTION -->
        <div id="notes" class="section">
            <div class="card">
                <h2 class="card-title">Notes</h2>
                <div class="notes-tabs">
                    <button class="notes-tab active" onclick="showNotesCategory('sessions')">Sessions</button>
                    <button class="notes-tab" onclick="showNotesCategory('locations')">Locations</button>
                    <button class="notes-tab" onclick="showNotesCategory('npcs')">NPCs</button>
                    <button class="notes-tab" onclick="showNotesCategory('battles')">Battles</button>
                    <button class="notes-tab" onclick="showNotesCategory('other')">Other</button>
                </div>
                <div class="notes-content" id="notesContent">
                    <div class="notes-folder-view" id="notesFolderView"></div>
                    <div class="add-note-row" id="addNoteRow">
                        <!-- Dynamic content based on category -->
                    </div>
                </div>
            </div>
            <div class="card" id="noteEditorCard" style="display:none;">
                <h2 class="card-title">
                    <span id="noteEditorTitle">Editing Note</span>
                    <button class="card-title-badge" onclick="closeNoteEditor()" style="cursor:pointer;">‚úï Close</button>
                </h2>
                <textarea id="noteEditor" class="note-textarea" placeholder="Write your notes here..."></textarea>
                <button class="save-note-btn" onclick="saveCurrentNote()">Save Note</button>
            </div>

            <!-- BACKUP SECTION -->
            <div class="card">
                <h2 class="card-title">üíæ Backup & Sync</h2>
                <div style="padding: 10px 0;">
                    <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 0.9em;">
                        Export your character data after each session. Import to restore from a backup.
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="exportBackup()" style="flex: 1; min-width: 120px; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">
                            üì§ Export Backup
                        </button>
                        <button onclick="document.getElementById('importBackupInput').click()" style="flex: 1; min-width: 120px; padding: 12px; background: var(--accent-blue); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">
                            üì• Import Backup
                        </button>
                        <input type="file" id="importBackupInput" accept=".json" onchange="importBackup(event)" style="display: none;">
                    </div>
                    <div id="lastBackupInfo" style="margin-top: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; font-size: 0.85em; color: var(--text-muted);"></div>
                </div>

                <!-- GitHub Sync -->
                <div style="border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                    <h3 style="font-size: 1em; margin-bottom: 10px;">‚òÅÔ∏è GitHub Sync</h3>
                    <div id="githubSyncStatus"></div>
                    <div id="githubSyncButtons" style="display: none;">
                        <button onclick="pushToGitHub()" style="width: 100%; padding: 12px; background: var(--accent-purple); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
                            üöÄ Push to GitHub
                        </button>
                        <button onclick="pullFromGitHub()" style="width: 100%; padding: 12px; background: var(--accent-blue); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
                            üì• Pull from GitHub
                        </button>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="openGitHubSettings()" style="flex: 1; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-muted); cursor: pointer;">
                                ‚öôÔ∏è Settings
                            </button>
                            <button onclick="disconnectGitHub()" style="padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--accent-red); cursor: pointer;">
                                Disconnect
                            </button>
                        </div>
                    </div>
                    <div id="githubSetupPrompt">
                        <p style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 10px;">
                            Connect to GitHub to sync your character sheet directly to your repository.
                        </p>
                        <button onclick="openGitHubSettings()" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-weight: bold; cursor: pointer;">
                            üîó Connect GitHub
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showSection('sheet')">
            <span class="nav-icon">üìã</span>
            <span>Sheet</span>
        </div>
        <div class="nav-item" onclick="showSection('spells')">
            <span class="nav-icon">‚ú®</span>
            <span>Spells</span>
        </div>
        <div class="nav-item" onclick="showSection('inventory')">
            <span class="nav-icon">üéí</span>
            <span>Inventory</span>
        </div>
        <div class="nav-item" onclick="showSection('features')">
            <span class="nav-icon">‚≠ê</span>
            <span>Features</span>
        </div>
        <div class="nav-item" onclick="showSection('backstory')">
            <span class="nav-icon">üìñ</span>
            <span>Story</span>
        </div>
        <div class="nav-item" onclick="showSection('notes')">
            <span class="nav-icon">üìù</span>
            <span>Notes</span>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Title</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // ===== CHARACTER BASE STATS =====
        const PROFICIENCY_BONUS = 3; // Level 5

        const BASE_ABILITY_SCORES = {
            str: 8,   // -1
            dex: 14,  // +2
            con: 15,  // +2
            int: 8,   // -1
            wis: 18,  // +4
            cha: 12   // +1
        };

        // Skills with their governing ability and proficiency status
        // expertise = double proficiency bonus
        const SKILLS = {
            acrobatics:     { ability: 'dex', proficient: false, expertise: false, id: 'skill-acrobatics', modId: 'skillMod-acrobatics' },
            animalHandling: { ability: 'wis', proficient: false, expertise: false, id: 'skill-animal', modId: 'skillMod-animal' },
            arcana:         { ability: 'int', proficient: false, expertise: false, id: 'skill-arcana', modId: 'skillMod-arcana', bonus: 4 }, // +4 from Magician (adds WIS mod)
            athletics:      { ability: 'str', proficient: false, expertise: false, id: 'skill-athletics', modId: 'skillMod-athletics' },
            deception:      { ability: 'cha', proficient: false, expertise: false, id: 'skill-deception', modId: 'skillMod-deception' },
            history:        { ability: 'int', proficient: false, expertise: false, id: 'skill-history', modId: 'skillMod-history' },
            insight:        { ability: 'wis', proficient: false, expertise: false, id: 'skill-insight', modId: 'skillMod-insight' },
            intimidation:   { ability: 'cha', proficient: false, expertise: false, id: 'skill-intimidation', modId: 'skillMod-intimidation' },
            investigation:  { ability: 'int', proficient: false, expertise: false, id: 'skill-investigation', modId: 'skillMod-investigation' },
            medicine:       { ability: 'wis', proficient: false, expertise: false, id: 'skill-medicine', modId: 'skillMod-medicine' },
            nature:         { ability: 'int', proficient: true,  expertise: false, id: 'skill-nature', modId: 'skillMod-nature', bonus: 4 }, // Proficient + Magician bonus (+4 WIS)
            perception:     { ability: 'wis', proficient: true,  expertise: false, id: 'skill-perception', modId: 'skillMod-perception' },
            performance:    { ability: 'cha', proficient: false, expertise: false, id: 'skill-performance', modId: 'skillMod-performance' },
            persuasion:     { ability: 'cha', proficient: false, expertise: false, id: 'skill-persuasion', modId: 'skillMod-persuasion' },
            religion:       { ability: 'int', proficient: false, expertise: false, id: 'skill-religion', modId: 'skillMod-religion' },
            sleightOfHand:  { ability: 'dex', proficient: false, expertise: false, id: 'skill-sleight', modId: 'skillMod-sleight' },
            stealth:        { ability: 'dex', proficient: true,  expertise: false, id: 'skill-stealth', modId: 'skillMod-stealth' },
            survival:       { ability: 'wis', proficient: true,  expertise: false, id: 'skill-survival', modId: 'skillMod-survival' }
        };

        // Calculate ability modifier from score
        function getAbilityMod(score) {
            return Math.floor((score - 10) / 2);
        }

        // Calculate skill modifier given ability scores
        function calculateSkillMod(skillName, abilityScores) {
            const skill = SKILLS[skillName];
            if (!skill) return 0;

            const abilityMod = getAbilityMod(abilityScores[skill.ability]);
            let profBonus = 0;

            if (skill.expertise) {
                profBonus = PROFICIENCY_BONUS * 2;
            } else if (skill.proficient) {
                profBonus = PROFICIENCY_BONUS;
            }

            // Add any static bonus (like from items or features)
            const staticBonus = skill.bonus || 0;

            return abilityMod + profBonus + staticBonus;
        }

        // Format modifier as string (+X or -X)
        function formatMod(mod) {
            return mod >= 0 ? '+' + mod : '' + mod;
        }

        // Get current ability scores (considers Wild Shape)
        function getCurrentAbilityScores() {
            // Only use beast scores if actively in wild shape AND beast exists
            if (state.activeForm && state.activeForm.type === 'wild-shape' && state.activeForm.beastId) {
                const beast = (typeof BEAST_FORMS !== 'undefined') ? BEAST_FORMS.find(b => b.id === state.activeForm.beastId) : null;
                if (beast && beast.str && beast.dex) {
                    return {
                        str: beast.str,
                        dex: beast.dex,
                        con: beast.con || 12,
                        int: BASE_ABILITY_SCORES.int,
                        wis: BASE_ABILITY_SCORES.wis,
                        cha: BASE_ABILITY_SCORES.cha
                    };
                }
            }
            // Always fall back to base scores
            return { ...BASE_ABILITY_SCORES };
        }

        // ===== STATE MANAGEMENT =====
        const STATE_VERSION = 3; // Increment to force state reset

        // Helper: Get max spell level based on character level
        function getMaxSpellLevel() {
            const level = state.characterLevel || 5;
            if (level >= 17) return 9;
            if (level >= 15) return 8;
            if (level >= 13) return 7;
            if (level >= 11) return 6;
            if (level >= 9) return 5;
            if (level >= 7) return 4;
            if (level >= 5) return 3;
            if (level >= 3) return 2;
            return 1;
        }

        // Helper: Get max prepared spells from level config
        function getMaxPreparedSpells() {
            const config = getLevelConfig();
            return config.maxPreparedSpells;
        }

        const DEFAULT_STATE = {
            version: STATE_VERSION,
            characterLevel: 6,  // Track current level
            hp: { current: 45, max: 45, temp: 0 },
            hpHistory: [],
            slots: { 1: [false,false,false,false], 2: [false,false,false], 3: [false,false,false] },
            resources: { guidingBolt: 4, wildShape: 2, healingHands: 1, healingWordFree: 1, celestialRevelation: 1, cosmicOmen: 3 },
            cosmicOmenType: null,  // 'weal' or 'woe' - chosen after Long Rest
            preparedSpells: [],
            knownBeastForms: ['cat', 'wolf', 'panther', 'giant-wolf-spider', 'black-bear', 'ape'],
            activeForm: null,
            inBattle: false,
            battleRound: 1,
            battleLog: [],
            battleHistory: [],
            actionsUsed: { action: false, bonus: false, reaction: false },
            equipment: [],
            inventory: [],
            notes: { sessions: [], locations: [], npcs: [], battles: [], other: [] },
            concentration: null,
            companions: [],  // Array to support multiple companions (familiar + summon beast)
            itemCharges: {},  // Track charges for magic items: { itemId: { current: N, usedToday: [] } }
            itemSpellsUsed: {},  // Track 1/day spell usage: { itemId_spellName: true }
            thrownWeapons: [],  // Track weapons that have been thrown and can be reclaimed
            movementUsed: 0,  // Track movement used in current round
            hitDiceRemaining: 6  // Hit Dice remaining for short rest healing
        };

        let state = JSON.parse(JSON.stringify(DEFAULT_STATE));

        // ===== COMPREHENSIVE LEVEL CONFIG (Levels 5-8) =====
        // Contains ALL stats for each level - when level changes, everything updates
        const LEVEL_CONFIG = {
            5: {
                level: 5,
                proficiencyBonus: 3,
                maxHp: 38,  // 8 + (4√ó5) + (5√ó2) = 8 + 20 + 10
                maxPreparedSpells: 9,  // WIS (4) + Level (5)
                slots: { 1: 4, 2: 3, 3: 2 },
                wildShapeTempHp: 5,
                wildShapeDuration: 2.5,  // hours
                wildShapeMaxCR: 0.5,
                canFlyWildShape: false,
                cosmicOmenUses: 0,  // Not available at level 5
                features: ['starMap', 'starryForm', 'wildShape', 'wildCompanion'],
                cantripsKnown: 4  // 3 druid + 1 magician
            },
            6: {
                level: 6,
                proficiencyBonus: 3,
                maxHp: 45,  // 38 + 5 + 2
                maxPreparedSpells: 10,
                slots: { 1: 4, 2: 3, 3: 3 },
                wildShapeTempHp: 6,
                wildShapeDuration: 3,
                wildShapeMaxCR: 0.5,
                canFlyWildShape: false,
                cosmicOmenUses: 3,  // Proficiency bonus
                features: ['starMap', 'starryForm', 'wildShape', 'wildCompanion', 'cosmicOmen'],
                cantripsKnown: 4
            },
            7: {
                level: 7,
                proficiencyBonus: 3,
                maxHp: 52,  // 45 + 5 + 2
                maxPreparedSpells: 11,
                slots: { 1: 4, 2: 3, 3: 3, 4: 1 },
                wildShapeTempHp: 7,
                wildShapeDuration: 3.5,
                wildShapeMaxCR: 0.5,
                canFlyWildShape: false,
                cosmicOmenUses: 3,
                features: ['starMap', 'starryForm', 'wildShape', 'wildCompanion', 'cosmicOmen'],
                cantripsKnown: 4,
                newSpellLevel: 4
            },
            8: {
                level: 8,
                proficiencyBonus: 3,
                maxHp: 59,  // 52 + 5 + 2
                maxPreparedSpells: 12,
                slots: { 1: 4, 2: 3, 3: 3, 4: 2 },
                wildShapeTempHp: 8,
                wildShapeDuration: 4,
                wildShapeMaxCR: 0.5,
                canFlyWildShape: true,  // Unlocked at level 8!
                cosmicOmenUses: 3,
                features: ['starMap', 'starryForm', 'wildShape', 'wildCompanion', 'cosmicOmen'],
                cantripsKnown: 4,
                asiAvailable: true
            }
        };

        // Get current level config
        function getLevelConfig() {
            const level = state.characterLevel || 6;
            return LEVEL_CONFIG[level] || LEVEL_CONFIG[6];
        }

        // ===== SET CHARACTER LEVEL =====
        // Main function to change level - updates EVERYTHING
        function setCharacterLevel(newLevel) {
            if (newLevel < 5 || newLevel > 8) {
                showToast('Level must be between 5 and 8');
                return;
            }

            saveForUndo();
            const oldLevel = state.characterLevel || 6;
            const config = LEVEL_CONFIG[newLevel];

            // Update level
            state.characterLevel = newLevel;

            // Update HP (set to max for the new level)
            const hpDiff = config.maxHp - (LEVEL_CONFIG[oldLevel]?.maxHp || 38);
            state.hp.max = config.maxHp;
            state.hp.current = Math.min(state.hp.current + Math.max(0, hpDiff), config.maxHp);

            // Update spell slots structure
            const newSlots = {};
            for (const [lvl, count] of Object.entries(config.slots)) {
                // Create array of false (unused) slots
                const existingSlots = state.slots[lvl] || [];
                newSlots[lvl] = [];
                for (let i = 0; i < count; i++) {
                    // Preserve used status if slot existed before
                    newSlots[lvl].push(existingSlots[i] || false);
                }
            }
            state.slots = newSlots;

            // Update resources
            state.resources.cosmicOmen = config.cosmicOmenUses;

            // Reset cosmic omen type if downgrading below level 6
            if (newLevel < 6) {
                state.cosmicOmenType = null;
            }

            // Remove 4th level spells from prepared if going below level 7
            if (newLevel < 7) {
                const removed = state.preparedSpells.filter(s => s.level >= 4);
                if (removed.length > 0) {
                    state.preparedSpells = state.preparedSpells.filter(s => s.level < 4);
                    showToast(`Removed ${removed.length} spell(s) above level 3`);
                }
            }

            // Reset Hit Dice to new level max
            state.hitDiceRemaining = newLevel;

            // Update all displays
            updateAllDisplays();
            renderSpells();  // Re-render to show/hide 4th level spells
            renderFeatures();  // Update features visibility
            saveState();

            showToast(`Level set to ${newLevel}! HP: ${state.hp.current}/${config.maxHp}`);
        }

        // Open level selector modal
        function openLevelSelector() {
            const currentLevel = state.characterLevel || 6;
            const config = getLevelConfig();

            let body = `
                <div style="margin-bottom: 20px;">
                    <p class="text-muted">Select your character level. All stats will update automatically.</p>
                </div>
                <div class="form-options">
            `;

            for (let lvl = 5; lvl <= 8; lvl++) {
                const lvlConfig = LEVEL_CONFIG[lvl];
                const isActive = lvl === currentLevel;
                const activeStyle = isActive ? 'border-color: var(--accent-gold); background: rgba(201, 162, 39, 0.1);' : '';

                let features = [];
                if (lvl >= 6) features.push('Cosmic Omen');
                if (lvl >= 7) features.push('4th Level Spells');
                if (lvl >= 8) features.push('Flying Wild Shape', 'ASI/Feat');

                body += `
                    <div class="form-option" onclick="setCharacterLevel(${lvl}); closeModal();" style="${activeStyle}">
                        <div class="form-option-title" ${isActive ? 'style="color: var(--accent-gold);"' : ''}>
                            ${isActive ? '‚úì ' : ''}Level ${lvl} ${isActive ? '(Current)' : ''}
                        </div>
                        <div class="form-option-desc">
                            HP: ${lvlConfig.maxHp} | Prepared: ${lvlConfig.maxPreparedSpells} |
                            Slots: ${Object.entries(lvlConfig.slots).map(([l,c]) => `${c}√ó${l}st`).join(', ')}
                        </div>
                        ${features.length > 0 ? `<div class="form-option-desc" style="color: var(--accent-purple); font-size: 0.8em; margin-top: 5px;">+ ${features.join(', ')}</div>` : ''}
                    </div>
                `;
            }

            body += '</div>';
            showModal('Select Character Level', body);
        }

        // ===== LEVEL UP DATA (kept for reference/migration) =====
        const LEVEL_UP_DATA = {
            6: {
                name: "Level 6",
                hpIncrease: { die: 8, con: 2 },  // 1d8 + CON mod
                maxPreparedSpells: 10,  // WIS (4) + Level (6)
                slots: { 1: 4, 2: 3, 3: 3 },  // Gain 1 3rd level slot
                proficiencyBonus: 3,
                features: [
                    {
                        name: "Cosmic Omen",
                        source: "Circle of Stars Level 6",
                        category: "stars",
                        desc: "<strong>After Long Rest</strong> | Uses: 3 per Long Rest (Proficiency Bonus)<br><br>After each Long Rest, <strong>choose</strong> your cosmic omen:<br><br><strong style='color: var(--accent-gold);'>‚òÄÔ∏è Weal (Good Omen):</strong><br>Reaction: When a creature you can see within 30 feet makes an attack roll, saving throw, or ability check, you can add 1d6 to the roll.<br><br><strong style='color: var(--accent-purple);'>üåë Woe (Bad Omen):</strong><br>Reaction: When a creature you can see within 30 feet makes an attack roll, saving throw, or ability check, you can subtract 1d6 from the roll.<br><br>You can use this feature a number of times equal to your proficiency bonus. Your chosen omen appears in the Reactions menu."
                    }
                ],
                newResource: { cosmicOmen: 3 },
                wildShapeChanges: null,
                newSpellLevel: null
            },
            7: {
                name: "Level 7",
                hpIncrease: { die: 8, con: 2 },
                maxPreparedSpells: 11,
                slots: { 1: 4, 2: 3, 3: 3, 4: 1 },  // Gain 4th level slots!
                proficiencyBonus: 3,
                features: [],
                newResource: null,
                wildShapeChanges: null,
                newSpellLevel: 4,
                newSpells: [
                    { id: "conjure-minor-elementals", name: "Conjure Minor Elementals", school: "Conjuration", conc: true, ritual: false, time: "Action", range: "Self (15-foot emanation)", dur: "Conc, 1 hour", comp: "V, S", desc: "You conjure spirits from the Elemental Planes that flit around you in a 15-foot Emanation for the duration. Until the spell ends, any attack you make deals an extra 2d8 damage when you hit a creature in the Emanation. This damage is Acid, Cold, Fire, or Lightning (your choice when you cast the spell). In addition, the ground in the Emanation is Difficult Terrain for your enemies.", higher: "Extra damage increases by 2d8 for each slot level above 4th." },
                    { id: "conjure-woodland-beings", name: "Conjure Woodland Beings", school: "Conjuration", conc: true, ritual: false, time: "Action", range: "Self (10-foot emanation)", dur: "Conc, 10 min", comp: "V, S", desc: "You conjure nature spirits that flit around you in a 10-foot Emanation for the duration. Whenever the Emanation enters the space of a creature you can see and whenever a creature you can see enters the Emanation or ends its turn there, you can force that creature to make a Wisdom saving throw. The creature takes 5d8 Force damage on a failed save or half as much damage on a successful one. A creature makes this save only once per turn.", higher: "Damage increases by 1d8 for each slot level above 4th." },
                    { id: "freedom-of-movement", name: "Freedom of Movement", school: "Abjuration", conc: false, ritual: false, time: "Action", range: "Touch", dur: "1 hour", comp: "V, S, M (leather strap)", desc: "You touch a willing creature. For the duration, the target's movement is unaffected by Difficult Terrain, and spells and other magical effects can neither reduce the target's Speed nor cause the target to have the Paralyzed or Restrained conditions. The target can also spend 5 feet of movement to automatically escape from nonmagical restraints." },
                    { id: "ice-storm", name: "Ice Storm", school: "Evocation", conc: false, ritual: false, time: "Action", range: "300 ft", dur: "Instant", comp: "V, S, M (a pinch of dust and a few drops of water)", desc: "A hail of rock-hard ice pounds to the ground in a 20-foot-radius, 40-foot-high Cylinder centered on a point within range. Each creature in the Cylinder makes a Dexterity saving throw. A creature takes 2d10 Bludgeoning damage and 4d6 Cold damage on a failed save or half as much damage on a successful one. Hailstones turn the Cylinder's area of effect into Difficult Terrain until the end of your next turn.", higher: "Bludgeoning damage increases by 1d10 for each slot level above 4th." },
                    { id: "polymorph", name: "Polymorph", school: "Transmutation", conc: true, ritual: false, time: "Action", range: "60 ft", dur: "Conc, 1 hour", comp: "V, S, M (a caterpillar cocoon)", desc: "You attempt to transform a creature that you can see within range into a Beast. The target must succeed on a Wisdom saving throw or shape-shift into Beast form for the duration. That form can be any Beast you choose that has a Challenge Rating equal to or less than the target's (or the target's level if it doesn't have a Challenge Rating). An unwilling target automatically succeeds if it is missing any limbs or incapacitated." },
                    { id: "stone-shape", name: "Stone Shape", school: "Transmutation", conc: false, ritual: false, time: "Action", range: "Touch", dur: "Instant", comp: "V, S, M (soft clay)", desc: "You touch a stone object of Medium size or smaller or a section of stone no more than 5 feet in any dimension and form it into any shape you like. For example, you could shape a large rock into a weapon, idol, or coffer, or make a small passage through a wall, as long as the wall is less than 5 feet thick." },
                    { id: "wall-of-fire", name: "Wall of Fire", school: "Evocation", conc: true, ritual: false, time: "Action", range: "120 ft", dur: "Conc, 1 min", comp: "V, S, M (a small piece of phosphorus)", desc: "You create a wall of fire on a solid surface within range. You can make the wall up to 60 feet long, 20 feet high, and 1 foot thick, or a ringed wall up to 20 feet in diameter, 20 feet high, and 1 foot thick. One side of the wall deals 5d8 Fire damage to each creature that ends its turn within 10 feet of that side. A creature also takes that damage when it enters the wall's space for the first time on a turn or ends its turn there.", higher: "Damage increases by 1d8 for each slot level above 4th." }
                ]
            },
            8: {
                name: "Level 8",
                hpIncrease: { die: 8, con: 2 },
                maxPreparedSpells: 12,
                slots: { 1: 4, 2: 3, 3: 3, 4: 2 },  // Gain 2nd 4th level slot
                proficiencyBonus: 3,
                features: [],
                newResource: null,
                wildShapeChanges: {
                    canFly: true,
                    description: "Wild Shape Improvement: You can now transform into beasts with a flying speed!"
                },
                newSpellLevel: null,
                asi: {
                    required: true,
                    options: [
                        { type: "asi", name: "+2 to one ability or +1 to two abilities" },
                        { type: "feat", name: "Choose a feat (if allowed)" }
                    ]
                }
            }
        };

        // ===== LEVEL DISPLAY SYSTEM =====
        function updateLevelDisplay() {
            const level = state.characterLevel || 6;
            const config = getLevelConfig();
            const topBarEl = document.getElementById('topBarLevel');
            const classTitle = document.getElementById('classLevelTitle');

            if (topBarEl) {
                topBarEl.textContent = `Level ${level} Druid (Circle of Stars) ‚ñº`;
            }
            if (classTitle) {
                classTitle.textContent = `Class: Druid (Level ${level})`;
            }
            // Hit Dice badge is handled by updateHitDiceBadge()
        }

        function openLevelUp() {
            const currentLevel = state.characterLevel || 5;
            const nextLevel = currentLevel + 1;

            if (nextLevel > 8) {
                showToast('Already at maximum level!');
                return;
            }

            const levelData = LEVEL_UP_DATA[nextLevel];
            if (!levelData) {
                showToast('Level data not found');
                return;
            }

            // Roll HP
            const hpRoll = Math.floor(Math.random() * levelData.hpIncrease.die) + 1;
            const hpGain = hpRoll + levelData.hpIncrease.con;

            let content = `
                <div class="level-up-content">
                    <div class="level-up-section">
                        <h4>üìä Hit Points</h4>
                        <div class="level-up-item">
                            <span class="icon">‚ù§Ô∏è</span>
                            <span class="text">HP Increase (1d${levelData.hpIncrease.die} + ${levelData.hpIncrease.con})</span>
                            <span class="value">+${hpGain} (rolled ${hpRoll})</span>
                        </div>
                    </div>

                    <div class="level-up-section">
                        <h4>‚ú® Spell Slots</h4>
            `;

            // Show spell slot changes
            const currentSlots = nextLevel === 6 ? { 1: 4, 2: 3, 3: 2 } :
                                 nextLevel === 7 ? { 1: 4, 2: 3, 3: 3 } :
                                 { 1: 4, 2: 3, 3: 3, 4: 1 };

            for (const [slotLevel, count] of Object.entries(levelData.slots)) {
                const prevCount = currentSlots[slotLevel] || 0;
                const change = count - prevCount;
                if (change > 0) {
                    content += `
                        <div class="level-up-item">
                            <span class="icon">üîÆ</span>
                            <span class="text">Level ${slotLevel} Slots</span>
                            <span class="value">${prevCount} ‚Üí ${count} (+${change})</span>
                        </div>
                    `;
                }
            }

            content += `
                        <div class="level-up-item">
                            <span class="icon">üìñ</span>
                            <span class="text">Prepared Spells</span>
                            <span class="value">${levelData.maxPreparedSpells} max</span>
                        </div>
                    </div>
            `;

            // Show new features
            if (levelData.features && levelData.features.length > 0) {
                content += `<div class="level-up-section"><h4>üåü New Features</h4>`;
                levelData.features.forEach(feat => {
                    content += `
                        <div class="level-up-item">
                            <span class="icon">‚≠ê</span>
                            <span class="text"><strong>${feat.name}</strong><br><small style="color: var(--text-secondary);">${feat.source}</small></span>
                        </div>
                    `;
                });
                content += `</div>`;
            }

            // Show wild shape changes
            if (levelData.wildShapeChanges) {
                content += `
                    <div class="level-up-section">
                        <h4>ü¶Ö Wild Shape</h4>
                        <div class="level-up-item">
                            <span class="icon">‚úàÔ∏è</span>
                            <span class="text">${levelData.wildShapeChanges.description}</span>
                        </div>
                    </div>
                `;
            }

            // Show new spell level
            if (levelData.newSpellLevel) {
                content += `
                    <div class="level-up-section">
                        <h4>üìú New Spells Unlocked (Level ${levelData.newSpellLevel})</h4>
                        <p style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">
                            You can now prepare level ${levelData.newSpellLevel} spells! New options available:
                        </p>
                        <div class="level-up-spells-list">
                `;
                levelData.newSpells.forEach(spell => {
                    content += `
                        <div class="level-up-item" style="flex-direction: column; align-items: flex-start;">
                            <strong style="color: var(--accent-purple);">${spell.name}</strong>
                            <small style="color: var(--text-muted);">${spell.school}${spell.conc ? ' ‚Ä¢ Concentration' : ''} ‚Ä¢ ${spell.time}</small>
                        </div>
                    `;
                });
                content += `</div></div>`;
            }

            // Show ASI/Feat choice at level 8
            if (levelData.asi && levelData.asi.required) {
                content += `
                    <div class="level-up-section">
                        <h4>üéØ Ability Score Improvement</h4>
                        <p style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">
                            At level 8, you receive an Ability Score Improvement. Choose one:
                        </p>
                        <div class="asi-option selected" onclick="this.classList.add('selected'); this.nextElementSibling.classList.remove('selected');">
                            <strong>+2 to One Ability</strong> or <strong>+1 to Two Abilities</strong>
                            <br><small style="color: var(--text-muted);">Increase ability scores (max 20)</small>
                        </div>
                        <div class="asi-option" onclick="this.classList.add('selected'); this.previousElementSibling.classList.remove('selected');">
                            <strong>Choose a Feat</strong>
                            <br><small style="color: var(--text-muted);">If your DM allows feats</small>
                        </div>
                        <p style="font-size: 0.85em; color: var(--accent-gold); margin-top: 8px;">
                            ‚ö†Ô∏è Note: ASI/Feat must be applied manually to your character stats
                        </p>
                    </div>
                `;
            }

            content += `
                    <button class="level-up-confirm" onclick="applyLevelUp(${nextLevel}, ${hpGain})">
                        ‚úì Level Up to ${nextLevel}!
                    </button>
                </div>
            `;

            showModal(`‚¨ÜÔ∏è Level Up: ${currentLevel} ‚Üí ${nextLevel}`, content);
        }

        function applyLevelUp(newLevel, hpGain) {
            saveForUndo();

            const levelData = LEVEL_UP_DATA[newLevel];
            if (!levelData) return;

            // Update character level
            state.characterLevel = newLevel;

            // Increase HP
            state.hp.max += hpGain;
            state.hp.current += hpGain;

            // Update spell slots
            state.slots = {};
            for (const [slotLevel, count] of Object.entries(levelData.slots)) {
                state.slots[slotLevel] = Array(count).fill(false);
            }

            // Add new resources if any
            if (levelData.newResource) {
                for (const [key, value] of Object.entries(levelData.newResource)) {
                    state.resources[key] = value;
                }
            }

            // Update proficiency bonus in resources if it increased
            if (levelData.proficiencyBonus === 3 && newLevel === 6) {
                // Guiding Bolt uses = proficiency bonus (increases from 3 to 3, no change at 6)
                // At level 9 it would increase to 4, but max level is 8
            }

            saveState();
            closeModal();
            updateAllDisplays();

            // Re-render features to show newly unlocked ones
            if (typeof renderFeatures === 'function') {
                renderFeatures();
            }

            // Re-render spells to show new spell levels
            if (typeof renderSpells === 'function') {
                renderSpells();
            }

            // Show success message
            showToast(`üéâ Leveled up to ${newLevel}! HP +${hpGain}`);
        }

        function addFeatureToDisplay(feature) {
            // This adds the feature dynamically to the appropriate section
            // The features are rendered from static data, so new features from level up
            // should be added to the DRUID_FEATURES or STARS_FEATURES arrays
            // For now, we'll show a toast about the new feature
            showToast(`New feature: ${feature.name}`, 'info');
        }

        let undoStack = [];
        const MAX_UNDO = 20;

        function saveForUndo() {
            undoStack.push(JSON.stringify(state));
            if (undoStack.length > MAX_UNDO) undoStack.shift();
        }

        function undoLastAction() {
            if (undoStack.length === 0) return alert('Nothing to undo');
            state = JSON.parse(undoStack.pop());
            updateAllDisplays();
            saveState();
        }

        // Debug function: Set character level (call from console: setLevel(5))
        function setLevel(level) {
            if (level < 1 || level > 8) {
                console.log('Level must be between 1 and 8');
                return;
            }
            state.characterLevel = level;

            // HP by level (8 base + 2 CON at level 1, then +7 per level after)
            const hpByLevel = {
                1: 10, 2: 17, 3: 24, 4: 31, 5: 38, 6: 45, 7: 52, 8: 59
            };
            state.hp.max = hpByLevel[level];
            state.hp.current = state.hp.max;
            state.hp.temp = 0;

            // Spell slots by level
            const slotsByLevel = {
                1: { 1: 2 },
                2: { 1: 3 },
                3: { 1: 4, 2: 2 },
                4: { 1: 4, 2: 3 },
                5: { 1: 4, 2: 3, 3: 2 },
                6: { 1: 4, 2: 3, 3: 3 },
                7: { 1: 4, 2: 3, 3: 3, 4: 1 },
                8: { 1: 4, 2: 3, 3: 3, 4: 2 }
            };
            state.slots = {};
            for (const [slotLevel, count] of Object.entries(slotsByLevel[level])) {
                state.slots[slotLevel] = Array(count).fill(false);
            }

            // Reset all resources
            state.resources = {
                guidingBolt: 4,
                wildShape: 2,
                healingHands: 1,
                healingWordFree: 1,
                celestialRevelation: 1,
                cosmicOmen: level >= 6 ? 3 : 0
            };

            // Clear any prepared 4th level spells if going below level 7
            if (level < 7) {
                state.preparedSpells = state.preparedSpells.filter(s => s.level < 4);
            }

            saveState();
            updateAllDisplays();
            if (typeof renderFeatures === 'function') renderFeatures();
            if (typeof renderSpells === 'function') renderSpells();
            console.log(`Level set to ${level}. HP: ${state.hp.max}, Slots: ${JSON.stringify(slotsByLevel[level])}`);
            showToast(`Level set to ${level} (HP: ${state.hp.max})`);
        }

        function saveState() {
            localStorage.setItem('ashvael-v2', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('ashvael-v2');
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    // Check version - reset if outdated
                    if (!loaded.version || loaded.version < STATE_VERSION) {
                        console.log('State version outdated, resetting to defaults');
                        localStorage.removeItem('ashvael-v2');
                        state = JSON.parse(JSON.stringify(DEFAULT_STATE));
                    } else {
                        state = { ...DEFAULT_STATE, ...loaded };
                    }
                } catch (e) {
                    console.error('Error loading state:', e);
                    localStorage.removeItem('ashvael-v2');
                    state = JSON.parse(JSON.stringify(DEFAULT_STATE));
                }
            }
        }

        function updateAllDisplays() {
            try {
                updateHPDisplay();
                updateSlotsDisplay();
                updateResourcesDisplay();
                updateResourceSlots();
                updatePreparedDisplay();
                if (typeof CANTRIPS !== 'undefined') renderCantripsDisplay();
                updateFormIndicator();
                updateWildShapeDisplay();
                updateBattleUI();
                updateConcentrationDisplay();
                updateCompanionDisplay();
                updateItemChargesDisplay();
                renderInventory();
                updateReclaimButton();
                updateLevelDisplay();
                updateCosmicOmenDisplay();
                updateSpellCount();
                updateHitDiceBadge();
            } catch (e) {
                console.error('Error in updateAllDisplays:', e);
            }
        }

        // ===== HP SYSTEM =====
        function updateHPDisplay() {
            const el = document.getElementById('hpCurrent');
            el.textContent = state.hp.current;
            el.className = 'hp-current';
            if (state.hp.current <= state.hp.max * 0.25) el.classList.add('critical');
            else if (state.hp.current <= state.hp.max * 0.5) el.classList.add('injured');

            // Update max HP display
            const maxEl = document.getElementById('hpMax');
            if (maxEl) maxEl.textContent = `/ ${state.hp.max}`;

            document.getElementById('tempHP').value = state.hp.temp;
            document.getElementById('historyCount').textContent = state.hpHistory.length;

            const historyEl = document.getElementById('hpHistory');
            historyEl.innerHTML = state.hpHistory.slice(-10).reverse().map(h =>
                `<div class="hp-history-item ${h.type}">${h.type === 'damage' ? '‚àí' : '+'}${h.amount} (${h.newHP}/${state.hp.max}) <span class="battle-log-time">${h.time}</span></div>`
            ).join('');
        }

        function applyDamage() {
            const input = document.getElementById('damageInput');
            const amount = parseInt(input.value) || 0;
            if (amount <= 0) return;

            saveForUndo();

            let remaining = amount;
            if (state.hp.temp > 0) {
                if (state.hp.temp >= remaining) {
                    state.hp.temp -= remaining;
                    remaining = 0;
                } else {
                    remaining -= state.hp.temp;
                    state.hp.temp = 0;
                }
            }

            state.hp.current = Math.max(0, state.hp.current - remaining);
            state.hpHistory.push({
                type: 'damage',
                amount: amount,
                newHP: state.hp.current,
                time: new Date().toLocaleTimeString()
            });

            if (state.inBattle) addBattleLog(`Took ${amount} damage`);

            input.value = '';
            updateHPDisplay();
            saveState();

            // Check for concentration save
            if (state.concentration && remaining > 0) {
                promptConcentrationSave(remaining);
            }
        }

        function promptConcentrationSave(damageTaken) {
            const dc = Math.max(10, Math.floor(damageTaken / 2));
            const conMod = 2;  // Ashvael's CON modifier
            const profBonus = 3;  // Proficiency bonus (level 5-8)
            const isProficient = false;  // Not proficient in CON saves
            const saveBonus = conMod + (isProficient ? profBonus : 0);

            const body = `
                <div style="margin-bottom: 15px; padding: 15px; background: rgba(255, 107, 107, 0.1); border-radius: 8px; border-left: 4px solid var(--accent-red);">
                    <p style="font-weight: 600; color: var(--accent-red); margin-bottom: 10px;">Concentration Check Required!</p>
                    <p>You took <strong>${damageTaken} damage</strong> while concentrating on:</p>
                    <p style="font-size: 1.2em; color: var(--accent-purple); margin: 10px 0;"><strong>${state.concentration}</strong></p>
                </div>

                <div style="margin-bottom: 20px;">
                    <p><strong>DC:</strong> ${dc} (half of ${damageTaken} damage, minimum 10)</p>
                    <p><strong>Save:</strong> Constitution</p>
                    <p><strong>Your bonus:</strong> +${saveBonus} (CON ${conMod >= 0 ? '+' : ''}${conMod})</p>
                    <p style="margin-top: 10px; color: var(--text-muted);">Roll 1d20 + ${saveBonus}. Need ${dc} or higher to maintain concentration.</p>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="modal-btn primary" onclick="passConcentrationSave()" style="flex: 1; padding: 12px;">
                        ‚úì Passed (Maintain)
                    </button>
                    <button class="modal-btn" onclick="failConcentrationSave()" style="flex: 1; padding: 12px; background: var(--accent-red);">
                        ‚úó Failed (Drop)
                    </button>
                </div>
            `;
            showModal('Concentration Save', body);
        }

        function passConcentrationSave() {
            closeModal();
            showToast('Concentration maintained!');
            if (state.inBattle) addBattleLog(`Passed concentration save for ${state.concentration}`);
        }

        function failConcentrationSave() {
            const spellName = state.concentration;
            state.concentration = null;

            // Remove any companions that were from concentration spells
            const concentrationCompanions = state.companions.filter(c =>
                c.fromSpell === spellName || c.isConcentration
            );
            if (concentrationCompanions.length > 0) {
                state.companions = state.companions.filter(c =>
                    c.fromSpell !== spellName && !c.isConcentration
                );
                updateCompanionDisplay();
            }

            updateConcentrationDisplay();
            saveState();
            closeModal();
            showToast(`Concentration on ${spellName} dropped!`);
            if (state.inBattle) addBattleLog(`Failed concentration save - ${spellName} ended`);
        }

        function applyHeal() {
            const input = document.getElementById('healInput');
            const amount = parseInt(input.value) || 0;
            if (amount <= 0) return;

            saveForUndo();
            state.hp.current = Math.min(state.hp.max, state.hp.current + amount);
            state.hpHistory.push({
                type: 'heal',
                amount: amount,
                newHP: state.hp.current,
                time: new Date().toLocaleTimeString()
            });

            if (state.inBattle) addBattleLog(`Healed ${amount} HP`);

            input.value = '';
            updateHPDisplay();
            saveState();
        }

        function updateTempHP(value) {
            const amount = parseInt(value) || 0;
            if (amount < 0) return;

            saveForUndo();
            state.hp.temp = amount;
            if (state.inBattle && amount > 0) addBattleLog(`Set temp HP to ${amount}`);
            saveState();
        }

        function openTempHPModal() {
            const currentTemp = state.hp.temp || 0;
            showModal('Set Temporary HP', `
                <div style="text-align: center;">
                    <p style="margin-bottom: 15px;">Current Temp HP: <strong>${currentTemp}</strong></p>
                    <div style="margin-bottom: 15px;">
                        <label>New Temp HP:</label>
                        <input type="number" id="newTempHP" class="hp-input" style="width: 80px; margin-left: 10px;" min="0" value="${currentTemp}">
                    </div>
                    <p class="text-small text-muted" style="margin-bottom: 15px;">
                        Temp HP doesn't stack - use the higher value.<br>
                        Common sources: Aid, Heroism, False Life
                    </p>
                    <button class="modal-btn primary" onclick="setTempHP()">Apply</button>
                </div>
            `);
        }

        function setTempHP() {
            const input = document.getElementById('newTempHP');
            const amount = parseInt(input.value) || 0;

            saveForUndo();
            state.hp.temp = Math.max(0, amount);
            document.getElementById('tempHP').value = state.hp.temp;

            if (state.inBattle && amount > 0) addBattleLog(`Set temp HP to ${amount}`);

            saveState();
            closeModal();
            showToast(`Temp HP set to ${state.hp.temp}`);
        }

        function toggleHPHistory() {
            document.getElementById('hpHistory').classList.toggle('expanded');
        }

        // ===== SPELL SLOTS =====
        function toggleSlot(el) {
            saveForUndo();
            el.classList.toggle('used');
            const level = el.parentElement.dataset.level;
            const index = Array.from(el.parentElement.children).indexOf(el);
            state.slots[level][index] = el.classList.contains('used');
            saveState();
        }

        function updateSlotsDisplay() {
            renderSpellSlots();
        }

        function renderSpellSlots() {
            const container = document.getElementById('spellSlotsContainer');
            if (!container) return;

            const levelLabels = { 1: '1st', 2: '2nd', 3: '3rd', 4: '4th', 5: '5th', 6: '6th', 7: '7th', 8: '8th', 9: '9th' };

            let html = '';
            Object.entries(state.slots).forEach(([level, slots]) => {
                html += `
                    <div class="slot-group">
                        <span class="slot-label">${levelLabels[level] || level}</span>
                        <div class="slot-boxes" data-level="${level}">
                            ${slots.map((used, i) => `<div class="slot-box${used ? ' used' : ''}" onclick="toggleSlot(this)">‚óè</div>`).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ===== RESOURCES =====
        function updateResourcesDisplay() {
            // Resources are now displayed via Resource Slots section
            updateResourceSlots();
        }

        function useResource(resource) {
            if (resource === 'guiding-bolt' && state.resources.guidingBolt > 0) {
                saveForUndo();
                state.resources.guidingBolt--;
                if (state.inBattle) addBattleLog('Cast Guiding Bolt (free)');
                updateResourceSlots();
                saveState();
            }
        }

        // ===== PREPARED SPELLS =====
        function updatePreparedDisplay() {
            const container = document.getElementById('preparedDisplay');
            const counter = document.getElementById('preparedCounter');

            // Always prepared spells (from features/feats)
            let html = `<div class="prepared-spell-chip always" onclick="showSpellInfo('guiding-bolt')">
                <span class="spell-level-dot">1</span><span>Guiding Bolt</span>
                <span style="font-size:0.7em; color:var(--text-muted);">(Star Map)</span>
            </div>`;
            html += `<div class="prepared-spell-chip always" onclick="showSpellInfo('healing-word')">
                <span class="spell-level-dot">1</span><span>Healing Word</span>
                <span style="font-size:0.7em; color:var(--text-muted);">(Magic Init.)</span>
            </div>`;

            state.preparedSpells.forEach(spell => {
                html += `<div class="prepared-spell-chip" onclick="showSpellInfo('${spell.id}')">
                    <span class="spell-level-dot">${spell.level}</span><span>${spell.name}</span>
                </div>`;
            });

            container.innerHTML = html;
            const maxPrep = getMaxPreparedSpells();
            counter.textContent = `${state.preparedSpells.length}/${maxPrep}`;
        }

        // ===== CANTRIPS DISPLAY (Main Sheet) =====
        function renderCantripsDisplay() {
            const container = document.getElementById('cantripsDisplay');
            if (!container) return;

            container.innerHTML = CANTRIPS.map(c => `
                <div class="prepared-spell-chip always" onclick="showSpellInfo('${c.id}')" style="border-color: var(--accent-gold);">
                    <span class="spell-level-dot" style="background: var(--accent-gold);">C</span>
                    <span>${c.name}</span>
                </div>
            `).join('');
        }

        // ===== FORMS (Wild Shape / Starry Form) =====
        function openFormSelection() {
            if (state.inBattle && state.actionsUsed.bonus) {
                showToast('Bonus Action already used this round!');
                return;
            }
            if (state.resources.wildShape <= 0) {
                alert('No Wild Shape uses remaining!');
                return;
            }

            const body = `
                <p><strong>Bonus Action</strong> | Uses Wild Shape</p>
                <p style="margin-top: 10px;">Choose a form to take:</p>

                <div style="margin-top: 15px;">
                    <button class="modal-btn" onclick="selectForm('starry-archer')" style="width: 100%; padding: 12px; margin-bottom: 8px; text-align: left;">
                        <strong>‚≠ê Starry Form: Archer</strong><br>
                        <span style="font-size: 0.9em; color: var(--text-muted);">Bonus action: Ranged spell attack, 60ft, 1d8+4 radiant</span>
                    </button>
                    <button class="modal-btn" onclick="selectForm('starry-chalice')" style="width: 100%; padding: 12px; margin-bottom: 8px; text-align: left;">
                        <strong>üèÜ Starry Form: Chalice</strong><br>
                        <span style="font-size: 0.9em; color: var(--text-muted);">Healing spells also heal 1d8+4 to you or ally within 30ft</span>
                    </button>
                    <button class="modal-btn" onclick="selectForm('starry-dragon')" style="width: 100%; padding: 12px; margin-bottom: 8px; text-align: left;">
                        <strong>üêâ Starry Form: Dragon</strong><br>
                        <span style="font-size: 0.9em; color: var(--text-muted);">Concentration checks: treat 9 or lower as 10</span>
                    </button>
                    <hr style="border-color: var(--border-color); margin: 15px 0;">
                    <button class="modal-btn" onclick="openBeastSelection()" style="width: 100%; padding: 12px; text-align: left; background: linear-gradient(135deg, var(--accent-green) 0%, #2d8a4e 100%);">
                        <strong>üê∫ Wild Shape (Beast Form)</strong><br>
                        <span style="font-size: 0.9em;">Transform into a beast (CR 1/2 max, ${Math.floor((state.characterLevel || 6) / 2)} hours, +${state.characterLevel || 6} temp HP)</span>
                    </button>
                </div>
            `;
            showModal('Wild Shape / Starry Form', body);
        }

        function openBeastSelection() {
            const knownForms = getKnownBeastForms();
            let body = '<div class="form-options">';
            const tempHpGain = state.characterLevel || 6;
            body += `<p class="text-muted" style="margin-bottom:15px;">Choose a beast form. You gain ${tempHpGain} temp HP. Your STR/DEX/CON are replaced. You keep Int/Wis/Cha and skill/save proficiencies. Cannot cast spells.</p>`;

            knownForms.forEach(b => {
                body += `
                    <div class="form-option" onclick="selectBeastForm('${b.id}')">
                        <div class="form-option-title">${b.name} (CR ${b.cr})</div>
                        <div class="form-option-desc">AC ${b.ac} | HP ${b.hp} | ${b.speed}</div>
                        <div class="form-option-desc" style="margin-top:5px; font-size:0.8em;">${b.attacks}</div>
                    </div>
                `;
            });

            body += '</div>';
            showModal('Choose Beast Form (' + knownForms.length + '/6 known)', body);
        }

        function selectBeastForm(beastId) {
            saveForUndo();
            state.resources.wildShape--;

            const beast = BEAST_FORMS.find(b => b.id === beastId);
            if (!beast) return;

            // Store original stats if not already in a form
            if (!state.originalStats) {
                state.originalStats = {
                    ac: 15,
                    speed: 30,
                    hp: state.hp.current,
                    maxHp: state.hp.max
                };
            }

            // Add temp HP equal to druid level
            const wildShapeTempHp = state.characterLevel || 6;
            state.hp.temp += wildShapeTempHp;

            state.activeForm = {
                type: 'wild-shape',
                beastId: beastId,
                name: `Wild Shape: ${beast.name}`,
                details: `AC ${beast.ac} | HP ${beast.hp} | ${beast.speed}`,
                beastHp: beast.hp,
                beastMaxHp: beast.hp,
                showArcherAction: false
            };

            if (state.inBattle) {
                state.actionsUsed.bonus = true;
                addBattleLog(`Transformed into ${beast.name} (+${wildShapeTempHp} temp HP)`);
            }

            closeModal();
            updateFormIndicator();
            updateWildShapeDisplay();
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        function selectForm(formType) {
            saveForUndo();
            state.resources.wildShape--;

            const forms = {
                'starry-archer': { name: 'Starry Form: Archer', details: 'Bonus Action: 1d8+4 radiant attack (60ft)', showArcherAction: true },
                'starry-chalice': { name: 'Starry Form: Chalice', details: 'Healing spells also heal 1d8+4 to ally', showArcherAction: false },
                'starry-dragon': { name: 'Starry Form: Dragon', details: 'Concentration: treat rolls 9 or below as 10', showArcherAction: false }
            };

            state.activeForm = { type: formType, ...forms[formType] };

            if (state.inBattle) {
                state.actionsUsed.bonus = true;
                addBattleLog(`Activated ${state.activeForm.name}`);
            }

            closeModal();
            updateFormIndicator();
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        function updateWildShapeDisplay() {
            const inWildShape = state.activeForm && state.activeForm.type === 'wild-shape';
            const abilitiesDiv = document.getElementById('wildShapeAbilities');
            const abilitiesContent = document.getElementById('beastAbilitiesContent');

            // Safety check - if elements don't exist, skip
            if (!abilitiesDiv || !abilitiesContent) return;

            if (inWildShape) {
                const beast = BEAST_FORMS.find(b => b.id === state.activeForm.beastId);
                if (beast) {
                    // Update combat stats (with safety checks)
                    const acEl = document.getElementById('displayAC');
                    const speedEl = document.getElementById('displaySpeed');
                    if (acEl) acEl.textContent = beast.ac;
                    if (speedEl) speedEl.textContent = beast.speed.split(',')[0];

                    // Update physical ability scores (STR, DEX, CON)
                    updateAbilityScore('str', beast.str);
                    updateAbilityScore('dex', beast.dex);
                    updateAbilityScore('con', beast.con);

                    // Add visual indicator
                    const strBox = document.getElementById('strBox');
                    const dexBox = document.getElementById('dexBox');
                    const conBox = document.getElementById('conBox');
                    if (strBox) strBox.classList.add('wild-shape');
                    if (dexBox) dexBox.classList.add('wild-shape');
                    if (conBox) conBox.classList.add('wild-shape');

                    // Update senses
                    const sensesEl = document.getElementById('sensesDisplay');
                    if (sensesEl) sensesEl.textContent = beast.senses;

                    // Show beast abilities with attacks
                    abilitiesDiv.style.display = 'block';
                    abilitiesContent.innerHTML = formatBeastAbilities(beast);

                    // Update skills display
                    updateSkillsForWildShape(beast);

                    // Disable spell casting while in Wild Shape
                    updateSpellButtonsForWildShape(true);
                }
            } else {
                // Restore original stats
                updateACFromEquipment();
                const speedEl = document.getElementById('displaySpeed');
                if (speedEl) speedEl.textContent = '30ft';

                // Restore original ability scores
                updateAbilityScore('str', 8);
                updateAbilityScore('dex', 14);
                updateAbilityScore('con', 15);

                // Remove visual indicator
                const strBox = document.getElementById('strBox');
                const dexBox = document.getElementById('dexBox');
                const conBox = document.getElementById('conBox');
                if (strBox) strBox.classList.remove('wild-shape');
                if (dexBox) dexBox.classList.remove('wild-shape');
                if (conBox) conBox.classList.remove('wild-shape');

                // Restore senses
                const sensesEl = document.getElementById('sensesDisplay');
                const passiveEl = document.getElementById('passivePerceptionDisplay');
                if (sensesEl) sensesEl.textContent = 'Darkvision 60 ft';
                if (passiveEl) passiveEl.textContent = '17';

                // Hide beast abilities
                abilitiesDiv.style.display = 'none';

                // Restore normal skills
                restoreNormalSkills();

                // Re-enable spell casting
                updateSpellButtonsForWildShape(false);
            }
        }

        function updateSpellButtonsForWildShape(disabled) {
            // This will be called to enable/disable spell buttons during Wild Shape
            const castSpellButtons = document.querySelectorAll('.action-item');
            castSpellButtons.forEach(btn => {
                const text = btn.textContent || '';
                if (text.includes('Cast Spell')) {
                    if (disabled) {
                        btn.classList.add('disabled');
                        btn.style.opacity = '0.4';
                        btn.style.pointerEvents = 'none';
                    } else {
                        btn.classList.remove('disabled');
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                    }
                }
            });
        }

        // Ability descriptions for beasts, familiars, and companions
        const ABILITY_DESCRIPTIONS = {
            // Beast form abilities
            'Pack Tactics': 'You have advantage on attack rolls against a creature if at least one of your allies is within 5 feet of the creature and isn\'t incapacitated.',
            'Keen Smell': 'You have advantage on Wisdom (Perception) checks that rely on smell.',
            'Keen Hearing/Smell': 'You have advantage on Wisdom (Perception) checks that rely on hearing or smell.',
            'Keen Hearing/Sight': 'You have advantage on Wisdom (Perception) checks that rely on hearing or sight.',
            'Keen Sight': 'You have advantage on Wisdom (Perception) checks that rely on sight.',
            'Keen Hearing': 'You have advantage on Wisdom (Perception) checks that rely on hearing.',
            'Spider Climb': 'You can climb difficult surfaces, including upside down on ceilings, without needing to make an ability check.',
            'Web Sense': 'While in contact with a web, you know the exact location of any other creature in contact with the same web.',
            'Web Walker': 'You ignore movement restrictions caused by webbing.',
            'Pounce': 'If you move at least 20 feet straight toward a creature and hit it with a claw attack, the target must succeed on a DC 12 Strength save or be knocked prone. If prone, you can make one bite attack as a bonus action.',
            'Charge': 'If you move at least 20 feet straight toward a target and hit with a ram/tusk attack, the target takes extra damage and may be knocked prone.',
            'Relentless': 'If you take damage that would reduce you to 0 HP, you can use your reaction to drop to 1 HP instead. Usable once per short rest.',
            'Amphibious': 'You can breathe air and water.',
            'Standing Leap': 'Your long jump is up to 20 feet and high jump is up to 10 feet, with or without a running start.',
            'Blindsight': 'You can perceive your surroundings without relying on sight within a certain range.',
            'Hold Breath': 'You can hold your breath for 15 minutes.',
            'Sure-Footed': 'You have advantage on Strength and Dexterity saving throws made against effects that would knock you prone.',
            'Trampling Charge': 'If you move at least 20 feet straight toward a creature and hit it, the target must succeed on a DC 14 Strength save or be knocked prone. If prone, you can make a hooves attack as a bonus action.',
            // Familiar abilities
            'Flyby': 'Doesn\'t provoke opportunity attacks when flying out of enemy\'s reach.',
            'Mimicry': 'Can mimic simple sounds it has heard. A creature that hears the sounds can tell they are imitations with a DC 10 Wisdom (Insight) check.',
            'Echolocation': 'Can\'t use blindsight while deafened.',
            // Summon Beast abilities
            'Water Breathing': 'Can breathe underwater.',
            // Senses (for reference)
            'Darkvision 120 ft': 'Can see in dim light within 120 feet as if bright light, and darkness as dim light. Can\'t discern color in darkness.',
            'Darkvision 60 ft': 'Can see in dim light within 60 feet as if bright light, and darkness as dim light.',
            'Darkvision 30 ft': 'Can see in dim light within 30 feet as if bright light, and darkness as dim light.',
            'Blindsight 60 ft': 'Can perceive surroundings without relying on sight within 60 feet.'
        };

        // Keep old name for compatibility
        const BEAST_ABILITY_DESCRIPTIONS = ABILITY_DESCRIPTIONS;

        function formatBeastAbilities(beast) {
            let html = '';

            // Attacks
            html += `<div style="margin-bottom: 8px;"><strong>Attacks:</strong> ${beast.attacks}</div>`;

            // Speed details
            html += `<div style="margin-bottom: 8px;"><strong>Movement:</strong> ${beast.speed}</div>`;

            // Special abilities with descriptions
            html += '<div style="margin-bottom: 8px;"><strong>Special Abilities:</strong></div>';
            const abilities = beast.special.split(', ');
            abilities.forEach(ability => {
                const abilityName = ability.split(':')[0].split('(')[0].trim();
                const description = BEAST_ABILITY_DESCRIPTIONS[abilityName];
                if (description) {
                    html += `<div style="margin-left: 10px; margin-bottom: 5px;">
                        <strong style="color: var(--accent-gold);">${abilityName}:</strong> ${description}
                    </div>`;
                } else {
                    html += `<div style="margin-left: 10px; margin-bottom: 5px;">
                        <strong style="color: var(--accent-gold);">${ability}</strong>
                    </div>`;
                }
            });

            return html;
        }

        function updateSkillsForWildShape(beast) {
            // Create ability scores with beast's physical stats
            const wildShapeScores = {
                str: beast.str,
                dex: beast.dex,
                con: beast.con || 12,
                int: BASE_ABILITY_SCORES.int,  // Keep mental stats
                wis: BASE_ABILITY_SCORES.wis,
                cha: BASE_ABILITY_SCORES.cha
            };

            // Update all physical-based skills (STR and DEX)
            const physicalSkills = ['athletics', 'acrobatics', 'sleightOfHand', 'stealth'];

            physicalSkills.forEach(skillName => {
                const skill = SKILLS[skillName];
                if (!skill) return;

                const newMod = calculateSkillMod(skillName, wildShapeScores);
                const modEl = document.getElementById(skill.modId);
                const skillEl = document.getElementById(skill.id);

                if (modEl) modEl.textContent = formatMod(newMod);
                if (skillEl) skillEl.classList.add('wild-shape');
            });

            // Update passive perception to note beast's senses
            const passiveEl = document.getElementById('passivePerceptionDisplay');
            if (passiveEl) {
                const perceptionMod = calculateSkillMod('perception', wildShapeScores);
                passiveEl.textContent = (10 + perceptionMod) + ' (+ beast senses)';
            }
        }

        function restoreNormalSkills() {
            // Restore all physical-based skills using base ability scores
            const physicalSkills = ['athletics', 'acrobatics', 'sleightOfHand', 'stealth'];

            physicalSkills.forEach(skillName => {
                const skill = SKILLS[skillName];
                if (!skill) return;

                const normalMod = calculateSkillMod(skillName, BASE_ABILITY_SCORES);
                const modEl = document.getElementById(skill.modId);
                const skillEl = document.getElementById(skill.id);

                if (modEl) modEl.textContent = formatMod(normalMod);
                if (skillEl) skillEl.classList.remove('wild-shape');
            });

            // Restore passive perception
            const passiveEl = document.getElementById('passivePerceptionDisplay');
            if (passiveEl) {
                const perceptionMod = calculateSkillMod('perception', BASE_ABILITY_SCORES);
                passiveEl.textContent = '' + (10 + perceptionMod);
            }
        }

        // Update all skill displays based on current ability scores
        function updateAllSkillDisplays() {
            const currentScores = getCurrentAbilityScores();
            const isWildShape = state.activeForm && state.activeForm.type === 'wild-shape';

            Object.keys(SKILLS).forEach(skillName => {
                const skill = SKILLS[skillName];
                const mod = calculateSkillMod(skillName, currentScores);

                const modEl = document.getElementById(skill.modId);
                const skillEl = document.getElementById(skill.id);

                if (modEl) modEl.textContent = formatMod(mod);

                // Mark physical skills as wild-shape affected
                if (skillEl) {
                    if (isWildShape && (skill.ability === 'str' || skill.ability === 'dex')) {
                        skillEl.classList.add('wild-shape');
                    } else {
                        skillEl.classList.remove('wild-shape');
                    }
                }
            });

            // Update passive perception
            const passiveEl = document.getElementById('passivePerceptionDisplay');
            if (passiveEl) {
                const perceptionMod = calculateSkillMod('perception', currentScores);
                const passiveValue = 10 + perceptionMod;
                passiveEl.textContent = isWildShape ? passiveValue + ' (+ beast senses)' : '' + passiveValue;
            }
        }

        function updateAbilityScore(ability, score) {
            const mod = Math.floor((score - 10) / 2);
            const modStr = mod >= 0 ? '+' + mod : '' + mod;

            const scoreEl = document.getElementById(ability + 'Score');
            const modEl = document.getElementById(ability + 'Mod');
            const saveEl = document.getElementById(ability + 'Save');

            if (scoreEl) scoreEl.textContent = score;
            if (modEl) modEl.textContent = modStr;
            if (saveEl) saveEl.textContent = modStr;
        }

        function updateFormIndicator() {
            const indicator = document.getElementById('formIndicator');
            const archerAction = document.querySelector('.archer-action');

            if (state.activeForm) {
                indicator.classList.add('active');
                document.getElementById('formTitle').textContent = state.activeForm.name;

                let detailsText = state.activeForm.details;
                if (state.activeForm.type === 'wild-shape') {
                    const beast = BEAST_FORMS.find(b => b.id === state.activeForm.beastId);
                    if (beast) {
                        detailsText += ` | ${beast.special}`;
                        detailsText += ` | Cannot cast spells`;
                    }
                }
                document.getElementById('formDetails').textContent = detailsText;

                if (archerAction) {
                    archerAction.style.display = state.activeForm.showArcherAction ? 'block' : 'none';
                }
            } else {
                indicator.classList.remove('active');
                if (archerAction) archerAction.style.display = 'none';
            }
        }

        function endForm() {
            saveForUndo();
            if (state.inBattle && state.activeForm) addBattleLog(`Ended ${state.activeForm.name}`);

            // Clear form first
            state.activeForm = null;
            state.originalStats = null;

            // Restore all displays (AC, Speed, Ability Scores)
            updateFormIndicator();
            updateWildShapeDisplay();

            saveState();
        }

        // ===== BATTLE MODE =====
        function toggleBattle() {
            if (state.inBattle) {
                endBattle();
            } else {
                startBattle();
            }
        }

        function startBattle() {
            saveForUndo();
            state.inBattle = true;
            state.battleRound = 1;
            state.battleLog = [];
            state.actionsUsed = { action: false, bonus: false, reaction: false };
            state.movementUsed = 0;
            addBattleLog('Combat started!');
            updateBattleUI();
            saveState();
        }

        function endBattle() {
            saveForUndo();
            if (state.battleLog.length > 0) {
                // Save to battleHistory (legacy, keep last 3)
                state.battleHistory.push({
                    date: new Date().toLocaleDateString(),
                    rounds: state.battleRound,
                    log: [...state.battleLog]
                });
                if (state.battleHistory.length > 3) state.battleHistory.shift();

                // Save structured record to notes.battles
                initNotes();
                const battleRecord = {
                    type: 'battle',
                    id: Date.now(),
                    name: `Battle - ${new Date().toLocaleDateString()} (${state.battleRound} rounds)`,
                    date: new Date().toISOString(),
                    totalRounds: state.battleRound,
                    log: [...state.battleLog],
                    notes: ''
                };
                state.notes.battles.unshift(battleRecord);
                showToast(`Battle saved! (${state.battleRound} rounds)`);
            }
            state.inBattle = false;
            state.battleLog = [];
            state.movementUsed = 0;
            updateBattleUI();
            saveState();
        }

        function nextRound() {
            saveForUndo();
            state.battleRound++;
            state.actionsUsed = { action: false, bonus: false, reaction: false };
            state.movementUsed = 0;
            addBattleLog(`--- Round ${state.battleRound} ---`);
            updateBattleUI();
            saveState();
        }

        function addBattleLog(text) {
            state.battleLog.push({ time: new Date().toLocaleTimeString(), text });
            updateBattleLogDisplay();
        }

        function updateBattleLogDisplay() {
            const content = document.getElementById('battleLogContent');
            content.innerHTML = state.battleLog.slice(-10).map(l =>
                `<div class="battle-log-item"><span class="battle-log-time">${l.time}</span> ${l.text}</div>`
            ).join('');
        }

        function updateBattleUI() {
            const banner = document.getElementById('battleBanner');
            const log = document.getElementById('battleLog');
            const toggle = document.getElementById('battleToggle');
            const movementCounter = document.getElementById('movementCounter');

            banner.classList.toggle('active', state.inBattle);
            log.classList.toggle('active', state.inBattle);
            toggle.textContent = state.inBattle ? 'üè≥ End' : '‚öî Battle';
            document.getElementById('roundCount').textContent = state.battleRound;

            // Show/hide movement counter
            if (movementCounter) {
                movementCounter.style.display = state.inBattle ? 'block' : 'none';
                updateMovementDisplay();
            }

            // Update action availability - explicitly add/remove class
            const actionDisabled = state.inBattle && state.actionsUsed.action;
            const bonusDisabled = state.inBattle && state.actionsUsed.bonus;
            const reactionDisabled = state.inBattle && state.actionsUsed.reaction;

            document.querySelectorAll('#actionList .action-item').forEach(el => {
                if (actionDisabled) {
                    el.classList.add('disabled');
                } else {
                    el.classList.remove('disabled');
                }
            });
            document.querySelectorAll('#bonusActionList .action-item').forEach(el => {
                if (bonusDisabled) {
                    el.classList.add('disabled');
                } else {
                    el.classList.remove('disabled');
                }
            });
            document.querySelectorAll('#reactionList .action-item').forEach(el => {
                if (reactionDisabled) {
                    el.classList.add('disabled');
                } else {
                    el.classList.remove('disabled');
                }
            });

            updateBattleLogDisplay();
        }

        function updateMovementDisplay() {
            const speed = parseInt(document.getElementById('displaySpeed').textContent) || 30;
            const display = document.getElementById('movementDisplay');
            if (display) {
                display.textContent = `${state.movementUsed || 0}/${speed}`;
            }
        }

        function openMovementModal() {
            const speed = parseInt(document.getElementById('displaySpeed').textContent) || 30;
            const used = state.movementUsed || 0;
            const remaining = speed - used;

            showModal('Movement', `
                <div style="text-align: center;">
                    <p style="font-size: 1.2em; margin-bottom: 15px;">
                        <strong>Used:</strong> ${used} / ${speed} ft<br>
                        <strong>Remaining:</strong> ${remaining} ft
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px;">
                        <button class="modal-btn" onclick="addMovement(5)" ${remaining < 5 ? 'disabled style="opacity:0.5"' : ''}>+5 ft</button>
                        <button class="modal-btn" onclick="addMovement(10)" ${remaining < 10 ? 'disabled style="opacity:0.5"' : ''}>+10 ft</button>
                        <button class="modal-btn" onclick="addMovement(15)" ${remaining < 15 ? 'disabled style="opacity:0.5"' : ''}>+15 ft</button>
                        <button class="modal-btn" onclick="addMovement(${remaining})" ${remaining <= 0 ? 'disabled style="opacity:0.5"' : ''}>Max (${remaining} ft)</button>
                    </div>
                    <button class="modal-btn secondary" onclick="resetMovement()">Reset to 0</button>
                </div>
            `);
        }

        function addMovement(feet) {
            if (feet <= 0) return;
            const speed = parseInt(document.getElementById('displaySpeed').textContent) || 30;
            saveForUndo();
            state.movementUsed = Math.min((state.movementUsed || 0) + feet, speed);
            addBattleLog(`Moved ${feet} ft (${state.movementUsed}/${speed} used)`);
            updateMovementDisplay();
            saveState();
            closeModal();
        }

        function resetMovement() {
            saveForUndo();
            state.movementUsed = 0;
            addBattleLog('Movement reset');
            updateMovementDisplay();
            saveState();
            closeModal();
        }

        function useAction(type, el) {
            if (state.inBattle) {
                if (state.actionsUsed[type]) return;
                saveForUndo();
                state.actionsUsed[type] = true;
                addBattleLog(`Used ${type}: ${el.textContent}`);
                updateBattleUI();
                saveState();
            }
        }

        // ===== EXTRA ACTIONS MENU =====
        const SKILLS_DATA = [
            { id: 'acrobatics', name: 'Acrobatics', ability: 'DEX' },
            { id: 'animal', name: 'Animal Handling', ability: 'WIS' },
            { id: 'arcana', name: 'Arcana', ability: 'INT' },
            { id: 'athletics', name: 'Athletics', ability: 'STR' },
            { id: 'deception', name: 'Deception', ability: 'CHA' },
            { id: 'history', name: 'History', ability: 'INT' },
            { id: 'insight', name: 'Insight', ability: 'WIS' },
            { id: 'intimidation', name: 'Intimidation', ability: 'CHA' },
            { id: 'investigation', name: 'Investigation', ability: 'INT' },
            { id: 'medicine', name: 'Medicine', ability: 'WIS' },
            { id: 'nature', name: 'Nature', ability: 'INT' },
            { id: 'perception', name: 'Perception', ability: 'WIS' },
            { id: 'performance', name: 'Performance', ability: 'CHA' },
            { id: 'persuasion', name: 'Persuasion', ability: 'CHA' },
            { id: 'religion', name: 'Religion', ability: 'INT' },
            { id: 'sleight', name: 'Sleight of Hand', ability: 'DEX' },
            { id: 'stealth', name: 'Stealth', ability: 'DEX' },
            { id: 'survival', name: 'Survival', ability: 'WIS' }
        ];

        function openExtraMenu(actionType) {
            if (state.inBattle && state.actionsUsed[actionType]) {
                showToast(`${actionType === 'action' ? 'Action' : 'Bonus Action'} already used this round!`);
                return;
            }
            // Get current skill modifiers from the display
            const skillsHtml = SKILLS_DATA.map(skill => {
                const modEl = document.getElementById(`skillMod-${skill.id}`);
                const mod = modEl ? modEl.textContent : '+0';
                return `
                    <div class="extra-menu-item" onclick="useSkillCheck('${actionType}', '${skill.name}', '${mod}')">
                        ${skill.name}
                        <span class="skill-mod">${mod}</span>
                    </div>
                `;
            }).join('');

            // Combat actions (only for action type, not bonus)
            const combatActionsHtml = actionType === 'action' ? `
                <div class="extra-menu-item" onclick="useUtilityAction('${actionType}', 'Dash')">üèÉ Dash</div>
                <div class="extra-menu-item" onclick="useUtilityAction('${actionType}', 'Dodge')">üõ°Ô∏è Dodge</div>
                <div class="extra-menu-item" onclick="useUtilityAction('${actionType}', 'Help')">ü§ù Help</div>
                <div class="extra-menu-item" onclick="useUtilityAction('${actionType}', 'Hide')">üëÅÔ∏è Hide</div>
            ` : '';

            const utilityHtml = `
                <div class="extra-menu-item" onclick="useUtilityAction('${actionType}', 'Talk / Roleplay')">Talk / Roleplay</div>
                <div class="extra-menu-item" onclick="useUtilityAction('${actionType}', 'Interact with Object')">Interact with Object</div>
                <div class="extra-menu-item" onclick="useUtilityAction('${actionType}', 'Use Item')">Use Item</div>
                <div class="extra-menu-item" onclick="openMovementModal(); closeModal();">Free Movement</div>
            `;

            showModal(`Extra (${actionType === 'action' ? 'Action' : 'Bonus Action'})`, `
                ${actionType === 'action' ? `
                <div class="extra-menu-section">
                    <h4>Combat Actions</h4>
                    <div class="extra-menu-grid">${combatActionsHtml}</div>
                </div>
                ` : ''}
                <div class="extra-menu-section">
                    <h4>Skill Checks</h4>
                    <div class="extra-menu-grid">${skillsHtml}</div>
                </div>
                <div class="extra-menu-section">
                    <h4>Utility</h4>
                    <div class="extra-menu-grid">${utilityHtml}</div>
                </div>
            `);
        }

        function useSkillCheck(actionType, skillName, modifier) {
            if (state.inBattle) {
                saveForUndo();
                state.actionsUsed[actionType] = true;
                addBattleLog(`${skillName} check (${modifier})`);
                updateBattleUI();
                saveState();
            }
            closeModal();
            showToast(`${skillName} check: ${modifier}`);
        }

        function useUtilityAction(actionType, actionName) {
            if (state.inBattle && actionName !== 'Free Movement') {
                saveForUndo();
                state.actionsUsed[actionType] = true;
                addBattleLog(`${actionName}`);
                updateBattleUI();
                saveState();
            }
            closeModal();
            if (actionName !== 'Free Movement') {
                showToast(actionName);
            }
        }

        // ===== RESTS =====
        function shortRest() {
            if (state.inBattle) return alert('Cannot rest during battle!');

            const level = state.characterLevel || 6;
            const hitDiceRemaining = state.hitDiceRemaining ?? level;
            const conMod = 2;  // Ashvael's CON modifier (+2 from CON 15)

            // Show modal asking about Hit Dice
            const body = `
                <div style="margin-bottom: 15px;">
                    <p style="color: var(--text-muted);">During a short rest, you can spend Hit Dice to recover HP.</p>
                    <p style="margin-top: 10px;"><strong>Available:</strong> ${hitDiceRemaining}d8 HD (of ${level}d8)</p>
                    <p><strong>Per die:</strong> 1d8 + ${conMod} (CON)</p>
                </div>

                ${hitDiceRemaining > 0 ? `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">How many Hit Dice to spend?</label>
                    <select id="hitDiceToSpend" style="width: 100%; padding: 12px; border-radius: 8px; background: var(--bg-lighter); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 1em;">
                        <option value="0">None (just rest)</option>
                        ${Array.from({length: hitDiceRemaining}, (_, i) => i + 1).map(n =>
                            `<option value="${n}">${n}d8 + ${n * conMod}</option>`
                        ).join('')}
                    </select>
                </div>

                <div id="hitDiceHealingInput" style="display: none; margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Enter HP healed (roll your dice!):</label>
                    <input type="number" id="hitDiceHealAmount" min="1" placeholder="Total healing"
                           style="width: 100%; padding: 12px; border-radius: 8px; background: var(--bg-lighter); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 1em;">
                </div>
                ` : '<p style="color: var(--accent-red);">No Hit Dice remaining! Take a Long Rest to recover them.</p>'}

                <button class="modal-btn primary" onclick="confirmShortRest()" style="width: 100%; padding: 12px; font-size: 1.1em;">
                    Complete Short Rest
                </button>
            `;
            showModal('Short Rest', body);

            // Add event listener to show/hide healing input
            setTimeout(() => {
                const select = document.getElementById('hitDiceToSpend');
                const healingDiv = document.getElementById('hitDiceHealingInput');
                if (select && healingDiv) {
                    select.addEventListener('change', () => {
                        healingDiv.style.display = parseInt(select.value) > 0 ? 'block' : 'none';
                    });
                }
            }, 100);
        }

        function confirmShortRest() {
            saveForUndo();
            const level = state.characterLevel || 6;

            // Get Hit Dice spent
            const selectEl = document.getElementById('hitDiceToSpend');
            const diceSpent = selectEl ? parseInt(selectEl.value) || 0 : 0;

            // Get healing amount
            const healInput = document.getElementById('hitDiceHealAmount');
            const healAmount = healInput ? parseInt(healInput.value) || 0 : 0;

            // Apply healing
            if (healAmount > 0 && state.hp.current < state.hp.max) {
                const oldHp = state.hp.current;
                state.hp.current = Math.min(state.hp.max, state.hp.current + healAmount);
                const actualHeal = state.hp.current - oldHp;
                showToast(`Healed ${actualHeal} HP!`);
            }

            // Spend Hit Dice
            if (diceSpent > 0) {
                state.hitDiceRemaining = (state.hitDiceRemaining ?? level) - diceSpent;
            }

            // Restore Wild Shape
            state.resources.wildShape = 2;
            state.activeForm = null;
            state.originalStats = null;

            // Recharge magic items that recharge on short rest
            const recharged = rechargeItems('shortRest');

            updateFormIndicator();
            updateResourceSlots();
            updateWildShapeDisplay();
            updateItemChargesDisplay();
            updateHitDiceBadge();
            updateAllDisplays();
            saveState();
            closeModal();

            // Build message
            let msg = 'Short rest complete! Wild Shape restored.';
            if (diceSpent > 0) {
                msg += `\n\nSpent ${diceSpent}d8 Hit Dice. ${state.hitDiceRemaining}d8 remaining.`;
            }
            if (recharged.length > 0) {
                msg += '\n\nMagic items recharged:';
                recharged.forEach(r => {
                    msg += `\n‚Ä¢ ${r.item}: +${r.gained} charges (${r.current}/${r.max})`;
                });
            }
            alert(msg);
        }

        function updateHitDiceBadge() {
            const level = state.characterLevel || 6;
            const remaining = state.hitDiceRemaining ?? level;
            const badge = document.getElementById('hitDiceBadge');
            if (badge) {
                badge.textContent = `${remaining}d8 HD`;
                // Color based on remaining
                if (remaining === 0) {
                    badge.style.background = 'var(--accent-red)';
                } else if (remaining < level) {
                    badge.style.background = 'var(--accent-gold)';
                } else {
                    badge.style.background = 'var(--accent-green)';
                }
            }
        }

        function longRest() {
            if (state.inBattle) return alert('Cannot rest during battle!');
            saveForUndo();
            const config = getLevelConfig();

            state.hp.current = state.hp.max;
            state.hp.temp = 0;
            Object.keys(state.slots).forEach(k => state.slots[k].fill(false));

            // Reset resources using level config
            state.resources = {
                guidingBolt: 4,
                wildShape: 2,
                healingHands: 1,
                healingWordFree: 1,
                celestialRevelation: 1,
                cosmicOmen: config.cosmicOmenUses
            };

            state.activeForm = null;
            state.originalStats = null;
            state.celestialForm = null;
            state.cosmicOmenType = null;  // Reset omen choice
            state.hitDiceRemaining = config.level;  // Reset Hit Dice to max

            // Recharge magic items (both longRest and dawn items)
            const rechargedLR = rechargeItems('longRest');
            const rechargedDawn = rechargeItems('dawn');

            updateAllDisplays();
            saveState();

            // Build recharge message
            let msg = 'Long rest complete! All resources restored.';
            const allRecharged = [...rechargedLR, ...rechargedDawn];
            if (allRecharged.length > 0) {
                msg += '\n\nMagic items recharged:';
                allRecharged.forEach(r => {
                    msg += `\n‚Ä¢ ${r.item}: +${r.gained} charges (${r.current}/${r.max})`;
                });
            }

            // Show Cosmic Omen selection if level 6+
            if (config.cosmicOmenUses > 0) {
                alert(msg);
                openCosmicOmenSelection();
            } else {
                alert(msg);
            }
        }

        // ===== COSMIC OMEN (Level 6+) =====
        function openCosmicOmenSelection() {
            const body = `
                <p><strong>Reaction</strong> | 30 feet | 3/Long Rest</p>
                <p style="margin-top: 10px;">Choose your Cosmic Omen for today. This determines how your reaction ability works.</p>

                <div style="margin-top: 20px;">
                    <button class="modal-btn" onclick="selectCosmicOmen('weal')" style="width: 100%; padding: 15px; margin-bottom: 10px; background: linear-gradient(135deg, var(--accent-gold) 0%, #e6a800 100%); border: none; color: #1a1a2e;">
                        <strong>‚òÄÔ∏è Weal (Good Omen)</strong><br>
                        <span style="font-size: 0.9em;">Add 1d6 to an ally's roll</span>
                    </button>
                    <button class="modal-btn" onclick="selectCosmicOmen('woe')" style="width: 100%; padding: 15px; background: linear-gradient(135deg, var(--accent-purple) 0%, #5a3d8a 100%); border: none;">
                        <strong>üåë Woe (Bad Omen)</strong><br>
                        <span style="font-size: 0.9em;">Subtract 1d6 from an enemy's roll</span>
                    </button>
                </div>
            `;
            showModal('Cosmic Omen', body);
        }

        function selectCosmicOmen(omenType) {
            state.cosmicOmenType = omenType;
            updateCosmicOmenDisplay();
            saveState();
            closeModal();

            const omenName = omenType === 'weal' ? '‚òÄÔ∏è Weal (Good Omen)' : 'üåë Woe (Bad Omen)';
            const omenDesc = omenType === 'weal'
                ? 'Add 1d6 to ally rolls'
                : 'Subtract 1d6 from enemy rolls';
            showToast(`Cosmic Omen set: ${omenName}`);
        }

        function updateCosmicOmenDisplay() {
            const currentLevel = state.characterLevel || 6;
            const cosmicOmenReaction = document.getElementById('cosmicOmenReaction');

            if (cosmicOmenReaction) {
                if (currentLevel >= 6 && state.cosmicOmenType && state.resources.cosmicOmen > 0) {
                    cosmicOmenReaction.style.display = 'block';
                    const omenIcon = state.cosmicOmenType === 'weal' ? '‚òÄÔ∏è' : 'üåë';
                    const omenName = state.cosmicOmenType === 'weal' ? 'Weal' : 'Woe';
                    cosmicOmenReaction.textContent = `${omenIcon} Cosmic Omen: ${omenName} (${state.resources.cosmicOmen}/3)`;
                } else {
                    cosmicOmenReaction.style.display = 'none';
                }
            }
        }

        function useCosmicOmen() {
            if (!state.cosmicOmenType) {
                showToast('Choose your Cosmic Omen first!');
                openCosmicOmenSelection();
                return;
            }

            if (state.resources.cosmicOmen <= 0) {
                showToast('No Cosmic Omen uses remaining!');
                return;
            }

            if (state.inBattle && state.actionsUsed.reaction) {
                showToast('Reaction already used this round!');
                return;
            }

            // Show info modal with Use button
            const omenIcon = state.cosmicOmenType === 'weal' ? '‚òÄÔ∏è' : 'üåë';
            const omenName = state.cosmicOmenType === 'weal' ? 'Weal (Good Omen)' : 'Woe (Bad Omen)';
            const omenEffect = state.cosmicOmenType === 'weal'
                ? '<strong>Add 1d6</strong> to a creature\'s roll'
                : '<strong>Subtract 1d6</strong> from a creature\'s roll';

            const body = `
                <div style="margin-bottom: 15px;">
                    <p style="font-size: 1.2em; color: ${state.cosmicOmenType === 'weal' ? 'var(--accent-gold)' : 'var(--accent-purple)'};">
                        ${omenIcon} ${omenName}
                    </p>
                </div>
                <div style="margin-bottom: 15px;">
                    <p><strong>Reaction</strong> | 30 feet</p>
                    <p style="margin-top: 10px;">When a creature you can see within 30 feet makes an attack roll, saving throw, or ability check, you can use your Reaction to ${omenEffect}.</p>
                    <p style="margin-top: 10px; color: var(--text-muted);">Roll 1d6 and tell your DM the result.</p>
                </div>
                <div style="margin-bottom: 15px; padding: 10px; background: rgba(123, 104, 238, 0.1); border-radius: 8px;">
                    <p><strong>Uses Remaining:</strong> ${state.resources.cosmicOmen} / 3</p>
                </div>
                <button class="modal-btn primary" onclick="confirmUseCosmicOmen()" style="width: 100%; padding: 12px; font-size: 1.1em;">
                    Use Cosmic Omen (1 use)
                </button>
            `;
            showModal('Cosmic Omen', body);
        }

        function confirmUseCosmicOmen() {
            saveForUndo();
            state.resources.cosmicOmen--;

            const omenIcon = state.cosmicOmenType === 'weal' ? '‚òÄÔ∏è' : 'üåë';
            const omenEffect = state.cosmicOmenType === 'weal' ? 'Added 1d6 to roll' : 'Subtracted 1d6 from roll';

            if (state.inBattle) {
                state.actionsUsed.reaction = true;
                addBattleLog(`${omenIcon} Cosmic Omen: ${omenEffect}`);
            }

            updateCosmicOmenDisplay();
            updateResourceSlots();
            updateBattleUI();
            saveState();
            closeModal();

            showToast(`${omenIcon} Cosmic Omen used! (${state.resources.cosmicOmen} remaining)`);
        }

        // ===== NAVIGATION =====
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelector(`.nav-item[onclick="showSection('${id}')"]`).classList.add('active');
        }

        // ===== MODALS =====
        function showModal(title, body) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal(e) {
            if (!e || e.target === document.getElementById('modalOverlay')) {
                document.getElementById('modalOverlay').classList.remove('active');
            }
        }

        function showToast(message, duration = 2500) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        function showSpellInfo(spellId) {
            // Search cantrips first
            let spell = CANTRIPS.find(c => c.id === spellId);
            if (spell) {
                showModal(spell.name, `
                    <div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                        <p><strong style="color: var(--accent-purple);">${spell.school || 'Cantrip'}</strong> | ${spell.source}</p>
                        <p style="margin-top: 8px;"><strong>Casting Time:</strong> ${spell.time || 'Action'}</p>
                        <p><strong>Range:</strong> ${spell.range || 'Touch'}</p>
                        <p><strong>Components:</strong> ${spell.comp || 'V, S'}</p>
                        <p><strong>Duration:</strong> ${spell.dur || 'Instant'}</p>
                    </div>
                    <p style="line-height: 1.6;">${spell.desc}</p>
                `);
                return;
            }

            // Search leveled spells
            for (let level = 1; level <= getMaxSpellLevel(); level++) {
                spell = SPELLS[level].find(s => s.id === spellId);
                if (spell) {
                    let content = `
                        <div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                            <p><strong style="color: var(--accent-purple);">${spell.school || ''}</strong> | Level ${level} ${spell.ritual ? '<span style="color: var(--accent-blue);">(Ritual)</span>' : ''}</p>
                            <p style="margin-top: 8px;"><strong>Casting Time:</strong> ${spell.time}</p>
                            <p><strong>Range:</strong> ${spell.range}</p>
                            <p><strong>Components:</strong> ${spell.comp || 'V, S'}</p>
                            <p><strong>Duration:</strong> ${spell.dur} ${spell.conc ? '<span style="color: var(--accent-orange);">(Concentration)</span>' : ''}</p>
                        </div>
                        <p style="line-height: 1.6;">${spell.desc}</p>
                    `;
                    if (spell.higher) {
                        content += `<p style="margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border-color); color: var(--accent-gold);"><strong>At Higher Levels:</strong> ${spell.higher}</p>`;
                    }
                    if (spell.note) {
                        content += `<p style="margin-top: 10px; color: var(--accent-green);"><strong>${spell.note}</strong></p>`;
                    }
                    showModal(spell.name, content);
                    return;
                }
            }

            showModal('Spell Not Found', '<p>Spell information not available.</p>');
        }

        // ===== NEW ACTION FUNCTIONS =====

        function openAttackSelection() {
            if (state.inBattle && state.actionsUsed.action) {
                showToast('Action already used this round!');
                return;
            }
            const inWildShape = state.activeForm && state.activeForm.type === 'wild-shape';
            let body = '<div class="form-options">';

            if (inWildShape) {
                const beast = BEAST_FORMS.find(b => b.id === state.activeForm.beastId);
                body += `
                    <div class="form-option" onclick="useAction('action', {textContent:'${beast.name} Attack'}); closeModal();">
                        <div class="form-option-title">${beast.name} Attack</div>
                        <div class="form-option-desc">${beast.attacks}</div>
                    </div>
                `;
            } else {
                // Get equipped weapons from inventory
                const equippedWeapons = state.inventory ? state.inventory.filter(item =>
                    item.type === 'weapon' && (item.equipped === 'mainHand' || item.equipped === 'twoHanded')
                ) : [];

                // Also get unequipped ranged weapons that can be drawn
                const rangedWeapons = state.inventory ? state.inventory.filter(item =>
                    item.type === 'weapon' && item.weaponType === 'ranged' && !item.equipped
                ) : [];

                body += '<div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 8px;">üó°Ô∏è Melee Weapons</div>';

                // Show equipped melee and melee/thrown weapons
                equippedWeapons.filter(w => w.weaponType === 'melee' || w.weaponType === 'melee/thrown').forEach(weapon => {
                    const attackInfo = getWeaponAttackInfo(weapon);
                    body += `
                        <div class="form-option" onclick="performWeaponAttack('${weapon.id}', 'melee'); closeModal();">
                            <div class="form-option-title">${weapon.name} ${weapon.isMagic ? '‚ú¶' : ''}</div>
                            <div class="form-option-desc">${attackInfo}</div>
                        </div>
                    `;
                });

                // If no melee weapon equipped, show unarmed
                if (equippedWeapons.filter(w => w.weaponType === 'melee' || w.weaponType === 'melee/thrown').length === 0) {
                    body += `
                        <div class="form-option" onclick="useAction('action', {textContent:'Unarmed Strike (+1, 1)'}); closeModal();">
                            <div class="form-option-title">Unarmed Strike</div>
                            <div class="form-option-desc">+1 to hit, 1 bludgeoning</div>
                        </div>
                    `;
                }

                body += '<hr style="border-color: var(--border-color); margin: 12px 0;">';
                body += '<div style="color: var(--accent-blue); font-weight: bold; margin-bottom: 8px;">üèπ Ranged & Thrown</div>';

                // Show equipped ranged weapons
                equippedWeapons.filter(w => w.weaponType === 'ranged').forEach(weapon => {
                    const attackInfo = getWeaponAttackInfo(weapon);
                    const ammoType = getAmmoTypeForWeapon(weapon);
                    const ammoCount = ammoType ? getAmmoCount(ammoType) : null;
                    const ammoText = ammoCount !== null ? ` <span style="color: ${ammoCount > 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">(${ammoCount} ${ammoType})</span>` : '';
                    const isDisabled = ammoCount === 0;
                    body += `
                        <div class="form-option ${isDisabled ? 'disabled' : ''}" onclick="${isDisabled ? '' : `performWeaponAttack('${weapon.id}', 'ranged'); closeModal();`}" style="${isDisabled ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            <div class="form-option-title">${weapon.name} ${weapon.isMagic ? '‚ú¶' : ''}${ammoText}</div>
                            <div class="form-option-desc">${attackInfo}</div>
                        </div>
                    `;
                });

                // Show equipped thrown and melee/thrown weapons as throw option
                equippedWeapons.filter(w => w.weaponType === 'thrown' || w.weaponType === 'melee/thrown').forEach(weapon => {
                    const attackInfo = getWeaponAttackInfo(weapon, true); // true = thrown attack
                    body += `
                        <div class="form-option" onclick="throwWeapon('${weapon.id}'); closeModal();" style="border-left: 3px solid var(--accent-orange);">
                            <div class="form-option-title">üéØ Throw ${weapon.name} ${weapon.isMagic ? '‚ú¶' : ''}</div>
                            <div class="form-option-desc">${attackInfo} (unequips weapon)</div>
                        </div>
                    `;
                });

                // Show unequipped ranged weapons (need to equip first)
                rangedWeapons.forEach(weapon => {
                    const ammoType = getAmmoTypeForWeapon(weapon);
                    const ammoCount = ammoType ? getAmmoCount(ammoType) : null;
                    body += `
                        <div class="form-option" onclick="equipAndAttack('${weapon.id}'); closeModal();" style="border-left: 2px solid var(--text-muted);">
                            <div class="form-option-title" style="color: var(--text-muted);">${weapon.name} (not equipped)</div>
                            <div class="form-option-desc">Click to equip and attack${ammoCount !== null ? ` (${ammoCount} ${ammoType})` : ''}</div>
                        </div>
                    `;
                });
            }
            body += '</div>';
            showModal('Choose Attack', body);
        }

        function getWeaponAttackInfo(weapon, asThrown = false) {
            // Calculate attack bonus and damage
            let attackBonus = 0;
            let damageMod = 0;
            const profBonus = PROFICIENCY_BONUS;

            // Check weapon proficiency - only add proficiency bonus if proficient
            const profCheck = checkWeaponProficiency(weapon);
            const isProficient = profCheck.proficient;

            // Determine which ability modifier to use
            // Thrown weapons can use STR or DEX (finesse-like)
            if (weapon.modifier === 'finesse' || asThrown) {
                // Use higher of STR or DEX
                const strMod = getAbilityMod(BASE_ABILITY_SCORES.str);
                const dexMod = getAbilityMod(BASE_ABILITY_SCORES.dex);
                damageMod = Math.max(strMod, dexMod);
            } else if (weapon.modifier === 'dex') {
                damageMod = getAbilityMod(BASE_ABILITY_SCORES.dex);
            } else {
                damageMod = getAbilityMod(BASE_ABILITY_SCORES.str);
            }

            // Only add proficiency bonus if proficient with weapon
            attackBonus = isProficient ? (profBonus + damageMod) : damageMod;

            // Add magic bonuses
            if (weapon.isMagic) {
                attackBonus += weapon.attackBonus || 0;
                damageMod += weapon.damageBonus || 0;
            }

            const attackStr = attackBonus >= 0 ? '+' + attackBonus : '' + attackBonus;
            const damageStr = damageMod >= 0 ? '+' + damageMod : '' + damageMod;
            // Show range for thrown attacks or ranged weapons
            const rangeStr = (asThrown || weapon.weaponType === 'ranged' || weapon.weaponType === 'thrown') && weapon.range
                ? `, ${weapon.range} ft` : '';

            // Add warning if not proficient
            const profWarning = isProficient ? '' : ' ‚ö†Ô∏è';

            return `${attackStr} to hit${profWarning}, ${weapon.damageDie}${damageStr} ${weapon.damageType}${rangeStr}`;
        }

        function performWeaponAttack(weaponId, attackType) {
            const weapon = state.inventory.find(w => w.id === weaponId);
            if (!weapon) return;

            // If ranged weapon with ammo requirement, use ammo
            if (weapon.weaponType === 'ranged' && weapon.properties && weapon.properties.includes('ammunition')) {
                const ammoType = getAmmoTypeForWeapon(weapon);
                if (ammoType && !useAmmo(ammoType, 1)) {
                    return; // Failed to use ammo
                }
            }

            const attackInfo = getWeaponAttackInfo(weapon);
            useAction('action', { textContent: `${weapon.name} Attack (${attackInfo})` });
        }

        function equipAndAttack(weaponId) {
            const weapon = state.inventory.find(w => w.id === weaponId);
            if (!weapon) return;

            // Equip the weapon
            saveForUndo();
            if (weapon.hands === 'two') {
                // Unequip anything in both hands
                state.inventory.forEach(item => {
                    if (item.equipped === 'mainHand' || item.equipped === 'offHand' || item.equipped === 'twoHanded') {
                        item.equipped = null;
                    }
                });
                weapon.equipped = 'twoHanded';
            } else {
                weapon.equipped = 'mainHand';
            }
            saveState();
            renderInventory();
            updateACFromEquipment();

            // Then attack
            performWeaponAttack(weaponId, weapon.weaponType);
        }

        function throwWeapon(weaponId) {
            const weapon = state.inventory.find(w => w.id === weaponId);
            if (!weapon) return;

            saveForUndo();

            // Perform the attack
            const attackInfo = getWeaponAttackInfo(weapon, true);
            useAction('action', { textContent: `Throw ${weapon.name} (${attackInfo})` });

            // Unequip the weapon
            weapon.equipped = null;

            // Add to thrown weapons list for reclaiming
            if (!state.thrownWeapons) state.thrownWeapons = [];
            if (!state.thrownWeapons.includes(weaponId)) {
                state.thrownWeapons.push(weaponId);
            }

            saveState();
            renderInventory();
            updateReclaimButton();
        }

        // Off-hand weapon attack functions
        function openOffhandAttack() {
            if (state.inBattle && state.actionsUsed.bonus) {
                showToast('Bonus Action already used this round!');
                return;
            }
            const offhandWeapon = state.inventory ? state.inventory.find(item =>
                item.type === 'weapon' && item.equipped === 'offHand'
            ) : null;

            if (!offhandWeapon) {
                showToast('No off-hand weapon equipped');
                return;
            }

            const attackInfo = getOffhandAttackInfo(offhandWeapon);
            const body = `
                <div class="form-options">
                    <div class="form-option" onclick="performOffhandAttack('${offhandWeapon.id}'); closeModal();">
                        <div class="form-option-title">${offhandWeapon.name} ${offhandWeapon.isMagic ? '‚ú¶' : ''}</div>
                        <div class="form-option-desc">${attackInfo}</div>
                        <div class="form-option-note" style="color: var(--accent-orange); font-size: 0.85em; margin-top: 4px;">
                            ‚ö° Bonus Action (no ability mod to damage)
                        </div>
                    </div>
                </div>
            `;
            showModal('Off-hand Attack', body);
        }

        function getOffhandAttackInfo(weapon) {
            // Off-hand attacks: attack roll normal, but NO ability modifier to damage (unless negative)
            let attackBonus = 0;
            const profBonus = PROFICIENCY_BONUS;

            const profCheck = checkWeaponProficiency(weapon);
            const isProficient = profCheck.proficient;

            // Determine ability modifier for attack roll
            let abilityMod = 0;
            if (weapon.modifier === 'finesse') {
                const strMod = getAbilityMod(BASE_ABILITY_SCORES.str);
                const dexMod = getAbilityMod(BASE_ABILITY_SCORES.dex);
                abilityMod = Math.max(strMod, dexMod);
            } else if (weapon.modifier === 'dex') {
                abilityMod = getAbilityMod(BASE_ABILITY_SCORES.dex);
            } else {
                abilityMod = getAbilityMod(BASE_ABILITY_SCORES.str);
            }

            attackBonus = isProficient ? (profBonus + abilityMod) : abilityMod;

            // Add magic attack bonus
            if (weapon.isMagic) {
                attackBonus += weapon.attackBonus || 0;
            }

            // Off-hand damage: only add ability mod if negative, plus magic bonus
            let damageMod = abilityMod < 0 ? abilityMod : 0;
            if (weapon.isMagic) {
                damageMod += weapon.damageBonus || 0;
            }

            const attackStr = attackBonus >= 0 ? '+' + attackBonus : '' + attackBonus;
            const damageStr = damageMod !== 0 ? (damageMod >= 0 ? '+' + damageMod : '' + damageMod) : '';
            const profWarning = isProficient ? '' : ' ‚ö†Ô∏è';

            return `${attackStr} to hit, ${weapon.damage}${damageStr}${profWarning}`;
        }

        function performOffhandAttack(weaponId) {
            const weapon = state.inventory.find(w => w.id === weaponId);
            if (!weapon) return;

            saveForUndo();
            const attackInfo = getOffhandAttackInfo(weapon);

            if (state.inBattle) {
                state.actionsUsed.bonus = true;
                addBattleLog(`Off-hand: ${weapon.name} (${attackInfo})`);
                updateBattleUI();
            }

            saveState();
            showToast(`Off-hand Attack: ${weapon.name}`);
        }

        function updateOffhandButton() {
            const offhandBtn = document.querySelector('.offhand-attack');
            if (!offhandBtn) return;

            const offhandWeapon = state.inventory ? state.inventory.find(item =>
                item.type === 'weapon' && item.equipped === 'offHand'
            ) : null;

            offhandBtn.style.display = offhandWeapon ? '' : 'none';
            if (offhandWeapon) {
                offhandBtn.textContent = `Attack (${offhandWeapon.name} - off-hand)`;
            }
        }

        function reclaimWeapon(weaponId) {
            const weapon = state.inventory.find(w => w.id === weaponId);
            if (!weapon) return;

            saveForUndo();

            // Remove from thrown list
            if (state.thrownWeapons) {
                state.thrownWeapons = state.thrownWeapons.filter(id => id !== weaponId);
            }

            // Re-equip the weapon if hand is free
            const mainHand = state.inventory.find(i => i.equipped === 'mainHand');
            const twoHanded = state.inventory.find(i => i.equipped === 'twoHanded');

            if (!mainHand && !twoHanded) {
                weapon.equipped = 'mainHand';
            }
            // Otherwise it just goes back to inventory

            saveState();
            renderInventory();
            updateReclaimButton();
        }

        function reclaimAllWeapons() {
            if (!state.thrownWeapons || state.thrownWeapons.length === 0) return;

            saveForUndo();

            // Reclaim all thrown weapons
            const thrownIds = [...state.thrownWeapons];
            let equipped = false;

            thrownIds.forEach(weaponId => {
                const weapon = state.inventory.find(w => w.id === weaponId);
                if (weapon) {
                    // Only equip the first one if hands are free
                    if (!equipped) {
                        const mainHand = state.inventory.find(i => i.equipped === 'mainHand');
                        const twoHanded = state.inventory.find(i => i.equipped === 'twoHanded');
                        if (!mainHand && !twoHanded) {
                            weapon.equipped = 'mainHand';
                            equipped = true;
                        }
                    }
                }
            });

            state.thrownWeapons = [];
            saveState();
            renderInventory();
            updateReclaimButton();
        }

        function openReclaimSelection() {
            const thrownWeapons = state.thrownWeapons || [];
            if (thrownWeapons.length === 0) {
                showModal('No Thrown Weapons', '<div style="padding: 15px; text-align: center; color: var(--text-muted);">No thrown weapons to reclaim.</div>');
                return;
            }

            let body = '<div class="form-options">';

            // Reclaim section
            body += '<div style="color: var(--accent-green); font-weight: bold; margin-bottom: 8px;">‚Ü©Ô∏è Reclaim Weapons</div>';

            thrownWeapons.forEach(weaponId => {
                const weapon = state.inventory.find(w => w.id === weaponId);
                if (weapon) {
                    body += `
                        <div class="form-option" onclick="reclaimWeapon('${weapon.id}'); closeModal(); openReclaimSelection();" style="background: rgba(80,200,120,0.1);">
                            <div class="form-option-title">‚Ü©Ô∏è Reclaim ${weapon.name}</div>
                            <div class="form-option-desc">Pick up and re-equip (free object interaction)</div>
                        </div>
                    `;
                }
            });

            if (thrownWeapons.length > 1) {
                body += `
                    <div class="form-option" onclick="reclaimAllWeapons(); closeModal();" style="background: rgba(80,200,120,0.15);">
                        <div class="form-option-title">‚Ü©Ô∏è Reclaim All (${thrownWeapons.length})</div>
                        <div class="form-option-desc">Pick up all thrown weapons</div>
                    </div>
                `;
            }

            // Lost section
            body += '<hr style="border-color: var(--border-color); margin: 15px 0;">';
            body += '<div style="color: var(--accent-red); font-weight: bold; margin-bottom: 8px;">‚ùå Lost Weapons</div>';
            body += '<div style="color: var(--text-muted); font-size: 0.85em; margin-bottom: 10px;">Remove from inventory permanently</div>';

            thrownWeapons.forEach(weaponId => {
                const weapon = state.inventory.find(w => w.id === weaponId);
                if (weapon) {
                    body += `
                        <div class="form-option" onclick="lostWeapon('${weapon.id}'); closeModal(); openReclaimSelection();" style="background: rgba(220,53,69,0.1);">
                            <div class="form-option-title">‚ùå Lost ${weapon.name}</div>
                            <div class="form-option-desc">Remove from inventory</div>
                        </div>
                    `;
                }
            });

            if (thrownWeapons.length > 1) {
                body += `
                    <div class="form-option" onclick="lostAllWeapons(); closeModal();" style="background: rgba(220,53,69,0.15);">
                        <div class="form-option-title">‚ùå Lost All (${thrownWeapons.length})</div>
                        <div class="form-option-desc">Remove all thrown weapons from inventory</div>
                    </div>
                `;
            }

            body += '</div>';
            showModal('Reclaim Thrown Weapons', body);
        }

        function lostWeapon(weaponId) {
            const weaponIndex = state.inventory.findIndex(w => w.id === weaponId);
            if (weaponIndex === -1) return;

            saveForUndo();

            // Remove from thrown list
            if (state.thrownWeapons) {
                state.thrownWeapons = state.thrownWeapons.filter(id => id !== weaponId);
            }

            // Remove from inventory
            state.inventory.splice(weaponIndex, 1);

            saveState();
            renderInventory();
            updateReclaimButton();
        }

        function lostAllWeapons() {
            if (!state.thrownWeapons || state.thrownWeapons.length === 0) return;

            saveForUndo();

            // Remove all thrown weapons from inventory
            state.thrownWeapons.forEach(weaponId => {
                const weaponIndex = state.inventory.findIndex(w => w.id === weaponId);
                if (weaponIndex !== -1) {
                    state.inventory.splice(weaponIndex, 1);
                }
            });

            state.thrownWeapons = [];
            saveState();
            renderInventory();
            updateReclaimButton();
        }

        function updateReclaimButton() {
            const reclaimBtn = document.getElementById('reclaimBtn');
            if (reclaimBtn) {
                const thrownCount = (state.thrownWeapons || []).length;
                reclaimBtn.style.display = thrownCount > 0 ? 'block' : 'none';
                if (thrownCount > 0) {
                    reclaimBtn.textContent = `üîÑ Reclaim Weapons (${thrownCount})`;
                }
            }
        }

        function openCastSpellSelection(actionType) {
            // Check if action already used in battle
            if (state.inBattle && state.actionsUsed[actionType]) {
                showToast(`${actionType === 'action' ? 'Action' : 'Bonus Action'} already used this round!`);
                return;
            }

            // Check if spellcasting is blocked (armor proficiency, Wild Shape, etc.)
            const castCheck = canCastSpells();
            if (!castCheck.canCast) {
                showModal('Cannot Cast Spells', `<div style="text-align:center; padding:20px;">
                    <div style="font-size:2em; margin-bottom:15px;">üö´</div>
                    <p style="color:var(--accent-red); margin-bottom:15px;">${castCheck.reason}</p>
                    <p style="color:var(--text-muted); font-size:0.9em;">According to D&D 2024 rules, wearing armor you are not proficient with prevents you from casting spells.</p>
                </div>`);
                return;
            }

            const timeFilter = actionType === 'action' ? 'Action' :
                              actionType === 'bonus' ? 'Bonus Action' : 'Reaction';
            let body = '<div class="form-options">';

            // Add cantrips matching the casting time
            const availableCantrips = CANTRIPS.filter(c => {
                if (actionType === 'action') return c.time === 'Action';
                if (actionType === 'bonus') return c.time === 'Bonus Action';
                return false;
            });

            if (availableCantrips.length > 0) {
                body += '<div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 8px;">Cantrips (No Slot)</div>';
                availableCantrips.forEach(cantrip => {
                    const damage = getScaledCantripDamage(cantrip);
                    body += `
                        <div class="form-option" onclick="castCantrip('${cantrip.id}', '${actionType}')">
                            <div class="form-option-title">${cantrip.name}</div>
                            <div class="form-option-desc">${cantrip.range}${damage ? ' | ' + damage : ''}</div>
                        </div>
                    `;
                });
                body += '<hr style="border-color: var(--border-color); margin: 12px 0;">';
            }

            // Filter prepared spells by casting time
            const availableSpells = [];

            // Always prepared spells with free uses
            if (actionType === 'action') {
                // Guiding Bolt - always prepared from Star Map
                const gb = SPELLS[1].find(s => s.id === 'guiding-bolt');
                if (gb) availableSpells.push({ ...gb, level: 1, hasFree: true, freeResource: 'guidingBolt', freeMax: 4 });
            }

            if (actionType === 'bonus') {
                // Healing Word - always prepared from Magic Initiate
                const hw = SPELLS[1].find(s => s.id === 'healing-word');
                if (hw) availableSpells.push({ ...hw, level: 1, hasFree: true, freeResource: 'healingWordFree', freeMax: 1 });
            }

            // Check other prepared spells
            state.preparedSpells.forEach(prep => {
                // Skip if already added as always-prepared
                if (prep.id === 'guiding-bolt' || prep.id === 'healing-word') return;

                for (let level = 1; level <= getMaxSpellLevel(); level++) {
                    const spell = SPELLS[level].find(s => s.id === prep.id);
                    if (spell && spell.time === timeFilter) {
                        availableSpells.push({ ...spell, level });
                    }
                }
            });

            if (availableSpells.length > 0) {
                body += '<div style="color: var(--accent-purple); font-weight: bold; margin-bottom: 8px;">Leveled Spells</div>';
                availableSpells.forEach(spell => {
                    const dmgPreview = getSpellDamagePreview(spell, spell.level);
                    const freeIndicator = spell.hasFree ? ` <span style="color: var(--accent-green);">(${state.resources[spell.freeResource]}/${spell.freeMax} free)</span>` : '';
                    body += `
                        <div class="form-option" onclick="openSpellCastOptions('${spell.id}', ${spell.level}, '${actionType}', ${spell.hasFree || false}, '${spell.freeResource || ''}')">
                            <div class="form-option-title">${spell.name}${freeIndicator}</div>
                            <div class="form-option-desc">${spell.range} | ${spell.dur}${spell.conc ? ' <span style="color:var(--accent-orange)">(C)</span>' : ''}${dmgPreview ? ' | ' + dmgPreview : ''}</div>
                        </div>
                    `;
                });
            } else if (availableCantrips.length === 0) {
                body += '<p class="text-muted">No prepared spells with this casting time.</p>';
            }

            // Add Item Spells section
            const itemSpells = getItemSpellsForCasting(actionType);
            if (itemSpells.length > 0) {
                body += '<hr style="border-color: var(--border-color); margin: 12px 0;">';
                body += '<div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 8px;">‚ú¶ Item Spells</div>';
                itemSpells.forEach(is => {
                    let statusText = '';
                    let isDisabled = false;
                    if (is.type === 'charges') {
                        const charges = state.itemCharges[is.itemId];
                        const canCast = charges && charges.current >= is.cost;
                        statusText = `${is.cost} charge${is.cost > 1 ? 's' : ''} (${charges ? charges.current : 0} left)`;
                        isDisabled = !canCast;
                    } else if (is.type === 'spell') {
                        const usageKey = `${is.itemId}_${is.spellName}`;
                        const used = state.itemSpellsUsed[usageKey];
                        statusText = is.usage === 'atWill' ? 'At Will' : (used ? 'Used today' : is.usage);
                        isDisabled = used && is.usage !== 'atWill';
                    }
                    body += `
                        <div class="form-option ${isDisabled ? 'disabled' : ''}" onclick="${isDisabled ? '' : `castItemSpellFromMenu('${is.itemId}', '${is.spellName}', '${is.type}', ${is.cost || 0}, '${is.usage || ''}')`}" style="${isDisabled ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            <div class="form-option-title">${is.spellName} <span style="color: var(--text-muted); font-size: 0.85em;">(${is.itemName})</span></div>
                            <div class="form-option-desc" style="color: ${isDisabled ? 'var(--accent-red)' : 'var(--accent-gold)'};">${statusText}</div>
                        </div>
                    `;
                });
            }

            body += '</div>';
            showModal(`Cast Spell (${timeFilter})`, body);
        }

        function getScaledCantripDamage(cantrip) {
            // At level 5, cantrips scale to 2 dice
            const damageCantrips = {
                'starry-wisp': '2d8 radiant',
                'thorn-whip': '2d6 piercing',
                'produce-flame': '2d8 fire'
            };
            return damageCantrips[cantrip.id] || '';
        }

        function getItemSpellsForCasting(actionType) {
            // Collect all spells from magic items
            const itemSpells = [];

            state.inventory.forEach(item => {
                if (!item.effects) return;

                // Spells from charge-based items
                const chargesEffect = item.effects.find(e => e.type === 'charges');
                if (chargesEffect && chargesEffect.spells) {
                    chargesEffect.spells.forEach(spell => {
                        itemSpells.push({
                            type: 'charges',
                            itemId: item.id,
                            itemName: item.name,
                            spellName: spell.name,
                            spellLevel: spell.level,
                            cost: spell.cost
                        });
                    });
                }

                // Spells granted by items (spell effect type)
                item.effects.filter(e => e.type === 'spell').forEach(effect => {
                    itemSpells.push({
                        type: 'spell',
                        itemId: item.id,
                        itemName: item.name,
                        spellName: effect.spell,
                        spellLevel: effect.spellLevel,
                        usage: effect.usage
                    });
                });
            });

            return itemSpells;
        }

        function castItemSpellFromMenu(itemId, spellName, spellType, cost, usage) {
            if (spellType === 'charges') {
                if (castItemSpell(itemId, spellName, cost)) {
                    closeModal();
                    if (state.inBattle) {
                        useAction('action');
                    }
                }
            } else if (spellType === 'spell') {
                if (castItemGrantedSpell(itemId, spellName, usage)) {
                    closeModal();
                    if (state.inBattle) {
                        useAction('action');
                    }
                }
            }
        }

        function getSpellDamagePreview(spell, slotLevel) {
            const previews = {
                'guiding-bolt': { base: 4, perLevel: 1, type: 'd6 radiant' },
                'cure-wounds': { base: 2, perLevel: 2, type: 'd8+4 healing', isHealing: true },
                'healing-word': { base: 2, perLevel: 2, type: 'd4+4 healing', isHealing: true },
                'thunderwave': { base: 2, perLevel: 1, type: 'd8 thunder' },
                'absorb-elements': { base: 1, perLevel: 1, type: 'd6 (extra)' },
                'moonbeam': { base: 2, perLevel: 1, type: 'd10 radiant', baseLevel: 2 },
                'heat-metal': { base: 2, perLevel: 1, type: 'd8 fire', baseLevel: 2 },
                'call-lightning': { base: 3, perLevel: 1, type: 'd10 lightning', baseLevel: 3 },
                'conjure-animals': { base: 0, perLevel: 10, type: ' HP', isHP: true, baseLevel: 3 }
            };
            const p = previews[spell.id];
            if (!p) return '';
            const baseLevel = p.baseLevel || 1;
            const dice = p.base + (slotLevel - baseLevel) * p.perLevel;
            if (p.isHP) return `+${(slotLevel - baseLevel) * p.perLevel}${p.type}`;
            return `${dice}${p.type}`;
        }

        function castCantrip(cantripId, actionType) {
            const cantrip = CANTRIPS.find(c => c.id === cantripId);
            if (state.inBattle) {
                state.actionsUsed[actionType] = true;
                addBattleLog(`Cast ${cantrip.name} (cantrip)`);
            }
            closeModal();
            updateBattleUI();
            saveState();
        }

        function openSpellCastOptions(spellId, baseLevel, actionType, hasFree, freeResource) {
            // Find the spell
            let spell = null;
            for (let level = 1; level <= getMaxSpellLevel(); level++) {
                spell = SPELLS[level].find(s => s.id === spellId);
                if (spell) break;
            }
            if (!spell) return;

            let body = '<div class="form-options">';
            body += `<p class="text-muted" style="margin-bottom:12px;"><strong>${spell.name}</strong> - Choose how to cast:</p>`;

            // Concentration warning
            if (spell.conc && state.concentration) {
                body += `<div style="background: rgba(255,140,0,0.15); border: 1px solid var(--accent-orange); padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                    <strong style="color: var(--accent-orange);">Concentration Warning</strong><br>
                    <span style="font-size: 0.9em;">Currently concentrating on <strong>${state.concentration.spellName}</strong>. Casting this will end it.</span>
                </div>`;
            }

            // Free option (if available)
            if (hasFree && state.resources[freeResource] > 0) {
                const freeMax = freeResource === 'guidingBolt' ? 4 : 1;
                const dmg = getSpellDamagePreview(spell, 1);
                body += `
                    <div class="form-option" style="border-color: var(--accent-green);" onclick="castSpellFree('${spellId}', '${freeResource}', '${actionType}')">
                        <div class="form-option-title" style="color: var(--accent-green);">Free Cast (${state.resources[freeResource]}/${freeMax} remaining)</div>
                        <div class="form-option-desc">1st level effect${dmg ? ' | ' + dmg : ''}</div>
                    </div>
                `;
            } else if (hasFree) {
                body += `<div class="form-option" style="opacity: 0.5; pointer-events: none;">
                    <div class="form-option-title">Free Cast (0 remaining)</div>
                    <div class="form-option-desc">No free uses left today</div>
                </div>`;
            }

            // Slot options
            for (let l = baseLevel; l <= 3; l++) {
                const available = state.slots[l].filter(used => !used).length;
                const dmg = getSpellDamagePreview(spell, l);
                const isUpcast = l > baseLevel;

                if (available > 0) {
                    body += `
                        <div class="form-option" onclick="castSpellWithSlot('${spellId}', ${l}, '${actionType}')">
                            <div class="form-option-title">${l}${getOrdinal(l)} Level Slot${isUpcast ? ' (Upcast)' : ''}</div>
                            <div class="form-option-desc">${available} slot${available > 1 ? 's' : ''} remaining${dmg ? ' | ' + dmg : ''}</div>
                        </div>
                    `;
                } else {
                    body += `<div class="form-option" style="opacity: 0.5; pointer-events: none;">
                        <div class="form-option-title">${l}${getOrdinal(l)} Level Slot${isUpcast ? ' (Upcast)' : ''}</div>
                        <div class="form-option-desc">No slots remaining</div>
                    </div>`;
                }
            }

            body += '</div>';
            showModal(`Cast ${spell.name}`, body);
        }

        function castSpellFree(spellId, freeResource, actionType) {
            if (state.resources[freeResource] <= 0) {
                alert('No free uses remaining!');
                return;
            }

            // Find the spell for logging and concentration
            let spell = null;
            for (let level = 1; level <= getMaxSpellLevel(); level++) {
                spell = SPELLS[level].find(s => s.id === spellId);
                if (spell) break;
            }

            saveForUndo();
            state.resources[freeResource]--;

            // Handle concentration
            if (spell && spell.conc) {
                if (state.concentration) {
                    addBattleLog(`Ended concentration on ${state.concentration.spellName}`);
                }
                state.concentration = { spellId, spellName: spell.name, slotLevel: 1 };
                updateConcentrationDisplay();
            }

            // Handle summon spells
            if (spellId === 'summon-beast') {
                closeModal();
                openSummonBeastSelection(1);
                return;
            }

            if (state.inBattle) {
                state.actionsUsed[actionType] = true;
                addBattleLog(`Cast ${spell ? spell.name : spellId} (free)`);
            }

            closeModal();
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        function castSpellWithSlot(spellId, slotLevel, actionType) {
            // Find the spell
            let spell = null;
            for (let level = 1; level <= getMaxSpellLevel(); level++) {
                spell = SPELLS[level].find(s => s.id === spellId);
                if (spell) break;
            }

            // Use the slot
            const slotIndex = state.slots[slotLevel].findIndex(used => !used);
            if (slotIndex === -1) {
                alert('No spell slots available at this level!');
                return;
            }

            saveForUndo();
            state.slots[slotLevel][slotIndex] = true;

            // Handle concentration
            if (spell && spell.conc) {
                if (state.concentration) {
                    addBattleLog(`Ended concentration on ${state.concentration.spellName}`);
                }
                state.concentration = { spellId, spellName: spell.name, slotLevel };
                updateConcentrationDisplay();
            }

            // Handle summon spells
            if (spellId === 'summon-beast') {
                closeModal();
                openSummonBeastSelection(slotLevel);
                updateSlotsDisplay();
                saveState();
                return;
            }

            if (state.inBattle) {
                state.actionsUsed[actionType] = true;
                addBattleLog(`Cast ${spell ? spell.name : spellId} using ${slotLevel}${getOrdinal(slotLevel)} level slot`);
            }

            closeModal();
            updateSlotsDisplay();
            updateBattleUI();
            saveState();
        }

        function openUpcastSelection(spellId, baseLevel, actionType) {
            // Redirect to new unified function
            openSpellCastOptions(spellId, baseLevel, actionType, false, '');
        }

        function castSpell(spellId, slotLevel, actionType, spellOverride) {
            // Find the spell
            let spell = spellOverride;
            if (!spell) {
                for (let level = 1; level <= getMaxSpellLevel(); level++) {
                    spell = SPELLS[level].find(s => s.id === spellId);
                    if (spell) break;
                }
            }

            saveForUndo();

            // Use the specified slot level
            const slotIndex = state.slots[slotLevel].findIndex(used => !used);
            if (slotIndex === -1) {
                alert('No spell slots available at this level!');
                return;
            }

            state.slots[slotLevel][slotIndex] = true;

            // Handle concentration
            if (spell && spell.conc) {
                if (state.concentration) {
                    addBattleLog(`Ended concentration on ${state.concentration.spellName}`);
                }
                state.concentration = { spellId, spellName: spell.name, slotLevel };
                updateConcentrationDisplay();
            }

            // Handle summoning spells (Find Familiar via Wild Companion or Summon Beast)
            if (spellId === 'find-familiar') {
                summonFamiliar();
            } else if (spellId === 'summon-beast') {
                openSummonBeastSelection(slotLevel);
            }

            if (state.inBattle) {
                state.actionsUsed[actionType] = true;
                addBattleLog(`Cast ${spell ? spell.name : spellId} using ${slotLevel}${getOrdinal(slotLevel)} level slot`);
            }

            closeModal();
            updateSlotsDisplay();
            updateBattleUI();
            saveState();
        }

        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        function useGuidingBoltFree() {
            if (state.resources.guidingBolt <= 0) {
                alert('No free Guiding Bolt uses remaining! Use a spell slot instead.');
                return;
            }
            saveForUndo();
            state.resources.guidingBolt--;
            if (state.inBattle) {
                state.actionsUsed.action = true;
                addBattleLog('Cast Guiding Bolt (free from Star Map)');
            }
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        function useHealingWordFree() {
            if (state.resources.healingWordFree <= 0) {
                alert('Free Healing Word already used today! Use a spell slot instead.');
                return;
            }
            saveForUndo();
            state.resources.healingWordFree--;
            if (state.inBattle) {
                state.actionsUsed.bonus = true;
                addBattleLog('Cast Healing Word (free from Magic Initiate)');
            }
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        function openHealingHands() {
            if (state.inBattle && state.actionsUsed.action) {
                showToast('Action already used this round!');
                return;
            }
            if (state.resources.healingHands <= 0) {
                alert('Healing Hands already used today!');
                return;
            }
            showModal('Healing Hands', `
                <p><strong>Action</strong> | Touch | 1/Long Rest</p>
                <p style="margin-top: 10px;">Touch a creature and roll <strong>3d4</strong>. The creature regains HP equal to the total.</p>
                <button class="add-item-btn" style="width:100%; margin-top:15px;" onclick="useHealingHands()">Use Healing Hands</button>
            `);
        }

        function useHealingHands() {
            saveForUndo();
            state.resources.healingHands--;
            if (state.inBattle) {
                state.actionsUsed.action = true;
                addBattleLog('Used Healing Hands (3d4 healing)');
            }
            closeModal();
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        function openCelestialRevelation() {
            if (state.inBattle && state.actionsUsed.bonus) {
                showToast('Bonus Action already used this round!');
                return;
            }
            if (state.resources.celestialRevelation <= 0) {
                alert('Celestial Revelation already used today!');
                return;
            }
            showModal('Celestial Revelation', `
                <p><strong>Bonus Action</strong> | 1 minute | 1/Long Rest</p>
                <p style="margin-top: 10px;">Transform and gain one of the following benefits:</p>

                <div style="margin-top: 15px;">
                    <button class="modal-btn" onclick="useCelestialRevelation('radiant-soul')" style="width: 100%; padding: 12px; margin-bottom: 8px; text-align: left;">
                        <strong>Radiant Soul</strong><br>
                        <span style="font-size: 0.9em; color: var(--text-muted);">Spectral wings (fly 30ft), +3 radiant damage once/turn</span>
                    </button>
                    <button class="modal-btn" onclick="useCelestialRevelation('necrotic-shroud')" style="width: 100%; padding: 12px; margin-bottom: 8px; text-align: left;">
                        <strong>Necrotic Shroud</strong><br>
                        <span style="font-size: 0.9em; color: var(--text-muted);">Frighten enemies within 10ft (Cha save), +3 necrotic damage once/turn</span>
                    </button>
                    <button class="modal-btn" onclick="useCelestialRevelation('inner-radiance')" style="width: 100%; padding: 12px; text-align: left;">
                        <strong>Inner Radiance</strong><br>
                        <span style="font-size: 0.9em; color: var(--text-muted);">Bright light 10ft, creatures ending turn within 10ft take 3 radiant</span>
                    </button>
                </div>
            `);
        }

        function useCelestialRevelation(form) {
            saveForUndo();
            state.resources.celestialRevelation--;
            state.celestialForm = form;
            if (state.inBattle) {
                state.actionsUsed.bonus = true;
                addBattleLog(`Activated Celestial Revelation: ${form}`);
            }
            closeModal();
            updateResourceSlots();
            updateBattleUI();
            saveState();
        }

        // ===== WILD COMPANION =====
        function openWildCompanion() {
            if (state.inBattle && state.actionsUsed.action) {
                showToast('Action already used this round!');
                return;
            }
            if (state.activeForm && state.activeForm.type === 'wild-shape') {
                alert('Cannot use Wild Companion while in Wild Shape beast form!');
                return;
            }

            let body = '<div class="form-options">';
            body += '<p class="text-muted" style="margin-bottom:12px;"><strong>Wild Companion (Level 2)</strong><br>Cast Find Familiar without material components. Choose resource:</p>';

            // Check if Wild Shape uses available
            const hasWildShape = state.resources.wildShape > 0;
            // Check for available spell slots
            const hasSlots = Object.values(state.slots).some(slots => slots.some(used => !used));

            if (hasWildShape) {
                body += `
                    <div class="form-option" onclick="useWildCompanion('wildshape')">
                        <div class="form-option-title">üêæ Use Wild Shape</div>
                        <div class="form-option-desc">${state.resources.wildShape}/2 uses remaining</div>
                    </div>
                `;
            }

            if (hasSlots) {
                for (let l = 1; l <= 3; l++) {
                    const available = state.slots[l].filter(used => !used).length;
                    if (available > 0) {
                        body += `
                            <div class="form-option" onclick="useWildCompanion('slot', ${l})">
                                <div class="form-option-title">‚ú® Use ${l}${getOrdinal(l)} Level Slot</div>
                                <div class="form-option-desc">${available} slot${available > 1 ? 's' : ''} remaining</div>
                            </div>
                        `;
                    }
                }
            }

            if (!hasWildShape && !hasSlots) {
                body += '<p class="text-muted">No Wild Shape uses or spell slots available!</p>';
            }

            body += '</div>';
            showModal('Wild Companion', body);
        }

        function useWildCompanion(resourceType, slotLevel) {
            saveForUndo();

            if (resourceType === 'wildshape') {
                state.resources.wildShape--;
                updateResourceSlots();
            } else {
                const slotIndex = state.slots[slotLevel].findIndex(used => !used);
                state.slots[slotLevel][slotIndex] = true;
                updateSlotsDisplay();
            }

            if (state.inBattle) {
                state.actionsUsed.action = true;
                addBattleLog(`Used Wild Companion (Find Familiar) via ${resourceType === 'wildshape' ? 'Wild Shape' : slotLevel + getOrdinal(slotLevel) + ' slot'}`);
            }

            closeModal();
            summonFamiliar();
            updateBattleUI();
            saveState();
        }

        // ===== COMPANION TRACKING =====
        const FAMILIAR_FORMS = [
            { id: 'owl', name: 'Owl', ac: 11, hp: 1, speed: '5 ft, fly 60 ft', abilities: 'Flyby, Keen Hearing/Sight, Darkvision 120 ft' },
            { id: 'cat', name: 'Cat', ac: 12, hp: 2, speed: '40 ft, climb 30 ft', abilities: 'Keen Smell, Darkvision 60 ft' },
            { id: 'hawk', name: 'Hawk', ac: 13, hp: 1, speed: '10 ft, fly 60 ft', abilities: 'Keen Sight' },
            { id: 'raven', name: 'Raven', ac: 12, hp: 1, speed: '10 ft, fly 50 ft', abilities: 'Mimicry' },
            { id: 'spider', name: 'Spider', ac: 12, hp: 1, speed: '20 ft, climb 20 ft', abilities: 'Spider Climb, Web Sense, Darkvision 30 ft' },
            { id: 'frog', name: 'Frog', ac: 11, hp: 1, speed: '20 ft, swim 20 ft', abilities: 'Amphibious, Standing Leap, Darkvision 30 ft' },
            { id: 'bat', name: 'Bat', ac: 12, hp: 1, speed: '5 ft, fly 30 ft', abilities: 'Echolocation, Keen Hearing, Blindsight 60 ft' },
            { id: 'rat', name: 'Rat', ac: 10, hp: 1, speed: '20 ft', abilities: 'Keen Smell, Darkvision 30 ft' }
        ];

        const BESTIAL_SPIRIT = {
            air: { name: 'Air Spirit', speed: '30 ft, fly 60 ft', ability: 'Flyby: Doesn\'t provoke opportunity attacks when flying out of reach.' },
            land: { name: 'Land Spirit', speed: '30 ft, climb 30 ft', ability: 'Pack Tactics: Advantage if ally within 5 ft of target.' },
            water: { name: 'Water Spirit', speed: '30 ft, swim 30 ft', ability: 'Water Breathing, Pack Tactics.' }
        };

        function summonFamiliar() {
            let body = '<div class="form-options">';
            body += '<p class="text-muted" style="margin-bottom:12px;">Choose your familiar form (Fey, not Beast):</p>';

            FAMILIAR_FORMS.forEach(f => {
                body += `
                    <div class="form-option" onclick="createFamiliar('${f.id}')">
                        <div class="form-option-title">${f.name}</div>
                        <div class="form-option-desc">AC ${f.ac} | HP ${f.hp} | ${f.speed}</div>
                        <div class="form-option-desc" style="font-size:0.8em; margin-top:4px;">${f.abilities}</div>
                    </div>
                `;
            });

            body += '</div>';
            showModal('Choose Familiar Form', body);
        }

        function createFamiliar(formId) {
            const form = FAMILIAR_FORMS.find(f => f.id === formId);
            if (!form) return;

            // Remove existing familiar if any (can only have one familiar)
            state.companions = state.companions.filter(c => c.type !== 'familiar');

            // Add new familiar
            state.companions.push({
                id: 'familiar-' + Date.now(),
                type: 'familiar',
                name: form.name + ' (Familiar)',
                formId: formId,
                hp: { current: form.hp, max: form.hp },
                ac: form.ac,
                speed: form.speed,
                abilities: form.abilities
            });

            closeModal();
            updateCompanionDisplay();
            saveState();

            showModal('Familiar Summoned!', `
                <p>Your <strong>${form.name}</strong> familiar appears!</p>
                <p style="margin-top:10px; font-size:0.9em;">It is a <strong>Fey</strong> (not Beast) and will disappear after your next Long Rest.</p>
                <p style="margin-top:10px; font-size:0.9em;"><strong>Abilities:</strong> ${form.abilities}</p>
            `);
        }

        function openSummonBeastSelection(slotLevel) {
            let body = '<div class="form-options">';
            body += '<p class="text-muted" style="margin-bottom:12px;">Choose environment for your Bestial Spirit:</p>';

            const hp = 20 + 5 * (slotLevel - 2);
            const ac = 11 + slotLevel;
            const attackMod = 3 + slotLevel;
            const damage = `1d8+${2 + slotLevel}`;

            Object.entries(BESTIAL_SPIRIT).forEach(([env, spirit]) => {
                body += `
                    <div class="form-option" onclick="createBestialSpirit('${env}', ${slotLevel})">
                        <div class="form-option-title">${spirit.name} (${env.charAt(0).toUpperCase() + env.slice(1)})</div>
                        <div class="form-option-desc">AC ${ac} | HP ${hp} | ${spirit.speed}</div>
                        <div class="form-option-desc" style="margin-top:4px;">Attack: +${attackMod} to hit, ${damage} damage</div>
                        <div class="form-option-desc" style="font-size:0.8em; margin-top:4px;">${spirit.ability}</div>
                    </div>
                `;
            });

            body += '</div>';
            showModal('Summon Beast - Choose Environment', body);
        }

        function createBestialSpirit(environment, slotLevel) {
            const spirit = BESTIAL_SPIRIT[environment];
            const hp = 20 + 5 * (slotLevel - 2);
            const ac = 11 + slotLevel;

            // Remove existing beast if any (Summon Beast requires concentration, so only one)
            state.companions = state.companions.filter(c => c.type !== 'beast');

            // Add new beast companion
            state.companions.push({
                id: 'beast-' + Date.now(),
                type: 'beast',
                name: spirit.name,
                environment: environment,
                slotLevel: slotLevel,
                hp: { current: hp, max: hp },
                ac: ac,
                speed: spirit.speed,
                abilities: spirit.ability,
                attackMod: 3 + slotLevel,
                damage: `1d8+${2 + slotLevel}`
            });

            closeModal();
            updateCompanionDisplay();
            saveState();
        }

        function updateCompanionDisplay() {
            let companionSection = document.getElementById('companionSection');

            // Handle legacy state (single companion) to array conversion
            if (state.companion && !state.companions) {
                state.companions = [state.companion];
                delete state.companion;
            }
            if (!state.companions) state.companions = [];

            if (state.companions.length === 0) {
                if (companionSection) companionSection.style.display = 'none';
                return;
            }

            if (!companionSection) {
                // Create companion section dynamically in the HP section
                const hpSection = document.querySelector('.hp-section');
                companionSection = document.createElement('div');
                companionSection.id = 'companionSection';
                companionSection.className = 'companion-section';
                hpSection.appendChild(companionSection);
            }

            // Build HTML for all companions
            let html = '';
            state.companions.forEach((c, index) => {
                const borderColor = c.type === 'familiar' ? 'var(--accent-blue)' : 'var(--accent-purple)';
                const bgColor = c.type === 'familiar' ? 'rgba(74,144,217,0.1)' : 'rgba(123,104,238,0.1)';
                html += `
                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 12px; margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: ${borderColor};">${c.type === 'familiar' ? 'ü¶â' : 'üêæ'} ${c.name}</strong>
                            <button onclick="dismissCompanion('${c.id}')" style="background: var(--accent-red); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">Dismiss</button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 0.85em; margin-bottom: 8px;">
                            <div><strong>AC:</strong> ${c.ac}</div>
                            <div><strong>Speed:</strong> ${c.speed}</div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <strong>HP:</strong>
                                <input type="number" value="${c.hp.current}" min="0" max="${c.hp.max}" style="width: 40px; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; padding: 2px 4px;" onchange="updateCompanionHP('${c.id}', this.value)">
                                <span>/ ${c.hp.max}</span>
                            </div>
                        </div>
                        ${c.type === 'beast' ? `<div style="font-size: 0.85em; margin-bottom: 5px;"><strong>Attack:</strong> +${c.attackMod} to hit, ${c.damage} damage</div>` : ''}
                        <div style="font-size: 0.8em; margin-top: 8px;">
                            <strong>Abilities:</strong>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px;">
                                ${formatCompanionAbilities(c.abilities)}
                            </div>
                        </div>
                    </div>
                `;
            });

            companionSection.style.display = 'block';
            companionSection.innerHTML = html;
        }

        function formatCompanionAbilities(abilitiesString) {
            // Parse abilities (comma or period separated)
            const abilities = abilitiesString.split(/[,.]/).map(a => a.trim()).filter(a => a.length > 0);
            let html = '';

            abilities.forEach(ability => {
                // Extract ability name (before colon if present)
                const abilityName = ability.split(':')[0].trim();
                const hasDescription = ABILITY_DESCRIPTIONS[abilityName];

                if (hasDescription) {
                    const escapedName = abilityName.replace(/'/g, "\\'");
                    html += `<span onclick="showAbilityDescription('${escapedName}')" style="background: rgba(123,104,238,0.2); border: 1px solid var(--accent-purple); padding: 3px 8px; border-radius: 12px; cursor: pointer; color: var(--accent-purple); font-size: 0.85em;">${abilityName}</span>`;
                } else {
                    // Just display the full text for abilities without descriptions
                    html += `<span style="background: rgba(100,100,100,0.2); border: 1px solid var(--border-color); padding: 3px 8px; border-radius: 12px; color: var(--text-secondary); font-size: 0.85em;">${ability}</span>`;
                }
            });

            return html;
        }

        function showAbilityDescription(abilityName) {
            const description = ABILITY_DESCRIPTIONS[abilityName];
            if (description) {
                showModal(abilityName, `<p style="font-size: 1em; line-height: 1.5;">${description}</p>`);
            }
        }

        function updateCompanionHP(companionId, value) {
            if (!state.companions) return;
            const companion = state.companions.find(c => c.id === companionId);
            if (!companion) return;

            const hp = parseInt(value) || 0;
            companion.hp.current = Math.max(0, Math.min(hp, companion.hp.max));

            if (companion.hp.current <= 0) {
                if (state.inBattle) addBattleLog(`${companion.name} dropped to 0 HP and disappeared!`);
                state.companions = state.companions.filter(c => c.id !== companionId);
                updateCompanionDisplay();
            }
            saveState();
        }

        function dismissCompanion(companionId) {
            if (!state.companions) return;
            const companion = state.companions.find(c => c.id === companionId);
            if (!companion) return;

            if (confirm(`Dismiss your ${companion.name}?`)) {
                if (state.inBattle) addBattleLog(`Dismissed ${companion.name}`);
                state.companions = state.companions.filter(c => c.id !== companionId);
                updateCompanionDisplay();
                saveState();
            }
        }

        // ===== CONCENTRATION TRACKING =====
        function updateConcentrationDisplay() {
            let concSection = document.getElementById('concentrationSection');

            if (!state.concentration) {
                if (concSection) concSection.style.display = 'none';
                return;
            }

            if (!concSection) {
                // Create concentration section dynamically in the HP section
                const hpSection = document.querySelector('.hp-section');
                concSection = document.createElement('div');
                concSection.id = 'concentrationSection';
                // Insert before companion section if it exists
                const companionSection = document.getElementById('companionSection');
                if (companionSection) {
                    hpSection.insertBefore(concSection, companionSection);
                } else {
                    hpSection.appendChild(concSection);
                }
            }

            concSection.style.display = 'block';
            concSection.innerHTML = `
                <div style="background: rgba(255,140,0,0.15); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 12px; margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--accent-orange);">üéØ Concentrating:</strong> ${state.concentration.spellName}
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="promptConcentrationSave()" style="background: var(--accent-blue); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">Save</button>
                            <button onclick="endConcentration()" style="background: var(--accent-red); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">End</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function promptConcentrationSave() {
            showModal('Concentration Save', `
                <p style="margin-bottom: 15px;">When you take damage, make a Constitution saving throw to maintain concentration.</p>
                <p style="margin-bottom: 10px;"><strong>DC:</strong> 10 or half damage taken (whichever is higher)</p>
                <div style="background: rgba(80,200,120,0.15); border: 1px solid var(--accent-green); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: var(--accent-green);">‚öîÔ∏è War Caster:</strong> You have <strong>Advantage</strong> on this save!
                </div>
                <div style="background: rgba(123,104,238,0.15); border: 1px solid var(--accent-purple); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <strong style="color: var(--accent-purple);">üêâ Dragon Form:</strong> If you're in Starry Form (Dragon), treat rolls of 9 or lower as 10.
                </div>
                <p><strong>Your Con Save:</strong> +2 (with Advantage from War Caster)</p>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="closeModal()" style="flex:1; padding: 10px; background: var(--accent-green); color: white; border: none; border-radius: 6px; cursor: pointer;">Saved!</button>
                    <button onclick="endConcentration(); closeModal();" style="flex:1; padding: 10px; background: var(--accent-red); color: white; border: none; border-radius: 6px; cursor: pointer;">Failed</button>
                </div>
            `);
        }

        function endConcentration() {
            if (!state.concentration) return;
            const spellName = state.concentration.spellName;

            // If it was Summon Beast, dismiss only beast companions (not familiars)
            if (state.concentration.spellId === 'summon-beast' && state.companions) {
                state.companions = state.companions.filter(c => c.type !== 'beast');
                updateCompanionDisplay();
            }

            state.concentration = null;
            updateConcentrationDisplay();
            if (state.inBattle) addBattleLog(`Ended concentration on ${spellName}`);
            saveState();
        }

        function useArcherAttack() {
            if (!state.activeForm || !state.activeForm.showArcherAction) {
                alert('Archer form not active!');
                return;
            }
            saveForUndo();
            if (state.inBattle) {
                state.actionsUsed.bonus = true;
                addBattleLog('Archer Attack: +7 to hit, 1d8+4 radiant');
            }
            updateBattleUI();
            saveState();
        }

        function openOpportunityAttack() {
            if (state.inBattle && state.actionsUsed.reaction) {
                showToast('Reaction already used this round!');
                return;
            }
            // Get equipped melee weapons
            const meleeWeapons = state.inventory ? state.inventory.filter(item =>
                item.type === 'weapon' &&
                (item.equipped === 'mainHand' || item.equipped === 'offHand' || item.equipped === 'twoHanded') &&
                (item.weaponType === 'melee' || item.weaponType === 'melee/thrown')
            ) : [];

            let body = '<div class="form-options">';
            body += '<p class="text-muted" style="margin-bottom:10px;">Choose your opportunity attack:</p>';

            // Weapon attacks section
            body += '<div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 8px;">‚öîÔ∏è Weapon Attack</div>';

            if (meleeWeapons.length > 0) {
                meleeWeapons.forEach(weapon => {
                    const attackInfo = getWeaponAttackInfo(weapon);
                    body += `
                        <div class="form-option" onclick="performOpportunityWeapon('${weapon.id}')">
                            <div class="form-option-title">${weapon.name} ${weapon.isMagic ? '‚ú¶' : ''}</div>
                            <div class="form-option-desc">${attackInfo}</div>
                        </div>
                    `;
                });
            } else {
                body += '<p class="text-small text-muted" style="margin-left: 10px;">No melee weapon equipped</p>';
            }

            // War Caster spell section
            body += '<hr style="border-color: var(--border-color); margin: 12px 0;">';
            body += '<div style="color: var(--accent-purple); font-weight: bold; margin-bottom: 8px;">‚ú® War Caster (Cast Spell)</div>';
            body += `
                <div class="form-option" onclick="closeModal(); openWarCasterSpell();">
                    <div class="form-option-title">Cast a Spell Instead</div>
                    <div class="form-option-desc">Use War Caster to cast at the fleeing creature</div>
                </div>
            `;

            body += '</div>';
            showModal('Opportunity Attack', body);
        }

        function performOpportunityWeapon(weaponId) {
            const weapon = state.inventory.find(w => w.id === weaponId);
            if (!weapon) return;

            const attackInfo = getWeaponAttackInfo(weapon);

            if (state.inBattle) {
                saveForUndo();
                state.actionsUsed.reaction = true;
                addBattleLog(`Opportunity Attack: ${weapon.name} (${attackInfo})`);
                updateBattleUI();
                saveState();
            }

            closeModal();
            showToast(`Opportunity Attack: ${weapon.name}`);
        }

        function openWarCasterSpell() {
            if (state.activeForm && state.activeForm.type === 'wild-shape') {
                alert('Cannot cast spells while in Wild Shape!');
                return;
            }
            let body = '<div class="form-options">';
            body += '<p class="text-muted" style="margin-bottom:10px;">Cast a spell targeting the creature leaving your reach:</p>';

            // Add attack cantrips first
            const attackCantrips = CANTRIPS.filter(c =>
                ['starry-wisp', 'thorn-whip', 'produce-flame'].includes(c.id)
            );

            if (attackCantrips.length > 0) {
                body += '<div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 8px;">Cantrips (No Slot)</div>';
                attackCantrips.forEach(cantrip => {
                    const damage = getScaledCantripDamage(cantrip);
                    body += `
                        <div class="form-option" onclick="castWarCasterCantrip('${cantrip.id}')">
                            <div class="form-option-title">${cantrip.name}</div>
                            <div class="form-option-desc">${cantrip.range}${damage ? ' | ' + damage : ''}</div>
                        </div>
                    `;
                });
                body += '<hr style="border-color: var(--border-color); margin: 12px 0;">';
            }

            // Show action spells that can target one creature
            const singleTargetSpells = [];
            state.preparedSpells.forEach(prep => {
                for (let level = 1; level <= getMaxSpellLevel(); level++) {
                    const spell = SPELLS[level].find(s => s.id === prep.id);
                    if (spell && spell.time === 'Action') {
                        singleTargetSpells.push({ ...spell, level });
                    }
                }
            });

            // Always add Guiding Bolt
            singleTargetSpells.unshift({ ...SPELLS[1].find(s => s.id === 'guiding-bolt'), level: 1 });

            body += '<div style="color: var(--accent-purple); font-weight: bold; margin-bottom: 8px;">Leveled Spells</div>';
            singleTargetSpells.forEach(spell => {
                const dmgPreview = getSpellDamagePreview(spell, spell.level);
                body += `
                    <div class="form-option" onclick="castWarCasterSpell('${spell.id}', ${spell.level})">
                        <div class="form-option-title">${spell.name} (${spell.level}${getOrdinal(spell.level)})</div>
                        <div class="form-option-desc">${spell.range}${dmgPreview ? ' | ' + dmgPreview : ''}</div>
                    </div>
                `;
            });

            body += '</div>';
            showModal('War Caster - Choose Spell', body);
        }

        function castWarCasterCantrip(cantripId) {
            const cantrip = CANTRIPS.find(c => c.id === cantripId);
            if (state.inBattle) {
                state.actionsUsed.reaction = true;
                addBattleLog(`War Caster: Cast ${cantrip.name} as reaction`);
            }
            closeModal();
            updateBattleUI();
            saveState();
        }

        function castWarCasterSpell(spellId, level) {
            saveForUndo();

            // Use spell slot
            let slotUsed = false;
            for (let l = level; l <= 3; l++) {
                const slotIndex = state.slots[l].findIndex(used => !used);
                if (slotIndex !== -1) {
                    state.slots[l][slotIndex] = true;
                    slotUsed = true;
                    break;
                }
            }

            if (!slotUsed) {
                alert('No spell slots available!');
                return;
            }

            if (state.inBattle) {
                state.actionsUsed.reaction = true;
                addBattleLog(`War Caster: Cast ${spellId} as reaction`);
            }

            closeModal();
            updateSlotsDisplay();
            updateBattleUI();
            saveState();
        }

        function useAbsorbElements() {
            if (state.inBattle && state.actionsUsed.reaction) {
                showToast('Reaction already used this round!');
                return;
            }
            // Check if Absorb Elements is prepared
            const isPrepared = state.preparedSpells && state.preparedSpells.some(s => s.id === 'absorb-elements');
            if (!isPrepared) {
                showToast('Absorb Elements not prepared!');
                return;
            }

            // Check for 1st level slot
            const slotIndex = state.slots[1].findIndex(used => !used);
            if (slotIndex === -1) {
                // Check higher slots
                for (let l = 2; l <= 3; l++) {
                    const idx = state.slots[l].findIndex(used => !used);
                    if (idx !== -1) {
                        saveForUndo();
                        state.slots[l][idx] = true;
                        if (state.inBattle) {
                            state.actionsUsed.reaction = true;
                            addBattleLog('Cast Absorb Elements');
                        }
                        updateSlotsDisplay();
                        updateBattleUI();
                        saveState();
                        return;
                    }
                }
                alert('No spell slots available!');
                return;
            }

            saveForUndo();
            state.slots[1][slotIndex] = true;
            if (state.inBattle) {
                state.actionsUsed.reaction = true;
                addBattleLog('Cast Absorb Elements');
            }
            updateSlotsDisplay();
            updateBattleUI();
            saveState();
        }

        function updateAbsorbElementsButton() {
            const btn = document.querySelector('[onclick="useAbsorbElements()"]');
            if (!btn) return;
            const isPrepared = state.preparedSpells && state.preparedSpells.some(s => s.id === 'absorb-elements');
            btn.style.display = isPrepared ? '' : 'none';
        }

        // ===== RESOURCE SLOT TOGGLES =====
        function toggleWildShapeSlot(el) {
            el.classList.toggle('used');
            const used = document.querySelectorAll('#wildShapeSlots .slot-box.used').length;
            state.resources.wildShape = 2 - used;
            saveState();
        }

        function toggleGBSlot(el) {
            el.classList.toggle('used');
            const used = document.querySelectorAll('#guidingBoltSlots .slot-box.used').length;
            state.resources.guidingBolt = 4 - used;
            saveState();
        }

        function toggleHWFreeSlot(el) {
            el.classList.toggle('used');
            state.resources.healingWordFree = el.classList.contains('used') ? 0 : 1;
            saveState();
        }

        function toggleHHSlot(el) {
            el.classList.toggle('used');
            state.resources.healingHands = el.classList.contains('used') ? 0 : 1;
            saveState();
        }

        function toggleCRSlot(el) {
            el.classList.toggle('used');
            state.resources.celestialRevelation = el.classList.contains('used') ? 0 : 1;
            saveState();
        }

        function toggleCOSlot(el) {
            el.classList.toggle('used');
            const used = document.querySelectorAll('#cosmicOmenSlots .slot-box.used').length;
            state.resources.cosmicOmen = 3 - used;
            saveState();
        }

        function updateResourceSlots() {
            // Guiding Bolt
            const gbSlots = document.querySelectorAll('#guidingBoltSlots .slot-box');
            gbSlots.forEach((slot, i) => {
                slot.classList.toggle('used', i >= state.resources.guidingBolt);
            });

            // Wild Shape
            const wsSlots = document.querySelectorAll('#wildShapeSlots .slot-box');
            wsSlots.forEach((slot, i) => {
                slot.classList.toggle('used', i >= state.resources.wildShape);
            });

            // Healing Word Free
            const hwSlot = document.querySelector('#healingWordFreeSlot .slot-box');
            if (hwSlot) hwSlot.classList.toggle('used', state.resources.healingWordFree <= 0);

            // Healing Hands
            const hhSlot = document.querySelector('#healingHandsSlot .slot-box');
            if (hhSlot) hhSlot.classList.toggle('used', state.resources.healingHands <= 0);

            // Celestial Revelation
            const crSlot = document.querySelector('#celestialRevSlot .slot-box');
            if (crSlot) crSlot.classList.toggle('used', state.resources.celestialRevelation <= 0);

            // Cosmic Omen (Level 6+)
            const coGroup = document.getElementById('cosmicOmenGroup');
            const currentLevel = state.characterLevel || 5;
            if (coGroup) {
                coGroup.style.display = currentLevel >= 6 ? '' : 'none';
            }
            const coSlots = document.querySelectorAll('#cosmicOmenSlots .slot-box');
            coSlots.forEach((slot, i) => {
                slot.classList.toggle('used', i >= (state.resources.cosmicOmen || 0));
            });
        }

        function showFeatureModal(featureId) {
            const features = {
                'healing-hands': {
                    title: 'Healing Hands',
                    body: '<p><strong>Action</strong></p><p>Touch a creature and roll 3d4. The creature regains HP equal to the total.</p><p><strong>Uses:</strong> 1/Long Rest</p>'
                },
                'celestial-revelation': {
                    title: 'Celestial Revelation',
                    body: '<p><strong>Bonus Action</strong></p><p>Transform for 1 minute. Choose: Radiant Soul (fly 30ft, +3 radiant), Necrotic Shroud (frighten, +3 necrotic), or Inner Radiance (damage aura).</p><p><strong>Uses:</strong> 1/Long Rest</p>'
                }
            };

            const f = features[featureId];
            if (f) showModal(f.title, f.body);
        }

        // ===== INIT =====
        // Handle Enter key for HP inputs
        document.getElementById('damageInput').addEventListener('keypress', e => { if (e.key === 'Enter') applyDamage(); });
        document.getElementById('healInput').addEventListener('keypress', e => { if (e.key === 'Enter') applyHeal(); });

        // ===== SPELL DATA (2024 Druid) =====
        const CANTRIPS = [
            { id: 'druidcraft', name: 'Druidcraft', source: 'Druid', school: 'Transmutation', time: 'Action', range: '30 ft', dur: 'Instant', comp: 'V, S',
              desc: 'Whispering to the spirits of nature, you create one of the following effects within range: You create a tiny, harmless sensory effect that predicts the weather for the next 24 hours. You instantly make a flower blossom, a seed pod open, or a leaf bud bloom. You create an instantaneous, harmless sensory effect (falling leaves, a puff of wind, the sound of an animal, or faint odor). You instantly light or snuff out a candle, torch, or small campfire.' },
            { id: 'guidance', name: 'Guidance', source: 'Star Map (Circle of Stars)', school: 'Divination', time: 'Action', range: 'Touch', dur: '1 min (C)', comp: 'V, S',
              desc: 'You touch a willing creature and choose one of the following: Ability Check or Saving Throw. Once before the spell ends, the target can roll 1d4 and add the number rolled to one ability check or saving throw (your choice) of its choice. It can roll before or after making the roll. The spell then ends.' },
            { id: 'starry-wisp', name: 'Starry Wisp', source: 'Druid', school: 'Evocation', time: 'Action', range: '60 ft', dur: 'Instant', comp: 'V, S',
              desc: 'You launch a mote of light at one creature or object within range. Make a ranged spell attack against the target. On a hit, the target takes 1d8 Radiant damage, and until the end of your next turn, it emits Dim Light in a 10-foot radius and can\'t benefit from the Invisible condition. Damage increases: 2d8 at 5th level, 3d8 at 11th level, 4d8 at 17th level.' },
            { id: 'thorn-whip', name: 'Thorn Whip', source: 'Druid (Level 4)', school: 'Transmutation', time: 'Action', range: '30 ft', dur: 'Instant', comp: 'V, S, M (stem of a thorny plant)',
              desc: 'You create a vine-like whip covered in thorns that lashes out at your command toward a creature within range. Make a melee spell attack against the target. If the attack hits, the creature takes 1d6 Piercing damage, and if the creature is Large or smaller, you can pull the creature up to 10 feet closer to you. Damage increases: 2d6 at 5th level, 3d6 at 11th level, 4d6 at 17th level.' },
            { id: 'message', name: 'Message', source: 'Druid (Magician)', school: 'Transmutation', time: 'Action', range: '120 ft', dur: '1 round', comp: 'V, S, M (a copper wire)',
              desc: 'You point toward a creature within range and whisper a message. The target (and only the target) hears the message and can reply in a whisper that only you can hear. You can cast this spell through solid objects if you are familiar with the target. The spell is blocked by 3 feet of wood, 1 foot of stone, 1 inch of metal, or a thin sheet of lead.' },
            { id: 'produce-flame', name: 'Produce Flame', source: 'Magic Initiate', school: 'Conjuration', time: 'Bonus Action', range: 'Self', dur: '10 min', comp: 'V, S',
              desc: 'A flickering flame appears in your hand and remains for the duration. While there, the flame emits no heat and ignites nothing, and it sheds Bright Light in a 20-foot radius and Dim Light for an additional 20 feet. The spell ends if you cast it again. Until the spell ends, you can take a Magic action to hurl fire at a creature or object within 60 feet. Make a ranged spell attack. On a hit, the target takes 1d8 Fire damage. Damage increases: 2d8 at 5th level, 3d8 at 11th level, 4d8 at 17th level.' },
            { id: 'mending', name: 'Mending', source: 'Magic Initiate', school: 'Transmutation', time: '1 min', range: 'Touch', dur: 'Instant', comp: 'V, S, M (two lodestones)',
              desc: 'This spell repairs a single break or tear in an object you touch, such as a broken chain link, two halves of a broken key, a torn cloak, or a leaking wineskin. As long as the damage is no larger than 1 foot in any dimension, you mend it, leaving no trace of the former damage. This spell can physically repair a magic item, but it can\'t restore magic to such an object.' }
        ];

        const SPELLS = {
            1: [
                { id: 'guiding-bolt', name: 'Guiding Bolt', always: true, school: 'Evocation', conc: false, ritual: false, time: 'Action', range: '120 ft', dur: '1 round', comp: 'V, S',
                  desc: 'A flash of light streaks toward a creature of your choice within range. Make a ranged spell attack against the target. On a hit, the target takes 4d6 Radiant damage, and the next attack roll made against this target before the end of your next turn has Advantage.',
                  higher: 'The damage increases by 1d6 for each spell slot level above 1.',
                  note: '‚≠ê FREE: 4/long rest from Star Map (Wis mod)' },
                { id: 'cure-wounds', name: 'Cure Wounds', school: 'Abjuration', conc: false, ritual: false, time: 'Action', range: 'Touch', dur: 'Instant', comp: 'V, S',
                  desc: 'A creature you touch regains a number of Hit Points equal to 2d8 + your spellcasting ability modifier. This spell has no effect on Constructs or Undead.',
                  higher: 'The healing increases by 2d8 for each spell slot level above 1.' },
                { id: 'healing-word', name: 'Healing Word', always: true, school: 'Abjuration', conc: false, ritual: false, time: 'Bonus Action', range: '60 ft', dur: 'Instant', comp: 'V',
                  desc: 'A creature of your choice that you can see within range regains Hit Points equal to 2d4 + your spellcasting ability modifier. This spell has no effect on Constructs or Undead.',
                  higher: 'The healing increases by 2d4 for each spell slot level above 1.',
                  note: '‚≠ê FREE 1/day from Magic Initiate (always prepared)' },
                { id: 'entangle', name: 'Entangle', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '90 ft', dur: '1 min', comp: 'V, S',
                  desc: 'Grasping weeds and vines sprout from the ground in a 20-foot square starting from a point within range. For the duration, these plants turn the ground in the area into Difficult Terrain. A creature in the area when you cast the spell must succeed on a Strength saving throw or be Restrained by the entangling plants until the spell ends. A creature Restrained by the plants can take an action to make a Strength check against your spell save DC. On a success, it frees itself. When the spell ends, the conjured plants wilt away.' },
                { id: 'faerie-fire', name: 'Faerie Fire', school: 'Evocation', conc: true, ritual: false, time: 'Action', range: '60 ft', dur: '1 min', comp: 'V',
                  desc: 'Objects in a 20-foot Cube within range are outlined in blue, green, or violet light (your choice). Each creature in the Cube is also outlined if it fails a Dexterity saving throw. For the duration, objects and affected creatures shed Dim Light in a 10-foot radius and can\'t benefit from the Invisible condition. Attack rolls against affected creatures and objects have Advantage.' },
                { id: 'absorb-elements', name: 'Absorb Elements', school: 'Abjuration', conc: false, ritual: false, time: 'Reaction', range: 'Self', dur: '1 round', comp: 'S',
                  desc: 'Trigger: You take Acid, Cold, Fire, Lightning, or Thunder damage. You have Resistance to the triggering damage type until the start of your next turn. Also, the first time you hit with a melee attack on your next turn, the target takes an extra 1d6 damage of the triggering type.',
                  higher: 'The extra damage increases by 1d6 for each spell slot level above 1.' },
                { id: 'goodberry', name: 'Goodberry', school: 'Conjuration', conc: false, ritual: false, time: 'Action', range: 'Self', dur: 'Instant', comp: 'V, S, M (a sprig of mistletoe)',
                  desc: 'Ten berries appear in your hand and are infused with magic for the duration. A creature can use its Bonus Action to eat one berry. Eating a berry restores 1 Hit Point, and the berry provides enough nourishment to sustain a creature for one day. Uneaten berries disappear when the spell ends.' },
                { id: 'fog-cloud', name: 'Fog Cloud', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '120 ft', dur: '1 hour', comp: 'V, S',
                  desc: 'You create a 20-foot-radius Sphere of fog centered on a point within range. The Sphere is Heavily Obscured. It lasts for the duration or until a strong wind (such as one created by Gust of Wind) disperses it.',
                  higher: 'The fog\'s radius increases by 20 feet for each spell slot level above 1.' },
                { id: 'speak-animals', name: 'Speak with Animals', school: 'Divination', conc: false, ritual: true, time: 'Action', range: 'Self', dur: '10 min', comp: 'V, S',
                  desc: 'You gain the ability to comprehend and verbally communicate with Beasts for the duration. The knowledge and awareness of many Beasts is limited by their intelligence, but at minimum, Beasts can give you information about nearby locations and monsters, including whatever they have perceived within the past day.' },
                { id: 'thunderwave', name: 'Thunderwave', school: 'Evocation', conc: false, ritual: false, time: 'Action', range: 'Self (15-ft cube)', dur: 'Instant', comp: 'V, S',
                  desc: 'A wave of thunderous force sweeps out from you. Each creature in a 15-foot Cube originating from you makes a Constitution saving throw. On a failed save, a creature takes 2d8 Thunder damage and is pushed 10 feet away from you. On a successful save, it takes half damage only. In addition, unsecured objects that are completely within the Cube are pushed 10 feet away, and the spell emits a thunderous boom audible out to 300 feet.',
                  higher: 'The damage increases by 1d8 for each spell slot level above 1.' },
                { id: 'animal-friendship', name: 'Animal Friendship', school: 'Enchantment', conc: false, ritual: false, time: 'Action', range: '30 ft', dur: '24 hours', comp: 'V, S, M (a morsel of food)',
                  desc: 'Target a Beast that you can see within range. The target must succeed on a Wisdom saving throw or have the Charmed condition for the duration. If you or one of your allies deals damage to the target, the spell ends.',
                  higher: 'You can target one additional Beast for each spell slot level above 1.' },
                { id: 'detect-magic', name: 'Detect Magic', school: 'Divination', conc: true, ritual: true, time: 'Action', range: 'Self (30-ft radius)', dur: '10 min', comp: 'V, S',
                  desc: 'For the duration, you sense the presence of magical effects within 30 feet of yourself. If you sense such effects, you can take the Magic action to see a faint aura around any visible creature or object in the area that bears the magic, and if the magic was created by a spell, you learn the spell\'s school of magic. The spell is blocked by 1 foot of stone, dirt, or wood; 1 inch of metal; or a thin sheet of lead.' },
                { id: 'purify-food', name: 'Purify Food and Drink', school: 'Transmutation', conc: false, ritual: true, time: 'Action', range: '10 ft', dur: 'Instant', comp: 'V, S',
                  desc: 'You remove poison and disease from all nonmagical food and drink in a 5-foot-radius Sphere centered on a point within range.' },
                { id: 'charm-person', name: 'Charm Person', school: 'Enchantment', conc: false, ritual: false, time: 'Action', range: '30 ft', dur: '1 hour', comp: 'V, S',
                  desc: 'One Humanoid you can see within range makes a Wisdom saving throw. It does so with Advantage if you or your allies are fighting it. On a failed save, the target has the Charmed condition until the spell ends or until you or your allies damage it. The Charmed creature is Friendly to you. When the spell ends, the target knows it was Charmed by you.',
                  higher: 'You can target one additional creature for each spell slot level above 1.' },
                { id: 'create-water', name: 'Create or Destroy Water', school: 'Transmutation', conc: false, ritual: false, time: 'Action', range: '30 ft', dur: 'Instant', comp: 'V, S, M (a drop of water or a few grains of sand)',
                  desc: 'You do one of the following: Create Water: You create up to 10 gallons of clean water within range in an open container, or you create rain in a 30-foot Cube within range, extinguishing exposed flames. Destroy Water: You destroy up to 10 gallons of water in an open container, or you destroy fog in a 30-foot Cube within range.',
                  higher: 'You create or destroy 10 additional gallons for each spell slot level above 1, or the Cube increases by 5 feet.' },
                { id: 'jump', name: 'Jump', school: 'Transmutation', conc: false, ritual: false, time: 'Bonus Action', range: 'Touch', dur: '1 min', comp: 'V, S, M (a grasshopper\'s hind leg)',
                  desc: 'You touch a willing creature. Once on each of its turns until the spell ends, that creature can jump up to 30 feet by spending only 10 feet of movement.' },
                { id: 'longstrider', name: 'Longstrider', school: 'Transmutation', conc: false, ritual: false, time: 'Action', range: 'Touch', dur: '1 hour', comp: 'V, S, M (a pinch of dirt)',
                  desc: 'You touch a creature. The target\'s Speed increases by 10 feet until the spell ends.',
                  higher: 'You can target one additional creature for each spell slot level above 1.' }
            ],
            2: [
                { id: 'moonbeam', name: 'Moonbeam', school: 'Evocation', conc: true, ritual: false, time: 'Action', range: '120 ft', dur: '1 min', comp: 'V, S, M (several seeds of any moonseed plant and a piece of opalescent feldspar)',
                  desc: 'A silvery beam of pale light shines down in a 5-foot-radius, 40-foot-high Cylinder centered on a point within range. Until the spell ends, Dim Light fills the Cylinder. When a creature enters the Cylinder for the first time on a turn or starts its turn there, it makes a Constitution saving throw, taking 2d10 Radiant damage on a failed save, or half as much damage on a successful one. A Shapechanger makes its saving throw with Disadvantage. On your later turns, you can take a Magic action to move the Cylinder up to 60 feet.',
                  higher: 'The damage increases by 1d10 for each spell slot level above 2.' },
                { id: 'pass-without-trace', name: 'Pass Without Trace', school: 'Abjuration', conc: true, ritual: false, time: 'Action', range: 'Self (30-ft emanation)', dur: '1 hour', comp: 'V, S, M (ashes from burned mistletoe)',
                  desc: 'You and each creature you choose within 30 feet of yourself have a +10 bonus to Dexterity (Stealth) checks and leave no tracks or other traces of your passage.' },
                { id: 'hold-person', name: 'Hold Person', school: 'Enchantment', conc: true, ritual: false, time: 'Action', range: '60 ft', dur: '1 min', comp: 'V, S, M (a straight piece of iron)',
                  desc: 'Choose a Humanoid that you can see within range. The target must succeed on a Wisdom saving throw or have the Paralyzed condition for the duration. At the end of each of its turns, the target repeats the save, ending the spell on itself on a success.',
                  higher: 'You can target one additional Humanoid for each spell slot level above 2.' },
                { id: 'spike-growth', name: 'Spike Growth', school: 'Transmutation', conc: true, ritual: false, time: 'Action', range: '150 ft', dur: '10 min', comp: 'V, S, M (seven sharp thorns)',
                  desc: 'The ground in a 20-foot-radius Sphere centered on a point within range twists and sprouts hard spikes and thorns. The area becomes Difficult Terrain for the duration. When a creature moves into or within the area, it takes 2d4 Piercing damage for every 5 feet it travels. The transformation of the ground is camouflaged to look natural. Any creature that can\'t see the area when the spell is cast must take a Search action and succeed on a Wisdom (Perception) check against your spell save DC to recognize the terrain as hazardous.' },
                { id: 'lesser-restoration', name: 'Lesser Restoration', school: 'Abjuration', conc: false, ritual: false, time: 'Bonus Action', range: 'Touch', dur: 'Instant', comp: 'V, S',
                  desc: 'You touch a creature and end one condition on it: Blinded, Deafened, Paralyzed, or Poisoned. Alternatively, you can end one disease on the creature.' },
                { id: 'heat-metal', name: 'Heat Metal', school: 'Transmutation', conc: true, ritual: false, time: 'Action', range: '60 ft', dur: '1 min', comp: 'V, S, M (a piece of iron and a flame)',
                  desc: 'Choose a manufactured metal object, such as a metal weapon or a suit of Heavy or Medium metal armor. You cause the object to glow red-hot. Any creature in physical contact with the object takes 2d8 Fire damage when you cast the spell. Until the spell ends, you can take a Bonus Action on your later turns to deal this damage again. If a creature is holding or wearing the object and takes damage from it, the creature must succeed on a Constitution saving throw or drop the object if it can. If it doesn\'t drop the object, it has Disadvantage on attack rolls and ability checks until the start of your next turn.',
                  higher: 'The damage increases by 1d8 for each spell slot level above 2.' },
                { id: 'barkskin', name: 'Barkskin', school: 'Transmutation', conc: false, ritual: false, time: 'Bonus Action', range: 'Touch', dur: '1 hour', comp: 'V, S, M (a handful of bark)',
                  desc: 'You touch a willing creature. Until the spell ends, the target\'s skin takes on a rough, bark-like appearance, and the target\'s AC can\'t be less than 17, regardless of what kind of armor it is wearing.' },
                { id: 'beast-sense', name: 'Beast Sense', school: 'Divination', conc: true, ritual: true, time: 'Action', range: 'Touch', dur: '1 hour', comp: 'S',
                  desc: 'You touch a willing Beast. For the duration, you can take a Magic action to see through the Beast\'s eyes and hear what it hears, gaining the benefits of any special senses it has. During this time, your senses don\'t function, and you have the Blinded and Deafened conditions.' },
                { id: 'darkvision', name: 'Darkvision', school: 'Transmutation', conc: false, ritual: false, time: 'Action', range: 'Touch', dur: '8 hours', comp: 'V, S, M (a dried carrot)',
                  desc: 'You touch a willing creature to grant it Darkvision. For the duration, that creature has Darkvision with a range of 150 feet.' },
                { id: 'enhance-ability', name: 'Enhance Ability', school: 'Transmutation', conc: true, ritual: false, time: 'Action', range: 'Touch', dur: '1 hour', comp: 'V, S, M (fur or a feather)',
                  desc: 'You touch a creature and choose one of the following effects; the target gains that effect until the spell ends. Bear\'s Endurance: Advantage on Constitution checks. The target also gains 2d6 Temporary Hit Points. Bull\'s Strength: Advantage on Strength checks, and carrying capacity doubles. Cat\'s Grace: Advantage on Dexterity checks. Also doesn\'t take damage from falling 20 feet or less if not Incapacitated. Eagle\'s Splendor: Advantage on Charisma checks. Fox\'s Cunning: Advantage on Intelligence checks. Owl\'s Wisdom: Advantage on Wisdom checks.',
                  higher: 'You can target one additional creature for each spell slot level above 2.' },
                { id: 'flame-blade', name: 'Flame Blade', school: 'Evocation', conc: true, ritual: false, time: 'Bonus Action', range: 'Self', dur: '10 min', comp: 'V, S, M (a sumac leaf)',
                  desc: 'You evoke a fiery blade in your free hand. The blade sheds Bright Light in a 10-foot radius and Dim Light for an additional 10 feet. You can take a Magic action to make a melee spell attack with the blade. On a hit, the target takes Fire damage equal to 3d6 plus your spellcasting ability modifier. The flaming blade disappears if you let go of it, but you can evoke it again as a Bonus Action.',
                  higher: 'The Fire damage increases by 1d6 for every slot level above 2.' },
                { id: 'gust-of-wind', name: 'Gust of Wind', school: 'Evocation', conc: true, ritual: false, time: 'Action', range: 'Self', dur: '1 min', comp: 'V, S, M (a legume seed)',
                  desc: 'A Line of strong wind 60 feet long and 10 feet wide blasts from you in a direction you choose. Each creature in the Line must succeed on a Strength saving throw or be pushed 15 feet away from you in a direction following the Line. Any creature in the Line must spend 2 feet of movement for every 1 foot it moves when moving closer to you. The gust disperses gas or vapor, and it extinguishes candles and similar unprotected flames. It causes protected flames, such as lanterns, to dance wildly and has a 50 percent chance to extinguish them. As a Bonus Action on your later turns, you can change the direction of the Line.' },
                { id: 'protection-poison', name: 'Protection from Poison', school: 'Abjuration', conc: false, ritual: false, time: 'Action', range: 'Touch', dur: '1 hour', comp: 'V, S',
                  desc: 'You touch a creature. If it is Poisoned, you neutralize the poison. If more than one poison afflicts the target, you neutralize one poison you know is present, or you neutralize one at random. For the duration, the target has Advantage on saving throws against being Poisoned and has Resistance to Poison damage.' },
                { id: 'summon-beast', name: 'Summon Beast', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '90 ft', dur: '1 hour', comp: 'V, S, M (a feather, tuft of fur, and fish tail inside a gilded acorn worth 200+ GP)',
                  desc: 'You call forth a bestial spirit. It manifests in an unoccupied space that you can see within range and uses the Bestial Spirit stat block. When you cast the spell, choose an environment: Air, Land, or Water. The creature resembles an animal of your choice and gains certain traits based on the environment. The creature disappears when it drops to 0 Hit Points or when the spell ends. It is an ally to you and your companions. In combat, it shares your Initiative count and takes its turn immediately after yours. It obeys your verbal commands (no action required). If you don\'t issue any, it takes the Dodge action and moves to avoid danger.',
                  higher: 'Use the spell slot\'s level for the spell\'s level in the stat block.' }
            ],
            3: [
                { id: 'conjure-animals', name: 'Conjure Animals', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '60 ft', dur: '10 min', comp: 'V, S',
                  desc: 'You conjure nature spirits that take the form of a Large swarm of spectral animals in an unoccupied space you can see within range. The swarm lasts for the duration, is allied with you and your companions, and obeys your commands. The swarm uses the Conjured Animals stat block. When you cast the spell, you choose the swarm\'s kind. Each kind has a specific creature appearance. See the spell for the full stat block. If you don\'t issue any commands, the swarm defends itself from hostile creatures but otherwise takes no actions.',
                  higher: 'The swarm\'s HP increases by 10 for each spell slot level above 3.' },
                { id: 'call-lightning', name: 'Call Lightning', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '120 ft', dur: '10 min', comp: 'V, S',
                  desc: 'A storm cloud appears at a point within range. It is a 10-foot-tall, 60-foot-radius cylinder. When you cast the spell, choose a point you can see under the cloud. A lightning bolt strikes that point. Each creature within 5 feet of that point makes a Dexterity saving throw, taking 3d10 Lightning damage on a failed save, or half as much damage on a successful one. Until the spell ends, you can take a Magic action to call down lightning in this way again, targeting the same point or a different one. If you\'re outdoors in a storm when you cast this spell, the damage increases by 1d10.',
                  higher: 'The damage increases by 1d10 for each spell slot level above 3.' },
                { id: 'dispel-magic', name: 'Dispel Magic', school: 'Abjuration', conc: false, ritual: false, time: 'Action', range: '120 ft', dur: 'Instant', comp: 'V, S',
                  desc: 'Choose one creature, object, or magical effect within range. Any ongoing spell of level 3 or lower on the target ends. For each ongoing spell of level 4 or higher on the target, make an ability check using your spellcasting ability (DC = 10 + the spell\'s level). On a successful check, the spell ends.',
                  higher: 'You automatically end a spell on the target if the spell\'s level is equal to or less than the level of the spell slot you used.' },
                { id: 'plant-growth', name: 'Plant Growth', school: 'Transmutation', conc: false, ritual: false, time: 'Action or 8 hours', range: '150 ft', dur: 'Instant', comp: 'V, S',
                  desc: 'This spell channels vitality into plants. There are two possible uses: If you cast this spell using 1 action, choose a point within range. All normal plants in a 100-foot-radius Sphere centered on that point become thick and overgrown. A creature moving through that area must spend 4 feet of movement for every 1 foot it moves. You can exclude areas of any size from being affected. If you cast this spell over 8 hours, you enrich the land. All plants in a half-mile radius centered on a point within range become enriched for 1 year. The plants yield twice the normal amount of food when harvested.' },
                { id: 'revivify', name: 'Revivify', school: 'Necromancy', conc: false, ritual: false, time: 'Action', range: 'Touch', dur: 'Instant', comp: 'V, S, M (diamonds worth 300+ GP, which the spell consumes)',
                  desc: 'You touch a creature that has died within the last minute. That creature revives with 1 Hit Point. This spell can\'t revive a creature that has died of old age, nor can it restore any missing body parts.' },
                { id: 'daylight', name: 'Daylight', school: 'Evocation', conc: false, ritual: false, time: 'Action', range: '60 ft', dur: '1 hour', comp: 'V, S',
                  desc: 'A 60-foot-radius Sphere of Bright Light spreads from a point you choose within range. The Sphere is Bright Light and sheds Dim Light for an additional 60 feet. If any of this spell\'s area overlaps with an area of Darkness created by a spell of level 3 or lower, that other spell is dispelled.' },
                { id: 'meld-into-stone', name: 'Meld into Stone', school: 'Transmutation', conc: false, ritual: true, time: 'Action', range: 'Touch', dur: '8 hours', comp: 'V, S',
                  desc: 'You step into a stone object or surface large enough to fully contain your body, melding yourself and everything you\'re carrying with the stone for the duration. Using your movement, you can step into the stone at a point you can touch. You remain aware of the passage of time and can cast spells on yourself while merged. You can exit the stone where you entered or at any other location that shares a surface with the stone you entered. If the stone is damaged, you are expelled and take 6d6 Bludgeoning damage. If the stone is destroyed, you die unless you exit first.' },
                { id: 'protection-energy', name: 'Protection from Energy', school: 'Abjuration', conc: true, ritual: false, time: 'Action', range: 'Touch', dur: '1 hour', comp: 'V, S',
                  desc: 'For the duration, the willing creature you touch has Resistance to one damage type of your choice: Acid, Cold, Fire, Lightning, or Thunder.' },
                { id: 'sleet-storm', name: 'Sleet Storm', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '150 ft', dur: '1 min', comp: 'V, S, M (a miniature umbrella)',
                  desc: 'Until the spell ends, sleet falls in a 40-foot-tall, 20-foot-radius Cylinder centered on a point you choose within range. The area is Heavily Obscured, and exposed flames in the area are doused. Ground in the area is covered with slick ice, making it Difficult Terrain. When a creature enters the area for the first time on a turn or starts its turn there, it must make a Dexterity saving throw. On a failed save, it has the Prone condition. If a creature starts its turn in the spell\'s area and is concentrating, it must succeed on a Constitution saving throw against your spell save DC or lose Concentration.' },
                { id: 'speak-plants', name: 'Speak with Plants', school: 'Transmutation', conc: false, ritual: false, time: 'Action', range: 'Self', dur: '10 min', comp: 'V, S',
                  desc: 'You imbue plants in an immobile 30-foot Emanation with limited sentience and animation, giving them the ability to communicate with you and follow your simple commands. You can question plants about events in the spell\'s area within the past day. You can also turn Difficult Terrain caused by plant growth (such as thickets and undergrowth) into ordinary terrain for the duration, or turn ordinary terrain where plants are present into Difficult Terrain for the duration. The spell doesn\'t enable plants to uproot themselves and move about. Plants might perform other tasks for you, at the DM\'s discretion.' },
                { id: 'water-breathing', name: 'Water Breathing', school: 'Transmutation', conc: false, ritual: true, time: 'Action', range: '30 ft', dur: '24 hours', comp: 'V, S, M (a short reed)',
                  desc: 'This spell grants up to ten willing creatures you can see within range the ability to breathe underwater until the spell ends. Affected creatures also retain their normal mode of respiration.' },
                { id: 'wind-wall', name: 'Wind Wall', school: 'Evocation', conc: true, ritual: false, time: 'Action', range: '120 ft', dur: '1 min', comp: 'V, S, M (a fan and feather)',
                  desc: 'A wall of strong wind rises from the ground at a point you choose within range. You can make the wall up to 50 feet long, 15 feet high, and 1 foot thick. You can shape the wall in any way you choose so long as it makes one continuous path along the ground. The wall lasts for the duration. When the wall appears, each creature in its area makes a Strength saving throw, taking 4d8 Bludgeoning damage on a failed save, or half as much damage on a successful one. The strong wind keeps fog, smoke, and other gases at bay. Small or smaller flying creatures or objects can\'t pass through the wall. Loose, lightweight materials are picked up. Arrows, bolts, and other ordinary projectiles launched at targets behind the wall are deflected upward and automatically miss.',
                  higher: 'The damage increases by 1d8 for each spell slot level above 3.' }
            ],
            4: [
                { id: 'conjure-minor-elementals', name: 'Conjure Minor Elementals', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: 'Self (15-foot emanation)', dur: 'Conc, 1 hour', comp: 'V, S',
                  desc: 'You conjure spirits from the Elemental Planes that flit around you in a 15-foot Emanation for the duration. Until the spell ends, any attack you make deals an extra 2d8 damage when you hit a creature in the Emanation. This damage is Acid, Cold, Fire, or Lightning (your choice when you cast the spell). In addition, the ground in the Emanation is Difficult Terrain for your enemies.',
                  higher: 'Extra damage increases by 2d8 for each slot level above 4th.' },
                { id: 'conjure-woodland-beings', name: 'Conjure Woodland Beings', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: 'Self (10-foot emanation)', dur: 'Conc, 10 min', comp: 'V, S',
                  desc: 'You conjure nature spirits that flit around you in a 10-foot Emanation for the duration. Whenever the Emanation enters the space of a creature you can see and whenever a creature you can see enters the Emanation or ends its turn there, you can force that creature to make a Wisdom saving throw. The creature takes 5d8 Force damage on a failed save or half as much damage on a successful one. A creature makes this save only once per turn.',
                  higher: 'Damage increases by 1d8 for each slot level above 4th.' },
                { id: 'freedom-of-movement', name: 'Freedom of Movement', school: 'Abjuration', conc: false, ritual: false, time: 'Action', range: 'Touch', dur: '1 hour', comp: 'V, S, M (leather strap)',
                  desc: 'You touch a willing creature. For the duration, the target\'s movement is unaffected by Difficult Terrain, and spells and other magical effects can neither reduce the target\'s Speed nor cause the target to have the Paralyzed or Restrained conditions. The target can also spend 5 feet of movement to automatically escape from nonmagical restraints.' },
                { id: 'ice-storm', name: 'Ice Storm', school: 'Evocation', conc: false, ritual: false, time: 'Action', range: '300 ft', dur: 'Instant', comp: 'V, S, M (a pinch of dust and a few drops of water)',
                  desc: 'A hail of rock-hard ice pounds to the ground in a 20-foot-radius, 40-foot-high Cylinder centered on a point within range. Each creature in the Cylinder makes a Dexterity saving throw. A creature takes 2d10 Bludgeoning damage and 4d6 Cold damage on a failed save or half as much damage on a successful one. Hailstones turn the Cylinder\'s area of effect into Difficult Terrain until the end of your next turn.',
                  higher: 'Bludgeoning damage increases by 1d10 for each slot level above 4th.' },
                { id: 'polymorph', name: 'Polymorph', school: 'Transmutation', conc: true, ritual: false, time: 'Action', range: '60 ft', dur: 'Conc, 1 hour', comp: 'V, S, M (a caterpillar cocoon)',
                  desc: 'You attempt to transform a creature that you can see within range into a Beast. The target must succeed on a Wisdom saving throw or shape-shift into Beast form for the duration. That form can be any Beast you choose that has a Challenge Rating equal to or less than the target\'s (or the target\'s level if it doesn\'t have a Challenge Rating). An unwilling target automatically succeeds if it is missing any limbs or incapacitated.' },
                { id: 'stone-shape', name: 'Stone Shape', school: 'Transmutation', conc: false, ritual: false, time: 'Action', range: 'Touch', dur: 'Instant', comp: 'V, S, M (soft clay)',
                  desc: 'You touch a stone object of Medium size or smaller or a section of stone no more than 5 feet in any dimension and form it into any shape you like. For example, you could shape a large rock into a weapon, idol, or coffer, or make a small passage through a wall, as long as the wall is less than 5 feet thick.' },
                { id: 'wall-of-fire', name: 'Wall of Fire', school: 'Evocation', conc: true, ritual: false, time: 'Action', range: '120 ft', dur: 'Conc, 1 min', comp: 'V, S, M (a small piece of phosphorus)',
                  desc: 'You create a wall of fire on a solid surface within range. You can make the wall up to 60 feet long, 20 feet high, and 1 foot thick, or a ringed wall up to 20 feet in diameter, 20 feet high, and 1 foot thick. One side of the wall deals 5d8 Fire damage to each creature that ends its turn within 10 feet of that side. A creature also takes that damage when it enters the wall\'s space for the first time on a turn or ends its turn there.',
                  higher: 'Damage increases by 1d8 for each slot level above 4th.' },
                { id: 'blight', name: 'Blight', school: 'Necromancy', conc: false, ritual: false, time: 'Action', range: '30 ft', dur: 'Instant', comp: 'V, S',
                  desc: 'Necromantic energy washes over a creature of your choice that you can see within range, draining moisture and vitality from it. The target must make a Constitution saving throw. The target takes 8d8 Necrotic damage on a failed save, or half as much damage on a successful one. This spell has no effect on Constructs or Undead. If you target a Plant creature or a magical plant, it makes the saving throw with Disadvantage, and the spell deals maximum damage to it.',
                  higher: 'Damage increases by 1d8 for each slot level above 4th.' },
                { id: 'control-water', name: 'Control Water', school: 'Transmutation', conc: true, ritual: false, time: 'Action', range: '300 ft', dur: 'Conc, 10 min', comp: 'V, S, M (a drop of water and a pinch of dust)',
                  desc: 'Until the spell ends, you control any water inside an area you choose that is a Cube up to 100 feet on a side. Choose one of the following effects when you cast this spell. As a Magic action on your later turns, you can repeat the same effect or choose a different one: Flood, Part Water, Redirect Flow, or Whirlpool.' },
                { id: 'divination', name: 'Divination', school: 'Divination', conc: false, ritual: true, time: 'Action', range: 'Self', dur: 'Instant', comp: 'V, S, M (incense worth 25+ GP, which the spell consumes)',
                  desc: 'This spell puts you in contact with a god or a god\'s servants. You ask one question about a specific goal, event, or activity to occur within 7 days. The DM offers a truthful reply, which might be a short phrase, a cryptic rhyme, or an omen.' },
                { id: 'fire-shield', name: 'Fire Shield', school: 'Evocation', conc: false, ritual: false, time: 'Action', range: 'Self', dur: '10 min', comp: 'V, S, M (a bit of phosphorus or a firefly)',
                  desc: 'Flames wreathe your body for the duration, shedding Bright Light in a 10-foot radius and Dim Light for an additional 10 feet. Choose Warm Shield or Chill Shield. Warm Shield grants Resistance to Cold damage. When hit by melee attack within 5 ft, attacker takes 2d8 Fire damage. Chill Shield grants Resistance to Fire damage, and attacker takes 2d8 Cold damage instead.' },
                { id: 'giant-insect', name: 'Giant Insect', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '30 ft', dur: 'Conc, 10 min', comp: 'V, S',
                  desc: 'You summon a giant centipede, spider, wasp, or scorpion in an unoccupied space within range. The creature uses Giant Insect stat block and acts on your initiative. It obeys your verbal commands. The creature disappears when it drops to 0 HP or when the spell ends.',
                  higher: 'Summon one additional insect for each slot level above 4th.' },
                { id: 'grasping-vine', name: 'Grasping Vine', school: 'Conjuration', conc: true, ritual: false, time: 'Bonus Action', range: '60 ft', dur: 'Conc, 1 min', comp: 'V, S',
                  desc: 'You conjure a vine that sprouts from a surface in an unoccupied space within range. When you cast this spell, you can direct the vine to lash out at a creature within 30 feet of it that you can see. That creature must succeed on a Dexterity saving throw or be pulled up to 30 feet directly toward the vine. Until the spell ends, you can take a Bonus Action to direct the vine to lash out at the same or a different creature.' },
                { id: 'locate-creature', name: 'Locate Creature', school: 'Divination', conc: true, ritual: false, time: 'Action', range: 'Self', dur: 'Conc, 1 hour', comp: 'V, S, M (fur from a bloodhound)',
                  desc: 'Describe or name a creature that is familiar to you. You sense the direction to the creature\'s location, if it is within 1,000 feet. If moving, you know the direction of movement. The spell can locate a specific creature known to you, or the nearest creature of a specific kind if you\'ve seen such a creature up close within 30 feet. A creature is blocked from this spell if running water at least 10 feet wide separates you.' },
                { id: 'summon-elemental', name: 'Summon Elemental', school: 'Conjuration', conc: true, ritual: false, time: 'Action', range: '90 ft', dur: 'Conc, 1 hour', comp: 'V, S, M (air, a pebble, ash, and water inside a gold-inlaid vial worth 400+ GP)',
                  desc: 'You call forth an elemental spirit. It manifests in an unoccupied space that you can see within range and uses the Elemental Spirit stat block. When you cast the spell, choose an element: Air, Earth, Fire, or Water. The creature gains certain traits based on element. The creature disappears when it drops to 0 HP or when the spell ends.',
                  higher: 'Use the spell slot\'s level for the spell\'s level in the stat block.' }
            ]
        };

        // ALL available beast forms (no flying, up to CR 1/2 at level 5)
        const ALL_BEAST_FORMS = [
            // CR 0 - Utility/Scouting
            { id: 'cat', name: 'Cat', cr: '0', ac: 12, hp: 2, speed: '40 ft, climb 30 ft', str: 3, dex: 15, con: 10, attacks: 'Claws: +0 to hit, 1 slashing', senses: 'Darkvision 60 ft', special: 'Keen Smell: Advantage on Perception (smell)' },
            { id: 'rat', name: 'Rat', cr: '0', ac: 10, hp: 1, speed: '20 ft', str: 2, dex: 11, con: 9, attacks: 'Bite: +0 to hit, 1 piercing', senses: 'Darkvision 30 ft', special: 'Keen Smell, Tiny size for infiltration' },
            { id: 'spider', name: 'Spider', cr: '0', ac: 12, hp: 1, speed: '20 ft, climb 20 ft', str: 2, dex: 14, con: 8, attacks: 'Bite: +4 to hit, 1 piercing + DC 9 Con or 1d4 poison', senses: 'Darkvision 30 ft', special: 'Spider Climb, Web Sense, Web Walker' },
            { id: 'frog', name: 'Frog', cr: '0', ac: 11, hp: 1, speed: '20 ft, swim 20 ft', str: 1, dex: 13, con: 8, attacks: 'None (Tiny)', senses: 'Darkvision 30 ft', special: 'Amphibious, Standing Leap (10ft/20ft)' },
            { id: 'lizard', name: 'Lizard', cr: '0', ac: 10, hp: 2, speed: '20 ft, climb 20 ft', str: 2, dex: 11, con: 10, attacks: 'Bite: +0 to hit, 1 piercing', senses: 'Darkvision 30 ft', special: 'Climbing, small size for scouting' },
            { id: 'badger', name: 'Badger', cr: '0', ac: 10, hp: 3, speed: '20 ft, burrow 5 ft', str: 4, dex: 11, con: 12, attacks: 'Bite: +2 to hit, 1 piercing', senses: 'Darkvision 30 ft', special: 'Keen Smell, Burrow' },
            { id: 'crab', name: 'Crab', cr: '0', ac: 11, hp: 2, speed: '20 ft, swim 20 ft', str: 2, dex: 11, con: 10, attacks: 'Claw: +0 to hit, 1 bludgeoning', senses: 'Blindsight 30 ft', special: 'Amphibious, Blindsight' },
            // CR 1/4 - Combat capable
            { id: 'wolf', name: 'Wolf', cr: '1/4', ac: 13, hp: 11, speed: '40 ft', str: 12, dex: 15, con: 12, attacks: 'Bite: +4 to hit, 2d4+2 piercing, DC 11 Str or prone', senses: 'Passive Perception 13', special: 'Keen Hearing/Smell, Pack Tactics' },
            { id: 'panther', name: 'Panther', cr: '1/4', ac: 12, hp: 13, speed: '50 ft, climb 40 ft', str: 14, dex: 15, con: 10, attacks: 'Bite +4 (1d6+2) or Claw +4 (1d4+2)', senses: 'Passive Perception 14', special: 'Keen Smell, Pounce (20ft charge = bonus claw + prone DC 12)' },
            { id: 'boar', name: 'Boar', cr: '1/4', ac: 11, hp: 11, speed: '40 ft', str: 13, dex: 11, con: 12, attacks: 'Tusk: +3 to hit, 1d6+1 slashing', senses: 'Passive Perception 9', special: 'Charge (+1d6 dmg), Relentless (1/day drop to 1 HP instead of 0)' },
            { id: 'giant-badger', name: 'Giant Badger', cr: '1/4', ac: 10, hp: 13, speed: '30 ft, burrow 10 ft', str: 13, dex: 10, con: 15, attacks: 'Multiattack: Bite +3 (1d6+1) + Claws +3 (2d4+1)', senses: 'Darkvision 30 ft', special: 'Keen Smell, Burrow, Multiattack' },
            { id: 'giant-frog', name: 'Giant Frog', cr: '1/4', ac: 11, hp: 18, speed: '30 ft, swim 30 ft', str: 12, dex: 13, con: 11, attacks: 'Bite: +3 to hit, 1d6+1 + grapple (DC 11)', senses: 'Darkvision 30 ft', special: 'Amphibious, Standing Leap (20ft/40ft), Swallow Small creatures' },
            { id: 'giant-wolf-spider', name: 'Giant Wolf Spider', cr: '1/4', ac: 13, hp: 11, speed: '40 ft, climb 40 ft', str: 12, dex: 16, con: 13, attacks: 'Bite: +3 to hit, 1d6+1 + DC 11 Con or 2d6 poison', senses: 'Blindsight 10 ft, Darkvision 60 ft', special: 'Spider Climb, Web Sense, Web Walker' },
            { id: 'giant-centipede', name: 'Giant Centipede', cr: '1/4', ac: 13, hp: 4, speed: '30 ft, climb 30 ft', str: 5, dex: 14, con: 12, attacks: 'Bite: +4 to hit, 1d4+2 + DC 11 Con or 3d6 poison', senses: 'Blindsight 30 ft', special: 'High poison damage on failed save' },
            { id: 'giant-crab', name: 'Giant Crab', cr: '1/8', ac: 15, hp: 13, speed: '30 ft, swim 30 ft', str: 13, dex: 15, con: 11, attacks: 'Claw: +3 to hit, 1d6+1 + grapple (DC 11)', senses: 'Blindsight 30 ft', special: 'Amphibious, Blindsight, High AC, Grapple' },
            // CR 1/2 - Strong combat forms
            { id: 'black-bear', name: 'Black Bear', cr: '1/2', ac: 11, hp: 19, speed: '40 ft, climb 30 ft', str: 15, dex: 10, con: 14, attacks: 'Multiattack: Bite +4 (1d6+2) + Claws +4 (2d4+2)', senses: 'Passive Perception 13', special: 'Keen Smell, Multiattack, Good HP' },
            { id: 'ape', name: 'Ape', cr: '1/2', ac: 12, hp: 19, speed: '30 ft, climb 30 ft', str: 16, dex: 14, con: 14, attacks: 'Multiattack: 2x Fist +5 (1d6+3) or Rock +5 (1d6+3, 25/50 ft)', senses: 'Passive Perception 12', special: 'Multiattack, Ranged rock attack, +3 STR' },
            { id: 'crocodile', name: 'Crocodile', cr: '1/2', ac: 12, hp: 19, speed: '20 ft, swim 30 ft', str: 15, dex: 10, con: 13, attacks: 'Bite: +4 to hit, 1d10+2 + grapple (DC 12) + restrain', senses: 'Passive Perception 10', special: 'Hold Breath 15 min, Grapple + Restrain' },
            { id: 'giant-goat', name: 'Giant Goat', cr: '1/2', ac: 11, hp: 19, speed: '40 ft', str: 17, dex: 11, con: 12, attacks: 'Ram: +5 to hit, 2d4+3', senses: 'Passive Perception 11', special: 'Charge (+2d4 + prone DC 13), Sure-Footed (adv vs prone)' },
            { id: 'warhorse', name: 'Warhorse', cr: '1/2', ac: 11, hp: 19, speed: '60 ft', str: 18, dex: 12, con: 13, attacks: 'Hooves: +6 to hit, 2d6+4', senses: 'Passive Perception 11', special: 'Trampling Charge (20ft = prone DC 14 + bonus hooves), 60ft speed!' }
        ];

        // Default known forms (max 6 at level 5)
        const DEFAULT_KNOWN_FORMS = ['cat', 'wolf', 'panther', 'giant-wolf-spider', 'black-bear', 'ape'];

        // Helper to get known beast forms
        function getKnownBeastForms() {
            const knownIds = state.knownBeastForms || DEFAULT_KNOWN_FORMS;
            return ALL_BEAST_FORMS.filter(b => knownIds.includes(b.id));
        }

        // For compatibility with existing code
        const BEAST_FORMS = ALL_BEAST_FORMS;

        // ===== RENDER FUNCTIONS =====
        function renderCantrips() {
            const grid = document.getElementById('cantripGrid');
            if (!grid || !CANTRIPS) return;
            grid.innerHTML = CANTRIPS.map(c => `
                <div class="cantrip-card" onclick="this.classList.toggle('expanded')" style="cursor: pointer;">
                    <div class="cantrip-card-name">${c.name}</div>
                    <div class="cantrip-card-source">${c.source}</div>
                    <div style="font-size: 0.8em; color: var(--accent-purple); margin-bottom: 5px;">
                        ${c.school || ''} | ${c.time || 'Action'} | ${c.range || 'Touch'} | ${c.dur || 'Instant'}
                    </div>
                    <div style="font-size: 0.75em; color: var(--text-muted); margin-bottom: 8px;">
                        Components: ${c.comp || 'V, S'}
                    </div>
                    <div class="cantrip-card-desc">${c.desc}</div>
                </div>
            `).join('');
        }

        function renderSpells() {
            if (!SPELLS) return;
            const maxLevel = getMaxSpellLevel();

            // Show/hide 4th level card based on level
            const spells4Card = document.getElementById('spells4Card');
            if (spells4Card) {
                spells4Card.style.display = maxLevel >= 4 ? '' : 'none';
            }

            for (let level = 1; level <= maxLevel; level++) {
                const container = document.getElementById('spells' + level);
                if (!container || !SPELLS[level]) continue;
                container.innerHTML = SPELLS[level].map(s => `
                    <div class="spell-card ${s.always ? 'always' : ''} ${state.preparedSpells.some(p => p.id === s.id) ? 'prepared' : ''}"
                         data-spell-id="${s.id}" onclick="toggleSpellExpand(this)">
                        <div class="spell-card-header">
                            <div class="spell-card-name">
                                ${!s.always ? `<input type="checkbox" class="spell-checkbox" ${state.preparedSpells.some(p => p.id === s.id) ? 'checked' : ''} onclick="toggleSpellPrepared(event, '${s.id}', '${s.name}', ${level})">` : ''}
                                ${s.name}
                            </div>
                            <div class="spell-card-tags">
                                ${s.conc ? '<span class="spell-tag conc">C</span>' : ''}
                                ${s.ritual ? '<span class="spell-tag ritual">R</span>' : ''}
                            </div>
                        </div>
                        <div class="spell-card-meta">
                            <span style="color: var(--accent-purple);">${s.school || ''}</span> |
                            ${s.time} | ${s.range} | ${s.dur}
                        </div>
                        <div class="spell-card-meta" style="font-size: 0.85em; color: var(--text-muted);">
                            Components: ${s.comp || 'V, S'}
                        </div>
                        <div class="spell-card-desc">
                            <p>${s.desc}</p>
                            ${s.higher ? `<p style="margin-top: 10px; padding-top: 8px; border-top: 1px solid var(--border-color); color: var(--accent-gold);"><strong>At Higher Levels:</strong> ${s.higher}</p>` : ''}
                            ${s.note ? `<p style="margin-top: 8px; color: var(--accent-green);"><strong>${s.note}</strong></p>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            updateSpellCount();
        }

        function renderBeasts() {
            const container = document.getElementById('beastForms');
            const knownIds = state.knownBeastForms || DEFAULT_KNOWN_FORMS;
            const knownCount = knownIds.length;

            // Group by CR
            const crGroups = { '0': [], '1/8': [], '1/4': [], '1/2': [] };
            ALL_BEAST_FORMS.forEach(b => {
                if (crGroups[b.cr]) crGroups[b.cr].push(b);
                else crGroups['1/4'].push(b); // fallback
            });

            let html = `<div class="prepared-counter-display mb-10">
                Known Forms: <span class="prepared-count-value ${knownCount > 6 ? 'over' : ''}">${knownCount}</span> / 6
            </div>`;

            Object.entries(crGroups).forEach(([cr, beasts]) => {
                if (beasts.length === 0) return;
                html += `<h3 style="color: var(--accent-gold); margin: 15px 0 10px; font-size: 1em;">CR ${cr}</h3>`;
                html += '<div class="spell-list">';
                beasts.forEach(b => {
                    const isKnown = knownIds.includes(b.id);
                    html += `
                        <div class="spell-card ${isKnown ? 'prepared' : ''}" data-beast-id="${b.id}" onclick="toggleBeastExpand(this)">
                            <div class="spell-card-header">
                                <div class="spell-card-name">
                                    <input type="checkbox" class="spell-checkbox" ${isKnown ? 'checked' : ''}
                                        onclick="toggleBeastKnown(event, '${b.id}')">
                                    ${b.name}
                                </div>
                                <div class="spell-card-tags">
                                    <span class="spell-tag" style="background: rgba(80, 200, 120, 0.3); color: var(--accent-green);">CR ${b.cr}</span>
                                </div>
                            </div>
                            <div class="spell-card-meta">AC ${b.ac} | HP ${b.hp} | ${b.speed}</div>
                            <div class="spell-card-desc">
                                <p><strong>Attacks:</strong> ${b.attacks}</p>
                                <p><strong>Senses:</strong> ${b.senses}</p>
                                <p><strong>Special:</strong> ${b.special}</p>
                                <p><strong>Stats:</strong> STR ${b.str} (${formatScoreAsMod(b.str)}) | DEX ${b.dex} (${formatScoreAsMod(b.dex)}) | CON ${b.con} (${formatScoreAsMod(b.con)})</p>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            });

            container.innerHTML = html;
        }

        function formatScoreAsMod(score) {
            const mod = Math.floor((score - 10) / 2);
            return mod >= 0 ? '+' + mod : '' + mod;
        }

        function toggleBeastExpand(el) {
            if (event.target.classList.contains('spell-checkbox')) return;
            el.classList.toggle('expanded');
        }

        function toggleBeastKnown(event, beastId) {
            event.stopPropagation();
            saveForUndo();

            if (!state.knownBeastForms) {
                state.knownBeastForms = [...DEFAULT_KNOWN_FORMS];
            }

            const index = state.knownBeastForms.indexOf(beastId);
            if (index > -1) {
                // Remove from known
                state.knownBeastForms.splice(index, 1);
            } else {
                // Add to known (max 6)
                if (state.knownBeastForms.length >= 6) {
                    alert('Maximum 6 beast forms known at level 5! Uncheck one first.');
                    event.target.checked = false;
                    return;
                }
                state.knownBeastForms.push(beastId);
            }

            renderBeasts();
            saveState();
        }

        function toggleSpellSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + 'Toggle');
            if (section.style.display === 'none') {
                section.style.display = 'flex';
                if (toggle) toggle.textContent = '‚ñº';
            } else {
                section.style.display = 'none';
                if (toggle) toggle.textContent = '‚ñ∂';
            }
        }

        // Collapsible card system
        function toggleCard(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const content = card.querySelector('.card-content');
            const toggle = card.querySelector('.collapse-toggle');

            if (!content) return;

            const isCollapsed = content.classList.contains('collapsed');

            if (isCollapsed) {
                content.classList.remove('collapsed');
                card.classList.remove('collapsed');
                if (toggle) toggle.textContent = '‚ñº';
            } else {
                content.classList.add('collapsed');
                card.classList.add('collapsed');
                if (toggle) toggle.textContent = '‚ñ∂';
            }

            // Save collapse state
            saveCardCollapseState(cardId, !isCollapsed);
        }

        function saveCardCollapseState(cardId, collapsed) {
            let collapseStates = JSON.parse(localStorage.getItem('ashvael-collapse') || '{}');
            collapseStates[cardId] = collapsed;
            localStorage.setItem('ashvael-collapse', JSON.stringify(collapseStates));
        }

        function loadCardCollapseStates() {
            const collapseStates = JSON.parse(localStorage.getItem('ashvael-collapse') || '{}');
            Object.keys(collapseStates).forEach(cardId => {
                if (collapseStates[cardId]) {
                    const card = document.getElementById(cardId);
                    if (card) {
                        const content = card.querySelector('.card-content');
                        const toggle = card.querySelector('.collapse-toggle');
                        if (content) {
                            content.classList.add('collapsed');
                            card.classList.add('collapsed');
                            if (toggle) toggle.textContent = '‚ñ∂';
                        }
                    }
                }
            });
        }

        function toggleSpellExpand(el) {
            if (event.target.classList.contains('spell-checkbox')) return;
            el.classList.toggle('expanded');
        }

        function toggleSpellPrepared(event, spellId, spellName, level) {
            event.stopPropagation();
            saveForUndo();

            const index = state.preparedSpells.findIndex(s => s.id === spellId);
            if (index > -1) {
                state.preparedSpells.splice(index, 1);
            } else {
                const maxPrep = getMaxPreparedSpells();
                if (state.preparedSpells.length >= maxPrep) {
                    alert(`Maximum ${maxPrep} spells prepared!`);
                    event.target.checked = false;
                    return;
                }
                state.preparedSpells.push({ id: spellId, name: spellName, level });
            }

            renderSpells();
            updatePreparedDisplay();
            updateAbsorbElementsButton();
            saveState();
        }

        function updateSpellCount() {
            const count = state.preparedSpells.length;
            const maxPrep = getMaxPreparedSpells();
            document.getElementById('spellPreparedCount').textContent = count;
            document.getElementById('spellPreparedCount').className = 'prepared-count-value' + (count > maxPrep ? ' over' : '');
            // Also update the max display
            const maxEl = document.getElementById('spellPreparedMax');
            if (maxEl) maxEl.textContent = maxPrep;
        }

        function showBeastInfo(beastId) {
            const b = BEAST_FORMS.find(x => x.id === beastId);
            if (!b) return;
            showModal(b.name, `
                <p><strong>CR:</strong> ${b.cr}</p>
                <p><strong>AC:</strong> ${b.ac}</p>
                <p><strong>HP:</strong> ${b.hp}</p>
                <p><strong>Speed:</strong> ${b.speed}</p>
                <p><strong>Attacks:</strong> ${b.attacks}</p>
                <p><strong>Senses:</strong> ${b.senses}</p>
            `);
        }

        // ===== FEATURES =====
        const FEATURES = {
            background: [
                {
                    name: 'Guide Background',
                    source: 'Background',
                    desc: '<strong>You know the wilderness like the back of your hand.</strong> Years of guiding travelers through treacherous terrain have honed your senses and survival skills.<br><br><strong style="color: var(--accent-gold);">Ability Scores:</strong> +2 Wisdom, +1 Constitution (applied to your stats)<br><br><strong style="color: var(--accent-blue);">Skill Proficiencies:</strong> <strong>Stealth</strong>, <strong>Survival</strong><br><br><strong style="color: var(--accent-purple);">Tool Proficiency:</strong> Cartographer\'s Tools<br><br><strong style="color: var(--accent-green);">Feat:</strong> Magic Initiate (Druid) - See Feats section<br><br><strong>Starting Equipment:</strong> Bedroll, Tent, Tinderbox, Traveler\'s Clothes, Waterskin, 50 ft Hempen Rope, Quiver with 20 Arrows, Cartographer\'s Tools, 3 GP'
                }
            ],
            ancestry: [
                {
                    name: 'Half-Aasimar/Half-Tiefling Heritage',
                    source: 'Species',
                    desc: '<strong>Creature Type:</strong> Humanoid<br><strong>Size:</strong> Medium (4-7 feet tall)<br><strong>Speed:</strong> 30 feet<br><br>You are the rare offspring of both celestial and fiendish bloodlines, bearing traits from both Aasimar and Tiefling heritage. Your unique lineage grants you abilities from both sides.'
                },
                {
                    name: 'Celestial Resistance',
                    source: 'Species Trait',
                    desc: 'You have <strong>resistance to Necrotic damage</strong> (from Aasimar) and <strong>resistance to Radiant damage</strong> (from Tiefling adaptation). When you take these damage types, you only take half damage (rounded down).',
                    detail: 'This resistance stacks with temporary sources like Absorb Elements.'
                },
                {
                    name: 'Darkvision',
                    source: 'Species Trait',
                    desc: 'You can see in dim light within <strong>60 feet</strong> of yourself as if it were bright light, and in darkness as if it were dim light. You discern colors in that darkness only as shades of gray.',
                    detail: 'Does not see through magical darkness.'
                },
                {
                    name: 'Healing Hands',
                    source: 'Species Trait (1/Long Rest)',
                    desc: '<strong>Action</strong> | Touch | 1 use per Long Rest<br><br>You touch a creature and roll a number of d4s equal to your Proficiency Bonus (<strong>3d4</strong> at level 5). The creature regains Hit Points equal to the total rolled.<br><br>Average healing: 7.5 HP',
                    detail: 'Healing dice scale with proficiency bonus. At level 5: 3d4.'
                },
                {
                    name: 'Celestial Revelation',
                    source: 'Species Trait (Level 3+, 1/Long Rest)',
                    desc: '<strong>Bonus Action</strong> | 1 Minute | Once per Long Rest<br><br>Unveil your supernatural nature. Choose one option each time:<br><br><strong style="color: var(--accent-gold);">‚òÄÔ∏è Radiant Soul:</strong> Spectral wings grant Fly Speed 30 ft. Once per turn, add +3 to Radiant or Necrotic damage.<br><br><strong style="color: var(--accent-purple);">üåë Necrotic Shroud:</strong> Creatures within 10 ft make CHA save (DC 13) or are Frightened. Once per turn, add +3 to Radiant or Necrotic damage.<br><br><strong style="color: var(--accent-orange);">‚ú® Inner Radiance:</strong> Shed Bright Light 10 ft, Dim 10 more. End of your turn: creatures within 10 ft take 3 Radiant damage.',
                    hasChoices: true,
                    choices: ['Radiant Soul (Fly)', 'Necrotic Shroud (Fear)', 'Inner Radiance (Aura)']
                }
            ],
            druid: [
                {
                    name: 'Druid Class Features',
                    source: 'Class Overview',
                    desc: '<strong>Hit Dice:</strong> 1d8 per level (5d8 total)<br><strong>Hit Points:</strong> 38 (8 + 4√óCON mod + 4√óaverage roll)<br><br><strong style="color: var(--accent-gold);">Saving Throw Proficiencies:</strong><br>‚Ä¢ <strong>Intelligence</strong> (+2)<br>‚Ä¢ <strong>Wisdom</strong> (+7)<br><br><strong style="color: var(--accent-blue);">Skill Proficiencies (chose 2):</strong><br>‚Ä¢ <strong>Perception</strong> (chosen)<br>‚Ä¢ <strong>Nature</strong> (chosen)<br>‚Ä¢ Other options: Arcana, Animal Handling, Insight, Medicine, Religion, Survival<br><br><strong style="color: var(--accent-purple);">Armor Proficiencies:</strong> Light Armor, Shields only (NO medium armor - requires Warden subclass)<br><br><strong style="color: var(--accent-green);">Weapon Proficiencies:</strong> Simple Weapons<br><br><strong style="color: var(--text-muted);">Tool Proficiencies:</strong> Herbalism Kit'
                },
                {
                    name: 'Spellcasting',
                    source: 'Level 1',
                    desc: '<strong>Spell Slots (Level 5):</strong> 4 √ó 1st, 3 √ó 2nd, 2 √ó 3rd<br><strong>Spellcasting Ability:</strong> Wisdom<br><strong>Spell Save DC:</strong> 15 (8 + 3 + 4)<br><strong>Spell Attack Bonus:</strong> +7 (3 + 4)<br><br><strong style="color: var(--accent-gold);">Cantrips Known:</strong> 3 (Druid) + 1 (Magician) + 1 (Star Map) + 2 (Magic Initiate) = 7 total<br><br><strong style="color: var(--accent-blue);">Prepared Spells:</strong> 9 (Druid level + WIS mod)<br><br><strong style="color: var(--accent-purple);">Ritual Casting:</strong> You can cast any spell with the Ritual tag as a ritual (adds 10 minutes to casting time, doesn\'t use a spell slot).<br><br><strong style="color: var(--accent-green);">Spellcasting Focus:</strong> Druidic Focus (Star Map)'
                },
                {
                    name: 'Primal Order: Magician',
                    source: 'Level 1 Choice',
                    desc: '<strong style="color: var(--accent-gold);">Chosen at Level 1</strong><br><br>You know one extra cantrip from the Druid spell list: <strong>Message</strong><br><br>Your mystical connection to nature gives you a bonus to <strong>Intelligence (Arcana)</strong> and <strong>Intelligence (Nature)</strong> checks equal to your Wisdom modifier: <strong>+4</strong>',
                    detail: 'Alternative: Warden (martial weapons, medium armor proficiency)',
                    hasChoices: true,
                    choices: ['<strong>Magician (Chosen)</strong>', 'Warden']
                },
                {
                    name: 'Druidic',
                    source: 'Level 1',
                    desc: 'You know <strong>Druidic</strong>, the secret language of druids. You can speak the language and use it to leave hidden messages that only druids can automatically spot.<br><br>Others can spot the message with a DC 15 Intelligence (Investigation) check but cannot decipher it without magic.'
                },
                {
                    name: 'Wild Shape',
                    source: 'Level 2 (2/Short Rest)',
                    desc: '<strong>Bonus Action</strong> | 2 Hours Duration | 2 Uses per Short Rest<br><br>Transform into any Beast you have seen.<br><br><strong style="color: var(--accent-green);">Level 5 Limits:</strong><br>‚Ä¢ Max CR: 1/2<br>‚Ä¢ No Flying Speed yet<br>‚Ä¢ Must have seen the beast<br><br><strong>While Transformed:</strong><br>‚Ä¢ Gain <strong>5 Temporary HP</strong> (= Druid level)<br>‚Ä¢ Use beast\'s STR, DEX, CON<br>‚Ä¢ Keep your INT, WIS, CHA, proficiencies, features<br>‚Ä¢ <strong>Cannot cast spells</strong> (can maintain concentration)<br>‚Ä¢ Revert when temp HP drops to 0'
                },
                {
                    name: 'Wild Companion',
                    source: 'Level 2',
                    desc: '<strong>Action</strong> | Costs: Spell Slot OR Wild Shape use<br><br>Cast <strong>Find Familiar</strong> without material components. The familiar is a <strong>Fey</strong> creature and disappears after your next Long Rest.<br><br><strong>Familiar Benefits:</strong><br>‚Ä¢ Telepathic link within 100 ft<br>‚Ä¢ See through its eyes (Action)<br>‚Ä¢ Deliver your touch spells<br>‚Ä¢ Take Help action in combat<br>‚Ä¢ Cannot attack'
                },
                {
                    name: 'Wild Resurgence',
                    source: 'Level 5',
                    desc: '<strong>No Action Required</strong> | Once per Turn<br><br>If you have no Wild Shape uses remaining, you can expend a <strong>spell slot</strong> to regain one use.<br><br>This ensures you can always access Wild Shape or Starry Form as long as you have spell slots!'
                },
                {
                    name: '4th Level Spell Slots',
                    source: 'Level 7',
                    levelReq: 7,
                    desc: '<strong>New Spell Level Unlocked!</strong><br><br>You now have access to <strong>4th level spells</strong>. At level 7, you gain <strong>1 √ó 4th level slot</strong>.<br><br><strong style="color: var(--accent-purple);">New Spells Available:</strong><br>‚Ä¢ Conjure Minor Elementals<br>‚Ä¢ Conjure Woodland Beings<br>‚Ä¢ Freedom of Movement<br>‚Ä¢ Ice Storm<br>‚Ä¢ Polymorph<br>‚Ä¢ Stone Shape<br>‚Ä¢ Wall of Fire<br><br><strong style="color: var(--accent-gold);">Prepared Spells:</strong> 11 max (Druid level + WIS mod)'
                },
                {
                    name: 'Wild Shape Improvement',
                    source: 'Level 8',
                    levelReq: 8,
                    desc: '<strong>Flying Forms Unlocked!</strong><br><br>You can now Wild Shape into beasts that have a <strong>flying speed</strong>. This opens up new tactical options:<br><br><strong style="color: var(--accent-blue);">New Beast Forms Available:</strong><br>‚Ä¢ Giant Eagle (CR 1, Fly 80 ft)<br>‚Ä¢ Giant Owl (CR 1/4, Fly 60 ft)<br>‚Ä¢ Giant Vulture (CR 1, Fly 60 ft)<br>‚Ä¢ Blood Hawk (CR 1/8, Fly 60 ft)<br><br><strong style="color: var(--accent-gold);">Remember:</strong> Max CR is still 1/2, but flying speed is now allowed!'
                },
                {
                    name: 'Ability Score Improvement',
                    source: 'Level 8',
                    levelReq: 8,
                    desc: '<strong>Level 8 ASI</strong><br><br>At 8th level, you gain an Ability Score Improvement. You can choose one of:<br><br><strong style="color: var(--accent-gold);">Option 1 - Ability Scores:</strong><br>Increase one ability score by 2, or increase two ability scores by 1 each. Maximum score is 20.<br><br><strong style="color: var(--accent-purple);">Option 2 - Feat:</strong><br>If your DM allows feats, you can take a feat instead of the ability score increase.<br><br><strong style="color: var(--text-muted);">Note:</strong> You already took War Caster at level 4. Consider +2 WIS to increase Spell Save DC and healing, or another utility feat.'
                }
            ],
            stars: [
                {
                    name: 'Circle of Stars Overview',
                    source: 'Subclass (Level 2)',
                    desc: 'You have looked to the stars and their endless patterns for guidance. By harnessing the magic of starlight, you gain abilities that blend divination with celestial power.<br><br><strong>Subclass Features:</strong><br>‚Ä¢ Level 2: Star Map, Starry Form<br>‚Ä¢ Level 6: Cosmic Omen<br>‚Ä¢ Level 10: Twinkling Constellations<br>‚Ä¢ Level 14: Full of Stars'
                },
                {
                    name: 'Star Map',
                    source: 'Circle of Stars Level 2',
                    desc: '<strong>Spellcasting Focus</strong><br><br>Your star chart is your connection to the cosmos. While holding it:<br><br><strong style="color: var(--accent-gold);">Guiding Bolt:</strong> Always prepared, doesn\'t count against your limit.<br><br><strong style="color: var(--accent-blue);">Free Casts:</strong> Cast Guiding Bolt <strong>4 times</strong> without a spell slot (WIS mod uses per Long Rest).<br><br><strong>Guiding Bolt:</strong> 4d6 radiant damage, next attack vs target has Advantage!'
                },
                {
                    name: 'Starry Form',
                    source: 'Circle of Stars Level 2',
                    desc: '<strong>Bonus Action</strong> | Uses Wild Shape | 10 Minutes<br><br>Take on a starry form instead of becoming a beast. You shed dim light 10 ft. Choose one constellation:<br><br><strong style="color: var(--accent-gold);">‚≠ê Archer:</strong><br>Bonus Action: Ranged spell attack, 60 ft, <strong>1d8+4 radiant</strong> damage. Can attack when you activate and each subsequent turn.<br><br><strong style="color: var(--accent-blue);">üèÜ Chalice:</strong><br>When you cast a healing spell using a slot, you OR another creature within 30 ft regains <strong>1d8+4 additional HP</strong>.<br><br><strong style="color: var(--accent-purple);">üêâ Dragon:</strong><br>Treat rolls of 9 or lower as 10 on Intelligence checks, Wisdom checks, and <strong>Concentration saves</strong>. Minimum roll is 10!',
                    hasChoices: true,
                    choices: ['Archer (Bonus Action attack)', 'Chalice (Healing boost)', 'Dragon (Minimum 10 on checks)']
                },
                {
                    name: 'Cosmic Omen',
                    source: 'Circle of Stars Level 6',
                    levelReq: 6,
                    desc: '<strong>Reaction</strong> | 30 feet | 3 Uses per Long Rest (Proficiency Bonus)<br><br>After each Long Rest, <strong>choose</strong> your omen for the day:<br><br><strong style="color: var(--accent-gold);">‚òÄÔ∏è Weal (Good Omen):</strong><br>When a creature you can see within 30 feet makes an attack roll, saving throw, or ability check, you can use your Reaction to <strong>add 1d6</strong> to the roll.<br><br><strong style="color: var(--accent-purple);">üåë Woe (Bad Omen):</strong><br>When a creature you can see within 30 feet makes an attack roll, saving throw, or ability check, you can use your Reaction to <strong>subtract 1d6</strong> from the roll.<br><br><strong style="color: var(--text-muted);">Uses:</strong> Equal to your proficiency bonus (3/long rest at level 6).<br><br><strong>Note:</strong> Your chosen omen appears in the Reactions menu during battle.',
                    hasChoices: true,
                    choices: ['Weal (add 1d6 to ally)', 'Woe (subtract 1d6 from enemy)']
                }
            ],
            feats: [
                {
                    name: 'Magic Initiate: Druid',
                    source: 'Guide Background (Level 1)',
                    desc: '<strong>Origin Feat from Guide Background</strong><br><br><strong style="color: var(--accent-gold);">Two Cantrips:</strong><br>‚Ä¢ <strong>Produce Flame</strong> - Bonus Action light, or hurl for 2d8 fire (60 ft)<br>‚Ä¢ <strong>Mending</strong> - Repair small breaks/tears in objects<br><br><strong style="color: var(--accent-purple);">1st-Level Spell (Always Prepared):</strong><br>‚Ä¢ <strong>Healing Word</strong> - 60 ft, Bonus Action, 2d4+4 healing<br>‚Ä¢ Can cast <strong>1/day free</strong>, or use spell slots'
                },
                {
                    name: 'War Caster',
                    source: 'Level 4 ASI/Feat',
                    desc: '<strong>Taken at Level 4 instead of +2 Ability Score</strong><br><br><strong style="color: var(--accent-green);">Concentration Advantage:</strong><br>Advantage on CON saves to maintain concentration when damaged.<br><br><strong style="color: var(--accent-blue);">Somatic Components:</strong><br>Cast spells with S components while holding weapons/shield.<br><br><strong style="color: var(--accent-purple);">Reactive Spell:</strong><br>Cast a 1-action spell instead of Opportunity Attack when a creature leaves your reach.',
                    detail: 'Synergy: Dragon Starry Form + War Caster = minimum 10 + Advantage on concentration!'
                }
            ],
            skills: [
                {
                    name: 'Skill Proficiencies',
                    source: 'Summary',
                    desc: '<strong style="color: var(--accent-gold);">Proficient Skills (+3 proficiency bonus):</strong><br><br><strong>From Guide Background:</strong><br>‚Ä¢ <strong>Stealth</strong> (DEX): +2 +3 = <strong>+5</strong><br>‚Ä¢ <strong>Survival</strong> (WIS): +4 +3 = <strong>+7</strong><br><br><strong>From Druid Class (chose 2):</strong><br>‚Ä¢ <strong>Nature</strong> (INT): -1 +3 +4 = <strong>+6</strong> (includes Magician +4)<br>‚Ä¢ <strong>Perception</strong> (WIS): +4 +3 = <strong>+7</strong><br><br><strong style="color: var(--text-muted);">Arcana Note:</strong> With Magician, you add +4 to Arcana checks = <strong>+3</strong> total (-1 INT + 4 WIS)<br><br><strong style="color: var(--accent-blue);">Passive Perception:</strong> 10 + 7 = <strong>17</strong>'
                }
            ]
        };

        function renderFeatures() {
            if (!FEATURES) return;
            const categoryMap = {
                background: 'backgroundFeatures',
                ancestry: 'ancestryFeatures',
                druid: 'druidFeatures',
                stars: 'starsFeatures',
                feats: 'featFeatures',
                skills: 'skillsFeatures'
            };

            const currentLevel = state.characterLevel || 5;

            Object.keys(categoryMap).forEach(cat => {
                const container = document.getElementById(categoryMap[cat]);
                if (!container || !FEATURES[cat]) return;

                // Filter features by level requirement
                const availableFeatures = FEATURES[cat].filter(f => !f.levelReq || f.levelReq <= currentLevel);

                container.innerHTML = availableFeatures.map((f, idx) => {
                    // Find the original index in the full array for showFeatureDetail
                    const originalIdx = FEATURES[cat].indexOf(f);
                    return `
                    <div class="feature-item" onclick="showFeatureDetail('${cat}', ${originalIdx})" style="cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div class="feature-item-name">${f.name}</div>
                            <span style="color: var(--accent-blue); font-size: 0.8em;">Tap for details</span>
                        </div>
                        ${f.source ? `<div class="feature-item-source">${f.source}</div>` : ''}
                        <div class="feature-item-desc" style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">${f.desc.replace(/<[^>]*>/g, ' ').substring(0, 120)}...</div>
                        ${f.hasChoices ? `<div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 5px;">${f.choices.map(c => `<span style="background: rgba(123,104,238,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.75em;">${c}</span>`).join('')}</div>` : ''}
                    </div>
                `}).join('');
            });
        }

        function showFeatureDetail(category, index) {
            const f = FEATURES[category][index];
            let content = `
                <div style="margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                    <p><strong style="color: var(--accent-gold);">${f.source || 'Feature'}</strong></p>
                </div>
                <div style="line-height: 1.7;">${f.desc}</div>
            `;

            if (f.detail) {
                content += `<div style="margin-top: 15px; padding: 10px; background: rgba(123,104,238,0.1); border-radius: 8px; border-left: 3px solid var(--accent-purple);">
                    <strong style="color: var(--accent-purple);">DM Note:</strong> ${f.detail}
                </div>`;
            }

            if (f.hasChoices && f.choices) {
                content += `<div style="margin-top: 15px;">
                    <strong style="color: var(--accent-blue);">Options/Choices:</strong>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                        ${f.choices.map(c => `<span style="background: rgba(74,144,217,0.2); padding: 5px 12px; border-radius: 15px; border: 1px solid var(--accent-blue);">${c}</span>`).join('')}
                    </div>
                </div>`;
            }

            showModal(f.name, content);
        }

        // ===== INVENTORY =====
        // ===== EQUIPMENT SYSTEM =====

        // Default starting inventory
        const DEFAULT_INVENTORY = [
            // Weapons (Official Druid Starting Equipment)
            { id: 'sickle', type: 'weapon', name: 'Sickle', category: 'simple', weaponType: 'melee', hands: 'one',
              damageDie: '1d4', damageType: 'slashing', modifier: 'str', properties: ['light'],
              isMagic: false, equipped: 'mainHand' },
            { id: 'quarterstaff', type: 'weapon', name: 'Quarterstaff', category: 'simple', weaponType: 'melee', hands: 'versatile',
              damageDie: '1d6', damageDieVersatile: '1d8', damageType: 'bludgeoning', modifier: 'str', properties: ['versatile'],
              isMagic: false, equipped: null, description: 'Acts as Druidic Focus. 1d6 one-handed, 1d8 two-handed.' },
            { id: 'dagger', type: 'weapon', name: 'Dagger', category: 'simple', weaponType: 'melee/thrown', hands: 'one',
              damageDie: '1d4', damageType: 'piercing', modifier: 'finesse', range: '20/60',
              properties: ['light', 'finesse', 'thrown'], isMagic: false, equipped: null },
            { id: 'shortbow', type: 'weapon', name: 'Shortbow', category: 'simple', weaponType: 'ranged', hands: 'two',
              damageDie: '1d6', damageType: 'piercing', modifier: 'dex', range: '80/320',
              properties: ['ammunition', 'two-handed'], isMagic: false, equipped: null },
            // Shield
            { id: 'shield', type: 'shield', name: 'Wooden Shield', acBonus: 2, isMagic: false, equipped: 'offHand' },
            // Armor (Light - Druid proficient)
            { id: 'leather-armor', type: 'armor', name: 'Leather Armor', armorType: 'light',
              baseAC: 11, maxDex: null, stealthDisadvantage: false, isMagic: false, equipped: 'armor' },
            // Focus (Circle of Stars)
            { id: 'star-map', type: 'focus', name: 'Star Map', isMagic: true, equipped: null,
              description: 'Spellcasting focus from Circle of Stars. Grants Guidance cantrip and free Guiding Bolt casts (4/long rest).' },
            // Ammunition
            { id: 'arrows', type: 'ammo', name: 'Arrows', quantity: 20 }
        ];

        const DEFAULT_GEAR = [
            // Container
            { id: 'backpack', name: 'Backpack', qty: 1, consumable: false,
              desc: 'A backpack can hold one cubic foot or 30 pounds of gear. You can also strap items to the outside.' },
            // From Explorer's Pack
            { id: 'bedroll', name: 'Bedroll', qty: 1, consumable: false,
              desc: 'A sleeping bag for keeping warm and dry while camping outdoors. Roll it up and strap to backpack.' },
            { id: 'mess-kit', name: 'Mess Kit', qty: 1, consumable: false,
              desc: 'A tin box containing a plate, cup, and eating utensils (fork, spoon, knife). The lid doubles as a cooking pan.' },
            { id: 'tinderbox', name: 'Tinderbox', qty: 1, consumable: false,
              desc: 'This small container holds flint, fire steel, and tinder. Using it to light a torch takes an action. Lighting any other fire takes 1 minute.' },
            { id: 'torches', name: 'Torch', qty: 10, consumable: true,
              desc: 'Burns for 1 hour, providing bright light in a 20-foot radius and dim light for an additional 20 feet. Can be used as improvised weapon (1 fire damage).' },
            { id: 'rations', name: 'Rations', qty: 10, consumable: true, unit: 'days',
              desc: 'Dried, preserved food sufficient for one day. Consists of jerky, dried fruit, hardtack, and nuts.' },
            { id: 'waterskin', name: 'Waterskin', qty: 1, consumable: false,
              desc: 'A leather pouch that holds up to 4 pints of liquid. One pint of water per day prevents dehydration.' },
            { id: 'rope', name: 'Hempen Rope', qty: 50, consumable: true, unit: 'ft',
              desc: 'Has 2 HP and can be burst with DC 17 Strength check. Can be cut into smaller lengths for various uses.' },
            // From Guide Background
            { id: 'tent', name: 'Tent (2-person)', qty: 1, consumable: false,
              desc: 'A canvas shelter that accommodates two Medium creatures. Takes 10 minutes to set up or break down.' },
            { id: 'travelers-clothes', name: "Traveler's Clothes", qty: 1, consumable: false,
              desc: 'A set of durable, practical clothes for traveling: boots, trousers, shirt, vest, belt, and cloak.' },
            { id: 'quiver', name: 'Quiver', qty: 1, consumable: false,
              desc: 'A leather container that holds up to 20 arrows or bolts.' },
            // Tools (Proficient)
            { id: 'herbalism-kit', name: "Herbalism Kit", qty: 1, consumable: false, isTool: true,
              desc: 'This kit contains pouches for herbs, clippers, mortar and pestle, glass jars, and distilling equipment.',
              proficient: true,
              uses: [
                'Identify plants with Herbalism Kit check',
                'Create antitoxin (DC 15, 25 gp materials, 8 hours)',
                'Create healing potion (DC 15, 25 gp materials, 1 day)',
                'Prepare herbal remedies and poultices',
                'Forage for medicinal herbs in the wild'
              ],
              checks: 'Medicine, Nature, Survival - add proficiency bonus when using kit for these checks' },
            { id: 'cartographers-tools', name: "Cartographer's Tools", qty: 1, consumable: false, isTool: true,
              desc: 'These tools include a quill, ink, parchment, compass, calipers, and ruler.',
              proficient: true,
              uses: [
                'Create accurate maps of areas you explore',
                'Determine your position on a map',
                'Estimate distance between locations',
                'Navigate unfamiliar terrain'
              ],
              checks: 'Nature, Survival, Investigation - add proficiency bonus when using tools for these checks' }
        ];

        function initInventory() {
            if (!state.inventory || state.inventory.length === 0) {
                state.inventory = JSON.parse(JSON.stringify(DEFAULT_INVENTORY));
            }
            if (!state.gear || state.gear.length === 0) {
                state.gear = JSON.parse(JSON.stringify(DEFAULT_GEAR));
            }
        }

        // ===== AMMUNITION SYSTEM =====
        // Map weapon names to their required ammo type
        const AMMO_REQUIREMENTS = {
            'shortbow': 'arrows',
            'longbow': 'arrows',
            'light crossbow': 'bolts',
            'heavy crossbow': 'bolts',
            'hand crossbow': 'bolts',
            'crossbow': 'bolts'
        };

        function getAmmoTypeForWeapon(weapon) {
            if (!weapon.properties || !weapon.properties.includes('ammunition')) return null;
            const weaponName = weapon.name.toLowerCase();
            for (const [key, ammoType] of Object.entries(AMMO_REQUIREMENTS)) {
                if (weaponName.includes(key)) return ammoType;
            }
            // Default fallback based on weapon type keywords
            if (weaponName.includes('bow')) return 'arrows';
            if (weaponName.includes('crossbow')) return 'bolts';
            return 'arrows'; // Default
        }

        function getAmmoCount(ammoType) {
            const ammoItem = state.inventory.find(item =>
                item.type === 'ammo' && item.name.toLowerCase().includes(ammoType.toLowerCase())
            );
            return ammoItem ? ammoItem.quantity : 0;
        }

        function useAmmo(ammoType, amount = 1) {
            const ammoItem = state.inventory.find(item =>
                item.type === 'ammo' && item.name.toLowerCase().includes(ammoType.toLowerCase())
            );
            if (!ammoItem) {
                alert(`No ${ammoType} in inventory!`);
                return false;
            }
            if (ammoItem.quantity < amount) {
                alert(`Not enough ${ammoType}! (have ${ammoItem.quantity})`);
                return false;
            }
            saveForUndo();
            ammoItem.quantity -= amount;
            saveState();
            renderInventory();
            return true;
        }

        function addAmmo(ammoType, amount) {
            const ammoItem = state.inventory.find(item =>
                item.type === 'ammo' && item.name.toLowerCase().includes(ammoType.toLowerCase())
            );
            if (ammoItem) {
                saveForUndo();
                ammoItem.quantity += amount;
                saveState();
                renderInventory();
            } else {
                // Create new ammo item
                saveForUndo();
                const capitalizedName = ammoType.charAt(0).toUpperCase() + ammoType.slice(1);
                state.inventory.push({
                    id: ammoType + '-' + Date.now(),
                    type: 'ammo',
                    name: capitalizedName,
                    quantity: amount
                });
                saveState();
                renderInventory();
            }
        }

        function openAddAmmoModal() {
            const body = `
                <div class="form-group">
                    <label>Ammo Type</label>
                    <select id="ammoTypeSelect">
                        <option value="arrows">Arrows</option>
                        <option value="bolts">Bolts</option>
                        <option value="bullets">Sling Bullets</option>
                        <option value="darts">Darts</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity to Add</label>
                    <input type="number" id="ammoQuantity" value="20" min="1">
                </div>
                <button onclick="confirmAddAmmo()" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Ammunition</button>
            `;
            showModal('Add Ammunition', body);
        }

        function confirmAddAmmo() {
            const ammoType = document.getElementById('ammoTypeSelect').value;
            const quantity = parseInt(document.getElementById('ammoQuantity').value) || 1;
            addAmmo(ammoType, quantity);
            closeModal();
        }

        function getEquippedInSlot(slot) {
            if (!state.inventory) return null;
            // For hand slots, also check for two-handed weapons
            if (slot === 'mainHand' || slot === 'offHand') {
                const twoHanded = state.inventory.find(item => item.equipped === 'twoHanded');
                if (twoHanded) return twoHanded;
            }
            return state.inventory.find(item => item.equipped === slot);
        }

        function renderInventory() {
            initInventory();
            renderEquipmentSlots();
            renderInventoryList();
            renderGearList();
            renderAttunement();
            updateACFromEquipment();
            updateOffhandButton();
        }

        function renderEquipmentSlots() {
            const slots = ['mainHand', 'offHand', 'armor', 'head', 'neck', 'hands', 'feet', 'ring1', 'ring2'];

            // Check for two-handed weapon
            const twoHandedWeapon = state.inventory.find(item => item.equipped === 'twoHanded');

            slots.forEach(slot => {
                const contentEl = document.getElementById(slot + 'Content');
                const slotEl = document.getElementById('slot-' + slot);

                if (!contentEl || !slotEl) return;

                // Handle two-handed weapon display in both hand slots
                if ((slot === 'mainHand' || slot === 'offHand') && twoHandedWeapon) {
                    let displayText = twoHandedWeapon.name;
                    if (twoHandedWeapon.type === 'weapon') {
                        displayText += ` (${twoHandedWeapon.damageDie})`;
                    }
                    if (slot === 'offHand') {
                        displayText = '‚Üë Two-handed';
                    }
                    contentEl.textContent = displayText;
                    contentEl.classList.remove('empty');
                    slotEl.classList.add('filled');
                    if (twoHandedWeapon.isMagic) slotEl.classList.add('magic');
                    else slotEl.classList.remove('magic');
                    return;
                }

                const item = state.inventory.find(i => i.equipped === slot);

                if (item) {
                    let displayText = item.name;
                    if (item.type === 'weapon') {
                        displayText += ` (${item.damageDie})`;
                    } else if (item.type === 'armor') {
                        displayText += ` (AC ${item.baseAC})`;
                    } else if (item.type === 'shield') {
                        displayText += ` (+${item.acBonus} AC)`;
                    }
                    contentEl.textContent = displayText;
                    contentEl.classList.remove('empty');
                    slotEl.classList.add('filled');
                    if (item.isMagic) slotEl.classList.add('magic');
                    else slotEl.classList.remove('magic');
                } else {
                    contentEl.textContent = slot === 'mainHand' || slot === 'offHand' || slot === 'armor' ? 'Empty' : '-';
                    contentEl.classList.add('empty');
                    slotEl.classList.remove('filled', 'magic');
                }
            });
        }

        function renderInventoryList() {
            const listEl = document.getElementById('inventoryList');
            if (!listEl) return;

            const unequipped = state.inventory.filter(item => !item.equipped);

            if (unequipped.length === 0) {
                listEl.innerHTML = '<div class="text-muted" style="padding: 10px;">No unequipped items</div>';
                return;
            }

            listEl.innerHTML = unequipped.map(item => {
                let subtitle = '';
                if (item.type === 'weapon') {
                    const cat = item.category ? item.category.charAt(0).toUpperCase() + item.category.slice(1) : '';
                    subtitle = `${cat ? cat + ' | ' : ''}${item.damageDie} ${item.damageType}`;
                } else if (item.type === 'armor') {
                    subtitle = `AC ${item.baseAC} + DEX (max ${item.maxDex})`;
                } else if (item.type === 'shield') {
                    subtitle = `+${item.acBonus} AC`;
                } else if (item.type === 'ammo') {
                    subtitle = `Qty: ${item.quantity}`;
                }

                return `
                    <div class="inventory-item ${item.isMagic ? 'magic' : ''}" onclick="showItemOptions('${item.id}')">
                        <div class="inventory-item-left">
                            <span class="inventory-item-name">${item.name}</span>
                            <span style="font-size: 0.8em; color: var(--text-muted);">${subtitle}</span>
                        </div>
                        <div class="inventory-item-actions">
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteInventoryItem('${item.id}')">‚úï</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderGearList() {
            const gearList = document.getElementById('gearList');
            if (!gearList) return;

            // Categorize items - assign gearType to legacy items
            const categorized = {
                consumable: [],
                gear: [],
                tool: [],
                material: []
            };

            state.gear.forEach((item, i) => {
                // Determine type for legacy items
                let type = item.gearType;
                if (!type) {
                    if (item.isTool) type = 'tool';
                    else if (item.consumable) type = 'consumable';
                    else type = 'gear';
                }
                categorized[type] = categorized[type] || [];
                categorized[type].push({ ...item, originalIndex: i });
            });

            let html = '';

            // Render each category
            const categories = [
                { key: 'consumable', icon: 'üì¶', title: 'Consumables' },
                { key: 'gear', icon: 'üéí', title: 'Gear' },
                { key: 'tool', icon: 'üõ†Ô∏è', title: 'Tools' },
                { key: 'material', icon: 'üíé', title: 'Materials' }
            ];

            categories.forEach(cat => {
                const items = categorized[cat.key];
                if (!items || items.length === 0) return;

                html += `<div class="gear-category">
                    <div class="gear-category-title" style="color: var(--accent-gold); font-weight: bold; padding: 8px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 8px;">
                        ${cat.icon} ${cat.title}
                    </div>`;

                if (cat.key === 'material') {
                    // Group materials by name for stacking
                    html += renderMaterialsGrouped(items);
                } else {
                    items.forEach(item => {
                        html += renderGearItem(item, cat.key);
                    });
                }

                html += '</div>';
            });

            if (html === '') {
                html = '<div class="text-muted" style="padding: 10px;">No adventuring gear yet</div>';
            }

            gearList.innerHTML = html;
        }

        function renderGearItem(item, type) {
            const i = item.originalIndex;
            const qtyDisplay = item.unit ? `${item.qty} ${item.unit}` : `√ó${item.qty || 1}`;
            const isConsumable = type === 'consumable';
            const isTool = type === 'tool';
            const showQtyControls = isConsumable || (item.qty > 1);

            // For tools, show proficiency indicator
            const profBadge = isTool && item.proficient ? ' <span style="color: var(--accent-green); font-size: 0.8em;">‚úì</span>' : '';

            return `
                <div class="inventory-item ${isTool ? 'tool-item' : ''}" onclick="showGearDetails(${i})" style="cursor: pointer;">
                    <div class="inventory-item-left">
                        <span class="inventory-item-name">${item.name}${profBadge}</span>
                    </div>
                    <div class="inventory-item-actions" onclick="event.stopPropagation();">
                        ${showQtyControls ? `
                            <button class="qty-btn" onclick="adjustGearQty(${i}, -1)" style="padding: 4px 8px; background: var(--accent-red); border: none; border-radius: 4px; color: white; cursor: pointer;">‚àí</button>
                            <span style="color: var(--text-muted); min-width: 40px; text-align: center;">${qtyDisplay}</span>
                            <button class="qty-btn" onclick="adjustGearQty(${i}, 1)" style="padding: 4px 8px; background: var(--accent-green); border: none; border-radius: 4px; color: white; cursor: pointer;">+</button>
                        ` : `
                            <span style="color: var(--text-muted);">${qtyDisplay}</span>
                        `}
                        <button class="delete-btn" onclick="deleteItem('gear', ${i})">‚úï</button>
                    </div>
                </div>
            `;
        }

        function renderMaterialsGrouped(items) {
            // Group materials by name
            const grouped = {};
            items.forEach(item => {
                const key = item.name.toLowerCase();
                if (!grouped[key]) {
                    grouped[key] = {
                        name: item.name,
                        items: [],
                        totalWorth: 0,
                        totalQty: 0,
                        currency: item.currency || 'gp'
                    };
                }
                grouped[key].items.push(item);
                grouped[key].totalQty += item.qty || 1;
                grouped[key].totalWorth += (item.worth || 0) * (item.qty || 1);
            });

            let html = '';
            Object.values(grouped).forEach(group => {
                const hasMultiple = group.items.length > 1 || group.totalQty > 1;
                const worthDisplay = group.totalWorth > 0 ? `${group.totalWorth} ${group.currency}` : '';
                const qtyDisplay = group.totalQty > 1 ? `${group.totalQty}p` : '';
                const summaryParts = [qtyDisplay, worthDisplay].filter(Boolean).join(', ');

                if (group.items.length === 1 && group.items[0].qty === 1) {
                    // Single item - simple display
                    const item = group.items[0];
                    const i = item.originalIndex;
                    const worthText = item.worth ? `${item.worth} ${item.currency || 'gp'}` : '';
                    html += `
                        <div class="inventory-item" onclick="showGearDetails(${i})" style="cursor: pointer;">
                            <div class="inventory-item-left">
                                <span class="inventory-item-name">${item.name}${worthText ? ` (${worthText})` : ''}</span>
                            </div>
                            <div class="inventory-item-actions" onclick="event.stopPropagation();">
                                <button class="qty-btn" onclick="adjustGearQty(${i}, -1)" style="padding: 4px 8px; background: var(--accent-red); border: none; border-radius: 4px; color: white; cursor: pointer;">‚àí</button>
                                <span style="color: var(--text-muted); min-width: 30px; text-align: center;">√ó${item.qty}</span>
                                <button class="qty-btn" onclick="adjustGearQty(${i}, 1)" style="padding: 4px 8px; background: var(--accent-green); border: none; border-radius: 4px; color: white; cursor: pointer;">+</button>
                                <button class="delete-btn" onclick="deleteItem('gear', ${i})">‚úï</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Multiple items or qty > 1 - expandable group
                    const groupId = 'mat-' + group.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                    const escapedName = group.name.replace(/'/g, "\\'");
                    html += `
                        <div class="material-group">
                            <div class="inventory-item material-group-header" style="cursor: pointer;">
                                <div class="inventory-item-left" onclick="showMaterialGroupInfo('${escapedName}')">
                                    <span class="inventory-item-name">${group.name}${group.items.length > 1 ? 's' : ''} (${summaryParts})</span>
                                </div>
                                <div class="inventory-item-actions">
                                    <button onclick="toggleMaterialGroup('${groupId}')" style="padding: 4px 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-muted); cursor: pointer; font-size: 0.9em;">‚ñº</button>
                                </div>
                            </div>
                            <div id="${groupId}" class="material-group-items" style="display: none; padding-left: 15px; border-left: 2px solid var(--border-color); margin-left: 10px;">
                                ${group.items.map(item => {
                                    const i = item.originalIndex;
                                    const worthText = item.worth ? `${item.worth} ${item.currency || 'gp'}` : 'no value';
                                    return `
                                        <div class="inventory-item" onclick="showMaterialItemInfo(${i})" style="padding: 6px 0; cursor: pointer;">
                                            <div class="inventory-item-left">
                                                <span style="color: var(--text-muted);">${worthText} √ó ${item.qty}</span>
                                            </div>
                                            <div class="inventory-item-actions" onclick="event.stopPropagation();">
                                                <button class="qty-btn" onclick="adjustGearQty(${i}, -1)" style="padding: 2px 6px; background: var(--accent-red); border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 0.9em;">‚àí</button>
                                                <button class="qty-btn" onclick="adjustGearQty(${i}, 1)" style="padding: 2px 6px; background: var(--accent-green); border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 0.9em;">+</button>
                                                <button class="delete-btn" onclick="deleteItem('gear', ${i})" style="font-size: 0.9em;">‚úï</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                                <div style="padding: 8px 0;">
                                    <button onclick="addMoreMaterial('${escapedName}', '')" style="width: 100%; padding: 6px; background: var(--bg-tertiary); border: 1px dashed var(--border-color); border-radius: 4px; color: var(--text-muted); cursor: pointer; font-size: 0.9em;">+ Add ${group.name}</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            return html;
        }

        function toggleMaterialGroup(groupId) {
            const el = document.getElementById(groupId);
            if (el) {
                el.style.display = el.style.display === 'none' ? 'block' : 'none';
            }
        }

        function showMaterialGroupInfo(groupName) {
            // Find all items with this name
            const items = state.gear.filter(item =>
                item.name.toLowerCase() === groupName.toLowerCase() &&
                (item.gearType === 'material' || item.worth !== undefined)
            );

            if (items.length === 0) return;

            const firstItem = items[0];
            const totalQty = items.reduce((sum, item) => sum + (item.qty || 1), 0);
            const totalWorth = items.reduce((sum, item) => sum + ((item.worth || 0) * (item.qty || 1)), 0);
            const currency = firstItem.currency || 'gp';

            let body = `<div style="padding: 10px;">`;

            // Type badge
            body += `<div style="display: inline-block; padding: 4px 10px; background: var(--bg-tertiary); border-radius: 12px; font-size: 0.85em; color: var(--text-muted); margin-bottom: 10px;">
                üíé Material Group
            </div>`;

            // Description
            body += `<div style="font-size: 1.1em; margin-bottom: 10px;">${firstItem.desc || 'No description available.'}</div>`;

            // Stats
            body += `<div style="margin-bottom: 15px; color: var(--text-muted);">`;
            body += `<div>üì¶ Total: ${totalQty} pieces (${items.length} stack${items.length > 1 ? 's' : ''})</div>`;
            body += `<div>üí∞ Total Worth: ${totalWorth} ${currency}</div>`;
            body += `</div>`;

            // Breakdown
            body += `<div style="background: var(--bg-tertiary); padding: 10px; border-radius: 8px; margin-bottom: 15px;">`;
            body += `<div style="font-weight: bold; margin-bottom: 8px;">Worth Breakdown:</div>`;
            items.forEach(item => {
                const worthText = item.worth ? `${item.worth} ${item.currency || 'gp'}` : 'no value';
                body += `<div style="color: var(--text-muted);">‚Ä¢ ${worthText} √ó ${item.qty || 1}</div>`;
            });
            body += `</div>`;

            // Add more button
            const escapedName = groupName.replace(/'/g, "\\'");
            const escapedDesc = (firstItem.desc || '').replace(/'/g, "\\'");
            body += `<div style="margin-bottom: 10px;">`;
            body += `<button onclick="addMoreMaterial('${escapedName}', '${escapedDesc}')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">+ Add ${groupName}</button>`;
            body += `</div>`;

            // Edit button (for name/description)
            body += `<div style="display: flex; gap: 10px;">`;
            body += `<button onclick="editMaterialGroup('${escapedName}')" style="flex: 1; padding: 12px; background: var(--accent-purple); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">‚úèÔ∏è Edit Name/Description</button>`;
            body += `</div>`;

            body += `</div>`;

            showModal(`üíé ${groupName}`, body);
        }

        function editMaterialGroup(groupName) {
            // Find first item to get current values
            const firstItem = state.gear.find(item =>
                item.name.toLowerCase() === groupName.toLowerCase() &&
                (item.gearType === 'material' || item.worth !== undefined)
            );

            if (!firstItem) return;

            const escapedName = groupName.replace(/'/g, "\\'");

            const body = `
                <div class="form-group">
                    <label>Material Name</label>
                    <input type="text" id="editGroupName" value="${firstItem.name}" placeholder="e.g., Diamond, Pearl">
                    <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 4px;">Changes apply to all items in this group</div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editGroupDesc" rows="3" placeholder="What spells use this?">${firstItem.desc || ''}</textarea>
                </div>
                <button onclick="saveMaterialGroup('${escapedName}')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Save Changes</button>
            `;

            showModal(`‚úèÔ∏è Edit: ${groupName}`, body);
        }

        function saveMaterialGroup(originalName) {
            const newName = document.getElementById('editGroupName').value.trim();
            const newDesc = document.getElementById('editGroupDesc').value.trim();

            if (!newName) { alert('Please enter a name'); return; }

            saveForUndo();

            // Update all items with the original name
            state.gear.forEach(item => {
                if (item.name.toLowerCase() === originalName.toLowerCase() &&
                    (item.gearType === 'material' || item.worth !== undefined)) {
                    item.name = newName;
                    item.desc = newDesc || null;
                }
            });

            saveState();
            closeModal();
            renderGearList();
            showToast('Group updated!');
        }

        function showMaterialItemInfo(index) {
            const item = state.gear[index];
            if (!item) return;

            const worthText = item.worth ? `${item.worth} ${item.currency || 'gp'}` : 'No value set';
            const totalWorth = (item.worth || 0) * (item.qty || 1);

            let body = `<div style="padding: 10px;">`;

            // Type badge
            body += `<div style="display: inline-block; padding: 4px 10px; background: var(--bg-tertiary); border-radius: 12px; font-size: 0.85em; color: var(--text-muted); margin-bottom: 10px;">
                üíé Material
            </div>`;

            // Name display (read-only, edit via group)
            body += `<div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">${item.name}</div>`;

            // Description
            body += `<div style="font-size: 1em; margin-bottom: 10px; color: var(--text-muted);">${item.desc || 'No description.'}</div>`;

            // Stats
            body += `<div style="margin-bottom: 15px;">`;
            body += `<div>üì¶ Quantity: ${item.qty || 1}</div>`;
            body += `<div>üí∞ Worth: ${worthText} each</div>`;
            if (item.qty > 1) {
                body += `<div>üí∞ Total: ${totalWorth} ${item.currency || 'gp'}</div>`;
            }
            body += `</div>`;

            // Edit worth button
            body += `<div style="display: flex; gap: 10px; margin-top: 15px;">`;
            body += `<button onclick="editMaterialWorth(${index})" style="flex: 1; padding: 12px; background: var(--accent-purple); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">‚úèÔ∏è Edit Worth</button>`;
            body += `<button onclick="deleteGearItem(${index}); closeModal();" style="padding: 12px; background: var(--accent-red); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">üóëÔ∏è</button>`;
            body += `</div>`;

            body += `</div>`;

            showModal(`üíé ${item.name}`, body);
        }

        function editMaterialWorth(index) {
            const item = state.gear[index];
            if (!item) return;

            const body = `
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="editItemQty" value="${item.qty || 1}" min="1">
                </div>
                <div class="form-row" style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 2;">
                        <label>Worth (per item)</label>
                        <input type="number" id="editItemWorth" value="${item.worth || 0}" min="0">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Currency</label>
                        <select id="editItemCurrency">
                            <option value="gp" ${item.currency === 'gp' || !item.currency ? 'selected' : ''}>GP</option>
                            <option value="sp" ${item.currency === 'sp' ? 'selected' : ''}>SP</option>
                            <option value="cp" ${item.currency === 'cp' ? 'selected' : ''}>CP</option>
                        </select>
                    </div>
                </div>
                <div style="font-size: 0.85em; color: var(--text-muted); margin-bottom: 15px;">To change name/description, edit from the group header</div>
                <button onclick="saveMaterialWorth(${index})" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Save Changes</button>
            `;

            showModal(`üí∞ Edit Worth: ${item.name}`, body);
        }

        function saveMaterialWorth(index) {
            const item = state.gear[index];
            if (!item) return;

            saveForUndo();

            item.qty = parseInt(document.getElementById('editItemQty').value) || 1;
            item.worth = parseInt(document.getElementById('editItemWorth').value) || 0;
            item.currency = document.getElementById('editItemCurrency').value || 'gp';

            saveState();
            closeModal();
            renderGearList();
            showToast('Item updated!');
        }

        function showGearDetails(index) {
            const item = state.gear[index];
            if (!item) return;

            // Determine item type
            let type = item.gearType;
            if (!type) {
                if (item.isTool) type = 'tool';
                else if (item.consumable) type = 'consumable';
                else if (item.worth !== undefined) type = 'material';
                else type = 'gear';
            }

            const typeIcons = { consumable: 'üì¶', gear: 'üéí', tool: 'üõ†Ô∏è', material: 'üíé' };
            const typeNames = { consumable: 'Consumable', gear: 'Gear', tool: 'Tool', material: 'Material' };

            let body = `<div style="padding: 10px;">`;

            // Type badge
            body += `<div style="display: inline-block; padding: 4px 10px; background: var(--bg-tertiary); border-radius: 12px; font-size: 0.85em; color: var(--text-muted); margin-bottom: 10px;">
                ${typeIcons[type]} ${typeNames[type]}
            </div>`;

            // Description
            body += `<div style="font-size: 1.1em; margin-bottom: 10px;">${item.desc || 'No description available.'}</div>`;

            // Stats row based on type
            body += `<div style="margin-bottom: 15px; color: var(--text-muted); display: flex; gap: 15px; flex-wrap: wrap;">`;

            // Quantity for all types
            body += `<span>üì¶ Qty: ${item.qty || 1}${item.unit ? ' ' + item.unit : ''}</span>`;

            // Material-specific: worth
            if (type === 'material' && item.worth) {
                const totalWorth = item.worth * (item.qty || 1);
                body += `<span>üí∞ Worth: ${item.worth} ${item.currency || 'gp'} each (${totalWorth} ${item.currency || 'gp'} total)</span>`;
            }

            body += `</div>`;

            // Tool-specific info
            if (type === 'tool') {
                body += `<div style="background: rgba(100,149,237,0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px;">`;
                body += `<div style="color: var(--accent-blue); font-weight: bold; margin-bottom: 8px;">üõ†Ô∏è Tool${item.proficient ? ' <span style="color: var(--accent-green);">(Proficient)</span>' : ''}</div>`;

                if (item.toolFunction) {
                    body += `<div style="white-space: pre-wrap;">${item.toolFunction}</div>`;
                }

                // Legacy fields support
                if (item.checks) {
                    body += `<div style="margin-top: 8px;"><strong>Related Checks:</strong> ${item.checks}</div>`;
                }

                if (item.uses && item.uses.length > 0) {
                    body += `<div style="margin-top: 8px;"><strong>Common Uses:</strong></div>`;
                    body += `<ul style="margin: 0; padding-left: 20px;">`;
                    item.uses.forEach(use => {
                        body += `<li style="margin-bottom: 4px;">${use}</li>`;
                    });
                    body += `</ul>`;
                }
                body += `</div>`;
            }

            // Material add more button
            if (type === 'material') {
                const escapedName = item.name.replace(/'/g, "\\'");
                const escapedDesc = (item.desc || '').replace(/'/g, "\\'");
                body += `<div style="margin-top: 15px;">`;
                body += `<button onclick="addMoreMaterial('${escapedName}', '${escapedDesc}')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">+ Add ${item.name}</button>`;
                body += `</div>`;
            }

            // Edit & Delete buttons
            body += `<div style="display: flex; gap: 10px; margin-top: 15px;">`;
            body += `<button onclick="editGear(${index})" style="flex: 1; padding: 12px; background: var(--accent-purple); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">‚úèÔ∏è Edit</button>`;
            body += `<button onclick="deleteGearItem(${index}); closeModal();" style="padding: 12px; background: var(--accent-red); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">üóëÔ∏è</button>`;
            body += `</div>`;

            body += `</div>`;

            showModal(`${typeIcons[type]} ${item.name}`, body);
        }

        function addMoreMaterial(name, desc) {
            closeModal();
            openAddGearForm('material');
            // Wait for modal to render, then prefill
            setTimeout(() => {
                const nameEl = document.getElementById('gearName');
                const descEl = document.getElementById('gearDesc');
                if (nameEl) nameEl.value = name;
                if (descEl) descEl.value = desc;
            }, 50);
        }

        function adjustGearQty(index, amount) {
            const item = state.gear[index];
            if (!item) return;

            saveForUndo();
            const newQty = (item.qty || 1) + amount;

            if (newQty <= 0) {
                // Auto-delete when quantity reaches 0
                state.gear.splice(index, 1);
                showToast(`${item.name} removed`);
            } else {
                item.qty = newQty;
            }

            saveState();
            renderGearList();
        }

        function editGear(index) {
            const item = state.gear[index];
            if (!item) return;

            // Determine item type
            let type = item.gearType;
            if (!type) {
                if (item.isTool) type = 'tool';
                else if (item.consumable) type = 'consumable';
                else if (item.worth !== undefined) type = 'material';
                else type = 'gear';
            }

            let body = '';

            if (type === 'consumable') {
                body = `
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="editGearName" value="${item.name || ''}" placeholder="e.g., Potion of Healing, Torch">
                    </div>
                    <div class="form-row" style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Quantity</label>
                            <input type="number" id="editGearQty" value="${item.qty || 1}" min="1">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Unit (optional)</label>
                            <select id="editGearUnit">
                                <option value="" ${!item.unit ? 'selected' : ''}>-</option>
                                <option value="ft" ${item.unit === 'ft' ? 'selected' : ''}>ft</option>
                                <option value="days" ${item.unit === 'days' ? 'selected' : ''}>days</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editGearDesc" rows="3" placeholder="What does this item do when used?">${item.desc || ''}</textarea>
                    </div>
                    <button onclick="saveEditGear(${index}, 'consumable')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Save Changes</button>
                `;
            } else if (type === 'tool') {
                body = `
                    <div class="form-group">
                        <label>Tool Name</label>
                        <input type="text" id="editGearName" value="${item.name || ''}" placeholder="e.g., Herbalism Kit">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="editGearQty" value="${item.qty || 1}" min="1">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editGearDesc" rows="2" placeholder="What's in this tool kit?">${item.desc || ''}</textarea>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="editToolProficient" ${item.proficient ? 'checked' : ''} style="width: 20px; height: 20px;">
                            <span>Proficient with this tool</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Tool Functions / Related Checks</label>
                        <textarea id="editToolFunction" rows="4" placeholder="What can you do with this tool?">${item.toolFunction || ''}</textarea>
                    </div>
                    <button onclick="saveEditGear(${index}, 'tool')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Save Changes</button>
                `;
            } else if (type === 'material') {
                const worthDisplay = item.worth ? `${item.worth} ${item.currency || 'gp'}` : 'No value set';
                body = `
                    <div class="form-group">
                        <label>Material Name</label>
                        <input type="text" id="editGearName" value="${item.name || ''}" placeholder="e.g., Diamond, Pearl">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="editGearQty" value="${item.qty || 1}" min="1">
                    </div>
                    <div class="form-group">
                        <label>Worth (per item)</label>
                        <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 6px; color: var(--text-muted);">
                            üí∞ ${worthDisplay}
                            <span style="font-size: 0.85em; display: block; margin-top: 4px;">To change worth, delete and add new</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editGearDesc" rows="2" placeholder="What spells use this?">${item.desc || ''}</textarea>
                    </div>
                    <button onclick="saveEditGear(${index}, 'material')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Save Changes</button>
                `;
            } else {
                // Standard gear
                body = `
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="editGearName" value="${item.name || ''}" placeholder="e.g., Backpack, Waterskin">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="editGearQty" value="${item.qty || 1}" min="1">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editGearDesc" rows="3" placeholder="Describe the item...">${item.desc || ''}</textarea>
                    </div>
                    <button onclick="saveEditGear(${index}, 'gear')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Save Changes</button>
                `;
            }

            const typeIcons = { consumable: 'üì¶', gear: 'üéí', tool: 'üõ†Ô∏è', material: 'üíé' };
            showModal(`${typeIcons[type] || ''} Edit: ${item.name}`, body);
        }

        function saveEditGear(index, gearType) {
            const name = document.getElementById('editGearName').value.trim();
            if (!name) { alert('Please enter an item name'); return; }

            saveForUndo();

            const item = state.gear[index];
            item.name = name;
            item.qty = parseInt(document.getElementById('editGearQty').value) || 1;
            item.gearType = gearType;

            // Get description if exists
            const descEl = document.getElementById('editGearDesc');
            item.desc = descEl ? descEl.value.trim() || null : item.desc;

            // Type-specific fields
            if (gearType === 'consumable') {
                item.consumable = true;
                item.isTool = false;
                const unitEl = document.getElementById('editGearUnit');
                item.unit = unitEl ? unitEl.value || null : null;
                // Clear material fields
                delete item.worth;
                delete item.currency;
                delete item.toolFunction;
                delete item.proficient;
            } else if (gearType === 'tool') {
                item.isTool = true;
                item.consumable = false;
                item.proficient = document.getElementById('editToolProficient').checked;
                const funcEl = document.getElementById('editToolFunction');
                item.toolFunction = funcEl ? funcEl.value.trim() || null : null;
                // Clear material/consumable fields
                delete item.worth;
                delete item.currency;
                delete item.unit;
            } else if (gearType === 'material') {
                item.consumable = false;
                item.isTool = false;
                // Worth and currency are preserved (not editable)
                // Clear other type fields
                delete item.unit;
                delete item.toolFunction;
                delete item.proficient;
            } else {
                // Standard gear
                item.consumable = false;
                item.isTool = false;
                // Clear all type-specific fields
                delete item.worth;
                delete item.currency;
                delete item.unit;
                delete item.toolFunction;
                delete item.proficient;
            }

            saveState();
            closeModal();
            renderGearList();
            showToast('Gear updated!');
        }

        function deleteGearItem(index) {
            if (!confirm('Delete this item?')) return;
            saveForUndo();
            state.gear.splice(index, 1);
            saveState();
            renderGearList();
            showToast('Item deleted');
        }

        function showToolInfo(toolId) {
            // Find the tool in gear by ID
            const index = state.gear.findIndex(item => item.id === toolId);
            if (index !== -1) {
                showGearDetails(index);
            } else {
                // Fallback: show basic info if tool not in gear
                showModal('Tool Not Found', `<div style="padding: 10px;">Tool "${toolId}" not found in gear inventory.</div>`);
            }
        }

        function useGearItem(index) {
            const item = state.gear[index];
            if (!item || !item.consumable || item.qty <= 0) return;

            saveForUndo();
            item.qty -= 1;
            saveState();
            renderGearList();

            // Log the usage if in battle
            if (state.inBattle) {
                addBattleLog(`Used ${item.name}`);
            }
        }

        function openAddGearModal() {
            const body = `
                <div class="form-options">
                    <div class="form-option" onclick="openAddGearForm('consumable')">
                        <div class="form-option-title">üì¶ Consumable</div>
                        <div class="form-option-desc">Items that get used up (potions, rations, torches)</div>
                    </div>
                    <div class="form-option" onclick="openAddGearForm('gear')">
                        <div class="form-option-title">üéí Gear</div>
                        <div class="form-option-desc">Standard equipment (backpack, rope, bedroll)</div>
                    </div>
                    <div class="form-option" onclick="openAddGearForm('tool')">
                        <div class="form-option-title">üõ†Ô∏è Tool</div>
                        <div class="form-option-desc">Tools you may be proficient with (herbalism kit)</div>
                    </div>
                    <div class="form-option" onclick="openAddGearForm('material')">
                        <div class="form-option-title">üíé Material</div>
                        <div class="form-option-desc">Spell components and valuables (diamond, incense)</div>
                    </div>
                </div>
            `;
            showModal('Add Adventuring Gear', body);
        }

        function openAddGearForm(gearType) {
            let body = '';

            if (gearType === 'consumable') {
                body = `
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="gearName" placeholder="e.g., Potion of Healing, Torch">
                    </div>
                    <div class="form-row" style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Quantity</label>
                            <input type="number" id="gearQty" value="1" min="1">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Unit (optional)</label>
                            <select id="gearUnit">
                                <option value="">-</option>
                                <option value="ft">ft</option>
                                <option value="days">days</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="gearDesc" rows="3" placeholder="What does this item do when used?"></textarea>
                    </div>
                    <button onclick="saveNewGear('consumable')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Consumable</button>
                `;
            } else if (gearType === 'gear') {
                body = `
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="gearName" placeholder="e.g., Backpack, Waterskin">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="gearQty" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="gearDesc" rows="3" placeholder="Describe the item..."></textarea>
                    </div>
                    <button onclick="saveNewGear('gear')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Gear</button>
                `;
            } else if (gearType === 'tool') {
                body = `
                    <div class="form-group">
                        <label>Tool Name</label>
                        <input type="text" id="gearName" placeholder="e.g., Herbalism Kit, Thieves' Tools">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="gearQty" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="gearDesc" rows="2" placeholder="What's in this tool kit?"></textarea>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="toolProficient" style="width: 20px; height: 20px;">
                            <span>Proficient with this tool</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Tool Functions / Related Checks</label>
                        <textarea id="toolFunction" rows="4" placeholder="What can you do with this tool? What skill checks does it apply to?"></textarea>
                    </div>
                    <button onclick="saveNewGear('tool')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Tool</button>
                `;
            } else if (gearType === 'material') {
                body = `
                    <div class="form-group">
                        <label>Material Name</label>
                        <input type="text" id="gearName" placeholder="e.g., Diamond, Incense, Pearl">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="gearQty" value="1" min="1">
                    </div>
                    <div class="form-row" style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 2;">
                            <label>Worth (per item)</label>
                            <input type="number" id="materialWorth" value="0" min="0" placeholder="0">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Currency</label>
                            <select id="materialCurrency">
                                <option value="gp">GP</option>
                                <option value="sp">SP</option>
                                <option value="cp">CP</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="gearDesc" rows="2" placeholder="What spells use this? Any special properties?"></textarea>
                    </div>
                    <button onclick="saveNewGear('material')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Material</button>
                `;
            }

            showModal(`Add ${gearType.charAt(0).toUpperCase() + gearType.slice(1)}`, body);
        }

        function saveNewGear(gearType) {
            const name = document.getElementById('gearName').value.trim();
            if (!name) { alert('Please enter an item name'); return; }

            const newItem = {
                id: 'gear-' + Date.now(),
                name: name,
                qty: parseInt(document.getElementById('gearQty').value) || 1,
                gearType: gearType,
                desc: document.getElementById('gearDesc').value.trim() || null
            };

            // Type-specific fields
            if (gearType === 'consumable') {
                newItem.consumable = true;
                const unit = document.getElementById('gearUnit').value;
                if (unit) newItem.unit = unit;
            } else if (gearType === 'tool') {
                newItem.isTool = true;
                newItem.proficient = document.getElementById('toolProficient').checked;
                newItem.toolFunction = document.getElementById('toolFunction').value.trim() || null;
            } else if (gearType === 'material') {
                newItem.worth = parseInt(document.getElementById('materialWorth').value) || 0;
                newItem.currency = document.getElementById('materialCurrency').value || 'gp';
            }

            saveForUndo();
            state.gear.push(newItem);
            saveState();
            renderGearList();
            closeModal();
        }

        function renderAttunement() {
            const attuned = state.inventory.filter(item => item.attuned);
            const countEl = document.getElementById('attunementCount');
            const listEl = document.getElementById('attunedItems');

            if (countEl) countEl.textContent = `(${attuned.length}/3)`;
            if (listEl) {
                if (attuned.length === 0) {
                    listEl.innerHTML = '<span class="text-muted">No attuned items</span>';
                } else {
                    listEl.innerHTML = attuned.map(item => `<div style="color: var(--accent-purple);">‚ú¶ ${item.name}</div>`).join('');
                }
            }
        }

        function updateACFromEquipment() {
            const dexMod = 2; // Character's DEX modifier
            let ac = 10 + dexMod; // Base AC (unarmored)

            const armor = getEquippedInSlot('armor');
            const shield = getEquippedInSlot('offHand');

            if (armor && armor.type === 'armor') {
                const maxDex = armor.maxDex !== undefined ? armor.maxDex : 99;
                const dexBonus = Math.min(dexMod, maxDex);
                ac = armor.baseAC + dexBonus;
                if (armor.magicBonus) ac += armor.magicBonus;
            }

            if (shield && shield.type === 'shield') {
                ac += shield.acBonus;
                if (shield.magicBonus) ac += shield.magicBonus;
            }

            const displayACEl = document.getElementById('displayAC');
            const acDisplayEl = document.getElementById('acDisplay');
            if (displayACEl) displayACEl.textContent = ac;
            if (acDisplayEl) acDisplayEl.textContent = 'AC: ' + ac;
        }

        function showSlotOptions(slot) {
            const currentItem = getEquippedInSlot(slot);
            let validItems = [];

            // Filter items that can go in this slot
            if (slot === 'mainHand') {
                validItems = state.inventory.filter(item => item.type === 'weapon' && !item.equipped);
            } else if (slot === 'offHand') {
                validItems = state.inventory.filter(item =>
                    ((item.type === 'weapon' && item.hands === 'one') || item.type === 'shield') && !item.equipped
                );
            } else if (slot === 'armor') {
                validItems = state.inventory.filter(item => item.type === 'armor' && !item.equipped);
            } else {
                validItems = state.inventory.filter(item =>
                    item.type === 'accessory' && item.slotType === slot && !item.equipped
                );
            }

            let body = '<div class="form-options">';

            if (currentItem) {
                body += `<div class="form-option" onclick="unequipFromSlot('${slot}')">
                    <div class="form-option-title" style="color: var(--accent-red);">‚úï Unequip ${currentItem.name}</div>
                </div><hr style="border-color: var(--border-color); margin: 10px 0;">`;
            }

            if (validItems.length === 0) {
                body += '<p class="text-muted">No items available for this slot</p>';
            } else {
                validItems.forEach(item => {
                    let subtitle = '';
                    if (item.type === 'weapon') subtitle = `${item.damageDie} ${item.damageType}`;
                    else if (item.type === 'armor') subtitle = `AC ${item.baseAC}`;
                    else if (item.type === 'shield') subtitle = `+${item.acBonus} AC`;

                    body += `<div class="form-option" onclick="equipToSlot('${item.id}', '${slot}')">
                        <div class="form-option-title">${item.name}</div>
                        <div class="form-option-desc">${subtitle}</div>
                    </div>`;
                });
            }

            body += '</div>';
            showModal(getSlotLabel(slot), body);
        }

        function getSlotLabel(slot) {
            const labels = {
                mainHand: 'Main Hand', offHand: 'Off Hand', armor: 'Body Armor',
                head: 'Head', neck: 'Neck', hands: 'Hands', feet: 'Feet',
                ring1: 'Ring 1', ring2: 'Ring 2'
            };
            return labels[slot] || slot;
        }

        // Druid proficiencies (D&D 5e 2024)
        const CLASS_PROFICIENCIES = {
            weapons: ['simple'],  // Druids are only proficient with simple weapons
            armor: ['light'],      // Light armor only
            shields: true          // Shields (no metal)
        };

        function checkWeaponProficiency(weapon) {
            if (!weapon.category) return { proficient: true }; // No category = assume proficient
            if (CLASS_PROFICIENCIES.weapons.includes(weapon.category)) {
                return { proficient: true };
            }
            return {
                proficient: false,
                warning: '‚ö†Ô∏è Not proficient - no proficiency bonus to attack'
            };
        }

        function checkArmorProficiency(armor) {
            if (!armor.armorType) return { proficient: true };
            if (CLASS_PROFICIENCIES.armor.includes(armor.armorType)) {
                return { proficient: true };
            }
            return {
                proficient: false,
                warning: '‚ö†Ô∏è Not proficient - disadvantage on STR/DEX checks and saves, cannot cast spells'
            };
        }

        // Check if character can cast spells (blocked by non-proficient armor or Wild Shape beast form)
        function canCastSpells() {
            // Check Wild Shape - beast form blocks casting
            if (state.wildShape && state.wildShape.active && state.wildShape.type === 'beast') {
                return { canCast: false, reason: 'Cannot cast spells while in Wild Shape beast form' };
            }

            // Check equipped armor for proficiency
            const equippedArmor = state.inventory.find(i => i.type === 'armor' && i.equipped === 'armor');
            if (equippedArmor) {
                const profCheck = checkArmorProficiency(equippedArmor);
                if (!profCheck.proficient) {
                    return { canCast: false, reason: `Cannot cast spells while wearing ${equippedArmor.name} (not proficient)` };
                }
            }

            // Check equipped shield for proficiency (shields also block casting if not proficient)
            const equippedShield = state.inventory.find(i => i.type === 'shield' && i.equipped === 'offHand');
            if (equippedShield && !CLASS_PROFICIENCIES.shields) {
                return { canCast: false, reason: `Cannot cast spells while using ${equippedShield.name} (not proficient)` };
            }

            return { canCast: true };
        }

        function equipToSlot(itemId, slot) {
            saveForUndo();
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            // Check if a two-handed weapon is currently equipped and we're replacing either hand
            if (slot === 'mainHand' || slot === 'offHand') {
                const twoHandedEquipped = state.inventory.find(i =>
                    i.equipped === 'twoHanded' || (i.equipped === 'mainHand' && i.hands === 'two')
                );
                if (twoHandedEquipped) {
                    twoHandedEquipped.equipped = null; // Fully unequip two-handed weapon
                }
            }

            // Handle two-handed weapons
            if (item.hands === 'two') {
                // Unequip both hand slots (automatic - no confirmation per user preference)
                state.inventory.forEach(i => {
                    if (i.equipped === 'mainHand' || i.equipped === 'offHand' || i.equipped === 'twoHanded') {
                        i.equipped = null;
                    }
                });
                item.equipped = 'twoHanded'; // Special marker for two-handed
            } else {
                // Unequip current item in slot
                state.inventory.forEach(i => {
                    if (i.equipped === slot) i.equipped = null;
                });
                item.equipped = slot;
            }

            closeModal();
            renderInventory();
            updateAttackOptions();
            updateResistancesDisplay();
            saveState();
        }

        function unequipFromSlot(slot) {
            saveForUndo();
            // If clicking on either hand slot with a two-handed weapon, unequip it
            if (slot === 'mainHand' || slot === 'offHand') {
                const twoHandedEquipped = state.inventory.find(i => i.equipped === 'twoHanded');
                if (twoHandedEquipped) {
                    twoHandedEquipped.equipped = null;
                    closeModal();
                    renderInventory();
                    updateAttackOptions();
                    updateResistancesDisplay();
                    saveState();
                    return;
                }
            }
            state.inventory.forEach(item => {
                if (item.equipped === slot) item.equipped = null;
            });
            closeModal();
            renderInventory();
            updateAttackOptions();
            updateResistancesDisplay();
            saveState();
        }

        function showItemOptions(itemId) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            let body = '<div class="form-options">';

            // Check proficiency and add warnings
            let profWarning = null;
            if (item.type === 'weapon') {
                const profCheck = checkWeaponProficiency(item);
                if (!profCheck.proficient) profWarning = profCheck.warning;
            } else if (item.type === 'armor') {
                const profCheck = checkArmorProficiency(item);
                if (!profCheck.proficient) profWarning = profCheck.warning;
            }

            // Show proficiency warning if applicable
            if (profWarning) {
                body += `<div style="background: rgba(220,53,69,0.15); padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9em; color: var(--accent-red);">${profWarning}</div>`;
            }

            // Equip options based on item type
            if (item.type === 'weapon') {
                body += `<div class="form-option" onclick="equipToSlot('${itemId}', 'mainHand')">
                    <div class="form-option-title">‚öîÔ∏è Equip to Main Hand</div>
                </div>`;
                if (item.hands === 'one') {
                    body += `<div class="form-option" onclick="equipToSlot('${itemId}', 'offHand')">
                        <div class="form-option-title">üõ°Ô∏è Equip to Off Hand</div>
                    </div>`;
                }
            } else if (item.type === 'shield') {
                body += `<div class="form-option" onclick="equipToSlot('${itemId}', 'offHand')">
                    <div class="form-option-title">üõ°Ô∏è Equip Shield</div>
                </div>`;
            } else if (item.type === 'armor') {
                body += `<div class="form-option" onclick="equipToSlot('${itemId}', 'armor')">
                    <div class="form-option-title">üõ°Ô∏è Equip Armor</div>
                </div>`;
            }

            // Info
            body += `<hr style="border-color: var(--border-color); margin: 10px 0;">`;
            body += `<div style="padding: 10px; font-size: 0.9em;">`;
            body += `<strong>${item.name}</strong><br>`;
            if (item.type === 'weapon') {
                const cat = item.category ? item.category.charAt(0).toUpperCase() + item.category.slice(1) : 'Unknown';
                const profCheck = checkWeaponProficiency(item);
                body += `Category: ${cat} ${profCheck.proficient ? '<span style="color:var(--accent-green);">‚úì</span>' : '<span style="color:var(--accent-red);">‚úó</span>'}<br>`;
                body += `Damage: ${item.damageDie} ${item.damageType}<br>`;
                body += `Type: ${item.weaponType}, ${item.hands}-handed<br>`;
                if (item.range) body += `Range: ${item.range} ft<br>`;
                if (item.properties) body += `Properties: ${item.properties.join(', ')}`;
            } else if (item.type === 'armor') {
                body += `AC: ${item.baseAC} + DEX (max ${item.maxDex})<br>`;
                body += `Type: ${item.armorType}`;
            } else if (item.type === 'shield') {
                body += `AC Bonus: +${item.acBonus}`;
                if (item.magicBonus) body += ` (+${item.magicBonus} magic)`;
            }
            if (item.isMagic) {
                body += `<br><span style="color: var(--accent-purple);">‚ú¶ Magic Item</span>`;
                if (item.requiresAttunement) body += ` <span style="color: var(--text-muted);">(Attunement)</span>`;

                // Show attack/damage bonuses for weapons
                if (item.type === 'weapon' && (item.attackBonus || item.damageBonus)) {
                    body += `<br>+${item.attackBonus || 0} attack, +${item.damageBonus || 0} damage`;
                }

                // Show magic bonus for armor
                if (item.type === 'armor' && item.magicBonus) {
                    body += `<br>+${item.magicBonus} AC bonus`;
                }

                // Display effects
                if (item.effects && item.effects.length > 0) {
                    body += `<br><div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color);">`;
                    body += `<strong style="color: var(--accent-purple);">Effects:</strong>`;
                    item.effects.forEach(effect => {
                        const desc = getEffectDescription(effect);
                        const info = EFFECT_TYPES[effect.type] || { icon: '‚ú¶' };
                        body += `<br><span style="color: var(--text-secondary);">${info.icon} ${desc}</span>`;
                    });
                    body += `</div>`;
                }

                // Legacy: show old effect text if present
                if (item.effect) {
                    body += `<br><span style="color: var(--text-secondary);">${item.effect}</span>`;
                }
            }
            body += `</div>`;

            // Edit and Delete buttons
            body += `<div style="display: flex; gap: 10px; margin-top: 15px; padding: 0 10px 10px 10px;">`;
            body += `<button onclick="editInventoryItem('${itemId}')" style="flex: 1; padding: 12px; background: var(--accent-purple); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">‚úèÔ∏è Edit</button>`;
            body += `<button onclick="deleteInventoryItem('${itemId}'); closeModal();" style="padding: 12px; background: var(--accent-red); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">üóëÔ∏è</button>`;
            body += `</div>`;

            body += '</div>';
            showModal(item.name, body);
        }

        function editInventoryItem(itemId) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            switch(item.type) {
                case 'weapon':
                    editWeapon(itemId);
                    break;
                case 'armor':
                    editArmor(itemId);
                    break;
                case 'shield':
                    editShield(itemId);
                    break;
                case 'accessory':
                    editAccessory(itemId);
                    break;
                default:
                    alert('Unknown item type');
            }
        }

        function deleteInventoryItem(itemId) {
            if (!confirm('Delete this item?')) return;
            saveForUndo();
            state.inventory = state.inventory.filter(item => item.id !== itemId);
            closeModal();
            renderInventory();
            updateAttackOptions();
            saveState();
        }

        function updateAttackOptions() {
            // This will update the attack menu to reflect equipped weapons
            // Called when weapons are equipped/unequipped
        }

        function updateResistancesDisplay() {
            const display = document.getElementById('resistancesDisplay');
            if (!display) return;

            // Base character resistances (Half-Aasimar/Half-Tiefling heritage)
            const baseResistances = ['necrotic', 'radiant'];

            // Collect all effects from equipped magic items
            const itemResistances = [];
            const immunities = [];
            const conditionImmunities = [];

            if (state.inventory) {
                state.inventory.forEach(item => {
                    if (!item.equipped || !item.isMagic || !item.effects) return;

                    item.effects.forEach(effect => {
                        switch(effect.type) {
                            case 'resistance':
                                if (!itemResistances.includes(effect.damageType) && !baseResistances.includes(effect.damageType)) {
                                    itemResistances.push(effect.damageType);
                                }
                                break;
                            case 'immunity':
                                if (!immunities.includes(effect.damageType)) {
                                    immunities.push(effect.damageType);
                                }
                                break;
                            case 'conditionImmunity':
                                if (!conditionImmunities.includes(effect.condition)) {
                                    conditionImmunities.push(effect.condition);
                                }
                                break;
                        }
                    });
                });
            }

            let html = '<div class="resistance-tags">';

            // Base character resistances (always shown)
            baseResistances.forEach(r => {
                html += `<span class="resistance-tag">Resist ${r}</span>`;
            });

            // Item resistances
            itemResistances.forEach(r => {
                html += `<span class="resistance-tag" style="border-color: var(--accent-purple); background: rgba(123, 104, 238, 0.15);">Resist ${r} ‚ú¶</span>`;
            });

            // Damage Immunities
            immunities.forEach(i => {
                html += `<span class="resistance-tag immunity-tag">Immune ${i}</span>`;
            });

            // Condition Immunities
            conditionImmunities.forEach(c => {
                html += `<span class="resistance-tag immunity-tag">Immune ${c}</span>`;
            });

            html += '</div>';
            display.innerHTML = html;
        }

        // Add Equipment Modal
        function openAddEquipmentModal() {
            const body = `
                <div class="form-options">
                    <div class="form-option" onclick="openAddWeaponForm()">
                        <div class="form-option-title">‚öîÔ∏è Add Weapon</div>
                        <div class="form-option-desc">Melee, ranged, or thrown weapons</div>
                    </div>
                    <div class="form-option" onclick="openAddArmorForm()">
                        <div class="form-option-title">üõ°Ô∏è Add Armor</div>
                        <div class="form-option-desc">Body armor (light, medium, heavy)</div>
                    </div>
                    <div class="form-option" onclick="openAddShieldForm()">
                        <div class="form-option-title">üõ°Ô∏è Add Shield</div>
                        <div class="form-option-desc">Shields and bucklers</div>
                    </div>
                    <div class="form-option" onclick="openAddAccessoryForm()">
                        <div class="form-option-title">üíç Add Accessory</div>
                        <div class="form-option-desc">Rings, amulets, boots, etc.</div>
                    </div>
                </div>
            `;
            showModal('Add Equipment', body);
        }

        // ===== MAGIC ITEM EFFECTS SYSTEM =====
        const EFFECT_TYPES = {
            resistance: { icon: 'üõ°Ô∏è', label: 'Damage Resistance' },
            immunity: { icon: '‚≠ê', label: 'Damage Immunity' },
            conditionImmunity: { icon: '‚ú®', label: 'Condition Immunity' },
            extraDamage: { icon: '‚öîÔ∏è', label: 'Extra Damage' },
            extraDamageVs: { icon: 'üéØ', label: 'Extra Damage vs Creature Type' },
            speed: { icon: 'üí®', label: 'Movement Speed' },
            advantage: { icon: 'üé≤', label: 'Advantage on Checks' },
            light: { icon: 'üí°', label: 'Light Source' },
            darkvision: { icon: 'üëÅÔ∏è', label: 'Darkvision' },
            charges: { icon: '‚ö°', label: 'Charges (with spells)' },
            spell: { icon: '‚ú®', label: 'Grants Spell (at-will or 1/day)' },
            description: { icon: 'üìú', label: 'Description/Flavor' }
        };

        const DAMAGE_TYPES = ['Acid', 'Cold', 'Fire', 'Force', 'Lightning', 'Necrotic', 'Poison', 'Psychic', 'Radiant', 'Thunder', 'Bludgeoning', 'Piercing', 'Slashing'];
        const CONDITIONS = ['Blinded', 'Charmed', 'Deafened', 'Frightened', 'Grappled', 'Paralyzed', 'Petrified', 'Poisoned', 'Prone', 'Restrained', 'Stunned', 'Unconscious'];
        const CREATURE_TYPES = ['Aberrations', 'Beasts', 'Celestials', 'Constructs', 'Dragons', 'Elementals', 'Fey', 'Fiends', 'Giants', 'Monstrosities', 'Oozes', 'Plants', 'Undead'];
        const SPEED_TYPES = ['Walking', 'Flying', 'Swimming', 'Climbing', 'Burrowing'];

        // Common spells that magic items can grant
        const ITEM_SPELLS = [
            { name: 'Detect Magic', level: 1 },
            { name: 'Shield', level: 1 },
            { name: 'Feather Fall', level: 1 },
            { name: 'Healing Word', level: 1 },
            { name: 'Cure Wounds', level: 1 },
            { name: 'Invisibility', level: 2 },
            { name: 'Levitate', level: 2 },
            { name: 'Misty Step', level: 2 },
            { name: 'Darkness', level: 2 },
            { name: 'Spider Climb', level: 2 },
            { name: 'Fly', level: 3 },
            { name: 'Fireball', level: 3 },
            { name: 'Lightning Bolt', level: 3 },
            { name: 'Dispel Magic', level: 3 },
            { name: 'Revivify', level: 3 },
            { name: 'Greater Invisibility', level: 4 },
            { name: 'Polymorph', level: 4 },
            { name: 'Wall of Fire', level: 4 },
            { name: 'Raise Dead', level: 5 },
            { name: 'Teleportation Circle', level: 5 },
            { name: 'Other (Custom)', level: 0 }
        ];

        // Temporary storage for effects being added to items
        let tempEffects = { weapon: [], armor: [], shield: [], accessory: [] };

        function showAddEffectForm(itemType) {
            const formEl = document.getElementById(itemType + 'EffectForm');
            if (!formEl) return;

            formEl.style.display = 'block';
            formEl.innerHTML = `
                <div class="effect-form">
                    <label>Effect Type</label>
                    <select id="${itemType}EffectType" onchange="updateEffectOptions('${itemType}')">
                        <option value="">Select effect type...</option>
                        ${Object.entries(EFFECT_TYPES).map(([key, val]) =>
                            `<option value="${key}">${val.icon} ${val.label}</option>`
                        ).join('')}
                    </select>
                    <div id="${itemType}EffectOptions"></div>
                    <div class="effect-form-buttons">
                        <button onclick="cancelAddEffect('${itemType}')" style="background: var(--bg-card);">Cancel</button>
                        <button onclick="confirmAddEffect('${itemType}')" style="background: var(--accent-green);">Add</button>
                    </div>
                </div>
            `;
        }

        function updateEffectOptions(itemType) {
            const effectType = document.getElementById(itemType + 'EffectType').value;
            const optionsEl = document.getElementById(itemType + 'EffectOptions');
            if (!optionsEl) return;

            let html = '';
            switch(effectType) {
                case 'resistance':
                case 'immunity':
                    html = `
                        <label style="margin-top:8px;">Damage Type</label>
                        <select id="${itemType}EffectValue">
                            ${DAMAGE_TYPES.map(t => `<option value="${t.toLowerCase()}">${t}</option>`).join('')}
                        </select>`;
                    break;
                case 'conditionImmunity':
                    html = `
                        <label style="margin-top:8px;">Condition</label>
                        <select id="${itemType}EffectValue">
                            ${CONDITIONS.map(c => `<option value="${c.toLowerCase()}">${c}</option>`).join('')}
                        </select>`;
                    break;
                case 'extraDamage':
                    html = `
                        <div class="effect-form-row">
                            <div>
                                <label>Dice</label>
                                <select id="${itemType}EffectDice">
                                    <option value="1d4">1d4</option>
                                    <option value="1d6">1d6</option>
                                    <option value="2d6" selected>2d6</option>
                                    <option value="1d8">1d8</option>
                                    <option value="2d8">2d8</option>
                                    <option value="1d10">1d10</option>
                                    <option value="2d10">2d10</option>
                                </select>
                            </div>
                            <div>
                                <label>Damage Type</label>
                                <select id="${itemType}EffectValue">
                                    ${DAMAGE_TYPES.map(t => `<option value="${t.toLowerCase()}">${t}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="effect-form-row" style="margin-top:8px;">
                            <div>
                                <label>Save DC (optional)</label>
                                <select id="${itemType}EffectSaveDC" onchange="toggleExtraDamageDC('${itemType}')">
                                    <option value="">No save (automatic)</option>
                                    <option value="character">Character's DC (15)</option>
                                    <option value="STR">STR save</option>
                                    <option value="DEX">DEX save</option>
                                    <option value="CON">CON save</option>
                                    <option value="custom">Custom DC...</option>
                                </select>
                            </div>
                            <div id="${itemType}ExtraDmgDCInput" style="display:none;">
                                <label>DC Value</label>
                                <input type="number" id="${itemType}EffectCustomDC" value="15" min="1" max="30" style="width:60px;">
                            </div>
                        </div>
                        <div id="${itemType}ExtraDmgSaveEffect" style="display:none; margin-top:8px;">
                            <label>On Save</label>
                            <select id="${itemType}EffectOnSave">
                                <option value="half">Half damage</option>
                                <option value="none">No damage</option>
                            </select>
                        </div>
                        <label style="margin-top:8px;">Activation</label>
                        <select id="${itemType}EffectActivation">
                            <option value="always">Always Active</option>
                            <option value="bonusAction">Bonus Action (Command Word)</option>
                        </select>`;
                    break;
                case 'extraDamageVs':
                    html = `
                        <div class="effect-form-row">
                            <div>
                                <label>Dice</label>
                                <select id="${itemType}EffectDice">
                                    <option value="1d6">1d6</option>
                                    <option value="2d6">2d6</option>
                                    <option value="3d6" selected>3d6</option>
                                </select>
                            </div>
                            <div>
                                <label>Creature Type</label>
                                <select id="${itemType}EffectValue">
                                    ${CREATURE_TYPES.map(c => `<option value="${c.toLowerCase()}">${c}</option>`).join('')}
                                </select>
                            </div>
                        </div>`;
                    break;
                case 'speed':
                    html = `
                        <div class="effect-form-row">
                            <div>
                                <label>Speed Type</label>
                                <select id="${itemType}EffectValue">
                                    ${SPEED_TYPES.map(s => `<option value="${s.toLowerCase()}">${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label>Speed (ft)</label>
                                <input type="number" id="${itemType}EffectAmount" value="30" min="5" step="5">
                            </div>
                        </div>`;
                    break;
                case 'advantage':
                    html = `
                        <label style="margin-top:8px;">Advantage On</label>
                        <select id="${itemType}EffectValue">
                            <option value="stealthChecks">Stealth Checks</option>
                            <option value="perceptionChecks">Perception Checks</option>
                            <option value="initiativeRolls">Initiative Rolls</option>
                            <option value="savesVsSpells">Saving Throws vs Spells</option>
                            <option value="savesVsMagic">Saving Throws vs Magic</option>
                            <option value="savesVsFrightened">Saving Throws vs Frightened</option>
                            <option value="savesVsCharmed">Saving Throws vs Charmed</option>
                        </select>`;
                    break;
                case 'light':
                    html = `
                        <div class="effect-form-row">
                            <div>
                                <label>Bright (ft)</label>
                                <input type="number" id="${itemType}EffectBright" value="20" min="0" step="5">
                            </div>
                            <div>
                                <label>Dim (ft)</label>
                                <input type="number" id="${itemType}EffectDim" value="20" min="0" step="5">
                            </div>
                        </div>
                        <label style="margin-top:8px;">Activation</label>
                        <select id="${itemType}EffectActivation">
                            <option value="always">Always On</option>
                            <option value="bonusAction">Bonus Action Toggle</option>
                        </select>`;
                    break;
                case 'darkvision':
                    html = `
                        <label style="margin-top:8px;">Range (ft)</label>
                        <select id="${itemType}EffectValue">
                            <option value="60">60 ft</option>
                            <option value="120">120 ft</option>
                        </select>`;
                    break;
                case 'description':
                    html = `
                        <label style="margin-top:8px;">Description</label>
                        <input type="text" id="${itemType}EffectValue" placeholder="e.g., Glows faintly in darkness">`;
                    break;
                case 'charges':
                    html = `
                        <div class="effect-form-row">
                            <div>
                                <label>Max Charges</label>
                                <input type="number" id="${itemType}EffectMaxCharges" value="7" min="1" max="50">
                            </div>
                            <div>
                                <label>Recharge</label>
                                <select id="${itemType}EffectRecharge" onchange="updateRechargeOptions('${itemType}')">
                                    <option value="dawn">At Dawn</option>
                                    <option value="dusk">At Dusk</option>
                                    <option value="longRest">Long Rest</option>
                                    <option value="shortRest">Short Rest</option>
                                    <option value="never">Never</option>
                                </select>
                            </div>
                        </div>
                        <div id="${itemType}RechargeOptions">
                            <div class="effect-form-row" style="margin-top:8px;">
                                <div>
                                    <label>Recharge Dice</label>
                                    <select id="${itemType}EffectRechargeDice">
                                        <option value="1d4+1">1d4+1</option>
                                        <option value="1d6+1" selected>1d6+1</option>
                                        <option value="1d8+1">1d8+1</option>
                                        <option value="2d4">2d4</option>
                                        <option value="all">Full Recharge</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Break Chance</label>
                                    <select id="${itemType}EffectBreakChance">
                                        <option value="0">Never Breaks</option>
                                        <option value="1">On 1 (crumbles)</option>
                                        <option value="5">On 1-5 (5%)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <label style="margin-top:12px;">Spells (click to add)</label>
                        <div id="${itemType}ChargeSpellsList" style="margin-bottom:8px; font-size:0.9em;"></div>
                        <div class="effect-form-row">
                            <div style="flex:2;">
                                <select id="${itemType}ChargeSpellSelect" onchange="toggleChargeCustomSpell('${itemType}')">
                                    ${ITEM_SPELLS.map(s => `<option value="${s.name}">${s.name} (${s.level === 0 ? 'Cantrip' : 'Lvl ' + s.level})</option>`).join('')}
                                    <option value="custom">‚ú® Custom Spell...</option>
                                </select>
                            </div>
                            <div style="flex:1;">
                                <input type="number" id="${itemType}ChargeSpellCost" value="1" min="1" max="10" placeholder="Cost">
                            </div>
                            <div>
                                <button type="button" onclick="addChargeSpell('${itemType}')" style="padding:8px 12px; background:var(--accent-green);">+</button>
                            </div>
                        </div>
                        <div id="${itemType}ChargeCustomSpellForm" style="display:none; margin-top:10px; padding:12px; background:rgba(100,149,237,0.1); border-radius:8px;">
                            <div style="color:var(--accent-blue); font-weight:bold; margin-bottom:10px;">Custom Spell Details</div>
                            <div class="form-group">
                                <label>Spell Name</label>
                                <input type="text" id="${itemType}ChargeCustomName" placeholder="Enter spell name">
                            </div>
                            <div class="effect-form-row" style="margin-top:8px;">
                                <div>
                                    <label>Level</label>
                                    <select id="${itemType}ChargeCustomLevel">
                                        <option value="0">Cantrip</option>
                                        <option value="1" selected>1st</option>
                                        <option value="2">2nd</option>
                                        <option value="3">3rd</option>
                                        <option value="4">4th</option>
                                        <option value="5">5th</option>
                                        <option value="6">6th</option>
                                        <option value="7">7th</option>
                                        <option value="8">8th</option>
                                        <option value="9">9th</option>
                                    </select>
                                </div>
                                <div>
                                    <label>School</label>
                                    <select id="${itemType}ChargeCustomSchool">
                                        <option value="Abjuration">Abjuration</option>
                                        <option value="Conjuration">Conjuration</option>
                                        <option value="Divination">Divination</option>
                                        <option value="Enchantment">Enchantment</option>
                                        <option value="Evocation">Evocation</option>
                                        <option value="Illusion">Illusion</option>
                                        <option value="Necromancy">Necromancy</option>
                                        <option value="Transmutation">Transmutation</option>
                                    </select>
                                </div>
                            </div>
                            <div class="effect-form-row" style="margin-top:8px;">
                                <div>
                                    <label>Casting Time</label>
                                    <select id="${itemType}ChargeCustomTime">
                                        <option value="Action">Action</option>
                                        <option value="Bonus Action">Bonus Action</option>
                                        <option value="Reaction">Reaction</option>
                                        <option value="1 Minute">1 Minute</option>
                                        <option value="10 Minutes">10 Minutes</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Range</label>
                                    <select id="${itemType}ChargeCustomRange" onchange="toggleChargeCustomRange('${itemType}')">
                                        <option value="Self">Self</option>
                                        <option value="Touch">Touch</option>
                                        <option value="30 feet">30 feet</option>
                                        <option value="60 feet">60 feet</option>
                                        <option value="90 feet">90 feet</option>
                                        <option value="120 feet">120 feet</option>
                                        <option value="Sight">Sight</option>
                                        <option value="custom">Other...</option>
                                    </select>
                                    <input type="number" id="${itemType}ChargeCustomRangeFeet" placeholder="feet" style="display:none; margin-top:5px; width:80px;" min="5" step="5">
                                </div>
                            </div>
                            <div class="effect-form-row" style="margin-top:8px;">
                                <div>
                                    <label>Duration</label>
                                    <select id="${itemType}ChargeCustomDuration">
                                        <option value="Instantaneous">Instantaneous</option>
                                        <option value="1 round">1 round</option>
                                        <option value="1 minute">1 minute</option>
                                        <option value="10 minutes">10 minutes</option>
                                        <option value="1 hour">1 hour</option>
                                        <option value="8 hours">8 hours</option>
                                        <option value="24 hours">24 hours</option>
                                        <option value="Until dispelled">Until dispelled</option>
                                        <option value="Special">Special</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Area (optional)</label>
                                    <div style="display:flex; gap:5px;">
                                        <select id="${itemType}ChargeCustomAreaShape" style="flex:1;">
                                            <option value="">None</option>
                                            <option value="Sphere">Sphere</option>
                                            <option value="Cube">Cube</option>
                                            <option value="Cone">Cone</option>
                                            <option value="Line">Line</option>
                                            <option value="Cylinder">Cylinder</option>
                                        </select>
                                        <input type="number" id="${itemType}ChargeCustomAreaSize" placeholder="ft" style="width:50px;" min="5" step="5">
                                    </div>
                                </div>
                            </div>
                            <div class="effect-form-row" style="margin-top:8px;">
                                <div style="display:flex; gap:15px; align-items:center;">
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}ChargeCustomConc" style="width:18px; height:18px;">
                                        <span>Concentration</span>
                                    </label>
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}ChargeCustomRitual" style="width:18px; height:18px;">
                                        <span>Ritual</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top:8px;">
                                <label>Components</label>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}ChargeCustomV" checked style="width:18px; height:18px;">
                                        <span>V</span>
                                    </label>
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}ChargeCustomS" checked style="width:18px; height:18px;">
                                        <span>S</span>
                                    </label>
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}ChargeCustomM" style="width:18px; height:18px;" onchange="toggleChargeCustomMaterial('${itemType}')">
                                        <span>M</span>
                                    </label>
                                </div>
                                <input type="text" id="${itemType}ChargeCustomMaterial" placeholder="Material component details" style="margin-top:5px; display:none;">
                            </div>
                            <div class="effect-form-row" style="margin-top:8px;">
                                <div>
                                    <label>Damage/Healing</label>
                                    <input type="text" id="${itemType}ChargeCustomDamage" placeholder="e.g., 8d6 fire">
                                </div>
                                <div>
                                    <label>Save DC</label>
                                    <select id="${itemType}ChargeCustomSave" onchange="toggleChargeCustomDC('${itemType}')">
                                        <option value="">None</option>
                                        <option value="character">Character's DC (15)</option>
                                        <option value="STR">STR save</option>
                                        <option value="DEX">DEX save</option>
                                        <option value="CON">CON save</option>
                                        <option value="INT">INT save</option>
                                        <option value="WIS">WIS save</option>
                                        <option value="CHA">CHA save</option>
                                        <option value="custom">Custom DC...</option>
                                    </select>
                                    <input type="number" id="${itemType}ChargeCustomDCValue" placeholder="DC" style="display:none; margin-top:5px; width:60px;" min="1" max="30">
                                </div>
                            </div>
                            <div class="form-group" style="margin-top:8px;">
                                <label>Description</label>
                                <textarea id="${itemType}ChargeCustomDesc" rows="3" placeholder="Full spell description..."></textarea>
                            </div>
                            <div class="form-group" style="margin-top:8px;">
                                <label>Upcast Scaling (optional)</label>
                                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                                    <input type="text" id="${itemType}ChargeCustomUpcastDice" placeholder="Extra dice" style="width:80px;">
                                    <span style="color:var(--text-muted);">per</span>
                                    <select id="${itemType}ChargeCustomUpcastInterval" style="width:100px;">
                                        <option value="1">1 level</option>
                                        <option value="2">2 levels</option>
                                    </select>
                                    <span style="color:var(--text-muted);">above base</span>
                                </div>
                                <div style="font-size:0.8em; color:var(--text-muted); margin-top:4px;">e.g., "1d6" per 1 level = +1d6 at 2nd, +2d6 at 3rd...</div>
                            </div>
                        </div>`;
                    // Initialize empty spell list for this item
                    setTimeout(() => { if (!window.tempChargeSpells) window.tempChargeSpells = {}; window.tempChargeSpells[itemType] = []; }, 0);
                    break;
                case 'spell':
                    html = `
                        <label style="margin-top:8px;">Spell</label>
                        <select id="${itemType}EffectSpell" onchange="toggleCustomSpellForm('${itemType}')">
                            ${ITEM_SPELLS.map(s => `<option value="${s.name}" data-level="${s.level}">${s.name} (${s.level === 0 ? 'Cantrip' : 'Lvl ' + s.level})</option>`).join('')}
                        </select>
                        <div id="${itemType}CustomSpellForm" style="display:none; margin-top:12px; padding:12px; background:rgba(100,149,237,0.1); border-radius:8px;">
                            <div style="color:var(--accent-blue); font-weight:bold; margin-bottom:10px;">Custom Spell Details</div>
                            <div class="form-group">
                                <label>Spell Name</label>
                                <input type="text" id="${itemType}CustomSpellName" placeholder="Enter spell name">
                            </div>
                            <div class="effect-form-row">
                                <div>
                                    <label>School</label>
                                    <select id="${itemType}CustomSpellSchool">
                                        <option value="Abjuration">Abjuration</option>
                                        <option value="Conjuration">Conjuration</option>
                                        <option value="Divination">Divination</option>
                                        <option value="Enchantment">Enchantment</option>
                                        <option value="Evocation">Evocation</option>
                                        <option value="Illusion">Illusion</option>
                                        <option value="Necromancy">Necromancy</option>
                                        <option value="Transmutation">Transmutation</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Casting Time</label>
                                    <select id="${itemType}CustomSpellTime">
                                        <option value="Action">Action</option>
                                        <option value="Bonus Action">Bonus Action</option>
                                        <option value="Reaction">Reaction</option>
                                        <option value="1 Minute">1 Minute</option>
                                        <option value="10 Minutes">10 Minutes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="effect-form-row" style="margin-top:8px;">
                                <div>
                                    <label>Range</label>
                                    <select id="${itemType}CustomSpellRange" onchange="toggleCustomRange('${itemType}')">
                                        <option value="Self">Self</option>
                                        <option value="Touch">Touch</option>
                                        <option value="30 feet">30 feet</option>
                                        <option value="60 feet">60 feet</option>
                                        <option value="90 feet">90 feet</option>
                                        <option value="120 feet">120 feet</option>
                                        <option value="Sight">Sight</option>
                                        <option value="custom">Other...</option>
                                    </select>
                                    <input type="number" id="${itemType}CustomSpellRangeFeet" placeholder="feet" style="display:none; margin-top:5px; width:80px;" min="5" step="5">
                                </div>
                                <div>
                                    <label>Duration</label>
                                    <select id="${itemType}CustomSpellDuration">
                                        <option value="Instantaneous">Instantaneous</option>
                                        <option value="1 round">1 round</option>
                                        <option value="1 minute">1 minute</option>
                                        <option value="10 minutes">10 minutes</option>
                                        <option value="1 hour">1 hour</option>
                                        <option value="8 hours">8 hours</option>
                                        <option value="24 hours">24 hours</option>
                                        <option value="Until dispelled">Until dispelled</option>
                                        <option value="Special">Special</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top:8px;">
                                <label>Area of Effect (optional)</label>
                                <div class="effect-form-row">
                                    <select id="${itemType}CustomSpellAreaShape">
                                        <option value="">No area</option>
                                        <option value="Sphere">Sphere</option>
                                        <option value="Cube">Cube</option>
                                        <option value="Cone">Cone</option>
                                        <option value="Line">Line</option>
                                        <option value="Cylinder">Cylinder</option>
                                    </select>
                                    <input type="number" id="${itemType}CustomSpellAreaSize" placeholder="Size (ft)" style="width:80px;" min="5" step="5">
                                </div>
                            </div>
                            <div class="effect-form-row" style="margin-top:8px;">
                                <div style="display:flex; gap:10px; align-items:center;">
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}CustomSpellConc" style="width:18px; height:18px;">
                                        <span>Concentration</span>
                                    </label>
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}CustomSpellRitual" style="width:18px; height:18px;">
                                        <span>Ritual</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top:8px;">
                                <label>Components</label>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}CustomSpellV" checked style="width:18px; height:18px;">
                                        <span>V</span>
                                    </label>
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}CustomSpellS" checked style="width:18px; height:18px;">
                                        <span>S</span>
                                    </label>
                                    <label style="display:flex; gap:5px; align-items:center; cursor:pointer;">
                                        <input type="checkbox" id="${itemType}CustomSpellM" style="width:18px; height:18px;">
                                        <span>M</span>
                                    </label>
                                </div>
                                <input type="text" id="${itemType}CustomSpellMaterial" placeholder="Material component details (if M)" style="margin-top:5px; display:none;">
                            </div>
                            <div class="effect-form-row" style="margin-top:8px;">
                                <div>
                                    <label>Damage/Healing</label>
                                    <input type="text" id="${itemType}CustomSpellDamage" placeholder="e.g., 8d6 fire">
                                </div>
                                <div>
                                    <label>Save DC</label>
                                    <select id="${itemType}CustomSpellSave" onchange="toggleCustomDC('${itemType}')">
                                        <option value="">None</option>
                                        <option value="character">Character's DC (15)</option>
                                        <option value="STR">STR save</option>
                                        <option value="DEX">DEX save</option>
                                        <option value="CON">CON save</option>
                                        <option value="INT">INT save</option>
                                        <option value="WIS">WIS save</option>
                                        <option value="CHA">CHA save</option>
                                        <option value="custom">Custom DC...</option>
                                    </select>
                                    <input type="number" id="${itemType}CustomSpellDCValue" placeholder="DC" style="display:none; margin-top:5px; width:60px;" min="1" max="30">
                                </div>
                            </div>
                            <div class="form-group" style="margin-top:8px;">
                                <label>Description</label>
                                <textarea id="${itemType}CustomSpellDesc" rows="3" placeholder="Full spell description..."></textarea>
                            </div>
                            <div class="form-group" style="margin-top:8px;">
                                <label>Upcast Scaling (optional)</label>
                                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                                    <input type="text" id="${itemType}CustomSpellUpcastDice" placeholder="Extra dice" style="width:80px;">
                                    <span style="color:var(--text-muted);">per</span>
                                    <select id="${itemType}CustomSpellUpcastInterval" style="width:100px;">
                                        <option value="1">1 level</option>
                                        <option value="2">2 levels</option>
                                    </select>
                                    <span style="color:var(--text-muted);">above base</span>
                                </div>
                                <div style="font-size:0.8em; color:var(--text-muted); margin-top:4px;">e.g., "1d6" per 1 level = +1d6 at 2nd, +2d6 at 3rd...</div>
                            </div>
                        </div>
                        <div class="effect-form-row" style="margin-top:8px;">
                            <div>
                                <label>Spell Level</label>
                                <select id="${itemType}EffectSpellLevel">
                                    <option value="0">Cantrip</option>
                                    <option value="1" selected>1st</option>
                                    <option value="2">2nd</option>
                                    <option value="3">3rd</option>
                                    <option value="4">4th</option>
                                    <option value="5">5th</option>
                                </select>
                            </div>
                            <div>
                                <label>Usage</label>
                                <select id="${itemType}EffectSpellUsage">
                                    <option value="atWill">At Will</option>
                                    <option value="1/day" selected>1/Day</option>
                                    <option value="2/day">2/Day</option>
                                    <option value="3/day">3/Day</option>
                                </select>
                            </div>
                        </div>
                        <label style="margin-top:8px;">Spellcasting Ability (for save DC)</label>
                        <select id="${itemType}EffectSpellAbility">
                            <option value="item">Item's DC (use item DC)</option>
                            <option value="wis">Wisdom (your DC)</option>
                            <option value="int">Intelligence (your DC)</option>
                            <option value="cha">Charisma (your DC)</option>
                        </select>`;
                    // Set up material component toggle
                    setTimeout(() => {
                        const mCheckbox = document.getElementById(itemType + 'CustomSpellM');
                        const mInput = document.getElementById(itemType + 'CustomSpellMaterial');
                        if (mCheckbox && mInput) {
                            mCheckbox.addEventListener('change', () => {
                                mInput.style.display = mCheckbox.checked ? 'block' : 'none';
                            });
                        }
                    }, 50);
                    break;
            }
            optionsEl.innerHTML = html;
        }

        function confirmAddEffect(itemType) {
            const effectType = document.getElementById(itemType + 'EffectType').value;
            if (!effectType) { alert('Please select an effect type'); return; }

            const effect = { type: effectType };

            switch(effectType) {
                case 'resistance':
                case 'immunity':
                    effect.damageType = document.getElementById(itemType + 'EffectValue').value;
                    break;
                case 'conditionImmunity':
                    effect.condition = document.getElementById(itemType + 'EffectValue').value;
                    break;
                case 'extraDamage':
                    effect.dice = document.getElementById(itemType + 'EffectDice').value;
                    effect.damageType = document.getElementById(itemType + 'EffectValue').value;
                    effect.activation = document.getElementById(itemType + 'EffectActivation').value;
                    const saveDC = document.getElementById(itemType + 'EffectSaveDC').value;
                    if (saveDC) {
                        effect.saveDC = saveDC;
                        if (saveDC === 'custom') {
                            effect.customDC = parseInt(document.getElementById(itemType + 'EffectCustomDC').value) || 15;
                        }
                        effect.onSave = document.getElementById(itemType + 'EffectOnSave').value;
                    }
                    break;
                case 'extraDamageVs':
                    effect.dice = document.getElementById(itemType + 'EffectDice').value;
                    effect.creatureType = document.getElementById(itemType + 'EffectValue').value;
                    break;
                case 'speed':
                    effect.speedType = document.getElementById(itemType + 'EffectValue').value;
                    effect.value = parseInt(document.getElementById(itemType + 'EffectAmount').value);
                    break;
                case 'advantage':
                    effect.on = document.getElementById(itemType + 'EffectValue').value;
                    break;
                case 'light':
                    effect.bright = parseInt(document.getElementById(itemType + 'EffectBright').value);
                    effect.dim = parseInt(document.getElementById(itemType + 'EffectDim').value);
                    effect.activation = document.getElementById(itemType + 'EffectActivation').value;
                    break;
                case 'darkvision':
                    effect.range = parseInt(document.getElementById(itemType + 'EffectValue').value);
                    break;
                case 'description':
                    effect.text = document.getElementById(itemType + 'EffectValue').value;
                    if (!effect.text) { alert('Please enter a description'); return; }
                    break;
                case 'charges':
                    effect.maxCharges = parseInt(document.getElementById(itemType + 'EffectMaxCharges').value);
                    effect.recharge = document.getElementById(itemType + 'EffectRecharge').value;
                    if (effect.recharge !== 'never') {
                        effect.rechargeDice = document.getElementById(itemType + 'EffectRechargeDice').value;
                        effect.breakChance = parseInt(document.getElementById(itemType + 'EffectBreakChance').value);
                    }
                    effect.spells = window.tempChargeSpells && window.tempChargeSpells[itemType] ? [...window.tempChargeSpells[itemType]] : [];
                    if (effect.spells.length === 0) {
                        alert('Please add at least one spell to use with charges');
                        return;
                    }
                    break;
                case 'spell':
                    const spellSelect = document.getElementById(itemType + 'EffectSpell');
                    const spellName = spellSelect.value;
                    if (spellName === 'Other (Custom)') {
                        effect.spell = document.getElementById(itemType + 'CustomSpellName').value;
                        if (!effect.spell) { alert('Please enter a custom spell name'); return; }
                        effect.isCustom = true;
                        // Get range value (handle custom feet input)
                        const rangeSelect = document.getElementById(itemType + 'CustomSpellRange').value;
                        const rangeFeet = document.getElementById(itemType + 'CustomSpellRangeFeet').value;
                        const rangeValue = rangeSelect === 'custom' && rangeFeet ? `${rangeFeet} feet` : rangeSelect;
                        // Get save DC (handle custom DC input)
                        const saveSelect = document.getElementById(itemType + 'CustomSpellSave').value;
                        const customDC = document.getElementById(itemType + 'CustomSpellDCValue').value;
                        // Get area effect
                        const areaShape = document.getElementById(itemType + 'CustomSpellAreaShape').value;
                        const areaSize = document.getElementById(itemType + 'CustomSpellAreaSize').value;
                        // Get upcast scaling
                        const upcastDice = document.getElementById(itemType + 'CustomSpellUpcastDice').value;
                        const upcastInterval = document.getElementById(itemType + 'CustomSpellUpcastInterval').value;
                        // Capture full custom spell details
                        effect.spellDetails = {
                            school: document.getElementById(itemType + 'CustomSpellSchool').value,
                            castingTime: document.getElementById(itemType + 'CustomSpellTime').value,
                            range: rangeValue,
                            duration: document.getElementById(itemType + 'CustomSpellDuration').value,
                            concentration: document.getElementById(itemType + 'CustomSpellConc').checked,
                            ritual: document.getElementById(itemType + 'CustomSpellRitual').checked,
                            components: {
                                v: document.getElementById(itemType + 'CustomSpellV').checked,
                                s: document.getElementById(itemType + 'CustomSpellS').checked,
                                m: document.getElementById(itemType + 'CustomSpellM').checked,
                                material: document.getElementById(itemType + 'CustomSpellMaterial').value || null
                            },
                            area: areaShape ? { shape: areaShape, size: parseInt(areaSize) || 0 } : null,
                            damage: document.getElementById(itemType + 'CustomSpellDamage').value || null,
                            save: saveSelect || null,
                            customDC: saveSelect === 'custom' && customDC ? parseInt(customDC) : null,
                            description: document.getElementById(itemType + 'CustomSpellDesc').value || null,
                            upcast: upcastDice ? { dice: upcastDice, interval: parseInt(upcastInterval) || 1 } : null
                        };
                    } else {
                        effect.spell = spellName;
                        effect.isCustom = false;
                    }
                    effect.spellLevel = parseInt(document.getElementById(itemType + 'EffectSpellLevel').value);
                    effect.usage = document.getElementById(itemType + 'EffectSpellUsage').value;
                    effect.ability = document.getElementById(itemType + 'EffectSpellAbility').value;
                    break;
            }

            tempEffects[itemType].push(effect);
            renderEffectsList(itemType);
            cancelAddEffect(itemType);
        }

        function cancelAddEffect(itemType) {
            const formEl = document.getElementById(itemType + 'EffectForm');
            if (formEl) formEl.style.display = 'none';
        }

        function removeEffect(itemType, index) {
            tempEffects[itemType].splice(index, 1);
            renderEffectsList(itemType);
        }

        function renderEffectsList(itemType) {
            const listEl = document.getElementById(itemType + 'EffectsList');
            if (!listEl) return;

            if (tempEffects[itemType].length === 0) {
                listEl.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85em; padding: 8px;">No effects added</div>';
                return;
            }

            listEl.innerHTML = tempEffects[itemType].map((effect, i) => {
                const info = EFFECT_TYPES[effect.type] || { icon: '‚ùì', label: effect.type };
                let desc = getEffectDescription(effect);
                return `
                    <div class="effect-item">
                        <span class="effect-icon">${info.icon}</span>
                        <span class="effect-text">${desc}</span>
                        <span class="effect-remove" onclick="removeEffect('${itemType}', ${i})">‚úï</span>
                    </div>
                `;
            }).join('');
        }

        function getEffectDescription(effect) {
            switch(effect.type) {
                case 'resistance': return `Resistance to ${effect.damageType} damage`;
                case 'immunity': return `Immunity to ${effect.damageType} damage`;
                case 'conditionImmunity': return `Immunity to ${effect.condition}`;
                case 'extraDamage':
                    let dmgDesc = `+${effect.dice} ${effect.damageType}`;
                    if (effect.saveDC) {
                        const dcVal = effect.saveDC === 'character' ? '15' : (effect.saveDC === 'custom' ? effect.customDC : effect.saveDC);
                        const saveType = effect.saveDC === 'character' || effect.saveDC === 'custom' ? '' : ` ${effect.saveDC}`;
                        dmgDesc += ` (DC ${dcVal}${saveType} save, ${effect.onSave === 'half' ? 'half on save' : 'none on save'})`;
                    }
                    return effect.activation === 'always' ? dmgDesc : `${dmgDesc} (command word)`;
                case 'extraDamageVs': return `+${effect.dice} damage vs ${effect.creatureType}`;
                case 'speed': return `${effect.speedType} speed ${effect.value} ft`;
                case 'advantage':
                    const advLabels = {
                        stealthChecks: 'Stealth checks',
                        perceptionChecks: 'Perception checks',
                        initiativeRolls: 'Initiative',
                        savesVsSpells: 'saves vs spells',
                        savesVsMagic: 'saves vs magic',
                        savesVsFrightened: 'saves vs frightened',
                        savesVsCharmed: 'saves vs charmed'
                    };
                    return `Advantage on ${advLabels[effect.on] || effect.on}`;
                case 'light':
                    return effect.activation === 'always'
                        ? `Light: ${effect.bright}/${effect.dim} ft`
                        : `Light: ${effect.bright}/${effect.dim} ft (toggle)`;
                case 'darkvision': return `Darkvision ${effect.range} ft`;
                case 'description': return effect.text;
                case 'charges':
                    const spellNames = effect.spells.map(s => s.name).join(', ');
                    const rechargeText = effect.recharge === 'never' ? 'no recharge' : `recharges at ${effect.recharge}`;
                    return `${effect.maxCharges} charges (${rechargeText}) - ${spellNames}`;
                case 'spell':
                    const usageText = effect.usage === 'atWill' ? 'at will' : effect.usage;
                    return `${effect.spell} (${usageText})`;
                default: return effect.type;
            }
        }

        // Helper functions for charges effect type
        function updateRechargeOptions(itemType) {
            const rechargeType = document.getElementById(itemType + 'EffectRecharge').value;
            const optionsEl = document.getElementById(itemType + 'RechargeOptions');
            if (optionsEl) {
                optionsEl.style.display = rechargeType === 'never' ? 'none' : 'block';
            }
        }

        function toggleChargeCustomSpell(itemType) {
            const spellSelect = document.getElementById(itemType + 'ChargeSpellSelect');
            const customForm = document.getElementById(itemType + 'ChargeCustomSpellForm');
            if (customForm) {
                customForm.style.display = spellSelect.value === 'custom' ? 'block' : 'none';
            }
        }

        function toggleChargeCustomRange(itemType) {
            const rangeSelect = document.getElementById(itemType + 'ChargeCustomRange');
            const rangeFeetInput = document.getElementById(itemType + 'ChargeCustomRangeFeet');
            if (rangeFeetInput) {
                rangeFeetInput.style.display = rangeSelect.value === 'custom' ? 'block' : 'none';
            }
        }

        function toggleChargeCustomMaterial(itemType) {
            const mCheckbox = document.getElementById(itemType + 'ChargeCustomM');
            const materialInput = document.getElementById(itemType + 'ChargeCustomMaterial');
            if (materialInput) {
                materialInput.style.display = mCheckbox.checked ? 'block' : 'none';
            }
        }

        function toggleChargeCustomDC(itemType) {
            const saveSelect = document.getElementById(itemType + 'ChargeCustomSave');
            const dcInput = document.getElementById(itemType + 'ChargeCustomDCValue');
            if (dcInput) {
                dcInput.style.display = saveSelect.value === 'custom' ? 'block' : 'none';
            }
        }

        function addChargeSpell(itemType) {
            const spellSelect = document.getElementById(itemType + 'ChargeSpellSelect');
            const costInput = document.getElementById(itemType + 'ChargeSpellCost');
            const spellValue = spellSelect.value;
            const cost = parseInt(costInput.value) || 1;

            if (!window.tempChargeSpells) window.tempChargeSpells = {};
            if (!window.tempChargeSpells[itemType]) window.tempChargeSpells[itemType] = [];

            let spellName, level, isCustom = false, customDetails = null;

            if (spellValue === 'custom') {
                // Handle custom spell
                spellName = document.getElementById(itemType + 'ChargeCustomName').value.trim();
                if (!spellName) {
                    alert('Please enter a custom spell name');
                    return;
                }
                level = parseInt(document.getElementById(itemType + 'ChargeCustomLevel').value);
                isCustom = true;

                // Get range (handle custom range)
                let range = document.getElementById(itemType + 'ChargeCustomRange').value;
                if (range === 'custom') {
                    const customFeet = document.getElementById(itemType + 'ChargeCustomRangeFeet').value;
                    range = customFeet ? customFeet + ' feet' : '30 feet';
                }

                // Build components string
                const compV = document.getElementById(itemType + 'ChargeCustomV').checked;
                const compS = document.getElementById(itemType + 'ChargeCustomS').checked;
                const compM = document.getElementById(itemType + 'ChargeCustomM').checked;
                let components = '';
                if (compV) components += 'V';
                if (compS) components += (components ? ', ' : '') + 'S';
                if (compM) components += (components ? ', ' : '') + 'M';
                const material = compM ? document.getElementById(itemType + 'ChargeCustomMaterial').value : null;

                // Get save DC
                let saveDC = document.getElementById(itemType + 'ChargeCustomSave').value || null;
                if (saveDC === 'custom') {
                    const customDC = document.getElementById(itemType + 'ChargeCustomDCValue').value;
                    saveDC = customDC ? 'DC ' + customDC : null;
                }

                // Get area of effect
                const areaShape = document.getElementById(itemType + 'ChargeCustomAreaShape').value;
                const areaSize = document.getElementById(itemType + 'ChargeCustomAreaSize').value;
                let area = null;
                if (areaShape && areaSize) {
                    area = areaSize + '-foot ' + areaShape;
                }

                // Get upcast scaling
                const upcastDice = document.getElementById(itemType + 'ChargeCustomUpcastDice').value;
                const upcastInterval = document.getElementById(itemType + 'ChargeCustomUpcastInterval').value;
                let upcast = null;
                if (upcastDice) {
                    upcast = { dice: upcastDice, perLevels: parseInt(upcastInterval) || 1 };
                }

                customDetails = {
                    school: document.getElementById(itemType + 'ChargeCustomSchool').value,
                    castingTime: document.getElementById(itemType + 'ChargeCustomTime').value,
                    range: range,
                    duration: document.getElementById(itemType + 'ChargeCustomDuration').value,
                    concentration: document.getElementById(itemType + 'ChargeCustomConc').checked,
                    ritual: document.getElementById(itemType + 'ChargeCustomRitual').checked,
                    components: components,
                    material: material,
                    damage: document.getElementById(itemType + 'ChargeCustomDamage').value || null,
                    save: saveDC,
                    area: area,
                    description: document.getElementById(itemType + 'ChargeCustomDesc').value || null,
                    upcast: upcast
                };
            } else {
                spellName = spellValue;
                // Get spell level from ITEM_SPELLS
                const spellData = ITEM_SPELLS.find(s => s.name === spellName);
                level = spellData ? spellData.level : 1;
            }

            // Check if spell already exists
            if (window.tempChargeSpells[itemType].find(s => s.name === spellName)) {
                alert('This spell is already added');
                return;
            }

            const spellEntry = { name: spellName, cost: cost, level: level };
            if (isCustom) {
                spellEntry.isCustom = true;
                spellEntry.customDetails = customDetails;
            }

            window.tempChargeSpells[itemType].push(spellEntry);
            renderChargeSpells(itemType);
            costInput.value = '1'; // Reset cost

            // Reset custom form if used
            if (spellValue === 'custom') {
                document.getElementById(itemType + 'ChargeCustomName').value = '';
                document.getElementById(itemType + 'ChargeCustomDesc').value = '';
                document.getElementById(itemType + 'ChargeCustomDamage').value = '';
                document.getElementById(itemType + 'ChargeCustomUpcastDice').value = '';
                document.getElementById(itemType + 'ChargeCustomLevel').value = '1';
                document.getElementById(itemType + 'ChargeCustomSchool').value = 'Abjuration';
                document.getElementById(itemType + 'ChargeCustomTime').value = 'Action';
                document.getElementById(itemType + 'ChargeCustomRange').value = 'Self';
                document.getElementById(itemType + 'ChargeCustomDuration').value = 'Instantaneous';
                document.getElementById(itemType + 'ChargeCustomAreaShape').value = '';
                document.getElementById(itemType + 'ChargeCustomAreaSize').value = '';
                document.getElementById(itemType + 'ChargeCustomConc').checked = false;
                document.getElementById(itemType + 'ChargeCustomRitual').checked = false;
                document.getElementById(itemType + 'ChargeCustomV').checked = true;
                document.getElementById(itemType + 'ChargeCustomS').checked = true;
                document.getElementById(itemType + 'ChargeCustomM').checked = false;
                document.getElementById(itemType + 'ChargeCustomMaterial').value = '';
                document.getElementById(itemType + 'ChargeCustomMaterial').style.display = 'none';
                document.getElementById(itemType + 'ChargeCustomSave').value = '';
                document.getElementById(itemType + 'ChargeCustomDCValue').value = '';
                document.getElementById(itemType + 'ChargeCustomDCValue').style.display = 'none';
                document.getElementById(itemType + 'ChargeCustomRangeFeet').value = '';
                document.getElementById(itemType + 'ChargeCustomRangeFeet').style.display = 'none';
                spellSelect.value = ITEM_SPELLS[0].name;
                toggleChargeCustomSpell(itemType);
            }
        }

        function renderChargeSpells(itemType) {
            const listEl = document.getElementById(itemType + 'ChargeSpellsList');
            if (!listEl) return;

            if (!window.tempChargeSpells || !window.tempChargeSpells[itemType] || window.tempChargeSpells[itemType].length === 0) {
                listEl.innerHTML = '<span style="color: var(--text-muted);">No spells added yet</span>';
                return;
            }

            listEl.innerHTML = window.tempChargeSpells[itemType].map((spell, i) => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:4px 8px; background:var(--bg-input); border-radius:4px; margin-bottom:4px;">
                    <span>${spell.isCustom ? '‚ú® ' : ''}${spell.name} (${spell.cost} charge${spell.cost > 1 ? 's' : ''})</span>
                    <span style="cursor:pointer; color:var(--accent-red);" onclick="removeChargeSpell('${itemType}', ${i})">‚úï</span>
                </div>
            `).join('');
        }

        function removeChargeSpell(itemType, index) {
            if (window.tempChargeSpells && window.tempChargeSpells[itemType]) {
                window.tempChargeSpells[itemType].splice(index, 1);
                renderChargeSpells(itemType);
            }
        }

        // Helper function for spell effect type - toggles custom spell form
        function toggleCustomSpellForm(itemType) {
            const spellSelect = document.getElementById(itemType + 'EffectSpell');
            const levelSelect = document.getElementById(itemType + 'EffectSpellLevel');
            const customForm = document.getElementById(itemType + 'CustomSpellForm');
            const selectedOption = spellSelect.options[spellSelect.selectedIndex];

            if (spellSelect.value === 'Other (Custom)') {
                if (customForm) customForm.style.display = 'block';
            } else {
                if (customForm) customForm.style.display = 'none';
                const level = selectedOption.dataset.level;
                if (level && levelSelect) {
                    levelSelect.value = level;
                }
            }
        }

        function toggleCustomRange(itemType) {
            const rangeSelect = document.getElementById(itemType + 'CustomSpellRange');
            const feetInput = document.getElementById(itemType + 'CustomSpellRangeFeet');
            if (rangeSelect && feetInput) {
                feetInput.style.display = rangeSelect.value === 'custom' ? 'block' : 'none';
            }
        }

        function toggleCustomDC(itemType) {
            const saveSelect = document.getElementById(itemType + 'CustomSpellSave');
            const dcInput = document.getElementById(itemType + 'CustomSpellDCValue');
            if (saveSelect && dcInput) {
                dcInput.style.display = saveSelect.value === 'custom' ? 'block' : 'none';
            }
        }

        function toggleExtraDamageDC(itemType) {
            const saveSelect = document.getElementById(itemType + 'EffectSaveDC');
            const dcInput = document.getElementById(itemType + 'ExtraDmgDCInput');
            const saveEffect = document.getElementById(itemType + 'ExtraDmgSaveEffect');
            if (saveSelect) {
                const hasSave = saveSelect.value !== '';
                if (dcInput) dcInput.style.display = saveSelect.value === 'custom' ? 'block' : 'none';
                if (saveEffect) saveEffect.style.display = hasSave ? 'block' : 'none';
            }
        }

        // Legacy alias for backwards compatibility
        function updateSpellLevelFromSelection(itemType) {
            toggleCustomSpellForm(itemType);
        }

        function resetTempEffects(itemType) {
            tempEffects[itemType] = [];
            const listEl = document.getElementById(itemType + 'EffectsList');
            if (listEl) listEl.innerHTML = '';
            // Also clear temporary charge spells
            if (window.tempChargeSpells && window.tempChargeSpells[itemType]) {
                window.tempChargeSpells[itemType] = [];
            }
        }

        // ===== ITEM CHARGES MANAGEMENT =====
        function initializeItemCharges(item) {
            // Check if item has a charges effect
            if (!item.effects) return;
            const chargesEffect = item.effects.find(e => e.type === 'charges');
            if (!chargesEffect) return;

            // Initialize charges if not already set
            if (!state.itemCharges[item.id]) {
                state.itemCharges[item.id] = {
                    current: chargesEffect.maxCharges,
                    max: chargesEffect.maxCharges
                };
            }
        }

        function getItemCharges(itemId) {
            return state.itemCharges[itemId] || null;
        }

        function useItemCharges(itemId, amount) {
            if (!state.itemCharges[itemId]) return false;
            if (state.itemCharges[itemId].current < amount) return false;

            saveForUndo();
            state.itemCharges[itemId].current -= amount;
            saveState();
            updateItemChargesDisplay();
            return true;
        }

        function getChargesEffectForItem(item) {
            if (!item.effects) return null;
            return item.effects.find(e => e.type === 'charges');
        }

        function rollDice(diceStr) {
            // Parse dice string like "1d6+1", "2d4", "all"
            if (diceStr === 'all') return Infinity; // Will be capped to max

            const match = diceStr.match(/(\d+)d(\d+)(?:\+(\d+))?/);
            if (!match) return 0;

            const numDice = parseInt(match[1]);
            const dieSize = parseInt(match[2]);
            const bonus = parseInt(match[3]) || 0;

            let total = bonus;
            for (let i = 0; i < numDice; i++) {
                total += Math.floor(Math.random() * dieSize) + 1;
            }
            return total;
        }

        function rechargeItems(rechargeTime) {
            // rechargeTime can be 'dawn', 'dusk', 'longRest', 'shortRest'
            let recharged = [];

            state.inventory.forEach(item => {
                const chargesEffect = getChargesEffectForItem(item);
                if (!chargesEffect) return;
                if (chargesEffect.recharge === 'never') return;
                if (chargesEffect.recharge !== rechargeTime) return;

                const charges = state.itemCharges[item.id];
                if (!charges) return;

                // Roll recharge dice
                let rechargeAmount = rollDice(chargesEffect.rechargeDice);
                if (rechargeAmount === Infinity) {
                    rechargeAmount = charges.max;
                }

                const oldCharges = charges.current;
                charges.current = Math.min(charges.current + rechargeAmount, charges.max);
                const gained = charges.current - oldCharges;

                if (gained > 0) {
                    recharged.push({ item: item.name, gained: gained, current: charges.current, max: charges.max });
                }

                // Check for break on last charge used (roll d20, break on specified value)
                if (oldCharges === 0 && chargesEffect.breakChance > 0) {
                    const breakRoll = Math.floor(Math.random() * 20) + 1;
                    if (breakRoll <= chargesEffect.breakChance) {
                        // Item breaks!
                        alert(`${item.name} crumbles to dust!`);
                        // Remove from inventory
                        const index = state.inventory.indexOf(item);
                        if (index > -1) {
                            state.inventory.splice(index, 1);
                            delete state.itemCharges[item.id];
                        }
                    }
                }
            });

            // Also reset 1/day spell usage
            if (rechargeTime === 'dawn' || rechargeTime === 'longRest') {
                state.itemSpellsUsed = {};
            }

            saveState();
            updateItemChargesDisplay();
            renderInventory();

            return recharged;
        }

        function castItemSpell(itemId, spellName, chargeCost) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) { alert('Item not found'); return false; }

            if (chargeCost > 0) {
                // Spell costs charges
                if (!useItemCharges(itemId, chargeCost)) {
                    alert(`Not enough charges! (need ${chargeCost})`);
                    return false;
                }
                // Check if item should break (expended last charge)
                const charges = state.itemCharges[itemId];
                const chargesEffect = getChargesEffectForItem(item);
                if (charges && charges.current === 0 && chargesEffect && chargesEffect.breakChance > 0) {
                    const breakRoll = Math.floor(Math.random() * 20) + 1;
                    if (breakRoll <= chargesEffect.breakChance) {
                        alert(`${item.name} crumbles to dust!`);
                        const index = state.inventory.indexOf(item);
                        if (index > -1) {
                            state.inventory.splice(index, 1);
                            delete state.itemCharges[item.id];
                        }
                        saveState();
                        renderInventory();
                    }
                }
            }

            // Log the cast
            if (state.inBattle) {
                state.battleLog.push(`Cast ${spellName} from ${item.name}`);
            }

            updateItemChargesDisplay();
            return true;
        }

        function castItemGrantedSpell(itemId, spellName, usage) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) { alert('Item not found'); return false; }

            const usageKey = `${itemId}_${spellName}`;

            if (usage !== 'atWill') {
                // Check if already used today
                if (state.itemSpellsUsed[usageKey]) {
                    alert(`${spellName} has already been used today!`);
                    return false;
                }
                // Mark as used
                saveForUndo();
                state.itemSpellsUsed[usageKey] = true;
                saveState();
            }

            // Log the cast
            if (state.inBattle) {
                state.battleLog.push(`Cast ${spellName} from ${item.name}`);
            }

            updateItemChargesDisplay();
            return true;
        }

        function updateItemChargesDisplay() {
            const chargesContainer = document.getElementById('itemChargesDisplay');
            if (!chargesContainer) return;

            let html = '';
            let hasChargedItems = false;

            state.inventory.forEach(item => {
                // Initialize charges if needed
                initializeItemCharges(item);

                const chargesEffect = getChargesEffectForItem(item);
                if (chargesEffect) {
                    const charges = state.itemCharges[item.id];
                    if (charges) {
                        hasChargedItems = true;
                        const percentage = (charges.current / charges.max) * 100;
                        html += `
                            <div class="item-charges-row" onclick="showItemChargesModal('${item.id}')">
                                <span class="item-charges-name">${item.name}</span>
                                <div class="item-charges-bar">
                                    <div class="item-charges-fill" style="width: ${percentage}%"></div>
                                </div>
                                <span class="item-charges-count">${charges.current}/${charges.max}</span>
                            </div>
                        `;
                    }
                }

                // Also show spell effects with usage (non-at-will)
                if (item.effects) {
                    item.effects.filter(e => e.type === 'spell' && e.usage !== 'atWill').forEach(effect => {
                        hasChargedItems = true;
                        const usageKey = `${item.id}_${effect.spell}`;
                        const used = state.itemSpellsUsed[usageKey];
                        html += `
                            <div class="item-spell-row ${used ? 'used' : ''}" onclick="showItemSpellModal('${item.id}', '${effect.spell}')">
                                <span class="item-spell-name">${effect.spell} (${item.name})</span>
                                <span class="item-spell-usage">${used ? 'Used' : effect.usage}</span>
                            </div>
                        `;
                    });
                }
            });

            // Show/hide the integrated charges section
            chargesContainer.style.display = hasChargedItems ? 'block' : 'none';

            if (hasChargedItems) {
                chargesContainer.innerHTML = '<div style="font-size: 0.85em; color: var(--accent-purple); margin-bottom: 8px;">‚ö° Magic Item Charges</div>' + html;
            }
        }

        function showItemChargesModal(itemId) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            const chargesEffect = getChargesEffectForItem(item);
            if (!chargesEffect) return;

            const charges = state.itemCharges[itemId];
            if (!charges) return;

            let spellsHtml = chargesEffect.spells.map(spell => `
                <div class="charge-spell-option" onclick="castItemSpell('${itemId}', '${spell.name}', ${spell.cost})">
                    <span class="charge-spell-name">${spell.name}</span>
                    <span class="charge-spell-cost">${spell.cost} charge${spell.cost > 1 ? 's' : ''}</span>
                </div>
            `).join('');

            const body = `
                <div class="item-charges-modal">
                    <div class="charges-header">
                        <span>Charges: ${charges.current} / ${charges.max}</span>
                        <span class="recharge-info">${chargesEffect.recharge === 'never' ? 'No recharge' : 'Recharges at ' + chargesEffect.recharge}</span>
                    </div>
                    <div class="charges-bar-large">
                        <div class="charges-fill-large" style="width: ${(charges.current / charges.max) * 100}%"></div>
                    </div>
                    <h4 style="margin: 15px 0 10px;">Cast Spell:</h4>
                    <div class="charge-spells-list">
                        ${spellsHtml}
                    </div>
                </div>
            `;

            showModal(item.name, body);
        }

        function showItemSpellModal(itemId, spellName) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            const spellEffect = item.effects.find(e => e.type === 'spell' && e.spell === spellName);
            if (!spellEffect) return;

            const usageKey = `${itemId}_${spellName}`;
            const used = state.itemSpellsUsed[usageKey];

            // Build spell details section
            let detailsHtml = '';
            if (spellEffect.isCustom && spellEffect.spellDetails) {
                const d = spellEffect.spellDetails;
                const components = [];
                if (d.components.v) components.push('V');
                if (d.components.s) components.push('S');
                if (d.components.m) components.push('M' + (d.components.material ? ` (${d.components.material})` : ''));

                // Build area effect string
                let areaStr = '';
                if (d.area && d.area.shape) {
                    areaStr = `${d.area.size}-ft ${d.area.shape.toLowerCase()}`;
                }

                // Build save DC string
                let saveStr = '';
                if (d.save) {
                    if (d.save === 'character') {
                        saveStr = 'DC 15 (your DC)';
                    } else if (d.save === 'custom' && d.customDC) {
                        saveStr = `DC ${d.customDC}`;
                    } else {
                        saveStr = `${d.save} save`;
                    }
                }

                // Build upcast info
                let upcastStr = '';
                if (d.upcast && d.upcast.dice) {
                    upcastStr = `+${d.upcast.dice} per ${d.upcast.interval === 1 ? 'level' : d.upcast.interval + ' levels'} above base`;
                }

                detailsHtml = `
                    <div style="background: rgba(100,149,237,0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                            <div><strong>School:</strong> ${d.school}</div>
                            <div><strong>Casting Time:</strong> ${d.castingTime}</div>
                            <div><strong>Range:</strong> ${d.range}${areaStr ? ` (${areaStr})` : ''}</div>
                            <div><strong>Duration:</strong> ${d.concentration ? 'Conc., ' : ''}${d.duration}</div>
                            <div><strong>Components:</strong> ${components.join(', ')}</div>
                            ${saveStr ? `<div><strong>Save:</strong> ${saveStr}</div>` : ''}
                            ${d.damage ? `<div><strong>Damage:</strong> ${d.damage}</div>` : ''}
                        </div>
                        ${d.description ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">${d.description}</div>` : ''}
                        ${upcastStr ? `<div style="margin-top: 10px; color: var(--accent-gold);"><strong>At Higher Levels:</strong> ${upcastStr}</div>` : ''}
                    </div>
                `;
            }

            const body = `
                <div class="item-spell-modal">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 1.3em; font-weight: bold; color: var(--accent-purple);">${spellName}</div>
                        <div style="color: var(--text-secondary);">Level ${spellEffect.spellLevel} ${spellEffect.isCustom && spellEffect.spellDetails ? spellEffect.spellDetails.school : ''} Spell</div>
                    </div>
                    ${detailsHtml}
                    <div style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Usage:</span>
                            <span style="color: ${used ? 'var(--accent-red)' : 'var(--accent-green)'};">${used ? 'Already Used' : spellEffect.usage}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                            <span>Save DC:</span>
                            <span>${spellEffect.ability === 'item' ? 'Item DC' : 'Your DC (15)'}</span>
                        </div>
                    </div>
                    ${used ?
                        `<div style="text-align: center; color: var(--text-muted); padding: 15px;">This spell has already been used today.<br>It resets at dawn.</div>` :
                        `<button onclick="castItemGrantedSpell('${itemId}', '${spellName}', '${spellEffect.usage}'); closeModal();" style="width: 100%; padding: 12px; background: var(--accent-purple); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">Cast ${spellName}</button>`
                    }
                </div>
            `;

            showModal(`${item.name}`, body);
        }

        function openAddWeaponForm() {
            resetTempEffects('weapon');
            const body = `
                <div class="form-group">
                    <label>Weapon Name</label>
                    <input type="text" id="weaponName" placeholder="e.g., Longsword">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="weaponCategory">
                            <option value="simple">Simple</option>
                            <option value="martial">Martial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="weaponType">
                            <option value="melee">Melee</option>
                            <option value="ranged">Ranged</option>
                            <option value="thrown">Thrown Only</option>
                            <option value="melee/thrown">Melee/Thrown</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hands</label>
                        <select id="weaponHands">
                            <option value="one">One-handed</option>
                            <option value="two">Two-handed</option>
                            <option value="versatile">Versatile</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Damage Die</label>
                        <select id="weaponDamageDie">
                            <option value="1d4">1d4</option>
                            <option value="1d6" selected>1d6</option>
                            <option value="1d8">1d8</option>
                            <option value="1d10">1d10</option>
                            <option value="1d12">1d12</option>
                            <option value="2d6">2d6</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Damage Type</label>
                        <select id="weaponDamageType">
                            <option value="slashing">Slashing</option>
                            <option value="piercing">Piercing</option>
                            <option value="bludgeoning">Bludgeoning</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Modifier</label>
                    <select id="weaponModifier">
                        <option value="str">Strength</option>
                        <option value="dex">Dexterity</option>
                        <option value="finesse">Finesse (STR or DEX)</option>
                    </select>
                </div>
                <div class="form-group" id="rangeGroup" style="display:none;">
                    <label>Range (normal/long)</label>
                    <input type="text" id="weaponRange" placeholder="e.g., 80/320">
                </div>

                <div class="activation-section">
                    <label style="font-weight:bold; margin-bottom:8px; display:block;">Activation (DC Save)</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="weaponHasDCSave" onchange="toggleWeaponDCSave()">
                        <label>Requires Saving Throw</label>
                    </div>
                    <div id="weaponDCSaveFields" style="display:none; margin-top:10px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Save Type</label>
                                <select id="weaponSaveType">
                                    <option value="STR">Strength</option>
                                    <option value="DEX">Dexterity</option>
                                    <option value="CON">Constitution</option>
                                    <option value="INT">Intelligence</option>
                                    <option value="WIS">Wisdom</option>
                                    <option value="CHA">Charisma</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>DC Value</label>
                                <input type="number" id="weaponSaveDC" value="15" min="1" max="30" style="width:60px;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>On Successful Save</label>
                            <select id="weaponSaveEffect">
                                <option value="half">Half Damage</option>
                                <option value="none">No Effect</option>
                                <option value="other">Other (see description)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="weaponMagic">
                        <label>Magic Item</label>
                    </div>
                </div>
                <div id="magicWeaponOptions" class="magic-options" style="display:none;">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="weaponAttunement">
                            <label>Requires Attunement</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Attack Bonus</label>
                            <select id="weaponAttackBonus">
                                <option value="0">+0</option>
                                <option value="1">+1</option>
                                <option value="2">+2</option>
                                <option value="3">+3</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Damage Bonus</label>
                            <select id="weaponDamageBonus">
                                <option value="0">+0</option>
                                <option value="1">+1</option>
                                <option value="2">+2</option>
                                <option value="3">+3</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Magic Effects</label>
                        <div id="weaponEffectsList" class="effects-list"></div>
                        <div class="add-effect-btn" onclick="showAddEffectForm('weapon')">+ Add Effect</div>
                        <div id="weaponEffectForm" style="display:none;"></div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="saveNewWeapon()" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Weapon</button>
                </div>
            `;
            showModal('Add Weapon', body);

            // Show/hide range based on weapon type
            setTimeout(() => {
                document.getElementById('weaponType').addEventListener('change', function() {
                    document.getElementById('rangeGroup').style.display = ['ranged', 'thrown', 'melee/thrown'].includes(this.value) ? 'block' : 'none';
                });
                document.getElementById('weaponMagic').addEventListener('change', function() {
                    document.getElementById('magicWeaponOptions').style.display = this.checked ? 'block' : 'none';
                });
            }, 100);
        }

        function toggleWeaponDCSave() {
            const checkbox = document.getElementById('weaponHasDCSave');
            const fields = document.getElementById('weaponDCSaveFields');
            if (checkbox && fields) {
                fields.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        function toggleAccessoryDCSave() {
            const checkbox = document.getElementById('accessoryHasDCSave');
            const fields = document.getElementById('accessoryDCSaveFields');
            if (checkbox && fields) {
                fields.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        function saveNewWeapon() {
            const name = document.getElementById('weaponName').value.trim();
            if (!name) { alert('Please enter a weapon name'); return; }

            const weapon = {
                id: 'weapon-' + Date.now(),
                type: 'weapon',
                name: name,
                category: document.getElementById('weaponCategory').value,
                weaponType: document.getElementById('weaponType').value,
                hands: document.getElementById('weaponHands').value,
                damageDie: document.getElementById('weaponDamageDie').value,
                damageType: document.getElementById('weaponDamageType').value,
                modifier: document.getElementById('weaponModifier').value,
                isMagic: document.getElementById('weaponMagic').checked,
                equipped: null
            };

            if (['ranged', 'thrown', 'melee/thrown'].includes(weapon.weaponType)) {
                weapon.range = document.getElementById('weaponRange').value || '20/60';
            }

            // DC Save (Activation)
            if (document.getElementById('weaponHasDCSave').checked) {
                weapon.dcSave = {
                    type: document.getElementById('weaponSaveType').value,
                    dc: parseInt(document.getElementById('weaponSaveDC').value) || 15,
                    onSave: document.getElementById('weaponSaveEffect').value
                };
            }

            if (weapon.isMagic) {
                weapon.requiresAttunement = document.getElementById('weaponAttunement').checked;
                weapon.attackBonus = parseInt(document.getElementById('weaponAttackBonus').value) || 0;
                weapon.damageBonus = parseInt(document.getElementById('weaponDamageBonus').value) || 0;
                weapon.effects = [...tempEffects.weapon];
            }

            saveForUndo();
            state.inventory.push(weapon);
            initializeItemCharges(weapon);
            resetTempEffects('weapon');
            closeModal();
            renderInventory();
            updateResistancesDisplay();
            updateItemChargesDisplay();
            saveState();
        }

        function editWeapon(itemId) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            const body = `
                <div class="form-group">
                    <label>Weapon Name</label>
                    <input type="text" id="editWeaponName" value="${item.name || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="editWeaponCategory">
                            <option value="simple" ${item.category === 'simple' ? 'selected' : ''}>Simple</option>
                            <option value="martial" ${item.category === 'martial' ? 'selected' : ''}>Martial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="editWeaponType">
                            <option value="melee" ${item.weaponType === 'melee' ? 'selected' : ''}>Melee</option>
                            <option value="ranged" ${item.weaponType === 'ranged' ? 'selected' : ''}>Ranged</option>
                            <option value="thrown" ${item.weaponType === 'thrown' ? 'selected' : ''}>Thrown Only</option>
                            <option value="melee/thrown" ${item.weaponType === 'melee/thrown' ? 'selected' : ''}>Melee/Thrown</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hands</label>
                        <select id="editWeaponHands">
                            <option value="one" ${item.hands === 'one' ? 'selected' : ''}>One-handed</option>
                            <option value="two" ${item.hands === 'two' ? 'selected' : ''}>Two-handed</option>
                            <option value="versatile" ${item.hands === 'versatile' ? 'selected' : ''}>Versatile</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Range</label>
                        <input type="text" id="editWeaponRange" value="${item.range || ''}" placeholder="e.g., 80/320">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Damage Die</label>
                        <select id="editWeaponDamageDie">
                            <option value="1d4" ${item.damageDie === '1d4' ? 'selected' : ''}>1d4</option>
                            <option value="1d6" ${item.damageDie === '1d6' ? 'selected' : ''}>1d6</option>
                            <option value="1d8" ${item.damageDie === '1d8' ? 'selected' : ''}>1d8</option>
                            <option value="1d10" ${item.damageDie === '1d10' ? 'selected' : ''}>1d10</option>
                            <option value="1d12" ${item.damageDie === '1d12' ? 'selected' : ''}>1d12</option>
                            <option value="2d6" ${item.damageDie === '2d6' ? 'selected' : ''}>2d6</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Damage Type</label>
                        <select id="editWeaponDamageType">
                            <option value="slashing" ${item.damageType === 'slashing' ? 'selected' : ''}>Slashing</option>
                            <option value="piercing" ${item.damageType === 'piercing' ? 'selected' : ''}>Piercing</option>
                            <option value="bludgeoning" ${item.damageType === 'bludgeoning' ? 'selected' : ''}>Bludgeoning</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Modifier</label>
                    <select id="editWeaponModifier">
                        <option value="str" ${item.modifier === 'str' ? 'selected' : ''}>Strength</option>
                        <option value="dex" ${item.modifier === 'dex' ? 'selected' : ''}>Dexterity</option>
                        <option value="finesse" ${item.modifier === 'finesse' ? 'selected' : ''}>Finesse (STR or DEX)</option>
                    </select>
                </div>
                ${item.isMagic ? `
                <div class="form-row" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                    <div class="form-group">
                        <label>Attack Bonus</label>
                        <input type="number" id="editWeaponAttackBonus" value="${item.attackBonus || 0}" min="0" max="3" style="width:60px;">
                    </div>
                    <div class="form-group">
                        <label>Damage Bonus</label>
                        <input type="number" id="editWeaponDamageBonus" value="${item.damageBonus || 0}" min="0" max="3" style="width:60px;">
                    </div>
                </div>
                <p style="color: var(--text-muted); font-size: 0.85em; margin: 10px 0;">Note: To edit magic effects, delete and re-add the weapon.</p>
                ` : ''}
                <button onclick="saveEditWeapon('${itemId}')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px;">Save Changes</button>
            `;
            showModal('Edit: ' + item.name, body);
        }

        function saveEditWeapon(itemId) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            const name = document.getElementById('editWeaponName').value.trim();
            if (!name) { alert('Please enter a weapon name'); return; }

            saveForUndo();
            item.name = name;
            item.category = document.getElementById('editWeaponCategory').value;
            item.weaponType = document.getElementById('editWeaponType').value;
            item.hands = document.getElementById('editWeaponHands').value;
            item.range = document.getElementById('editWeaponRange').value || null;
            item.damageDie = document.getElementById('editWeaponDamageDie').value;
            item.damageType = document.getElementById('editWeaponDamageType').value;
            item.modifier = document.getElementById('editWeaponModifier').value;

            if (item.isMagic) {
                item.attackBonus = parseInt(document.getElementById('editWeaponAttackBonus').value) || 0;
                item.damageBonus = parseInt(document.getElementById('editWeaponDamageBonus').value) || 0;
            }

            saveState();
            closeModal();
            renderInventory();
            updateAttackOptions();
            showToast('Weapon updated!');
        }

        function openAddArmorForm() {
            resetTempEffects('armor');
            const body = `
                <div class="form-group">
                    <label>Armor Name</label>
                    <input type="text" id="armorName" placeholder="e.g., Chain Mail">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Armor Type</label>
                        <select id="armorType">
                            <option value="light">Light</option>
                            <option value="medium">Medium</option>
                            <option value="heavy">Heavy</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Base AC</label>
                        <select id="armorBaseAC">
                            <option value="11">11 (Padded/Leather)</option>
                            <option value="12">12 (Studded/Hide)</option>
                            <option value="13">13 (Chain Shirt)</option>
                            <option value="14">14 (Scale/Breastplate)</option>
                            <option value="15">15 (Half Plate)</option>
                            <option value="16">16 (Ring/Chain)</option>
                            <option value="17">17 (Splint)</option>
                            <option value="18">18 (Plate)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Max DEX Bonus</label>
                    <select id="armorMaxDex">
                        <option value="99">No limit (Light)</option>
                        <option value="2">+2 (Medium)</option>
                        <option value="0">+0 (Heavy)</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="armorStealth">
                        <label>Disadvantage on Stealth</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="armorMagic">
                        <label>Magic Armor</label>
                    </div>
                </div>
                <div id="magicArmorOptions" class="magic-options" style="display:none;">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="armorAttunement">
                            <label>Requires Attunement</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>AC Bonus</label>
                        <select id="armorACBonus">
                            <option value="0">+0</option>
                            <option value="1">+1</option>
                            <option value="2">+2</option>
                            <option value="3">+3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Magic Effects</label>
                        <div id="armorEffectsList" class="effects-list"></div>
                        <div class="add-effect-btn" onclick="showAddEffectForm('armor')">+ Add Effect</div>
                        <div id="armorEffectForm" style="display:none;"></div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="saveNewArmor()" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Armor</button>
                </div>
            `;
            showModal('Add Armor', body);

            setTimeout(() => {
                document.getElementById('armorMagic').addEventListener('change', function() {
                    document.getElementById('magicArmorOptions').style.display = this.checked ? 'block' : 'none';
                });
            }, 100);
        }

        function saveNewArmor() {
            const name = document.getElementById('armorName').value.trim();
            if (!name) { alert('Please enter an armor name'); return; }

            const armor = {
                id: 'armor-' + Date.now(),
                type: 'armor',
                name: name,
                armorType: document.getElementById('armorType').value,
                baseAC: parseInt(document.getElementById('armorBaseAC').value),
                maxDex: parseInt(document.getElementById('armorMaxDex').value),
                stealthDisadvantage: document.getElementById('armorStealth').checked,
                isMagic: document.getElementById('armorMagic').checked,
                equipped: null
            };

            if (armor.isMagic) {
                armor.requiresAttunement = document.getElementById('armorAttunement').checked;
                armor.magicBonus = parseInt(document.getElementById('armorACBonus').value) || 0;
                armor.effects = [...tempEffects.armor];
            }

            saveForUndo();
            state.inventory.push(armor);
            initializeItemCharges(armor);
            resetTempEffects('armor');
            closeModal();
            renderInventory();
            updateResistancesDisplay();
            updateItemChargesDisplay();
            saveState();
        }

        function editArmor(itemId) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            const body = `
                <div class="form-group">
                    <label>Armor Name</label>
                    <input type="text" id="editArmorName" value="${item.name || ''}">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Armor Type</label>
                        <select id="editArmorType">
                            <option value="light" ${item.armorType === 'light' ? 'selected' : ''}>Light</option>
                            <option value="medium" ${item.armorType === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="heavy" ${item.armorType === 'heavy' ? 'selected' : ''}>Heavy</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Base AC</label>
                        <input type="number" id="editArmorBaseAC" value="${item.baseAC || 11}" min="10" max="20" style="width:60px;">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Max DEX Bonus</label>
                        <select id="editArmorMaxDex">
                            <option value="99" ${item.maxDex >= 99 ? 'selected' : ''}>No limit</option>
                            <option value="2" ${item.maxDex === 2 ? 'selected' : ''}>+2</option>
                            <option value="0" ${item.maxDex === 0 ? 'selected' : ''}>+0</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="editArmorStealth" ${item.stealthDisadvantage ? 'checked' : ''} style="width: 20px; height: 20px;">
                            <span>Stealth Disadvantage</span>
                        </label>
                    </div>
                </div>
                ${item.isMagic ? `
                <div class="form-group" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                    <label>Magic AC Bonus</label>
                    <input type="number" id="editArmorMagicBonus" value="${item.magicBonus || 0}" min="0" max="3" style="width:60px;">
                </div>
                <p style="color: var(--text-muted); font-size: 0.85em; margin: 10px 0;">Note: To edit magic effects, delete and re-add the armor.</p>
                ` : ''}
                <button onclick="saveEditArmor('${itemId}')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px;">Save Changes</button>
            `;
            showModal('Edit: ' + item.name, body);
        }

        function saveEditArmor(itemId) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            const name = document.getElementById('editArmorName').value.trim();
            if (!name) { alert('Please enter an armor name'); return; }

            saveForUndo();
            item.name = name;
            item.armorType = document.getElementById('editArmorType').value;
            item.baseAC = parseInt(document.getElementById('editArmorBaseAC').value) || 11;
            item.maxDex = parseInt(document.getElementById('editArmorMaxDex').value);
            item.stealthDisadvantage = document.getElementById('editArmorStealth').checked;

            if (item.isMagic) {
                item.magicBonus = parseInt(document.getElementById('editArmorMagicBonus').value) || 0;
            }

            saveState();
            closeModal();
            renderInventory();
            updateACDisplay();
            showToast('Armor updated!');
        }

        function openAddShieldForm() {
            resetTempEffects('shield');
            const body = `
                <div class="form-group">
                    <label>Shield Name</label>
                    <input type="text" id="shieldName" placeholder="e.g., Wooden Shield" value="Shield">
                </div>
                <div class="form-group">
                    <label>AC Bonus</label>
                    <select id="shieldACBonus">
                        <option value="1">+1</option>
                        <option value="2" selected>+2</option>
                        <option value="3">+3</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="shieldMagic">
                        <label>Magic Shield</label>
                    </div>
                </div>
                <div id="magicShieldOptions" class="magic-options" style="display:none;">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="shieldAttunement">
                            <label>Requires Attunement</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Additional AC Bonus</label>
                        <select id="shieldMagicBonus">
                            <option value="0">+0</option>
                            <option value="1">+1</option>
                            <option value="2">+2</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Magic Effects</label>
                        <div id="shieldEffectsList" class="effects-list"></div>
                        <div class="add-effect-btn" onclick="showAddEffectForm('shield')">+ Add Effect</div>
                        <div id="shieldEffectForm" style="display:none;"></div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="saveNewShield()" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Shield</button>
                </div>
            `;
            showModal('Add Shield', body);

            setTimeout(() => {
                document.getElementById('shieldMagic').addEventListener('change', function() {
                    document.getElementById('magicShieldOptions').style.display = this.checked ? 'block' : 'none';
                });
            }, 100);
        }

        function saveNewShield() {
            const name = document.getElementById('shieldName').value.trim() || 'Shield';

            const shield = {
                id: 'shield-' + Date.now(),
                type: 'shield',
                name: name,
                acBonus: parseInt(document.getElementById('shieldACBonus').value),
                isMagic: document.getElementById('shieldMagic').checked,
                equipped: null
            };

            if (shield.isMagic) {
                shield.requiresAttunement = document.getElementById('shieldAttunement').checked;
                shield.magicBonus = parseInt(document.getElementById('shieldMagicBonus').value) || 0;
                shield.effects = [...tempEffects.shield];
            }

            saveForUndo();
            state.inventory.push(shield);
            initializeItemCharges(shield);
            resetTempEffects('shield');
            closeModal();
            renderInventory();
            updateResistancesDisplay();
            updateItemChargesDisplay();
            saveState();
        }

        function editShield(itemId) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            const body = `
                <div class="form-group">
                    <label>Shield Name</label>
                    <input type="text" id="editShieldName" value="${item.name || 'Shield'}">
                </div>
                <div class="form-group">
                    <label>AC Bonus</label>
                    <select id="editShieldACBonus">
                        <option value="1" ${item.acBonus === 1 ? 'selected' : ''}>+1</option>
                        <option value="2" ${item.acBonus === 2 ? 'selected' : ''}>+2</option>
                        <option value="3" ${item.acBonus === 3 ? 'selected' : ''}>+3</option>
                    </select>
                </div>
                ${item.isMagic ? `
                <div class="form-group" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                    <label>Magic Bonus</label>
                    <input type="number" id="editShieldMagicBonus" value="${item.magicBonus || 0}" min="0" max="3" style="width:60px;">
                </div>
                <p style="color: var(--text-muted); font-size: 0.85em; margin: 10px 0;">Note: To edit magic effects, delete and re-add the shield.</p>
                ` : ''}
                <button onclick="saveEditShield('${itemId}')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px;">Save Changes</button>
            `;
            showModal('Edit: ' + item.name, body);
        }

        function saveEditShield(itemId) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            saveForUndo();
            item.name = document.getElementById('editShieldName').value.trim() || 'Shield';
            item.acBonus = parseInt(document.getElementById('editShieldACBonus').value) || 2;

            if (item.isMagic) {
                item.magicBonus = parseInt(document.getElementById('editShieldMagicBonus').value) || 0;
            }

            saveState();
            closeModal();
            renderInventory();
            updateACDisplay();
            showToast('Shield updated!');
        }

        function openAddAccessoryForm() {
            resetTempEffects('accessory');
            const body = `
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" id="accessoryName" placeholder="e.g., Ring of Protection">
                </div>
                <div class="form-group">
                    <label>Slot</label>
                    <select id="accessorySlot">
                        <option value="head">Head</option>
                        <option value="neck">Neck</option>
                        <option value="hands">Hands</option>
                        <option value="feet">Feet</option>
                        <option value="ring1">Ring</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="accessoryAttunement">
                        <label>Requires Attunement</label>
                    </div>
                </div>

                <div class="activation-section">
                    <label style="font-weight:bold; margin-bottom:8px; display:block;">Activation (DC Save)</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="accessoryHasDCSave" onchange="toggleAccessoryDCSave()">
                        <label>Requires Saving Throw</label>
                    </div>
                    <div id="accessoryDCSaveFields" style="display:none; margin-top:10px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Save Type</label>
                                <select id="accessorySaveType">
                                    <option value="STR">Strength</option>
                                    <option value="DEX">Dexterity</option>
                                    <option value="CON">Constitution</option>
                                    <option value="INT">Intelligence</option>
                                    <option value="WIS">Wisdom</option>
                                    <option value="CHA">Charisma</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>DC Value</label>
                                <input type="number" id="accessorySaveDC" value="15" min="1" max="30" style="width:60px;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>On Successful Save</label>
                            <select id="accessorySaveEffect">
                                <option value="half">Half Damage</option>
                                <option value="none">No Effect</option>
                                <option value="other">Other (see description)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Magic Effects</label>
                    <div id="accessoryEffectsList" class="effects-list"></div>
                    <div class="add-effect-btn" onclick="showAddEffectForm('accessory')">+ Add Effect</div>
                    <div id="accessoryEffectForm" style="display:none;"></div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="saveNewAccessory()" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Add Accessory</button>
                </div>
            `;
            showModal('Add Accessory', body);
        }

        function saveNewAccessory() {
            const name = document.getElementById('accessoryName').value.trim();
            if (!name) { alert('Please enter an item name'); return; }

            const accessory = {
                id: 'accessory-' + Date.now(),
                type: 'accessory',
                name: name,
                slotType: document.getElementById('accessorySlot').value,
                requiresAttunement: document.getElementById('accessoryAttunement').checked,
                effects: [...tempEffects.accessory],
                isMagic: true,
                equipped: null
            };

            // DC Save (Activation)
            if (document.getElementById('accessoryHasDCSave').checked) {
                accessory.dcSave = {
                    type: document.getElementById('accessorySaveType').value,
                    dc: parseInt(document.getElementById('accessorySaveDC').value) || 15,
                    onSave: document.getElementById('accessorySaveEffect').value
                };
            }

            saveForUndo();
            state.inventory.push(accessory);
            initializeItemCharges(accessory);
            resetTempEffects('accessory');
            closeModal();
            renderInventory();
            updateResistancesDisplay();
            updateItemChargesDisplay();
            saveState();
        }

        function editAccessory(itemId) {
            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            resetTempEffects('accessory');
            if (item.effects) {
                tempEffects.accessory = [...item.effects];
            }

            const hasDCSave = item.dcSave ? 'checked' : '';
            const dcSaveDisplay = item.dcSave ? '' : 'display:none;';

            const body = `
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" id="editAccessoryName" value="${item.name || ''}" placeholder="e.g., Ring of Protection">
                </div>
                <div class="form-group">
                    <label>Slot</label>
                    <select id="editAccessorySlot">
                        <option value="head" ${item.slotType === 'head' ? 'selected' : ''}>Head</option>
                        <option value="neck" ${item.slotType === 'neck' ? 'selected' : ''}>Neck</option>
                        <option value="hands" ${item.slotType === 'hands' ? 'selected' : ''}>Hands</option>
                        <option value="feet" ${item.slotType === 'feet' ? 'selected' : ''}>Feet</option>
                        <option value="ring1" ${item.slotType === 'ring1' ? 'selected' : ''}>Ring</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="editAccessoryAttunement" ${item.requiresAttunement ? 'checked' : ''}>
                        <label>Requires Attunement</label>
                    </div>
                </div>

                <div class="activation-section">
                    <label style="font-weight:bold; margin-bottom:8px; display:block;">Activation (DC Save)</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="editAccessoryHasDCSave" ${hasDCSave} onchange="document.getElementById('editAccessoryDCSaveFields').style.display = this.checked ? '' : 'none';">
                        <label>Requires Saving Throw</label>
                    </div>
                    <div id="editAccessoryDCSaveFields" style="${dcSaveDisplay} margin-top:10px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Save Type</label>
                                <select id="editAccessorySaveType">
                                    <option value="STR" ${item.dcSave?.type === 'STR' ? 'selected' : ''}>Strength</option>
                                    <option value="DEX" ${item.dcSave?.type === 'DEX' ? 'selected' : ''}>Dexterity</option>
                                    <option value="CON" ${item.dcSave?.type === 'CON' ? 'selected' : ''}>Constitution</option>
                                    <option value="INT" ${item.dcSave?.type === 'INT' ? 'selected' : ''}>Intelligence</option>
                                    <option value="WIS" ${item.dcSave?.type === 'WIS' ? 'selected' : ''}>Wisdom</option>
                                    <option value="CHA" ${item.dcSave?.type === 'CHA' ? 'selected' : ''}>Charisma</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>DC Value</label>
                                <input type="number" id="editAccessorySaveDC" value="${item.dcSave?.dc || 15}" min="1" max="30" style="width:60px;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>On Successful Save</label>
                            <select id="editAccessorySaveEffect">
                                <option value="half" ${item.dcSave?.onSave === 'half' ? 'selected' : ''}>Half Damage</option>
                                <option value="none" ${item.dcSave?.onSave === 'none' ? 'selected' : ''}>No Effect</option>
                                <option value="other" ${item.dcSave?.onSave === 'other' ? 'selected' : ''}>Other (see description)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Magic Effects</label>
                    <div id="accessoryEffectsList" class="effects-list"></div>
                    <div class="add-effect-btn" onclick="showAddEffectForm('accessory')">+ Add Effect</div>
                    <div id="accessoryEffectForm" style="display:none;"></div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="saveEditAccessory('${itemId}')" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">Save Changes</button>
                </div>
            `;
            showModal('Edit: ' + item.name, body);
            setTimeout(() => renderEffectsList('accessory'), 50);
        }

        function saveEditAccessory(itemId) {
            const name = document.getElementById('editAccessoryName').value.trim();
            if (!name) { alert('Please enter an item name'); return; }

            const item = state.inventory.find(i => i.id === itemId);
            if (!item) return;

            saveForUndo();
            item.name = name;
            item.slotType = document.getElementById('editAccessorySlot').value;
            item.requiresAttunement = document.getElementById('editAccessoryAttunement').checked;
            item.effects = [...tempEffects.accessory];

            // DC Save (Activation)
            if (document.getElementById('editAccessoryHasDCSave').checked) {
                item.dcSave = {
                    type: document.getElementById('editAccessorySaveType').value,
                    dc: parseInt(document.getElementById('editAccessorySaveDC').value) || 15,
                    onSave: document.getElementById('editAccessorySaveEffect').value
                };
            } else {
                delete item.dcSave;
            }

            resetTempEffects('accessory');
            closeModal();
            renderInventory();
            updateResistancesDisplay();
            updateItemChargesDisplay();
            saveState();
            showToast('Accessory updated!');
        }

        function deleteItem(type, index) {
            if (!confirm('Delete this item?')) return;
            saveForUndo();
            if (type === 'gear') state.gear.splice(index, 1);
            renderInventory();
            saveState();
        }

        // ===== NOTES =====
        let currentNoteCategory = 'sessions';
        let currentNoteId = null;

        function initNotes() {
            if (!state.notes) {
                state.notes = { sessions: [], cities: [], npcs: [], battles: [], other: [] };
            }
            ['sessions', 'locations', 'npcs', 'battles', 'other'].forEach(cat => {
                if (!state.notes[cat]) state.notes[cat] = [];
            });
            // Migrate old 'cities' to 'locations'
            if (state.notes.cities && state.notes.cities.length > 0) {
                state.notes.locations = [...(state.notes.locations || []), ...state.notes.cities];
                delete state.notes.cities;
            }
        }

        function showNotesCategory(cat) {
            currentNoteCategory = cat;
            document.querySelectorAll('.notes-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.notes-tab[onclick="showNotesCategory('${cat}')"]`).classList.add('active');
            updateAddNoteRow();
            renderNotes();
        }

        function updateAddNoteRow() {
            const row = document.getElementById('addNoteRow');
            let html = '';

            switch (currentNoteCategory) {
                case 'sessions':
                    html = `
                        <div class="add-note-buttons">
                            <button class="add-item-btn" onclick="openAddSessionNote()">+ Session Note</button>
                            <button class="add-item-btn" onclick="openAddPartyMember()">+ Party Member</button>
                        </div>
                    `;
                    break;
                case 'locations':
                    html = `
                        <div class="add-note-buttons">
                            <button class="add-item-btn" onclick="openAddLocation()">+ Location</button>
                        </div>
                    `;
                    break;
                case 'npcs':
                    html = `
                        <div class="add-note-buttons">
                            <button class="add-item-btn" onclick="openAddNPC()">+ NPC</button>
                        </div>
                    `;
                    break;
                case 'battles':
                    html = '<p class="text-small text-muted">Battle records are created automatically when you end a battle.</p>';
                    break;
                case 'other':
                    html = `
                        <input type="text" id="newNoteName" class="add-item-input" placeholder="Note title...">
                        <button class="add-item-btn" onclick="addNote()">+ Note</button>
                    `;
                    break;
            }

            row.innerHTML = html;
        }

        function renderNotes() {
            initNotes();
            const view = document.getElementById('notesFolderView');
            const notes = state.notes[currentNoteCategory] || [];

            if (notes.length === 0) {
                const emptyMessages = {
                    'sessions': 'No session notes or party members yet. Add one below!',
                    'locations': 'No locations yet. Add one below!',
                    'npcs': 'No NPCs yet. Add one below!',
                    'battles': 'No battle records yet. End a battle to create one!',
                    'other': 'No notes yet. Add one below!'
                };
                view.innerHTML = `<p class="text-muted text-center">${emptyMessages[currentNoteCategory]}</p>`;
                return;
            }

            // Category-specific rendering
            switch (currentNoteCategory) {
                case 'sessions':
                    view.innerHTML = renderSessionNotes(notes);
                    break;
                case 'locations':
                    view.innerHTML = renderLocationNotes(notes);
                    break;
                case 'npcs':
                    view.innerHTML = renderNPCNotes(notes);
                    break;
                case 'battles':
                    view.innerHTML = renderBattleNotes(notes);
                    break;
                default:
                    view.innerHTML = renderNoteTree(notes, 0);
            }
        }

        function renderSessionNotes(notes) {
            return notes.map((item, i) => {
                if (item.type === 'party-member') {
                    return renderPartyMemberCard(item, i);
                } else {
                    return renderSessionNoteCard(item, i);
                }
            }).join('');
        }

        function renderSessionNoteCard(note, index) {
            return `
                <div class="note-item" onclick="openNote(${index})">
                    <span>üìù ${note.name}</span>
                    <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${index})">‚úï</button>
                </div>
            `;
        }

        function renderPartyMemberCard(member, index) {
            const fullName = `${member.firstName || ''} ${member.lastName || ''}`.trim() || 'Unnamed';
            return `
                <div class="party-member-card">
                    <div class="party-member-header" onclick="togglePartyMemberDetails(${index})">
                        <div>
                            <span class="party-member-name">üë§ ${fullName}</span>
                            <span class="party-member-class">${member.className || ''} (${member.role || ''})</span>
                        </div>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${index})">‚úï</button>
                    </div>
                    <div class="party-member-details" id="partyMember-${index}">
                        <div class="party-member-stat"><label>Race:</label> ${member.race || '-'}</div>
                        <div class="party-member-stat"><label>Size:</label> ${member.size || '-'}</div>
                        <div class="party-member-stat"><label>Class:</label> ${member.className || '-'}</div>
                        <div class="party-member-stat"><label>Role:</label> ${member.role || '-'}</div>
                        ${renderAddInfoList(member.addInfo, index)}
                        <button class="add-info-btn" onclick="event.stopPropagation(); openAddInfoForm(${index}, 'party-member')">+ Add Info</button>
                        <button class="modal-btn secondary" style="margin-top: 8px; margin-left: 8px;" onclick="event.stopPropagation(); editPartyMember(${index})">Edit</button>
                    </div>
                </div>
            `;
        }

        function renderLocationNotes(notes) {
            return notes.map((item, i) => {
                if (item.type === 'location') {
                    return renderLocationCard(item, i);
                } else {
                    // Legacy note format
                    return `
                        <div class="note-item" onclick="openNote(${i})">
                            <span>üìù ${item.name}</span>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${i})">‚úï</button>
                        </div>
                    `;
                }
            }).join('');
        }

        function renderLocationCard(location, index) {
            return `
                <div class="location-card">
                    <div class="location-header" onclick="toggleLocationDetails(${index})">
                        <span class="location-title">üìç ${location.title || 'Unnamed'}</span>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${index})">‚úï</button>
                    </div>
                    <div class="location-details" id="location-${index}">
                        <div class="location-desc">${parseMentions(location.description || '')}</div>
                        ${renderAddInfoList(location.addInfo, index)}
                        <button class="add-info-btn" onclick="event.stopPropagation(); openAddInfoForm(${index}, 'location')">+ Add Info</button>
                        <button class="modal-btn secondary" style="margin-top: 8px; margin-left: 8px;" onclick="event.stopPropagation(); editLocation(${index})">Edit</button>
                    </div>
                </div>
            `;
        }

        function renderNPCNotes(notes) {
            return notes.map((item, i) => {
                if (item.type === 'npc') {
                    return renderNPCCard(item, i);
                } else {
                    // Legacy note format
                    return `
                        <div class="note-item" onclick="openNote(${i})">
                            <span>üìù ${item.name}</span>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${i})">‚úï</button>
                        </div>
                    `;
                }
            }).join('');
        }

        function renderNPCCard(npc, index) {
            return `
                <div class="npc-card">
                    <div class="npc-header" onclick="toggleNPCDetails(${index})">
                        <span class="npc-name">üßô ${npc.name || 'Unnamed'}</span>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${index})">‚úï</button>
                    </div>
                    <div class="location-details" id="npc-${index}">
                        <div class="location-desc">${parseMentions(npc.description || '')}</div>
                        ${renderAddInfoList(npc.addInfo, index)}
                        <button class="add-info-btn" onclick="event.stopPropagation(); openAddInfoForm(${index}, 'npc')">+ Add Info</button>
                        <button class="modal-btn secondary" style="margin-top: 8px; margin-left: 8px;" onclick="event.stopPropagation(); editNPC(${index})">Edit</button>
                    </div>
                </div>
            `;
        }

        function renderAddInfoList(addInfo, parentIndex) {
            if (!addInfo || addInfo.length === 0) return '';
            return `
                <div class="add-info-list">
                    ${addInfo.map((info, i) => `
                        <div class="add-info-item">
                            <div class="add-info-type">${info.type}</div>
                            <div class="add-info-content">${parseMentions(info.content)}</div>
                            <button class="delete-btn" style="float: right; margin-top: -20px;" onclick="event.stopPropagation(); deleteAddInfo(${parentIndex}, ${i})">‚úï</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function togglePartyMemberDetails(index) {
            document.getElementById(`partyMember-${index}`).classList.toggle('expanded');
        }

        function toggleLocationDetails(index) {
            document.getElementById(`location-${index}`).classList.toggle('expanded');
        }

        function toggleNPCDetails(index) {
            document.getElementById(`npc-${index}`).classList.toggle('expanded');
        }

        // @ mention parsing
        function parseMentions(text) {
            if (!text) return '';
            // Convert @Party(name), @NPC(name), @Location(name) to clickable links
            return text
                .replace(/@Party\(([^)]+)\)/g, '<span class="mention-link" onclick="findMention(\'party\', \'$1\')">@$1</span>')
                .replace(/@NPC\(([^)]+)\)/g, '<span class="mention-link" onclick="findMention(\'npc\', \'$1\')">@$1</span>')
                .replace(/@Location\(([^)]+)\)/g, '<span class="mention-link" onclick="findMention(\'location\', \'$1\')">@$1</span>');
        }

        function findMention(type, name) {
            const searchName = name.toLowerCase();
            let found = false;

            if (type === 'party') {
                const sessions = state.notes.sessions || [];
                for (let i = 0; i < sessions.length; i++) {
                    if (sessions[i].type === 'party-member') {
                        const fullName = `${sessions[i].firstName || ''} ${sessions[i].lastName || ''}`.toLowerCase();
                        if (fullName.includes(searchName)) {
                            showNotesCategory('sessions');
                            setTimeout(() => {
                                const el = document.getElementById(`partyMember-${i}`);
                                if (el) el.classList.add('expanded');
                            }, 100);
                            found = true;
                            break;
                        }
                    }
                }
            } else if (type === 'npc') {
                const npcs = state.notes.npcs || [];
                for (let i = 0; i < npcs.length; i++) {
                    if ((npcs[i].name || '').toLowerCase().includes(searchName)) {
                        showNotesCategory('npcs');
                        setTimeout(() => {
                            const el = document.getElementById(`npc-${i}`);
                            if (el) el.classList.add('expanded');
                        }, 100);
                        found = true;
                        break;
                    }
                }
            } else if (type === 'location') {
                const locations = state.notes.locations || [];
                for (let i = 0; i < locations.length; i++) {
                    if ((locations[i].title || '').toLowerCase().includes(searchName)) {
                        showNotesCategory('locations');
                        setTimeout(() => {
                            const el = document.getElementById(`location-${i}`);
                            if (el) el.classList.add('expanded');
                        }, 100);
                        found = true;
                        break;
                    }
                }
            }

            if (!found) {
                showToast(`${name} not found`);
            }
        }

        function renderBattleNotes(battles) {
            return battles.map((battle, i) => `
                <div class="note-folder battle-record">
                    <div class="note-folder-header" onclick="toggleFolder(this)">
                        <span>‚öîÔ∏è</span> ${battle.name}
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${i})">‚úï</button>
                    </div>
                    <div class="note-folder-items battle-log-details" style="display:none;">
                        <div class="battle-log-summary">
                            <strong>${battle.totalRounds} rounds</strong> - ${new Date(battle.date).toLocaleString()}
                        </div>
                        <div class="battle-log-entries">
                            ${battle.log.map(entry => `
                                <div class="battle-log-entry">
                                    <span class="battle-log-time">${entry.time}</span>
                                    <span>${entry.text}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="battle-notes-section">
                            <textarea class="battle-notes-input" placeholder="Add notes about this battle..."
                                onchange="updateBattleNotes(${i}, this.value)">${battle.notes || ''}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateBattleNotes(index, notes) {
            saveForUndo();
            state.notes.battles[index].notes = notes;
            saveState();
        }

        function renderNoteTree(items, depth) {
            return items.map((item, i) => {
                if (item.type === 'folder') {
                    return `
                        <div class="note-folder" style="margin-left: ${depth * 15}px">
                            <div class="note-folder-header" onclick="toggleFolder(this)">
                                <span>üìÅ</span> ${item.name}
                                <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${i})">‚úï</button>
                            </div>
                            <div class="note-folder-items" style="display:none;">
                                ${item.children ? renderNoteTree(item.children, depth + 1) : ''}
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="note-item" style="margin-left: ${depth * 15}px" onclick="openNote(${i})">
                            <span>üìù ${item.name}</span>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${i})">‚úï</button>
                        </div>
                    `;
                }
            }).join('');
        }

        function toggleFolder(el) {
            const items = el.nextElementSibling;
            items.style.display = items.style.display === 'none' ? 'block' : 'none';
        }

        // ===== ADD FORMS =====
        function openAddSessionNote() {
            showModal('Add Session Note', `
                <div style="margin-bottom: 15px;">
                    <label>Session Title:</label>
                    <input type="text" id="sessionNoteTitle" class="add-item-input" placeholder="Session 1, Session 2..." style="width: 100%; margin-top: 5px;">
                </div>
                <button class="modal-btn primary" onclick="saveNewSessionNote()">Create Note</button>
            `);
        }

        function saveNewSessionNote() {
            const title = document.getElementById('sessionNoteTitle').value.trim();
            if (!title) {
                showToast('Please enter a title');
                return;
            }
            saveForUndo();
            state.notes.sessions.push({
                type: 'note',
                name: title,
                content: ''
            });
            saveState();
            renderNotes();
            closeModal();
            showToast('Session note created');
        }

        function openAddPartyMember() {
            showModal('Add Party Member', `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label>First Name:</label>
                        <input type="text" id="pmFirstName" class="add-item-input" style="width: 100%; margin-top: 5px;">
                    </div>
                    <div>
                        <label>Last Name:</label>
                        <input type="text" id="pmLastName" class="add-item-input" style="width: 100%; margin-top: 5px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label>Race:</label>
                        <input type="text" id="pmRace" class="add-item-input" style="width: 100%; margin-top: 5px;">
                    </div>
                    <div>
                        <label>Size:</label>
                        <select id="pmSize" class="add-item-input" style="width: 100%; margin-top: 5px; padding: 8px;">
                            <option value="Small">Small</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Large">Large</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label>Class:</label>
                        <input type="text" id="pmClass" class="add-item-input" placeholder="Fighter, Wizard..." style="width: 100%; margin-top: 5px;">
                    </div>
                    <div>
                        <label>Role:</label>
                        <input type="text" id="pmRole" class="add-item-input" placeholder="Tank, Healer, DPS..." style="width: 100%; margin-top: 5px;">
                    </div>
                </div>
                <button class="modal-btn primary" onclick="saveNewPartyMember()">Add Party Member</button>
            `);
        }

        function saveNewPartyMember() {
            const firstName = document.getElementById('pmFirstName').value.trim();
            const lastName = document.getElementById('pmLastName').value.trim();

            if (!firstName && !lastName) {
                showToast('Please enter a name');
                return;
            }

            saveForUndo();
            state.notes.sessions.push({
                type: 'party-member',
                firstName,
                lastName,
                race: document.getElementById('pmRace').value.trim(),
                size: document.getElementById('pmSize').value,
                className: document.getElementById('pmClass').value.trim(),
                role: document.getElementById('pmRole').value.trim(),
                addInfo: []
            });
            saveState();
            renderNotes();
            closeModal();
            showToast('Party member added');
        }

        function editPartyMember(index) {
            const member = state.notes.sessions[index];
            showModal('Edit Party Member', `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label>First Name:</label>
                        <input type="text" id="pmFirstName" class="add-item-input" value="${member.firstName || ''}" style="width: 100%; margin-top: 5px;">
                    </div>
                    <div>
                        <label>Last Name:</label>
                        <input type="text" id="pmLastName" class="add-item-input" value="${member.lastName || ''}" style="width: 100%; margin-top: 5px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label>Race:</label>
                        <input type="text" id="pmRace" class="add-item-input" value="${member.race || ''}" style="width: 100%; margin-top: 5px;">
                    </div>
                    <div>
                        <label>Size:</label>
                        <select id="pmSize" class="add-item-input" style="width: 100%; margin-top: 5px; padding: 8px;">
                            <option value="Small" ${member.size === 'Small' ? 'selected' : ''}>Small</option>
                            <option value="Medium" ${member.size === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="Large" ${member.size === 'Large' ? 'selected' : ''}>Large</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label>Class:</label>
                        <input type="text" id="pmClass" class="add-item-input" value="${member.className || ''}" style="width: 100%; margin-top: 5px;">
                    </div>
                    <div>
                        <label>Role:</label>
                        <input type="text" id="pmRole" class="add-item-input" value="${member.role || ''}" style="width: 100%; margin-top: 5px;">
                    </div>
                </div>
                <button class="modal-btn primary" onclick="saveEditedPartyMember(${index})">Save Changes</button>
            `);
        }

        function saveEditedPartyMember(index) {
            saveForUndo();
            const member = state.notes.sessions[index];
            member.firstName = document.getElementById('pmFirstName').value.trim();
            member.lastName = document.getElementById('pmLastName').value.trim();
            member.race = document.getElementById('pmRace').value.trim();
            member.size = document.getElementById('pmSize').value;
            member.className = document.getElementById('pmClass').value.trim();
            member.role = document.getElementById('pmRole').value.trim();
            saveState();
            renderNotes();
            closeModal();
            showToast('Party member updated');
        }

        function openAddLocation() {
            showModal('Add Location', `
                <div style="margin-bottom: 15px;">
                    <label>Location Name:</label>
                    <input type="text" id="locTitle" class="add-item-input" placeholder="Tavern, City, Shop..." style="width: 100%; margin-top: 5px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Description:</label>
                    <textarea id="locDesc" class="note-textarea" placeholder="Describe this location..." style="min-height: 100px; margin-top: 5px;"></textarea>
                </div>
                <button class="modal-btn primary" onclick="saveNewLocation()">Add Location</button>
            `);
        }

        function saveNewLocation() {
            const title = document.getElementById('locTitle').value.trim();
            if (!title) {
                showToast('Please enter a name');
                return;
            }

            saveForUndo();
            state.notes.locations.push({
                type: 'location',
                title,
                description: document.getElementById('locDesc').value.trim(),
                addInfo: []
            });
            saveState();
            renderNotes();
            closeModal();
            showToast('Location added');
        }

        function editLocation(index) {
            const location = state.notes.locations[index];
            showModal('Edit Location', `
                <div style="margin-bottom: 15px;">
                    <label>Location Name:</label>
                    <input type="text" id="locTitle" class="add-item-input" value="${location.title || ''}" style="width: 100%; margin-top: 5px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Description:</label>
                    <textarea id="locDesc" class="note-textarea" style="min-height: 100px; margin-top: 5px;">${location.description || ''}</textarea>
                </div>
                <button class="modal-btn primary" onclick="saveEditedLocation(${index})">Save Changes</button>
            `);
        }

        function saveEditedLocation(index) {
            saveForUndo();
            state.notes.locations[index].title = document.getElementById('locTitle').value.trim();
            state.notes.locations[index].description = document.getElementById('locDesc').value.trim();
            saveState();
            renderNotes();
            closeModal();
            showToast('Location updated');
        }

        function openAddNPC() {
            showModal('Add NPC', `
                <div style="margin-bottom: 15px;">
                    <label>NPC Name:</label>
                    <input type="text" id="npcName" class="add-item-input" style="width: 100%; margin-top: 5px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Description:</label>
                    <textarea id="npcDesc" class="note-textarea" placeholder="Who is this NPC? What do they do?" style="min-height: 100px; margin-top: 5px;"></textarea>
                </div>
                <button class="modal-btn primary" onclick="saveNewNPC()">Add NPC</button>
            `);
        }

        function saveNewNPC() {
            const name = document.getElementById('npcName').value.trim();
            if (!name) {
                showToast('Please enter a name');
                return;
            }

            saveForUndo();
            state.notes.npcs.push({
                type: 'npc',
                name,
                description: document.getElementById('npcDesc').value.trim(),
                addInfo: []
            });
            saveState();
            renderNotes();
            closeModal();
            showToast('NPC added');
        }

        function editNPC(index) {
            const npc = state.notes.npcs[index];
            showModal('Edit NPC', `
                <div style="margin-bottom: 15px;">
                    <label>NPC Name:</label>
                    <input type="text" id="npcName" class="add-item-input" value="${npc.name || ''}" style="width: 100%; margin-top: 5px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Description:</label>
                    <textarea id="npcDesc" class="note-textarea" style="min-height: 100px; margin-top: 5px;">${npc.description || ''}</textarea>
                </div>
                <button class="modal-btn primary" onclick="saveEditedNPC(${index})">Save Changes</button>
            `);
        }

        function saveEditedNPC(index) {
            saveForUndo();
            state.notes.npcs[index].name = document.getElementById('npcName').value.trim();
            state.notes.npcs[index].description = document.getElementById('npcDesc').value.trim();
            saveState();
            renderNotes();
            closeModal();
            showToast('NPC updated');
        }

        // Add Info functionality
        function openAddInfoForm(parentIndex, parentType) {
            const infoTypes = parentType === 'location'
                ? ['Shop', 'House', 'Gossip', 'Quest', 'Custom']
                : ['Info', 'Personality', 'Relationship', 'Quest', 'Custom'];

            const typeOptions = infoTypes.map(t => `<option value="${t}">${t}</option>`).join('');

            showModal('Add Info', `
                <div style="margin-bottom: 15px;">
                    <label>Type:</label>
                    <select id="addInfoType" class="add-item-input" style="width: 100%; margin-top: 5px; padding: 8px;">
                        ${typeOptions}
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Content:</label>
                    <textarea id="addInfoContent" class="note-textarea" placeholder="Enter details..." style="min-height: 80px; margin-top: 5px;"></textarea>
                </div>
                <p class="text-small text-muted" style="margin-bottom: 15px;">
                    Tip: Use @Party(name), @NPC(name), or @Location(name) to create links!
                </p>
                <button class="modal-btn primary" onclick="saveAddInfo(${parentIndex}, '${parentType}')">Add</button>
            `);
        }

        function saveAddInfo(parentIndex, parentType) {
            const type = document.getElementById('addInfoType').value;
            const content = document.getElementById('addInfoContent').value.trim();

            if (!content) {
                showToast('Please enter content');
                return;
            }

            saveForUndo();

            let item;
            if (parentType === 'party-member') {
                item = state.notes.sessions[parentIndex];
            } else if (parentType === 'location') {
                item = state.notes.locations[parentIndex];
            } else if (parentType === 'npc') {
                item = state.notes.npcs[parentIndex];
            }

            if (!item.addInfo) item.addInfo = [];
            item.addInfo.push({ type, content });

            saveState();
            renderNotes();
            closeModal();
            showToast('Info added');
        }

        function deleteAddInfo(parentIndex, infoIndex) {
            if (!confirm('Delete this info?')) return;
            saveForUndo();

            let item;
            if (currentNoteCategory === 'sessions') {
                item = state.notes.sessions[parentIndex];
            } else if (currentNoteCategory === 'locations') {
                item = state.notes.locations[parentIndex];
            } else if (currentNoteCategory === 'npcs') {
                item = state.notes.npcs[parentIndex];
            }

            if (item && item.addInfo) {
                item.addInfo.splice(infoIndex, 1);
                saveState();
                renderNotes();
            }
        }

        function addNote() {
            const name = document.getElementById('newNoteName').value.trim();
            if (!name) return;
            saveForUndo();
            state.notes[currentNoteCategory].push({ type: 'note', name, content: '' });
            document.getElementById('newNoteName').value = '';
            renderNotes();
            saveState();
        }

        function addFolder() {
            const name = document.getElementById('newNoteName').value.trim();
            if (!name) return;
            saveForUndo();
            state.notes[currentNoteCategory].push({ type: 'folder', name, children: [] });
            document.getElementById('newNoteName').value = '';
            renderNotes();
            saveState();
        }

        function openNote(index) {
            currentNoteId = index;
            const note = state.notes[currentNoteCategory][index];
            document.getElementById('noteEditorTitle').textContent = 'Editing: ' + note.name;
            document.getElementById('noteEditor').value = note.content || '';
            document.getElementById('noteEditorCard').style.display = 'block';
        }

        function closeNoteEditor() {
            document.getElementById('noteEditorCard').style.display = 'none';
            currentNoteId = null;
        }

        function saveCurrentNote() {
            if (currentNoteId === null) return;
            saveForUndo();
            state.notes[currentNoteCategory][currentNoteId].content = document.getElementById('noteEditor').value;
            saveState();
            alert('Note saved!');
        }

        function deleteNote(index) {
            if (!confirm('Delete this note/folder?')) return;
            saveForUndo();
            state.notes[currentNoteCategory].splice(index, 1);
            renderNotes();
            saveState();
        }

        // ===== BACKUP & SYNC =====
        function exportBackup() {
            const backup = {
                version: STATE_VERSION,
                exportDate: new Date().toISOString(),
                characterName: 'Ashvael',
                state: state
            };

            const jsonString = JSON.stringify(backup, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            // Create filename with date
            const date = new Date();
            const dateStr = date.toISOString().split('T')[0];
            const timeStr = date.toTimeString().split(' ')[0].replace(/:/g, '-');
            const filename = `Ashvael_Backup_${dateStr}_${timeStr}.json`;

            // Trigger download
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Save last backup time
            localStorage.setItem('lastBackupDate', new Date().toISOString());
            updateBackupInfo();

            showToast('Backup exported!');
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);

                    // Validate backup
                    if (!backup.state) {
                        alert('Invalid backup file: missing state data');
                        return;
                    }

                    // Confirm import
                    const exportDate = backup.exportDate ? new Date(backup.exportDate).toLocaleString() : 'Unknown';
                    if (!confirm(`Import backup from ${exportDate}?\n\nThis will replace all current data.`)) {
                        return;
                    }

                    // Import the state
                    Object.assign(state, backup.state);
                    saveState();

                    // Record import
                    localStorage.setItem('lastImportDate', new Date().toISOString());
                    localStorage.setItem('lastImportFile', file.name);

                    // Refresh everything
                    location.reload();

                } catch (err) {
                    alert('Error reading backup file: ' + err.message);
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        function updateBackupInfo() {
            const infoEl = document.getElementById('lastBackupInfo');
            if (!infoEl) return;

            const lastBackup = localStorage.getItem('lastBackupDate');
            const lastImport = localStorage.getItem('lastImportDate');
            const lastImportFile = localStorage.getItem('lastImportFile');

            let html = '';

            if (lastBackup) {
                const date = new Date(lastBackup);
                html += `<div>üì§ Last export: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>`;
            }

            if (lastImport) {
                const date = new Date(lastImport);
                html += `<div>üì• Last import: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                if (lastImportFile) {
                    html += ` (${lastImportFile})`;
                }
                html += `</div>`;
            }

            if (!html) {
                html = '<div>No backups yet. Export your first backup after your session!</div>';
            }

            infoEl.innerHTML = html;
        }

        // ===== GITHUB SYNC =====
        function getGitHubConfig() {
            const config = localStorage.getItem('githubConfig');
            return config ? JSON.parse(config) : null;
        }

        function saveGitHubConfig(config) {
            localStorage.setItem('githubConfig', JSON.stringify(config));
            updateGitHubUI();
        }

        function updateGitHubUI() {
            const config = getGitHubConfig();
            const statusEl = document.getElementById('githubSyncStatus');
            const buttonsEl = document.getElementById('githubSyncButtons');
            const setupEl = document.getElementById('githubSetupPrompt');

            if (!statusEl || !buttonsEl || !setupEl) return;

            if (config && config.token && config.repo) {
                // Connected
                setupEl.style.display = 'none';
                buttonsEl.style.display = 'block';

                const lastPush = localStorage.getItem('lastGitHubPush');
                const lastPull = localStorage.getItem('lastGitHubPull');

                let statusHtml = `<div style="padding: 10px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 10px; font-size: 0.85em;">`;
                statusHtml += `<div style="color: var(--accent-green);">‚úì Connected to ${config.repo}</div>`;
                statusHtml += `<div style="color: var(--text-muted);">File: ${config.path || 'ashvael_backup.json'}</div>`;

                if (lastPush) {
                    const date = new Date(lastPush);
                    statusHtml += `<div style="color: var(--text-muted); margin-top: 5px;">üöÄ Last push: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>`;
                }
                if (lastPull) {
                    const date = new Date(lastPull);
                    statusHtml += `<div style="color: var(--text-muted);">üì• Last pull: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>`;
                }

                statusHtml += `</div>`;
                statusEl.innerHTML = statusHtml;
            } else {
                // Not connected
                setupEl.style.display = 'block';
                buttonsEl.style.display = 'none';
                statusEl.innerHTML = '';
            }
        }

        function openGitHubSettings() {
            const config = getGitHubConfig() || {};

            const body = `
                <div style="padding: 10px;">
                    <p style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 15px;">
                        To sync with GitHub, you need a Personal Access Token with <strong>repo</strong> scope.
                        <br><br>
                        <a href="https://github.com/settings/tokens/new?description=Ashvael%20Character%20Sheet&scopes=repo" target="_blank" style="color: var(--accent-blue);">
                            Create token on GitHub ‚Üí
                        </a>
                    </p>

                    <div class="form-group">
                        <label>Personal Access Token</label>
                        <input type="password" id="ghToken" value="${config.token || ''}" placeholder="ghp_xxxxxxxxxxxx" style="font-family: monospace;">
                    </div>

                    <div class="form-group">
                        <label>Repository (owner/repo)</label>
                        <input type="text" id="ghRepo" value="${config.repo || ''}" placeholder="username/repo-name">
                    </div>

                    <div class="form-group">
                        <label>File Path</label>
                        <input type="text" id="ghPath" value="${config.path || 'ashvael_backup.json'}" placeholder="ashvael_backup.json">
                        <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 4px;">Path in your repo where the backup will be saved</div>
                    </div>

                    <div class="form-group">
                        <label>Branch (optional)</label>
                        <input type="text" id="ghBranch" value="${config.branch || 'main'}" placeholder="main">
                    </div>

                    <button onclick="saveGitHubSettings()" style="width: 100%; padding: 12px; background: var(--accent-green); border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer;">
                        Save Settings
                    </button>
                </div>
            `;

            showModal('‚öôÔ∏è GitHub Settings', body);
        }

        function saveGitHubSettings() {
            const token = document.getElementById('ghToken').value.trim();
            const repo = document.getElementById('ghRepo').value.trim();
            const path = document.getElementById('ghPath').value.trim() || 'ashvael_backup.json';
            const branch = document.getElementById('ghBranch').value.trim() || 'main';

            if (!token || !repo) {
                alert('Please enter both token and repository');
                return;
            }

            if (!repo.includes('/')) {
                alert('Repository should be in format: owner/repo-name');
                return;
            }

            saveGitHubConfig({ token, repo, path, branch });
            closeModal();
            showToast('GitHub connected!');
        }

        function disconnectGitHub() {
            if (!confirm('Disconnect from GitHub?')) return;
            localStorage.removeItem('githubConfig');
            localStorage.removeItem('lastGitHubPush');
            localStorage.removeItem('lastGitHubPull');
            updateGitHubUI();
            showToast('GitHub disconnected');
        }

        async function pushToGitHub() {
            const config = getGitHubConfig();
            if (!config) {
                openGitHubSettings();
                return;
            }

            // Create backup data
            const backup = {
                version: STATE_VERSION,
                exportDate: new Date().toISOString(),
                characterName: 'Ashvael',
                state: state
            };

            const content = JSON.stringify(backup, null, 2);
            const contentBase64 = btoa(unescape(encodeURIComponent(content)));

            try {
                showToast('Pushing to GitHub...');

                // First, try to get existing file to get its SHA
                let sha = null;
                try {
                    const getResponse = await fetch(
                        `https://api.github.com/repos/${config.repo}/contents/${config.path}?ref=${config.branch}`,
                        {
                            headers: {
                                'Authorization': `token ${config.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    // File doesn't exist yet, that's fine
                }

                // Create or update file
                const body = {
                    message: `Update Ashvael backup - ${new Date().toLocaleString()}`,
                    content: contentBase64,
                    branch: config.branch
                };
                if (sha) {
                    body.sha = sha;
                }

                const response = await fetch(
                    `https://api.github.com/repos/${config.repo}/contents/${config.path}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    }
                );

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to push');
                }

                localStorage.setItem('lastGitHubPush', new Date().toISOString());
                updateGitHubUI();
                showToast('‚úì Pushed to GitHub!');

            } catch (err) {
                alert('GitHub push failed: ' + err.message);
            }
        }

        async function pullFromGitHub() {
            const config = getGitHubConfig();
            if (!config) {
                openGitHubSettings();
                return;
            }

            try {
                showToast('Pulling from GitHub...');

                const response = await fetch(
                    `https://api.github.com/repos/${config.repo}/contents/${config.path}?ref=${config.branch}`,
                    {
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Backup file not found in repository');
                    }
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to pull');
                }

                const fileData = await response.json();
                const content = decodeURIComponent(escape(atob(fileData.content)));
                const backup = JSON.parse(content);

                // Validate backup
                if (!backup.state) {
                    throw new Error('Invalid backup file');
                }

                // Confirm import
                const exportDate = backup.exportDate ? new Date(backup.exportDate).toLocaleString() : 'Unknown';
                if (!confirm(`Import backup from GitHub?\n\nBackup date: ${exportDate}\n\nThis will replace all current data.`)) {
                    return;
                }

                // Import the state
                Object.assign(state, backup.state);
                saveState();

                localStorage.setItem('lastGitHubPull', new Date().toISOString());

                // Refresh everything
                location.reload();

            } catch (err) {
                alert('GitHub pull failed: ' + err.message);
            }
        }

        // ===== ENHANCED INIT =====
        function initAll() {
            try {
                // Load saved state first
                loadState();

                // Render all sections
                if (typeof CANTRIPS !== 'undefined') {
                    renderCantrips();
                    renderCantripsDisplay();
                }
                if (typeof SPELLS !== 'undefined') {
                    renderSpells();
                }
                if (typeof ALL_BEAST_FORMS !== 'undefined') {
                    renderBeasts();
                }
                if (typeof FEATURES !== 'undefined') {
                    renderFeatures();
                }

                renderInventory();
                renderNotes();
                updateAddNoteRow();
                updateBackupInfo();
                updateGitHubUI();

                // Update all displays with current state
                updateHPDisplay();
                updateSlotsDisplay();
                updateResourcesDisplay();
                updateResourceSlots();
                updatePreparedDisplay();
                updateFormIndicator();
                updateAllSkillDisplays(); // Recalculate skills on load
                updateWildShapeDisplay();
                updateBattleUI();
                updateConcentrationDisplay();
                updateCompanionDisplay();
                updateResistancesDisplay();
                updateItemChargesDisplay();
                updateReclaimButton();
                updateAbsorbElementsButton();
                loadCardCollapseStates();

                console.log('Ashvael character sheet initialized successfully');
            } catch (error) {
                console.error('Init error:', error);
                alert('Error initializing: ' + error.message + '\n\nTry clearing site data and refreshing.');
            }
        }

        document.addEventListener('DOMContentLoaded', initAll);

        // ===== PWA SERVICE WORKER =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered:', reg.scope))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        // ===== iOS PWA INSTALL PROMPT =====
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        function isInStandaloneMode() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                   window.navigator.standalone === true;
        }

        function showIOSInstallPrompt() {
            if (isIOS() && !isInStandaloneMode() && !localStorage.getItem('pwa-install-dismissed')) {
                const banner = document.createElement('div');
                banner.className = 'pwa-install-banner show';
                banner.innerHTML = `
                    <div>
                        <strong>Install Ashvael</strong><br>
                        <small>Tap Share then "Add to Home Screen"</small>
                    </div>
                    <button onclick="this.parentElement.remove(); localStorage.setItem('pwa-install-dismissed', 'true');">Got it</button>
                `;
                document.body.appendChild(banner);
            }
        }

        // Show install prompt after a short delay
        setTimeout(showIOSInstallPrompt, 3000);
    </script>
</body>
</html>
